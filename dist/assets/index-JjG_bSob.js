(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const u of n)if(u.type==="childList")for(const o of u.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function s(n){const u={};return n.integrity&&(u.integrity=n.integrity),n.referrerPolicy&&(u.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?u.credentials="include":n.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function r(n){if(n.ep)return;n.ep=!0;const u=s(n);fetch(n.href,u)}})();var litegraph={},hasRequiredLitegraph;function requireLitegraph(){return hasRequiredLitegraph||(hasRequiredLitegraph=1,(function(exports$1){(function(global){var LiteGraph=global.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_SELECTED_TITLE_COLOR:"#FFF",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",NODE_BOX_OUTLINE_COLOR:"#FFF",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,GRID_SHAPE:6,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,NODE_MODES:["Always","On Event","Never","On Trigger"],NODE_MODES_COLORS:["#666","#422","#333","#224","#626"],ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,LINK_RENDER_MODES:["Straight","Linear","Spline"],STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,VERTICAL_LAYOUT:"vertical",proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,use_deferred_actions:!0,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},Globals:{},searchbox_extras:{},auto_sort_node_types:!1,node_box_coloured_when_on:!1,node_box_coloured_by_mode:!1,dialog_close_on_mouse_leave:!0,dialog_close_on_mouse_leave_delay:500,shift_click_do_break_link_from:!1,click_do_break_link_to:!1,search_hide_on_mouse_leave:!0,search_filter_enabled:!1,search_show_all_on_open:!0,auto_load_slot_types:!1,registered_slot_in_types:{},registered_slot_out_types:{},slot_types_in:[],slot_types_out:[],slot_types_default_in:[],slot_types_default_out:[],alt_drag_do_clone_nodes:!1,do_add_triggers_slots:!1,allow_multi_output_for_events:!0,middle_click_slot_add_default_node:!1,release_link_on_empty_shows_menu:!1,pointerevents_method:"mouse",ctrl_shift_v_paste_connect_unselected_outputs:!1,use_uuids:!1,registerNodeType:function(e,t){if(!t.prototype)throw"Cannot register a simple object, it must be a class with a prototype";t.type=e,LiteGraph.debug&&console.log("Node registered: "+e);const s=t.name,r=e.lastIndexOf("/");t.category=e.substring(0,r),t.title||(t.title=s);for(var n in LGraphNode.prototype)t.prototype[n]||(t.prototype[n]=LGraphNode.prototype[n]);const u=this.registered_node_types[e];if(u&&console.log("replacing node type: "+e),!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(o){switch(o){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=o}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(let o in t.supported_extensions){const a=t.supported_extensions[o];a&&a.constructor===String&&(this.node_types_by_file_extension[a.toLowerCase()]=t)}this.registered_node_types[e]=t,t.constructor.name&&(this.Nodes[s]=t),LiteGraph.onNodeTypeRegistered&&LiteGraph.onNodeTypeRegistered(e,t),u&&LiteGraph.onNodeTypeReplaced&&LiteGraph.onNodeTypeReplaced(e,t,u),t.prototype.onPropertyChange&&console.warn("LiteGraph node class "+e+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),this.auto_load_slot_types&&new t(t.title||"tmpnode")},unregisterNodeType:function(e){const t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw"node type not found: "+e;delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]},registerNodeAndSlotType:function(e,t,s){s=s||!1;const n=(e.constructor===String&&this.registered_node_types[e]!=="anonymous"?this.registered_node_types[e]:e).constructor.type;let u=[];typeof t=="string"?u=t.split(","):t==this.EVENT||t==this.ACTION?u=["_event_"]:u=["*"];for(let o=0;o<u.length;++o){let a=u[o];a===""&&(a="*");const l=s?"registered_slot_out_types":"registered_slot_in_types";this[l][a]===void 0&&(this[l][a]={nodes:[]}),this[l][a].nodes.includes(n)||this[l][a].nodes.push(n),s?this.slot_types_out.includes(a.toLowerCase())||(this.slot_types_out.push(a.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(a.toLowerCase())||(this.slot_types_in.push(a.toLowerCase()),this.slot_types_in.sort())}},buildNodeClassFromObject:function(e,t){var s="";if(t.inputs)for(var r=0;r<t.inputs.length;++r){var n=t.inputs[r][0],u=t.inputs[r][1];u&&u.constructor===String&&(u='"'+u+'"'),s+="this.addInput('"+n+"',"+u+`);
`}if(t.outputs)for(var r=0;r<t.outputs.length;++r){var n=t.outputs[r][0],u=t.outputs[r][1];u&&u.constructor===String&&(u='"'+u+'"'),s+="this.addOutput('"+n+"',"+u+`);
`}if(t.properties)for(var r in t.properties){var o=t.properties[r];o&&o.constructor===String&&(o='"'+o+'"'),s+="this.addProperty('"+r+"',"+o+`);
`}s+="if(this.onCreate)this.onCreate()";var a=Function(s);for(var r in t)r!="inputs"&&r!="outputs"&&r!="properties"&&(a.prototype[r]=t[r]);return a.title=t.title||e.split("/").pop(),a.desc=t.desc||"Generated from object",this.registerNodeType(e,a),a},wrapFunctionAsNode:function(e,t,s,r,n){var u=Array(t.length),o="";if(s!==null)for(var a=LiteGraph.getParameterNames(t),l=0;l<a.length;++l){var f=0;s&&(s[l]!=null&&s[l].constructor===String?f="'"+s[l]+"'":s[l]!=null&&(f=s[l])),o+="this.addInput('"+a[l]+"',"+f+`);
`}r!==null&&(o+="this.addOutput('out',"+(r!=null?r.constructor===String?"'"+r+"'":r:0)+`);
`),n&&(o+="this.properties = "+JSON.stringify(n)+`;
`);var m=Function(o);return m.title=e.split("/").pop(),m.desc="Generated from "+t.name,m.prototype.onExecute=function(){for(var d=0;d<u.length;++d)u[d]=this.getInputData(d);var g=t.apply(this,u);this.setOutputData(0,g)},this.registerNodeType(e,m),m},clearRegisteredTypes:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}},addNodeMethod:function(e,t){LGraphNode.prototype[e]=t;for(var s in this.registered_node_types){var r=this.registered_node_types[s];r.prototype[e]&&(r.prototype["_"+e]=r.prototype[e]),r.prototype[e]=t}},createNode:function(e,t,s){var r=this.registered_node_types[e];if(!r)return LiteGraph.debug&&console.log('GraphNode type "'+e+'" not registered.'),null;r.prototype,t=t||r.title||e;var n=null;if(LiteGraph.catch_exceptions)try{n=new r(t)}catch(o){return console.error(o),null}else n=new r(t);if(n.type=e,!n.title&&t&&(n.title=t),n.properties||(n.properties={}),n.properties_info||(n.properties_info=[]),n.flags||(n.flags={}),n.size||(n.size=n.computeSize()),n.pos||(n.pos=LiteGraph.DEFAULT_POSITION.concat()),n.mode||(n.mode=LiteGraph.ALWAYS),s)for(var u in s)n[u]=s[u];return n.onNodeCreated&&n.onNodeCreated(),n},getNodeType:function(e){return this.registered_node_types[e]},getNodeTypesInCategory:function(e,t){var s=[];for(var r in this.registered_node_types){var n=this.registered_node_types[r];n.filter==t&&(e==""?n.category==null&&s.push(n):n.category==e&&s.push(n))}return this.auto_sort_node_types&&s.sort(function(u,o){return u.title.localeCompare(o.title)}),s},getNodeTypesCategories:function(e){var t={"":1};for(var s in this.registered_node_types){var r=this.registered_node_types[s];if(r.category&&!r.skip_list){if(r.filter!=e)continue;t[r.category]=1}}var n=[];for(var s in t)n.push(s);return this.auto_sort_node_types?n.sort():n},reloadNodes:function(e){for(var t=document.getElementsByTagName("script"),s=[],r=0;r<t.length;r++)s.push(t[r]);var n=document.getElementsByTagName("head")[0];e=document.location.href+e;for(var r=0;r<s.length;r++){var u=s[r].src;if(!(!u||u.substr(0,e.length)!=e))try{LiteGraph.debug&&console.log("Reloading: "+u);var o=document.createElement("script");o.type="text/javascript",o.src=u,n.appendChild(o),n.removeChild(s[r])}catch(l){if(LiteGraph.throw_errors)throw l;LiteGraph.debug&&console.log("Error while reloading "+u)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(e,t){if(e==null)return null;var s=JSON.parse(JSON.stringify(e));if(!t)return s;for(var r in s)t[r]=s[r];return t},uuidv4:function(){return("10000000-1000-4000-8000"+-1e11).replace(/[018]/g,e=>(e^Math.random()*16>>e/4).toString(16))},isValidConnection:function(e,t){if((e==""||e==="*")&&(e=0),(t==""||t==="*")&&(t=0),!e||!t||e==t||e==LiteGraph.EVENT&&t==LiteGraph.ACTION)return!0;if(e=String(e),t=String(t),e=e.toLowerCase(),t=t.toLowerCase(),e.indexOf(",")==-1&&t.indexOf(",")==-1)return e==t;for(var s=e.split(","),r=t.split(","),n=0;n<s.length;++n)for(var u=0;u<r.length;++u)if(this.isValidConnection(s[n],r[u]))return!0;return!1},registerSearchboxExtra:function(e,t,s){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:s}},fetchFile:function(e,t,s,r){if(!e)return null;if(t=t||"text",e.constructor===String)return e.substr(0,4)=="http"&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then(function(u){if(!u.ok)throw new Error("File not found");if(t=="arraybuffer")return u.arrayBuffer();if(t=="text"||t=="string")return u.text();if(t=="json")return u.json();if(t=="blob")return u.blob()}).then(function(u){s&&s(u)}).catch(function(u){console.error("error fetching file:",e),r&&r(u)});if(e.constructor===File||e.constructor===Blob){var n=new FileReader;if(n.onload=function(u){var o=u.target.result;t=="json"&&(o=JSON.parse(o)),s&&s(o)},t=="arraybuffer")return n.readAsArrayBuffer(e);if(t=="text"||t=="json")return n.readAsText(e);if(t=="blob")return n.readAsBinaryString(e)}return null}};typeof performance<"u"?LiteGraph.getTime=performance.now.bind(performance):typeof Date<"u"&&Date.now?LiteGraph.getTime=Date.now.bind(Date):typeof process<"u"?LiteGraph.getTime=function(){var e=process.hrtime();return e[0]*.001+e[1]*1e-6}:LiteGraph.getTime=function(){return new Date().getTime()};function LGraph(e){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),e&&this.configure(e)}global.LGraph=LiteGraph.LGraph=LGraph,LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){if(this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var e=0;e<this._nodes.length;++e){var t=this._nodes[e];t.onRemoved&&t.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(e){if(e.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";e.graph&&e.graph!=this&&e.graph.detachCanvas(e),e.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(e)},LGraph.prototype.detachCanvas=function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);t!=-1&&(e.graph=null,this.list_of_graphcanvas.splice(t,1))}},LGraph.prototype.start=function(e){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime,e=e||0;var t=this;if(e==0&&typeof window<"u"&&window.requestAnimationFrame){let r=function(){t.execution_timer_id==-1&&(window.requestAnimationFrame(r),t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep())};var s=r;this.execution_timer_id=-1,r()}else this.execution_timer_id=setInterval(function(){t.onBeforeStep&&t.onBeforeStep(),t.runStep(1,!t.catch_errors),t.onAfterStep&&t.onAfterStep()},e)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),this.execution_timer_id!=null&&(this.execution_timer_id!=-1&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(e,t,s){e=e||1;var r=LiteGraph.getTime();this.globaltime=.001*(r-this.starttime);var n=this._nodes_executable?this._nodes_executable:this._nodes;if(n){if(s=s||n.length,t){for(var u=0;u<e;u++){for(var o=0;o<s;++o){var a=n[o];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.doExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(var u=0;u<e;u++){for(var o=0;o<s;++o){var a=n[o];LiteGraph.use_deferred_actions&&a._waiting_actions&&a._waiting_actions.length&&a.executePendingActions(),a.mode==LiteGraph.ALWAYS&&a.onExecute&&a.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(m){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw m;LiteGraph.debug&&console.log("Error during execution: "+m),this.stop()}var l=LiteGraph.getTime(),f=l-r;f==0&&(f=1),this.execution_time=.001*f,this.globaltime+=.001*f,this.iteration+=1,this.elapsed_time=(l-this.last_update_time)*.001,this.last_update_time=l,this.nodes_executing=[],this.nodes_actioning=[],this.nodes_executedAction=[]}},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])},LGraph.prototype.computeExecutionOrder=function(e,t){for(var s=[],r=[],n={},u={},o={},a=0,k=this._nodes.length;a<k;++a){var l=this._nodes[a];if(!(e&&!l.onExecute)){n[l.id]=l;var f=0;if(l.inputs)for(var m=0,O=l.inputs.length;m<O;m++)l.inputs[m]&&l.inputs[m].link!=null&&(f+=1);f==0?(r.push(l),t&&(l._level=1)):(t&&(l._level=0),o[l.id]=f)}}for(;r.length!=0;){var l=r.shift();if(s.push(l),delete n[l.id],!!l.outputs)for(var a=0;a<l.outputs.length;a++){var d=l.outputs[a];if(!(d==null||d.links==null||d.links.length==0))for(var m=0;m<d.links.length;m++){var g=d.links[m],E=this.links[g];if(E&&!u[E.id]){var I=this.getNodeById(E.target_id);if(I==null){u[E.id]=!0;continue}t&&(!I._level||I._level<=l._level)&&(I._level=l._level+1),u[E.id]=!0,o[I.id]-=1,o[I.id]==0&&r.push(I)}}}}for(var a in n)s.push(n[a]);s.length!=this._nodes.length&&LiteGraph.debug&&console.warn("something went wrong, nodes missing");for(var k=s.length,a=0;a<k;++a)s[a].order=a;s=s.sort(function(N,T){var h=N.constructor.priority||N.priority||0,L=T.constructor.priority||T.priority||0;return h==L?N.order-T.order:h-L});for(var a=0;a<k;++a)s[a].order=a;return s},LGraph.prototype.getAncestors=function(e){for(var t=[],s=[e],r={};s.length;){var n=s.shift();if(n.inputs){!r[n.id]&&n!=e&&(r[n.id]=!0,t.push(n));for(var u=0;u<n.inputs.length;++u){var o=n.getInputNode(u);o&&t.indexOf(o)==-1&&s.push(o)}}}return t.sort(function(a,l){return a.order-l.order}),t},LGraph.prototype.arrange=function(e,t){e=e||100;const s=this.computeExecutionOrder(!1,!0),r=[];for(let u=0;u<s.length;++u){const o=s[u],a=o._level||1;r[a]||(r[a]=[]),r[a].push(o)}let n=e;for(let u=0;u<r.length;++u){const o=r[u];if(!o)continue;let a=100,l=e+LiteGraph.NODE_TITLE_HEIGHT;for(let f=0;f<o.length;++f){const m=o[f];m.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?l:n,m.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?n:l;const O=t==LiteGraph.VERTICAL_LAYOUT?1:0;m.size[O]>a&&(a=m.size[O]);const d=t==LiteGraph.VERTICAL_LAYOUT?0:1;l+=m.size[d]+e+LiteGraph.NODE_TITLE_HEIGHT}n+=a+e}this.setDirtyCanvas(!0,!0)},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(e,t,s){s=s||LiteGraph.ALWAYS;var r=this._nodes_in_order?this._nodes_in_order:this._nodes;if(r)for(var n=0,u=r.length;n<u;++n){var o=r[n];if(o.constructor===LiteGraph.Subgraph&&e!="onExecute"){o.mode==s&&o.sendEventToAllNodes(e,t,s);continue}!o[e]||o.mode!=s||(t===void 0?o[e]():t&&t.constructor===Array?o[e].apply(o,t):o[e](t))}},LGraph.prototype.sendActionToCanvas=function(e,t){if(this.list_of_graphcanvas)for(var s=0;s<this.list_of_graphcanvas.length;++s){var r=this.list_of_graphcanvas[s];r[e]&&r[e].apply(r,t)}},LGraph.prototype.add=function(e,t){if(e){if(e.constructor===LGraphGroup){this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,this._version++;return}if(e.id!=-1&&this._nodes_by_id[e.id]!=null&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return LiteGraph.use_uuids?(e.id==null||e.id==-1)&&(e.id=LiteGraph.uuidv4()):e.id==null||e.id==-1?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this._version++,this._nodes.push(e),this._nodes_by_id[e.id]=e,e.onAdded&&e.onAdded(this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(e),this.setDirtyCanvas(!0),this.change(),e}},LGraph.prototype.remove=function(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);t!=-1&&this._groups.splice(t,1),e.graph=null,this._version++,this.setDirtyCanvas(!0,!0),this.change();return}if(this._nodes_by_id[e.id]!=null&&!e.ignore_remove){if(this.beforeChange(),e.inputs)for(var s=0;s<e.inputs.length;s++){var r=e.inputs[s];r.link!=null&&e.disconnectInput(s)}if(e.outputs)for(var s=0;s<e.outputs.length;s++){var r=e.outputs[s];r.links!=null&&r.links.length&&e.disconnectOutput(s)}if(e.onRemoved&&e.onRemoved(),e.graph=null,this._version++,this.list_of_graphcanvas)for(var s=0;s<this.list_of_graphcanvas.length;++s){var n=this.list_of_graphcanvas[s];n.selected_nodes[e.id]&&delete n.selected_nodes[e.id],n.node_dragged==e&&(n.node_dragged=null)}var u=this._nodes.indexOf(e);u!=-1&&this._nodes.splice(u,1),delete this._nodes_by_id[e.id],this.onNodeRemoved&&this.onNodeRemoved(e),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.afterChange(),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(e){return e==null?null:this._nodes_by_id[e]},LGraph.prototype.findNodesByClass=function(e,t){t=t||[],t.length=0;for(var s=0,r=this._nodes.length;s<r;++s)this._nodes[s].constructor===e&&t.push(this._nodes[s]);return t},LGraph.prototype.findNodesByType=function(s,t){var s=s.toLowerCase();t=t||[],t.length=0;for(var r=0,n=this._nodes.length;r<n;++r)this._nodes[r].type.toLowerCase()==s&&t.push(this._nodes[r]);return t},LGraph.prototype.findNodeByTitle=function(e){for(var t=0,s=this._nodes.length;t<s;++t)if(this._nodes[t].title==e)return this._nodes[t];return null},LGraph.prototype.findNodesByTitle=function(e){for(var t=[],s=0,r=this._nodes.length;s<r;++s)this._nodes[s].title==e&&t.push(this._nodes[s]);return t},LGraph.prototype.getNodeOnPos=function(e,t,s,r){s=s||this._nodes;for(var n=null,u=s.length-1;u>=0;u--){var o=s[u];if(o.isPointInside(e,t,r))return o}return n},LGraph.prototype.getGroupOnPos=function(e,t){for(var s=this._groups.length-1;s>=0;s--){var r=this._groups[s];if(r.isPointInside(e,t,2,!0))return r}return null},LGraph.prototype.checkNodeTypes=function(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],s=LiteGraph.registered_node_types[t.type];if(t.constructor!=s){console.log("node being replaced by newer version: "+t.type);var r=LiteGraph.createNode(t.type);this._nodes[e]=r,r.configure(t.serialize()),r.graph=this,this._nodes_by_id[r.id]=r,t.inputs&&(r.inputs=t.inputs.concat()),t.outputs&&(r.outputs=t.outputs.concat())}}this.updateExecutionOrder()},LGraph.prototype.onAction=function(e,t,s){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes);for(var r=0;r<this._input_nodes.length;++r){var n=this._input_nodes[r];if(n.properties.name==e){n.actionDo(e,t,s);break}}},LGraph.prototype.trigger=function(e,t){this.onTrigger&&this.onTrigger(e,t)},LGraph.prototype.addInput=function(e,t,s){var r=this.inputs[e];r||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:s},this._version++,this.afterChange(),this.onInputAdded&&this.onInputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange())},LGraph.prototype.setInputData=function(e,t){var s=this.inputs[e];s&&(s.value=t)},LGraph.prototype.getInputData=function(e){var t=this.inputs[e];return t?t.value:null},LGraph.prototype.renameInput=function(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return console.error("there is already one input with that name"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this._version++,this.onInputRenamed&&this.onInputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},LGraph.prototype.changeInputType=function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(e,t))},LGraph.prototype.removeInput=function(e){return this.inputs[e]?(delete this.inputs[e],this._version++,this.onInputRemoved&&this.onInputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.addOutput=function(e,t,s){this.outputs[e]={name:e,type:t,value:s},this._version++,this.onOutputAdded&&this.onOutputAdded(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.setOutputData=function(e,t){var s=this.outputs[e];s&&(s.value=t)},LGraph.prototype.getOutputData=function(e){var t=this.outputs[e];return t?t.value:null},LGraph.prototype.renameOutput=function(e,t){if(!this.outputs[e])return!1;if(this.outputs[t])return console.error("there is already one output with that name"),!1;this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.onOutputRenamed&&this.onOutputRenamed(e,t),this.onInputsOutputsChange&&this.onInputsOutputsChange()},LGraph.prototype.changeOutputType=function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(e,t))},LGraph.prototype.removeOutput=function(e){return this.outputs[e]?(delete this.outputs[e],this._version++,this.onOutputRemoved&&this.onOutputRemoved(e),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0):!1},LGraph.prototype.triggerInput=function(e,t){for(var s=this.findNodesByTitle(e),r=0;r<s.length;++r)s[r].onTrigger(t)},LGraph.prototype.setCallback=function(e,t){for(var s=this.findNodesByTitle(e),r=0;r<s.length;++r)s[r].setTrigger(t)},LGraph.prototype.beforeChange=function(e){this.onBeforeChange&&this.onBeforeChange(this,e),this.sendActionToCanvas("onBeforeChange",this)},LGraph.prototype.afterChange=function(e){this.onAfterChange&&this.onAfterChange(this,e),this.sendActionToCanvas("onAfterChange",this)},LGraph.prototype.connectionChange=function(e,t){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(e),this._version++,this.sendActionToCanvas("onConnectionChange")},LGraph.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){var t=this.list_of_graphcanvas[e];if(t.live_mode)return!0}return!1},LGraph.prototype.clearTriggeredSlots=function(){for(var e in this.links){var t=this.links[e];t&&t._last_time&&(t._last_time=0)}},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(e,t){this.sendActionToCanvas("setDirty",[e,t])},LGraph.prototype.removeLink=function(e){var t=this.links[e];if(t){var s=this.getNodeById(t.target_id);s&&s.disconnectInput(t.target_slot)}},LGraph.prototype.serialize=function(){for(var e=[],t=0,s=this._nodes.length;t<s;++t)e.push(this._nodes[t].serialize());var r=[];for(var t in this.links){var n=this.links[t];if(!n.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var u=new LLink;for(var o in n)u[o]=n[o];this.links[t]=u,n=u}r.push(n.serialize())}for(var a=[],t=0;t<this._groups.length;++t)a.push(this._groups[t].serialize());var l={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:r,groups:a,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.onSerialize&&this.onSerialize(l),l},LGraph.prototype.configure=function(e,t){if(e){t||this.clear();var s=e.nodes;if(e.links&&e.links.constructor===Array){for(var r=[],n=0;n<e.links.length;++n){var u=e.links[n];if(!u){console.warn("serialized graph link data contains errors, skipping.");continue}var o=new LLink;o.configure(u),r[o.id]=o}e.links=r}for(var n in e)n=="nodes"||n=="groups"||(this[n]=e[n]);var a=!1;if(this._nodes=[],s){for(var n=0,l=s.length;n<l;++n){var f=s[n],m=LiteGraph.createNode(f.type,f.title);m||(LiteGraph.debug&&console.log("Node not found or has errors: "+f.type),m=new LGraphNode,m.last_serialization=f,m.has_errors=!0,a=!0),m.id=f.id,this.add(m,!0)}for(var n=0,l=s.length;n<l;++n){var f=s[n],m=this.getNodeById(f.id);m&&m.configure(f)}}if(this._groups.length=0,e.groups)for(var n=0;n<e.groups.length;++n){var O=new LiteGraph.LGraphGroup;O.configure(e.groups[n]),this.add(O)}return this.updateExecutionOrder(),this.extra=e.extra||{},this.onConfigure&&this.onConfigure(e),this._version++,this.setDirtyCanvas(!0,!0),a}},LGraph.prototype.load=function(e,t){var s=this;if(e.constructor===File||e.constructor===Blob){var r=new FileReader;r.addEventListener("load",function(u){var o=JSON.parse(u.target.result);s.configure(o),t&&t()}),r.readAsText(e);return}var n=new XMLHttpRequest;n.open("GET",e,!0),n.send(null),n.onload=function(u){if(n.status!==200){console.error("Error loading graph:",n.status,n.response);return}var o=JSON.parse(n.response);s.configure(o),t&&t()},n.onerror=function(u){console.error("Error loading graph:",u)}},LGraph.prototype.onNodeTrace=function(e,t,s){};function LLink(e,t,s,r,n,u){this.id=e,this.type=t,this.origin_id=s,this.origin_slot=r,this.target_id=n,this.target_slot=u,this._data=null,this._pos=new Float32Array(2)}LLink.prototype.configure=function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)},LLink.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},LiteGraph.LLink=LLink;function LGraphNode(e){this._ctor(e)}global.LGraphNode=LiteGraph.LGraphNode=LGraphNode,LGraphNode.prototype._ctor=function(e){this.title=e||"Unnamed",this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),LiteGraph.use_uuids?this.id=LiteGraph.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},LGraphNode.prototype.configure=function(e){this.graph&&this.graph._version++;for(var t in e){if(t=="properties"){for(var s in e.properties)this.properties[s]=e.properties[s],this.onPropertyChanged&&this.onPropertyChanged(s,e.properties[s]);continue}e[t]!=null&&(typeof e[t]=="object"?this[t]&&this[t].configure?this[t].configure(e[t]):this[t]=LiteGraph.cloneObject(e[t],this[t]):this[t]=e[t])}if(e.title||(this.title=this.constructor.title),this.inputs)for(var r=0;r<this.inputs.length;++r){var n=this.inputs[r],u=this.graph?this.graph.links[n.link]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,r,!0,u,n),this.onInputAdded&&this.onInputAdded(n)}if(this.outputs)for(var r=0;r<this.outputs.length;++r){var o=this.outputs[r];if(o.links){for(var t=0;t<o.links.length;++t){var u=this.graph?this.graph.links[o.links[t]]:null;this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,r,!0,u,o)}this.onOutputAdded&&this.onOutputAdded(o)}}if(this.widgets){for(var r=0;r<this.widgets.length;++r){var a=this.widgets[r];a&&a.options&&a.options.property&&this.properties[a.options.property]!=null&&(a.value=JSON.parse(JSON.stringify(this.properties[a.options.property])))}if(e.widgets_values)for(var r=0;r<e.widgets_values.length;++r)this.widgets[r]&&(this.widgets[r].value=e.widgets_values[r])}this.onConfigure&&this.onConfigure(e)},LGraphNode.prototype.serialize=function(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;if(this.inputs&&(e.inputs=this.inputs),this.outputs){for(var t=0;t<this.outputs.length;t++)delete this.outputs[t]._data;e.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){e.widgets_values=[];for(var t=0;t<this.widgets.length;++t)this.widgets[t]?e.widgets_values[t]=this.widgets[t].value:e.widgets_values[t]=null}return e.type||(e.type=this.constructor.type),this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape),this.onSerialize&&this.onSerialize(e)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e},LGraphNode.prototype.clone=function(){var e=LiteGraph.createNode(this.type);if(!e)return null;var t=LiteGraph.cloneObject(this.serialize());if(t.inputs)for(var s=0;s<t.inputs.length;++s)t.inputs[s].link=null;if(t.outputs)for(var s=0;s<t.outputs.length;++s)t.outputs[s].links&&(t.outputs[s].links.length=0);return delete t.id,LiteGraph.use_uuids&&(t.id=LiteGraph.uuidv4()),e.configure(t),e},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.setProperty=function(e,t){if(this.properties||(this.properties={}),t!==this.properties[e]){var s=this.properties[e];if(this.properties[e]=t,this.onPropertyChanged&&this.onPropertyChanged(e,t,s)===!1&&(this.properties[e]=s),this.widgets)for(var r=0;r<this.widgets.length;++r){var n=this.widgets[r];if(n&&n.options.property==e){n.value=t;break}}}},LGraphNode.prototype.setOutputData=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var s=this.outputs[e];if(s&&(s._data=t,this.outputs[e].links))for(var r=0;r<this.outputs[e].links.length;r++){var n=this.outputs[e].links[r],u=this.graph.links[n];u&&(u.data=t)}}},LGraphNode.prototype.setOutputDataType=function(e,t){if(this.outputs&&!(e==-1||e>=this.outputs.length)){var s=this.outputs[e];if(s&&(s.type=t,this.outputs[e].links))for(var r=0;r<this.outputs[e].links.length;r++){var n=this.outputs[e].links[r];this.graph.links[n].type=t}}},LGraphNode.prototype.getInputData=function(e,t){if(this.inputs&&!(e>=this.inputs.length||this.inputs[e].link==null)){var s=this.inputs[e].link,r=this.graph.links[s];if(!r)return null;if(!t)return r.data;var n=this.graph.getNodeById(r.origin_id);return n&&(n.updateOutputData?n.updateOutputData(r.origin_slot):n.onExecute&&n.onExecute()),r.data}},LGraphNode.prototype.getInputDataType=function(e){if(!this.inputs||e>=this.inputs.length||this.inputs[e].link==null)return null;var t=this.inputs[e].link,s=this.graph.links[t];if(!s)return null;var r=this.graph.getNodeById(s.origin_id);if(!r)return s.type;var n=r.outputs[s.origin_slot];return n?n.type:null},LGraphNode.prototype.getInputDataByName=function(e,t){var s=this.findInputSlot(e);return s==-1?null:this.getInputData(s,t)},LGraphNode.prototype.isInputConnected=function(e){return this.inputs?e<this.inputs.length&&this.inputs[e].link!=null:!1},LGraphNode.prototype.getInputInfo=function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null},LGraphNode.prototype.getInputLink=function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null},LGraphNode.prototype.getInputNode=function(e){if(!this.inputs||e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||t.link===null)return null;var s=this.graph.links[t.link];return s?this.graph.getNodeById(s.origin_id):null},LGraphNode.prototype.getInputOrProperty=function(e){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[e]:null;for(var t=0,s=this.inputs.length;t<s;++t){var r=this.inputs[t];if(e==r.name&&r.link!=null){var n=this.graph.links[r.link];if(n)return n.data}}return this.properties[e]},LGraphNode.prototype.getOutputData=function(e){if(!this.outputs||e>=this.outputs.length)return null;var t=this.outputs[e];return t._data},LGraphNode.prototype.getOutputInfo=function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null},LGraphNode.prototype.isOutputConnected=function(e){return this.outputs?e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length:!1},LGraphNode.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var e=0;e<this.outputs.length;++e)if(this.outputs[e].links&&this.outputs[e].links.length)return!0;return!1},LGraphNode.prototype.getOutputNodes=function(e){if(!this.outputs||this.outputs.length==0||e>=this.outputs.length)return null;var t=this.outputs[e];if(!t.links||t.links.length==0)return null;for(var s=[],r=0;r<t.links.length;r++){var n=t.links[r],u=this.graph.links[n];if(u){var o=this.graph.getNodeById(u.target_id);o&&s.push(o)}}return s},LGraphNode.prototype.addOnTriggerInput=function(){var e=this.findInputSlot("onTrigger");if(e==-1){return this.addInput("onTrigger",LiteGraph.EVENT,{optional:!0,nameLocked:!0}),this.findInputSlot("onTrigger")}return e},LGraphNode.prototype.addOnExecutedOutput=function(){var e=this.findOutputSlot("onExecuted");if(e==-1){return this.addOutput("onExecuted",LiteGraph.ACTION,{optional:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")}return e},LGraphNode.prototype.onAfterExecuteNode=function(e,t){var s=this.findOutputSlot("onExecuted");s!=-1&&this.triggerSlot(s,e,null,t)},LGraphNode.prototype.changeMode=function(e){switch(e){case LiteGraph.ON_EVENT:break;case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.NEVER:break;case LiteGraph.ALWAYS:break;case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0},LGraphNode.prototype.executePendingActions=function(){if(!(!this._waiting_actions||!this._waiting_actions.length)){for(var e=0;e<this._waiting_actions.length;++e){var t=this._waiting_actions[e];this.onAction(t[0],t[1],t[2],t[3],t[4])}this._waiting_actions.length=0}},LGraphNode.prototype.doExecute=function(e,t){t=t||{},this.onExecute&&(t.action_call||(t.action_call=this.id+"_exec_"+Math.floor(Math.random()*9999)),this.graph.nodes_executing[this.id]=!0,this.onExecute(e,t),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,t&&t.action_call&&(this.action_call=t.action_call,this.graph.nodes_executedAction[this.id]=t.action_call)),this.execute_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(e,t)},LGraphNode.prototype.actionDo=function(e,t,s,r){s=s||{},this.onAction&&(s.action_call||(s.action_call=this.id+"_"+(e||"action")+"_"+Math.floor(Math.random()*9999)),this.graph.nodes_actioning[this.id]=e||"actioning",this.onAction(e,t,s,r),this.graph.nodes_actioning[this.id]=!1,s&&s.action_call&&(this.action_call=s.action_call,this.graph.nodes_executedAction[this.id]=s.action_call)),this.action_triggered=2,this.onAfterExecuteNode&&this.onAfterExecuteNode(t,s)},LGraphNode.prototype.trigger=function(e,t,s){if(!(!this.outputs||!this.outputs.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var r=0;r<this.outputs.length;++r){var n=this.outputs[r];!n||n.type!==LiteGraph.EVENT||e&&n.name!=e||this.triggerSlot(r,t,null,s)}}},LGraphNode.prototype.triggerSlot=function(e,t,s,r){if(r=r||{},!!this.outputs){if(e==null){console.error("slot must be a number");return}e.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");var n=this.outputs[e];if(n){var u=n.links;if(!(!u||!u.length)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var o=0;o<u.length;++o){var a=u[o];if(!(s!=null&&s!=a)){var l=this.graph.links[u[o]];if(l){l._last_time=LiteGraph.getTime();var f=this.graph.getNodeById(l.target_id);if(f){var m=f.inputs[l.target_slot];if(f.mode===LiteGraph.ON_TRIGGER)r.action_call||(r.action_call=this.id+"_trigg_"+Math.floor(Math.random()*9999)),f.onExecute&&f.doExecute(t,r);else if(f.onAction){r.action_call||(r.action_call=this.id+"_act_"+Math.floor(Math.random()*9999));var m=f.inputs[l.target_slot];LiteGraph.use_deferred_actions&&f.onExecute?(f._waiting_actions||(f._waiting_actions=[]),f._waiting_actions.push([m.name,t,r,l.target_slot])):f.actionDo(m.name,t,r,l.target_slot)}}}}}}}}},LGraphNode.prototype.clearTriggeredSlot=function(e,t){if(this.outputs){var s=this.outputs[e];if(s){var r=s.links;if(!(!r||!r.length))for(var n=0;n<r.length;++n){var u=r[n];if(!(t!=null&&t!=u)){var o=this.graph.links[r[n]];o&&(o._last_time=0)}}}}},LGraphNode.prototype.setSize=function(e){this.size=e,this.onResize&&this.onResize(this.size)},LGraphNode.prototype.addProperty=function(e,t,s,r){var n={name:e,type:s,default_value:t};if(r)for(var u in r)n[u]=r[u];return this.properties_info||(this.properties_info=[]),this.properties_info.push(n),this.properties||(this.properties={}),this.properties[e]=t,n},LGraphNode.prototype.addOutput=function(e,t,s){var r={name:e,type:t,links:null};if(s)for(var n in s)r[n]=s[n];return this.outputs||(this.outputs=[]),this.outputs.push(r),this.onOutputAdded&&this.onOutputAdded(r),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),r},LGraphNode.prototype.addOutputs=function(e){for(var t=0;t<e.length;++t){var s=e[t],r={name:s[0],type:s[1],link:null};if(e[2])for(var n in s[2])r[n]=s[2][n];this.outputs||(this.outputs=[]),this.outputs.push(r),this.onOutputAdded&&this.onOutputAdded(r),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,s[1],!0)}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeOutput=function(e){this.disconnectOutput(e),this.outputs.splice(e,1);for(var t=e;t<this.outputs.length;++t)if(!(!this.outputs[t]||!this.outputs[t].links))for(var s=this.outputs[t].links,r=0;r<s.length;++r){var n=this.graph.links[s[r]];n&&(n.origin_slot-=1)}this.setSize(this.computeSize()),this.onOutputRemoved&&this.onOutputRemoved(e),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addInput=function(e,t,s){t=t||0;var r={name:e,type:t,link:null};if(s)for(var n in s)r[n]=s[n];return this.inputs||(this.inputs=[]),this.inputs.push(r),this.setSize(this.computeSize()),this.onInputAdded&&this.onInputAdded(r),LiteGraph.registerNodeAndSlotType(this,t),this.setDirtyCanvas(!0,!0),r},LGraphNode.prototype.addInputs=function(e){for(var t=0;t<e.length;++t){var s=e[t],r={name:s[0],type:s[1],link:null};if(e[2])for(var n in s[2])r[n]=s[2][n];this.inputs||(this.inputs=[]),this.inputs.push(r),this.onInputAdded&&this.onInputAdded(r),LiteGraph.registerNodeAndSlotType(this,s[1])}this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.removeInput=function(e){this.disconnectInput(e);for(var t=this.inputs.splice(e,1),s=e;s<this.inputs.length;++s)if(this.inputs[s]){var r=this.graph.links[this.inputs[s].link];r&&(r.target_slot-=1)}this.setSize(this.computeSize()),this.onInputRemoved&&this.onInputRemoved(e,t[0]),this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.addConnection=function(e,t,s,r){var n={name:e,type:t,pos:s,direction:r,links:null};return this.connections.push(n),n},LGraphNode.prototype.computeSize=function(e){if(this.constructor.size)return this.constructor.size.concat();var t=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),s=e||new Float32Array([0,0]);t=Math.max(t,1);var r=LiteGraph.NODE_TEXT_SIZE,n=E(this.title),u=0,o=0;if(this.inputs)for(var a=0,l=this.inputs.length;a<l;++a){var f=this.inputs[a],m=f.label||f.name||"",O=E(m);u<O&&(u=O)}if(this.outputs)for(var a=0,l=this.outputs.length;a<l;++a){var d=this.outputs[a],m=d.label||d.name||"",O=E(m);o<O&&(o=O)}s[0]=Math.max(u+o+10,n),s[0]=Math.max(s[0],LiteGraph.NODE_WIDTH),this.widgets&&this.widgets.length&&(s[0]=Math.max(s[0],LiteGraph.NODE_WIDTH*1.5)),s[1]=(this.constructor.slot_start_y||0)+t*LiteGraph.NODE_SLOT_HEIGHT;var g=0;if(this.widgets&&this.widgets.length){for(var a=0,l=this.widgets.length;a<l;++a)this.widgets[a].computeSize?g+=this.widgets[a].computeSize(s[0])[1]+4:g+=LiteGraph.NODE_WIDGET_HEIGHT+4;g+=8}this.widgets_up?s[1]=Math.max(s[1],g):this.widgets_start_y!=null?s[1]=Math.max(s[1],g+this.widgets_start_y):s[1]+=g;function E(I){return I?r*I.length*.6:0}return this.constructor.min_height&&s[1]<this.constructor.min_height&&(s[1]=this.constructor.min_height),s[1]+=6,s},LGraphNode.prototype.getPropertyInfo=function(e){var t=null;if(this.properties_info){for(var s=0;s<this.properties_info.length;++s)if(this.properties_info[s].name==e){t=this.properties_info[s];break}}return this.constructor["@"+e]&&(t=this.constructor["@"+e]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t&&this.onGetPropertyInfo&&(t=this.onGetPropertyInfo(e)),t||(t={}),t.type||(t.type=typeof this.properties[e]),t.widget=="combo"&&(t.type="enum"),t},LGraphNode.prototype.addWidget=function(e,t,s,r,n){this.widgets||(this.widgets=[]),!n&&r&&r.constructor===Object&&(n=r,r=null),n&&n.constructor===String&&(n={property:n}),r&&r.constructor===String&&(n||(n={}),n.property=r,r=null),r&&r.constructor!==Function&&(console.warn("addWidget: callback must be a function"),r=null);var u={type:e.toLowerCase(),name:t,value:s,callback:r,options:n||{}};if(u.options.y!==void 0&&(u.y=u.options.y),!r&&!u.options.callback&&!u.options.property&&console.warn("LiteGraph addWidget(...) without a callback or property assigned"),e=="combo"&&!u.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(u),this.setSize(this.computeSize()),u},LGraphNode.prototype.addCustomWidget=function(e){return this.widgets||(this.widgets=[]),this.widgets.push(e),e},LGraphNode.prototype.getBounding=function(e,t){e=e||new Float32Array(4);const s=this.pos,r=this.flags.collapsed,n=this.size;let u=0,o=1,a=0,l=0;return t&&(u=4,o=6+u,a=4,l=5+a),e[0]=s[0]-u,e[1]=s[1]-LiteGraph.NODE_TITLE_HEIGHT-a,e[2]=r?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+o:n[0]+o,e[3]=r?LiteGraph.NODE_TITLE_HEIGHT+l:n[1]+LiteGraph.NODE_TITLE_HEIGHT+l,this.onBounding&&this.onBounding(e),e},LGraphNode.prototype.isPointInside=function(e,t,s,r){s=s||0;var n=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(r&&(n=0),this.flags&&this.flags.collapsed){if(isInsideRectangle(e,t,this.pos[0]-s,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-s,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*s,LiteGraph.NODE_TITLE_HEIGHT+2*s))return!0}else if(this.pos[0]-4-s<e&&this.pos[0]+this.size[0]+4+s>e&&this.pos[1]-n-s<t&&this.pos[1]+this.size[1]+s>t)return!0;return!1},LGraphNode.prototype.getSlotInPosition=function(e,t){var s=new Float32Array(2);if(this.inputs)for(var r=0,n=this.inputs.length;r<n;++r){var u=this.inputs[r];if(this.getConnectionPos(!0,r,s),isInsideRectangle(e,t,s[0]-10,s[1]-5,20,10))return{input:u,slot:r,link_pos:s}}if(this.outputs)for(var r=0,n=this.outputs.length;r<n;++r){var o=this.outputs[r];if(this.getConnectionPos(!1,r,s),isInsideRectangle(e,t,s[0]-10,s[1]-5,20,10))return{output:o,slot:r,link_pos:s}}return null},LGraphNode.prototype.findInputSlot=function(e,t){if(!this.inputs)return-1;for(var s=0,r=this.inputs.length;s<r;++s)if(e==this.inputs[s].name)return t?this.inputs[s]:s;return-1},LGraphNode.prototype.findOutputSlot=function(e,t){if(t=t||!1,!this.outputs)return-1;for(var s=0,r=this.outputs.length;s<r;++s)if(e==this.outputs[s].name)return t?this.outputs[s]:s;return-1},LGraphNode.prototype.findInputSlotFree=function(t){var t=t||{},s={returnObj:!1,typesNotAccepted:[]},r=Object.assign(s,t);if(!this.inputs)return-1;for(var n=0,u=this.inputs.length;n<u;++n)if(!(this.inputs[n].link&&this.inputs[n].link!=null)&&!(r.typesNotAccepted&&r.typesNotAccepted.includes&&r.typesNotAccepted.includes(this.inputs[n].type)))return r.returnObj?this.inputs[n]:n;return-1},LGraphNode.prototype.findOutputSlotFree=function(t){var t=t||{},s={returnObj:!1,typesNotAccepted:[]},r=Object.assign(s,t);if(!this.outputs)return-1;for(var n=0,u=this.outputs.length;n<u;++n)if(!(this.outputs[n].links&&this.outputs[n].links!=null)&&!(r.typesNotAccepted&&r.typesNotAccepted.includes&&r.typesNotAccepted.includes(this.outputs[n].type)))return r.returnObj?this.outputs[n]:n;return-1},LGraphNode.prototype.findInputSlotByType=function(e,t,s,r){return this.findSlotByType(!0,e,t,s,r)},LGraphNode.prototype.findOutputSlotByType=function(e,t,s,r){return this.findSlotByType(!1,e,t,s,r)},LGraphNode.prototype.findSlotByType=function(e,t,s,r,n){e=e||!1,s=s||!1,r=r||!1,n=n||!1;var u=e?this.inputs:this.outputs;if(!u)return-1;(t==""||t=="*")&&(t=0);for(var o=0,a=u.length;o<a;++o){var l=(t+"").toLowerCase().split(","),f=u[o].type=="0"||u[o].type=="*"?"0":u[o].type;f=(f+"").toLowerCase().split(",");for(var m=0;m<l.length;m++)for(var O=0;O<f.length;O++)if(l[m]=="_event_"&&(l[m]=LiteGraph.EVENT),f[m]=="_event_"&&(f[m]=LiteGraph.EVENT),l[m]=="*"&&(l[m]=0),f[m]=="*"&&(f[m]=0),l[m]==f[O]){if(r&&u[o].links&&u[o].links!==null)continue;return s?u[o]:o}}if(r&&!n)for(var o=0,a=u.length;o<a;++o){var l=(t+"").toLowerCase().split(","),f=u[o].type=="0"||u[o].type=="*"?"0":u[o].type;f=(f+"").toLowerCase().split(",");for(var m=0;m<l.length;m++)for(var O=0;O<f.length;O++)if(l[m]=="*"&&(l[m]=0),f[m]=="*"&&(f[m]=0),l[m]==f[O])return s?u[o]:o}return-1},LGraphNode.prototype.connectByType=function(e,t,s,n){var n=n||{},u={createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(u,n);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var a=t.findInputSlotByType(s,!1,!0);if(a>=0&&a!==null)return this.connect(e,t,a);if(o.createEventInCase&&s==LiteGraph.EVENT)return this.connect(e,t,-1);if(o.generalTypeInCase){var a=t.findInputSlotByType(0,!1,!0,!0);if(a>=0)return this.connect(e,t,a)}if(o.firstFreeIfOutputGeneralInCase&&(s==0||s=="*"||s=="")){var a=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(a>=0)return this.connect(e,t,a)}return console.debug("no way to connect type: ",s," to targetNODE ",t),null},LGraphNode.prototype.connectByTypeOutput=function(e,t,s,n){var n=n||{},u={createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},o=Object.assign(u,n);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var a=t.findOutputSlotByType(s,!1,!0);if(a>=0&&a!==null)return t.connect(a,this,e);if(o.generalTypeInCase){var a=t.findOutputSlotByType(0,!1,!0,!0);if(a>=0)return t.connect(a,this,e)}if(o.createEventInCase&&s==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots){var a=t.addOnExecutedOutput();return t.connect(a,this,e)}if(o.firstFreeIfInputGeneralInCase&&(s==0||s=="*"||s=="")){var a=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]});if(a>=0)return t.connect(a,this,e)}return console.debug("no way to connect byOUT type: ",s," to sourceNODE ",t),null},LGraphNode.prototype.connect=function(e,t,s){if(s=s||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),null}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;if(t&&t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"target node is null";if(t==this)return null;if(s.constructor===String){if(s=t.findInputSlot(s),s==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+s),null}else if(s===LiteGraph.EVENT)if(LiteGraph.do_add_triggers_slots)t.changeMode(LiteGraph.ON_TRIGGER),s=t.findInputSlot("onTrigger");else return null;else if(!t.inputs||s>=t.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),null;var r=!1,n=t.inputs[s],u=null,o=this.outputs[e];if(!this.outputs[e])return null;if(t.onBeforeConnectInput&&(s=t.onBeforeConnectInput(s)),s===!1||s===null||!LiteGraph.isValidConnection(o.type,n.type))return this.setDirtyCanvas(!1,!0),r&&this.graph.connectionChange(this,u),null;if(t.onConnectInput&&t.onConnectInput(s,o.type,o,this,e)===!1||this.onConnectOutput&&this.onConnectOutput(e,n.type,n,t,s)===!1)return null;t.inputs[s]&&t.inputs[s].link!=null&&(this.graph.beforeChange(),t.disconnectInput(s,{doProcessChange:!1}),r=!0),o.links!==null&&o.links.length&&o.type===LiteGraph.EVENT&&(LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),r=!0));var a;return LiteGraph.use_uuids?a=LiteGraph.uuidv4():a=++this.graph.last_link_id,u=new LLink(a,n.type||o.type,this.id,e,t.id,s),this.graph.links[u.id]=u,o.links==null&&(o.links=[]),o.links.push(u.id),t.inputs[s].link=u.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!0,u,o),t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,s,!0,u,n),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,s,this,e),this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e,t,s)),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,u),u},LGraphNode.prototype.disconnectOutput=function(e,t){if(e.constructor===String){if(e=this.findOutputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.outputs||e>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var s=this.outputs[e];if(!s||!s.links||s.links.length==0)return!1;if(t){if(t.constructor===Number&&(t=this.graph.getNodeById(t)),!t)throw"Target Node not found";for(var r=0,n=s.links.length;r<n;r++){var u=s.links[r],o=this.graph.links[u];if(o.target_id==t.id){s.links.splice(r,1);var a=t.inputs[o.target_slot];a.link=null,delete this.graph.links[u],this.graph&&this.graph._version++,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,a),this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,s),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot));break}}}else{for(var r=0,n=s.links.length;r<n;r++){var u=s.links[r],o=this.graph.links[u];if(o){var t=this.graph.getNodeById(o.target_id),a=null;this.graph&&this.graph._version++,t&&(a=t.inputs[o.target_slot],a.link=null,t.onConnectionsChange&&t.onConnectionsChange(LiteGraph.INPUT,o.target_slot,!1,o,a),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot)),delete this.graph.links[u],this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.OUTPUT,e,!1,o,s),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,this,e),this.graph.onNodeConnectionChange(LiteGraph.INPUT,t,o.target_slot))}}s.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},LGraphNode.prototype.disconnectInput=function(e){if(e.constructor===String){if(e=this.findInputSlot(e),e==-1)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+e),!1}else if(!this.inputs||e>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var t=this.inputs[e];if(!t)return!1;var s=this.inputs[e].link;if(s!=null){this.inputs[e].link=null;var r=this.graph.links[s];if(r){var n=this.graph.getNodeById(r.origin_id);if(!n)return!1;var u=n.outputs[r.origin_slot];if(!u||!u.links||u.links.length==0)return!1;for(var o=0,a=u.links.length;o<a;o++)if(u.links[o]==s){u.links.splice(o,1);break}delete this.graph.links[s],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(LiteGraph.INPUT,e,!1,r,t),n.onConnectionsChange&&n.onConnectionsChange(LiteGraph.OUTPUT,o,!1,r,u),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(LiteGraph.OUTPUT,n,o),this.graph.onNodeConnectionChange(LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0},LGraphNode.prototype.getConnectionPos=function(e,t,s){s=s||new Float32Array(2);var r=0;e&&this.inputs&&(r=this.inputs.length),!e&&this.outputs&&(r=this.outputs.length);var n=LiteGraph.NODE_SLOT_HEIGHT*.5;if(this.flags.collapsed){var u=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(s[0]=this.pos[0]+u*.5,e?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]):(e?s[0]=this.pos[0]:s[0]=this.pos[0]+u,s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT*.5),s}return e&&t==-1?(s[0]=this.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*.5,s[1]=this.pos[1]+LiteGraph.NODE_TITLE_HEIGHT*.5,s):e&&r>t&&this.inputs[t].pos?(s[0]=this.pos[0]+this.inputs[t].pos[0],s[1]=this.pos[1]+this.inputs[t].pos[1],s):!e&&r>t&&this.outputs[t].pos?(s[0]=this.pos[0]+this.outputs[t].pos[0],s[1]=this.pos[1]+this.outputs[t].pos[1],s):this.horizontal?(s[0]=this.pos[0]+(t+.5)*(this.size[0]/r),e?s[1]=this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:s[1]=this.pos[1]+this.size[1],s):(e?s[0]=this.pos[0]+n:s[0]=this.pos[0]+this.size[0]+1-n,s[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),s)},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(e){this.console||(this.console=[]),this.console.push(e),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,e)},LGraphNode.prototype.setDirtyCanvas=function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])},LGraphNode.prototype.loadImage=function(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var s=this;return t.onload=function(){this.ready=!0,s.setDirtyCanvas(!0)},t},LGraphNode.prototype.captureInput=function(e){if(!(!this.graph||!this.graph.list_of_graphcanvas))for(var t=this.graph.list_of_graphcanvas,s=0;s<t.length;++s){var r=t[s];!e&&r.node_capturing_input!=this||(r.node_capturing_input=e?this:null)}},LGraphNode.prototype.collapse=function(e){this.graph._version++,!(this.constructor.collapsable===!1&&!e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},LGraphNode.prototype.pin=function(e){this.graph._version++,e===void 0?this.flags.pinned=!this.flags.pinned:this.flags.pinned=e},LGraphNode.prototype.localToScreen=function(e,t,s){return[(e+this.pos[0])*s.scale+s.offset[0],(t+this.pos[1])*s.scale+s.offset[1]]};function LGraphGroup(e){this._ctor(e)}global.LGraphGroup=LiteGraph.LGraphGroup=LGraphGroup,LGraphGroup.prototype._ctor=function(e){this.title=e||"Group",this.font_size=24,this.color=LGraphCanvas.node_colors.pale_blue?LGraphCanvas.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},LGraphGroup.prototype.configure=function(e){this.title=e.title,this._bounding.set(e.bounding),this.color=e.color,this.font_size=e.font_size},LGraphGroup.prototype.serialize=function(){var e=this._bounding;return{title:this.title,bounding:[Math.round(e[0]),Math.round(e[1]),Math.round(e[2]),Math.round(e[3])],color:this.color,font_size:this.font_size}},LGraphGroup.prototype.move=function(e,t,s){if(this._pos[0]+=e,this._pos[1]+=t,!s)for(var r=0;r<this._nodes.length;++r){var n=this._nodes[r];n.pos[0]+=e,n.pos[1]+=t}},LGraphGroup.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var e=this.graph._nodes,t=new Float32Array(4),s=0;s<e.length;++s){var r=e[s];r.getBounding(t),overlapBounding(this._bounding,t)&&this._nodes.push(r)}},LGraphGroup.prototype.isPointInside=LGraphNode.prototype.isPointInside,LGraphGroup.prototype.setDirtyCanvas=LGraphNode.prototype.setDirtyCanvas;function DragAndScale(e,t){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,t||this.bindEvents(e))}LiteGraph.DragAndScale=DragAndScale,DragAndScale.prototype.bindEvents=function(e){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(e,"up",this._binded_mouse_callback),e.addEventListener("mousewheel",this._binded_mouse_callback,!1),e.addEventListener("wheel",this._binded_mouse_callback,!1)},DragAndScale.prototype.computeVisibleArea=function(e){if(!this.element){this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0;return}var t=this.element.width,s=this.element.height,r=-this.offset[0],n=-this.offset[1];e&&(r+=e[0]/this.scale,n+=e[1]/this.scale,t=e[2],s=e[3]);var u=r+t/this.scale,o=n+s/this.scale;this.visible_area[0]=r,this.visible_area[1]=n,this.visible_area[2]=u-r,this.visible_area[3]=o-n},DragAndScale.prototype.onMouse=function(e){if(this.enabled){var t=this.element,s=t.getBoundingClientRect(),r=e.clientX-s.left,n=e.clientY-s.top;e.canvasx=r,e.canvasy=n,e.dragging=this.dragging;var u=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3],o=!1;if(this.onmouse&&(o=this.onmouse(e)),e.type==LiteGraph.pointerevents_method+"down"&&u)this.dragging=!0,LiteGraph.pointerListenerRemove(t,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(document,"up",this._binded_mouse_callback);else if(e.type==LiteGraph.pointerevents_method+"move"){if(!o){var a=r-this.last_mouse[0],l=n-this.last_mouse[1];this.dragging&&this.mouseDrag(a,l)}}else e.type==LiteGraph.pointerevents_method+"up"?(this.dragging=!1,LiteGraph.pointerListenerRemove(document,"move",this._binded_mouse_callback),LiteGraph.pointerListenerRemove(document,"up",this._binded_mouse_callback),LiteGraph.pointerListenerAdd(t,"move",this._binded_mouse_callback)):u&&(e.type=="mousewheel"||e.type=="wheel"||e.type=="DOMMouseScroll")&&(e.eventType="mousewheel",e.type=="wheel"?e.wheel=-e.deltaY:e.wheel=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+e.delta*.05));if(this.last_mouse[0]=r,this.last_mouse[1]=n,u)return e.preventDefault(),e.stopPropagation(),!1}},DragAndScale.prototype.toCanvasContext=function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])},DragAndScale.prototype.convertOffsetToCanvas=function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]},DragAndScale.prototype.convertCanvasToOffset=function(e,t){return t=t||[0,0],t[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t},DragAndScale.prototype.mouseDrag=function(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw&&this.onredraw(this)},DragAndScale.prototype.changeScale=function(e,t){if(e<this.min_scale?e=this.min_scale:e>this.max_scale&&(e=this.max_scale),e!=this.scale&&this.element){var s=this.element.getBoundingClientRect();if(s){t=t||[s.width*.5,s.height*.5];var r=this.convertCanvasToOffset(t);this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var n=this.convertCanvasToOffset(t),u=[n[0]-r[0],n[1]-r[1]];this.offset[0]+=u[0],this.offset[1]+=u[1],this.onredraw&&this.onredraw(this)}}},DragAndScale.prototype.changeDeltaScale=function(e,t){this.changeScale(this.scale*e,t)},DragAndScale.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0};function LGraphCanvas(e,t,s){this.options=s=s||{},this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=""+LiteGraph.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+LiteGraph.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.allow_reconnect_links=!0,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=s.viewport||null,t&&t.attachCanvas(this),this.setCanvas(e,s.skip_events),this.clear(),s.skip_render||this.startRendering(),this.autoresize=s.autoresize}global.LGraphCanvas=LiteGraph.LGraphCanvas=LGraphCanvas,LGraphCanvas.DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",LGraphCanvas.link_type_colors={"-1":LiteGraph.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},LGraphCanvas.gradients={},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(e,t){if(this.graph!=e){if(t||this.clear(),!e&&this.graph){this.graph.detachCanvas(this);return}e.attachCanvas(this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)}},LGraphCanvas.prototype.getTopGraph=function(){return this._graph_stack.length?this._graph_stack[0]:this.graph},LGraphCanvas.prototype.openSubgraph=function(e){if(!e)throw"graph cannot be null";if(this.graph==e)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(!(!this._graph_stack||this._graph_stack.length==0)){var e=this.graph._subgraph_node,t=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},t.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}},LGraphCanvas.prototype.getCurrentGraph=function(){return this.graph},LGraphCanvas.prototype.setCanvas=function(e,t){if(e&&e.constructor===String&&(e=document.getElementById(e),!e))throw"Error creating LiteGraph canvas: Canvas not found";if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,!!e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),e.getContext==null)throw e.localName!="canvas"?"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName:"This browser doesn't support Canvas";var s=this.ctx=e.getContext("2d");s==null&&(e.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}},LGraphCanvas.prototype._doNothing=function(t){return t.preventDefault(),!1},LGraphCanvas.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},LGraphCanvas.prototype.bindEvents=function(){if(this._events_binded){console.warn("LGraphCanvas: events already binded");return}var e=this.canvas,t=this.getCanvasWindow(),s=t.document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),LiteGraph.pointerListenerAdd(e,"down",this._mousedown_callback,!0),e.addEventListener("mousewheel",this._mousewheel_callback,!1),LiteGraph.pointerListenerAdd(e,"up",this._mouseup_callback,!0),LiteGraph.pointerListenerAdd(e,"move",this._mousemove_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this._key_callback=this.processKey.bind(this),e.setAttribute("tabindex",1),e.addEventListener("keydown",this._key_callback,!0),s.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this._ondrop_callback,!1),e.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0},LGraphCanvas.prototype.unbindEvents=function(){if(!this._events_binded){console.warn("LGraphCanvas: no events binded");return}var e=this.getCanvasWindow(),t=e.document;LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"up",this._mousedown_callback),LiteGraph.pointerListenerRemove(this.canvas,"down",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1},LGraphCanvas.getFileExtension=function(e){var t=e.indexOf("?");t!=-1&&(e=e.substr(0,t));var s=e.lastIndexOf(".");return s==-1?"":e.substr(s+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if(typeof GL>"u")throw"litegl.js must be included to use a WebGL canvas";if(typeof enableWebGLCanvas>"u")throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},LGraphCanvas.prototype.setDirty=function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var e=this.canvas.ownerDocument;return e.defaultView||e.parentWindow},LGraphCanvas.prototype.startRendering=function(){if(this.is_rendering)return;this.is_rendering=!0,e.call(this);function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.blockClick=function(){this.block_click=!0,this.last_mouseclick=0},LGraphCanvas.prototype.processMouseDown=function(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){this.adjustMouseEvent(e);var t=this.getCanvasWindow();t.document,LGraphCanvas.active_canvas=this;var s=this,r=e.clientX,n=e.clientY;this.ds.viewport=this.viewport;var u=!this.viewport||this.viewport&&r>=this.viewport[0]&&r<this.viewport[0]+this.viewport[2]&&n>=this.viewport[1]&&n<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(LiteGraph.pointerListenerRemove(this.canvas,"move",this._mousemove_callback),LiteGraph.pointerListenerAdd(t.document,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(t.document,"up",this._mouseup_callback,!0)),!!u){var o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),a=!1,l=LiteGraph.getTime(),f=e.isPrimary===void 0||!e.isPrimary,m=l-this.last_mouseclick<300&&f;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&f?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.closeAllContextMenus(t),!(this.onMouse&&this.onMouse(e)==!0)){if(e.which==1&&!this.pointer_is_double){e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,a=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&o&&this.allow_interaction&&!a&&!this.read_only&&(cloned=o.clone())&&(cloned.pos[0]+=5,cloned.pos[1]+=5,this.graph.add(cloned,!1,{doCalcSize:!1}),o=cloned,a=!0,T||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,e)));var O=!1;if(o&&(this.allow_interaction||o.flags.allow_interaction)&&!a&&!this.read_only){if(!this.live_mode&&!o.flags.pinned&&this.bringToFront(o),this.allow_interaction&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!a&&o.resizable!==!1&&isInsideRectangle(e.canvasX,e.canvasY,o.pos[0]+o.size[0]-5,o.pos[1]+o.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",a=!0;else{if(o.outputs)for(var d=0,g=o.outputs.length;d<g;++d){var E=o.outputs[d],I=o.getConnectionPos(!1,d);if(isInsideRectangle(e.canvasX,e.canvasY,I[0]-15,I[1]-10,30,20)){this.connecting_node=o,this.connecting_output=E,this.connecting_output.slot_index=d,this.connecting_pos=o.getConnectionPos(!1,d),this.connecting_slot=d,LiteGraph.shift_click_do_break_link_from&&e.shiftKey&&o.disconnectOutput(d),m?o.onOutputDblClick&&o.onOutputDblClick(d,e):o.onOutputClick&&o.onOutputClick(d,e),a=!0;break}}if(o.inputs)for(var d=0,g=o.inputs.length;d<g;++d){var k=o.inputs[d],I=o.getConnectionPos(!0,d);if(isInsideRectangle(e.canvasX,e.canvasY,I[0]-15,I[1]-10,30,20)){if(m?o.onInputDblClick&&o.onInputDblClick(d,e):o.onInputClick&&o.onInputClick(d,e),k.link!==null){var N=this.graph.links[k.link];LiteGraph.click_do_break_link_to&&(o.disconnectInput(d),this.dirty_bgcanvas=!0,a=!0),(this.allow_reconnect_links||e.shiftKey)&&(LiteGraph.click_do_break_link_to||o.disconnectInput(d),this.connecting_node=this.graph._nodes_by_id[N.origin_id],this.connecting_slot=N.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),this.dirty_bgcanvas=!0,a=!0)}a||(this.connecting_node=o,this.connecting_input=k,this.connecting_input.slot_index=d,this.connecting_pos=o.getConnectionPos(!0,d),this.connecting_slot=d,this.dirty_bgcanvas=!0,a=!0)}}}if(!a){var T=!1,h=[e.canvasX-o.pos[0],e.canvasY-o.pos[1]],L=this.processNodeWidgets(o,this.graph_mouse,e);if(L&&(T=!0,this.node_widget=[o,L]),this.allow_interaction&&m&&this.selected_nodes[o.id]&&(o.onDblClick&&o.onDblClick(e,h,this),this.processNodeDblClicked(o),T=!0),o.onMouseDown&&o.onMouseDown(e,h,this))T=!0;else{if(o.subgraph&&!o.skip_subgraph_button&&!o.flags.collapsed&&h[0]>o.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&h[1]<0){var s=this;setTimeout(function(){s.openSubgraph(o.subgraph)},10)}this.live_mode&&(O=!0,T=!0)}T?o.is_selected||this.processNodeSelected(o,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.processNodeSelected(o,e)),this.dirty_canvas=!0}}else if(!a){if(!this.read_only)for(var d=0;d<this.visible_links.length;++d){var _=this.visible_links[d],D=_._pos;if(!(!D||e.canvasX<D[0]-4||e.canvasX>D[0]+4||e.canvasY<D[1]-4||e.canvasY>D[1]+4)){this.showLinkMenu(_,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only){e.ctrlKey&&(this.dragging_rectangle=null);var B=distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]]);B*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()}m&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),O=!0}!a&&O&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else if(e.which==2)if(LiteGraph.middle_click_slot_add_default_node){if(o&&this.allow_interaction&&!a&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var F=!1,H=!1,V=!1;if(o.outputs)for(var d=0,g=o.outputs.length;d<g;++d){var E=o.outputs[d],I=o.getConnectionPos(!1,d);if(isInsideRectangle(e.canvasX,e.canvasY,I[0]-15,I[1]-10,30,20)){F=E,H=d,V=!0;break}}if(o.inputs)for(var d=0,g=o.inputs.length;d<g;++d){var k=o.inputs[d],I=o.getConnectionPos(!0,d);if(isInsideRectangle(e.canvasX,e.canvasY,I[0]-15,I[1]-10,30,20)){F=k,H=d,V=!1;break}}if(F&&H!==!1){var Y=.5-(H+1)/(V?o.outputs.length:o.inputs.length),K=o.getBounding(),J=[V?K[0]+K[2]:K[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:V?o:null,slotFrom:V?H:null,nodeTo:V?null:o,slotTo:V?null:H,position:J,nodeType:"AUTO",posAdd:[V?30:-30,-Y*130],posSizeFix:[V?0:-1,0]})}}}else!a&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else(e.which==3||this.pointer_is_double)&&this.allow_interaction&&!a&&!this.read_only&&(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,e));return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!t.document.activeElement||t.document.activeElement.nodeName.toLowerCase()!="input"&&t.document.activeElement.nodeName.toLowerCase()!="textarea")&&e.preventDefault(),e.stopPropagation(),this.onMouseDown&&this.onMouseDown(e),!1}}}},LGraphCanvas.prototype.processMouseMove=function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var s=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return e.preventDefault(),!1;e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{var n=s[0]/this.ds.scale,u=s[1]/this.ds.scale;this.selected_group.move(n,u,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=s[0]/this.ds.scale,this.ds.offset[1]+=s[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||r&&r.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var o=0,a=this.graph._nodes.length;o<a;++o)this.graph._nodes[o].mouseOver&&r!=this.graph._nodes[o]&&(this.graph._nodes[o].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(r){if(r.redraw_on_mouse&&(this.dirty_canvas=!0),r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(e)),r.onMouseMove&&r.onMouseMove(e,[e.canvasX-r.pos[0],e.canvasY-r.pos[1]],this),this.connecting_node){if(this.connecting_output){var l=this._highlight_input||[0,0];if(!this.isOverNodeBox(r,e.canvasX,e.canvasY)){var f=this.isOverNodeInput(r,e.canvasX,e.canvasY,l);if(f!=-1&&r.inputs[f]){var m=r.inputs[f].type;LiteGraph.isValidConnection(this.connecting_output.type,m)&&(this._highlight_input=l,this._highlight_input_slot=r.inputs[f])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input){var l=this._highlight_output||[0,0];if(!this.isOverNodeBox(r,e.canvasX,e.canvasY)){var f=this.isOverNodeOutput(r,e.canvasX,e.canvasY,l);if(f!=-1&&r.outputs[f]){var m=r.outputs[f].type;LiteGraph.isValidConnection(this.connecting_input.type,m)&&(this._highlight_output=l)}else this._highlight_output=null}}}this.canvas&&(isInsideRectangle(e.canvasX,e.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var O=null,o=0;o<this.visible_links.length;++o){var d=this.visible_links[o],g=d._pos;if(!(!g||e.canvasX<g[0]-4||e.canvasX>g[0]+4||e.canvasY<g[1]-4||e.canvasY>g[1]+4)){O=d;break}}O!=this.over_link_center&&(this.over_link_center=O,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var o in this.selected_nodes){var E=this.selected_nodes[o];E.pos[0]+=s[0]/this.ds.scale,E.pos[1]+=s[1]/this.ds.scale,E.is_selected||this.processNodeSelected(E,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var I=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],k=this.resizing_node.computeSize();I[0]=Math.max(k[0],I[0]),I[1]=Math.max(k[1],I[1]),this.resizing_node.setSize(I),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(e){var t=e.isPrimary===void 0||e.isPrimary;if(!t)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),!!this.graph){var s=this.getCanvasWindow(),r=s.document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.pointerListenerRemove(r,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerAdd(this.canvas,"move",this._mousemove_callback,!0),LiteGraph.pointerListenerRemove(r,"up",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var n=LiteGraph.getTime();if(e.click_time=n-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),e.which==1){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var u=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(u,o,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}this.selected_group_resizing=!1;var a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var l=this.graph._nodes,f=new Float32Array(4),m=Math.abs(this.dragging_rectangle[2]),O=Math.abs(this.dragging_rectangle[3]),d=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-m:this.dragging_rectangle[0],g=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-O:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=d,this.dragging_rectangle[1]=g,this.dragging_rectangle[2]=m,this.dragging_rectangle[3]=O,!a||m>10&&O>10){for(var E=[],I=0;I<l.length;++I){var k=l[I];k.getBounding(f),overlapBounding(this.dragging_rectangle,f)&&E.push(k)}E.length&&this.selectNodes(E,e.shiftKey)}else this.selectNodes([a],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var N=this.connecting_output||this.connecting_input,T=N.type;if(a){if(this.connecting_output){var h=this.isOverNodeInput(a,e.canvasX,e.canvasY);h!=-1?this.connecting_node.connect(this.connecting_slot,a,h):this.connecting_node.connectByType(this.connecting_slot,a,T)}else if(this.connecting_input){var h=this.isOverNodeOutput(a,e.canvasX,e.canvasY);h!=-1?a.connect(h,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,a,T)}}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){var a=this.node_dragged;a&&e.click_time<300&&isInsideRectangle(e.canvasX,e.canvasY,a.pos[0],a.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&a.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else{var a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);!a&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}}else e.which==2?(this.dirty_canvas=!0,this.dragging_canvas=!1):e.which==3&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}},LGraphCanvas.prototype.processMouseWheel=function(e){if(!(!this.graph||!this.allow_dragcanvas)){var t=e.wheelDeltaY!=null?e.wheelDeltaY:e.detail*-60;this.adjustMouseEvent(e);var s=e.clientX,r=e.clientY,n=!this.viewport||this.viewport&&s>=this.viewport[0]&&s<this.viewport[0]+this.viewport[2]&&r>=this.viewport[1]&&r<this.viewport[1]+this.viewport[3];if(n){var u=this.ds.scale;return t>0?u*=1.1:t<0&&(u*=1/1.1),this.ds.changeScale(u,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}}},LGraphCanvas.prototype.isOverNodeBox=function(e,t,s){var r=LiteGraph.NODE_TITLE_HEIGHT;return!!isInsideRectangle(t,s,e.pos[0]+2,e.pos[1]+2-r,r-4,r-4)},LGraphCanvas.prototype.isOverNodeInput=function(e,t,s,r){if(e.inputs)for(var n=0,u=e.inputs.length;n<u;++n){e.inputs[n];var o=e.getConnectionPos(!0,n),a=!1;if(e.horizontal?a=isInsideRectangle(t,s,o[0]-5,o[1]-10,10,20):a=isInsideRectangle(t,s,o[0]-10,o[1]-5,40,10),a)return r&&(r[0]=o[0],r[1]=o[1]),n}return-1},LGraphCanvas.prototype.isOverNodeOutput=function(e,t,s,r){if(e.outputs)for(var n=0,u=e.outputs.length;n<u;++n){e.outputs[n];var o=e.getConnectionPos(!1,n),a=!1;if(e.horizontal?a=isInsideRectangle(t,s,o[0]-5,o[1]-10,10,20):a=isInsideRectangle(t,s,o[0]-10,o[1]-5,40,10),a)return r&&(r[0]=o[0],r[1]=o[1]),n}return-1},LGraphCanvas.prototype.processKey=function(e){if(this.graph){var t=!1;if(e.target.localName!="input"){if(e.type=="keydown"){if(e.keyCode==32&&(this.dragging_canvas=!0,t=!0),e.keyCode==27&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),t=!0),e.keyCode==65&&e.ctrlKey&&(this.selectNodes(),t=!0),e.keyCode===67&&(e.metaKey||e.ctrlKey)&&!e.shiftKey&&this.selected_nodes&&(this.copyToClipboard(),t=!0),e.keyCode===86&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(e.keyCode==46||e.keyCode==8)&&e.target.localName!="input"&&e.target.localName!="textarea"&&(this.deleteSelectedNodes(),t=!0),this.selected_nodes)for(var s in this.selected_nodes)this.selected_nodes[s].onKeyDown&&this.selected_nodes[s].onKeyDown(e)}else if(e.type=="keyup"&&(e.keyCode==32&&(this.dragging_canvas=!1),this.selected_nodes))for(var s in this.selected_nodes)this.selected_nodes[s].onKeyUp&&this.selected_nodes[s].onKeyUp(e);if(this.graph.change(),t)return e.preventDefault(),e.stopImmediatePropagation(),!1}}},LGraphCanvas.prototype.copyToClipboard=function(){var e={nodes:[],links:[]},t=0,s=[];for(var r in this.selected_nodes){var n=this.selected_nodes[r];n.clonable!==!1&&(n._relative_id=t,s.push(n),t+=1)}for(var r=0;r<s.length;++r){var n=s[r];if(n.clonable!==!1){var u=n.clone();if(!u){console.warn("node type not found: "+n.type);continue}if(e.nodes.push(u.serialize()),n.inputs&&n.inputs.length)for(var o=0;o<n.inputs.length;++o){var a=n.inputs[o];if(!(!a||a.link==null)){var l=this.graph.links[a.link];if(l){var f=this.graph.getNodeById(l.origin_id);f&&e.links.push([f._relative_id,l.origin_slot,n._relative_id,l.target_slot,f.id])}}}}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))},LGraphCanvas.prototype.pasteFromClipboard=function(e=!1){if(!(!LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e)){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var s=JSON.parse(t),r=!1,n=!1,u=0;u<s.nodes.length;++u)r?(r[0]>s.nodes[u].pos[0]&&(r[0]=s.nodes[u].pos[0],n[0]=u),r[1]>s.nodes[u].pos[1]&&(r[1]=s.nodes[u].pos[1],n[1]=u)):(r=[s.nodes[u].pos[0],s.nodes[u].pos[1]],n=[u,u]);for(var o=[],u=0;u<s.nodes.length;++u){var a=s.nodes[u],l=LiteGraph.createNode(a.type);l&&(l.configure(a),l.pos[0]+=this.graph_mouse[0]-r[0],l.pos[1]+=this.graph_mouse[1]-r[1],this.graph.add(l,{doProcessChange:!1}),o.push(l))}for(var u=0;u<s.links.length;++u){var f=s.links[u],m,O=f[0];if(O!=null)m=o[O];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var d=f[4];d&&(m=this.graph.getNodeById(d))}var g=o[f[2]];m&&g?m.connect(f[1],g,f[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(o),this.graph.afterChange()}}},LGraphCanvas.prototype.processDrop=function(e){e.preventDefault(),this.adjustMouseEvent(e);var t=e.clientX,s=e.clientY,r=!this.viewport||this.viewport&&t>=this.viewport[0]&&t<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(r){var n=[e.canvasX,e.canvasY],u=this.graph?this.graph.getNodeOnPos(n[0],n[1]):null;if(!u){var o=null;this.onDropItem&&(o=this.onDropItem(event)),o||this.checkDropItem(e);return}if(u.onDropFile||u.onDropData){var a=e.dataTransfer.files;if(a&&a.length)for(var l=0;l<a.length;l++){var f=e.dataTransfer.files[0],m=f.name;if(LGraphCanvas.getFileExtension(m),u.onDropFile&&u.onDropFile(f),u.onDropData){var O=new FileReader;O.onload=function(g){var E=g.target.result;u.onDropData(E,m,f)};var d=f.type.split("/")[0];d=="text"||d==""?O.readAsText(f):d=="image"?O.readAsDataURL(f):O.readAsArrayBuffer(f)}}}return u.onDropItem&&u.onDropItem(event)?!0:this.onDropItem?this.onDropItem(event):!1}},LGraphCanvas.prototype.checkDropItem=function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],s=LGraphCanvas.getFileExtension(t.name).toLowerCase(),r=LiteGraph.node_types_by_file_extension[s];if(r){this.graph.beforeChange();var n=LiteGraph.createNode(r.type);n.pos=[e.canvasX,e.canvasY],this.graph.add(n),n.onDropFile&&n.onDropFile(t),this.graph.afterChange()}}},LGraphCanvas.prototype.processNodeDblClicked=function(e){this.onShowNodePanel?this.onShowNodePanel(e):this.showShowNodePanel(e),this.onNodeDblClicked&&this.onNodeDblClicked(e),this.setDirty(!0)},LGraphCanvas.prototype.processNodeSelected=function(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.onNodeSelected&&this.onNodeSelected(e)},LGraphCanvas.prototype.selectNode=function(e,t){e==null?this.deselectAllNodes():this.selectNodes([e],t)},LGraphCanvas.prototype.selectNodes=function(e,t){t||this.deselectAllNodes(),e=e||this.graph._nodes,typeof e=="string"&&(e=[e]);for(var s in e){var r=e[s];if(r.is_selected){this.deselectNode(r);continue}if(!r.is_selected&&r.onSelected&&r.onSelected(),r.is_selected=!0,this.selected_nodes[r.id]=r,r.inputs)for(var n=0;n<r.inputs.length;++n)this.highlighted_links[r.inputs[n].link]=!0;if(r.outputs)for(var n=0;n<r.outputs.length;++n){var u=r.outputs[n];if(u.links)for(var o=0;o<u.links.length;++o)this.highlighted_links[u.links[o]]=!0}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},LGraphCanvas.prototype.deselectNode=function(e){if(e.is_selected){if(e.onDeselected&&e.onDeselected(),e.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(e),e.inputs)for(var t=0;t<e.inputs.length;++t)delete this.highlighted_links[e.inputs[t].link];if(e.outputs)for(var t=0;t<e.outputs.length;++t){var s=e.outputs[t];if(s.links)for(var r=0;r<s.links.length;++r)delete this.highlighted_links[s.links[r]]}}},LGraphCanvas.prototype.deselectAllNodes=function(){if(this.graph){for(var e=this.graph._nodes,t=0,s=e.length;t<s;++t){var r=e[t];r.is_selected&&(r.onDeselected&&r.onDeselected(),r.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(r))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},LGraphCanvas.prototype.deleteSelectedNodes=function(){this.graph.beforeChange();for(var e in this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var s=t.graph.links[t.inputs[0].link],r=t.graph.links[t.outputs[0].links[0]],n=t.getInputNode(0),u=t.getOutputNodes(0)[0];n&&u&&n.connect(s.origin_slot,u,r.target_slot)}this.graph.remove(t),this.onNodeDeselected&&this.onNodeDeselected(t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()},LGraphCanvas.prototype.centerOnNode=function(e){this.ds.offset[0]=-e.pos[0]-e.size[0]*.5+this.canvas.width*.5/this.ds.scale,this.ds.offset[1]=-e.pos[1]-e.size[1]*.5+this.canvas.height*.5/this.ds.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(e){var t=0,s=0;if(this.canvas){var r=this.canvas.getBoundingClientRect();t=e.clientX-r.left,s=e.clientY-r.top}else t=e.clientX,s=e.clientY;this.last_mouse_position[0]=t,this.last_mouse_position[1]=s,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=s/this.ds.scale-this.ds.offset[1]},LGraphCanvas.prototype.setZoom=function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(e,t){return this.ds.convertOffsetToCanvas(e,t)},LGraphCanvas.prototype.convertCanvasToOffset=function(e,t){return this.ds.convertCanvasToOffset(e,t)},LGraphCanvas.prototype.convertEventToCanvasOffset=function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])},LGraphCanvas.prototype.bringToFront=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))},LGraphCanvas.prototype.sendToBack=function(e){var t=this.graph._nodes.indexOf(e);t!=-1&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))};var temp=new Float32Array(4);LGraphCanvas.prototype.computeVisibleNodes=function(e,t){var s=t||[];s.length=0,e=e||this.graph._nodes;for(var r=0,n=e.length;r<n;++r){var u=e[r];this.live_mode&&!u.onDrawBackground&&!u.onDrawForeground||overlapBounding(this.visible_area,u.getBounding(temp,!0))&&s.push(u)}return s},LGraphCanvas.prototype.draw=function(e,t){if(!(!this.canvas||this.canvas.width==0||this.canvas.height==0)){var s=LiteGraph.getTime();this.render_time=(s-this.last_draw_time)*.001,this.last_draw_time=s,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&s-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||e)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},LGraphCanvas.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){var t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));var s=this.viewport||this.dirty_area;if(s&&(e.save(),e.beginPath(),e.rect(s[0],s[1],s[2],s[3]),e.clip()),this.clear_background&&(s?e.clearRect(s[0],s[1],s[2],s[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(t,e),this.show_info&&this.renderInfo(e,s?s[0]:0,s?s[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);for(var r=this.computeVisibleNodes(null,this.visible_nodes),n=0;n<r.length;++n){var u=r[n];e.save(),e.translate(u.pos[0],u.pos[1]),this.drawNode(u,e),e.restore()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),this.connecting_pos!=null){e.lineWidth=this.connections_width;var o=null,a=this.connecting_output||this.connecting_input,l=a.type,f=a.dir;f==null&&(this.connecting_output?f=this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:f=this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var m=a.shape;if(l===LiteGraph.EVENT?o=LiteGraph.EVENT_LINK_COLOR:o=LiteGraph.CONNECTING_LINK_COLOR,this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,o,f,LiteGraph.CENTER),e.beginPath(),l===LiteGraph.EVENT||m===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):m===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,Math.PI*2)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input){e.beginPath();var O=this._highlight_input_slot.shape;O===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,Math.PI*2),e.fill()}this._highlight_output&&(e.beginPath(),O===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,Math.PI*2),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,null),this.onDrawForeground&&this.onDrawForeground(e,this.visible_rect),e.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.onDrawOverlay&&this.onDrawOverlay(e),s&&e.restore(),e.finish2D&&e.finish2D()}},LGraphCanvas.prototype.drawSubgraphPanel=function(e){var t=this.graph,s=t._subgraph_node;if(!s){console.warn("subgraph without subnode");return}this.drawSubgraphPanelLeft(t,s,e),this.drawSubgraphPanelRight(t,s,e)},LGraphCanvas.prototype.drawSubgraphPanelLeft=function(e,t,s){var r=t.inputs?t.inputs.length:0,n=200,u=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);if(s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(10,10,n,(r+1)*u+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left",s.fillText("Graph Inputs",20,34),this.drawButton(n-20,20,20,20,"X","#151515")){this.closeSubgraph();return}var o=50;if(s.font="14px Arial",t.inputs)for(var a=0;a<t.inputs.length;++a){var l=t.inputs[a];if(!l.not_subgraph_input){if(this.drawButton(20,o+2,n-20,u-2)){var f=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var m=LiteGraph.createNode(f);m?(e.add(m),this.block_click=!1,this.last_click_position=null,this.selectNodes([m]),this.node_dragged=m,this.dragging_canvas=!1,m.setProperty("name",l.name),m.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",f)}s.fillStyle="#9C9",s.beginPath(),s.arc(n-16,o+u*.5,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(l.name,30,o+u*.75),s.fillStyle="#777",s.fillText(l.type,130,o+u*.75),o+=u}}this.drawButton(20,o+2,n-20,u-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)},LGraphCanvas.prototype.drawSubgraphPanelRight=function(e,t,s){var r=t.outputs?t.outputs.length:0,n=this.bgcanvas.width,u=200,o=Math.floor(LiteGraph.NODE_SLOT_HEIGHT*1.6);s.fillStyle="#111",s.globalAlpha=.8,s.beginPath(),s.roundRect(n-u-10,10,u,(r+1)*o+50,[8]),s.fill(),s.globalAlpha=1,s.fillStyle="#888",s.font="14px Arial",s.textAlign="left";var a="Graph Outputs",l=s.measureText(a).width;if(s.fillText(a,n-l-20,34),this.drawButton(n-u,20,20,20,"X","#151515")){this.closeSubgraph();return}var f=50;if(s.font="14px Arial",t.outputs)for(var m=0;m<t.outputs.length;++m){var O=t.outputs[m];if(!O.not_subgraph_input){if(this.drawButton(n-u,f+2,u-20,o-2)){var d=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var g=LiteGraph.createNode(d);g?(e.add(g),this.block_click=!1,this.last_click_position=null,this.selectNodes([g]),this.node_dragged=g,this.dragging_canvas=!1,g.setProperty("name",O.name),g.setProperty("type",O.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",d)}s.fillStyle="#9C9",s.beginPath(),s.arc(n-u+16,f+o*.5,5,0,2*Math.PI),s.fill(),s.fillStyle="#AAA",s.fillText(O.name,n-u+30,f+o*.75),s.fillStyle="#777",s.fillText(O.type,n-u+130,f+o*.75),f+=o}}this.drawButton(n-u,f+2,u-20,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)},LGraphCanvas.prototype.drawButton=function(e,t,s,r,n,u,o,a){var l=this.ctx;u=u||LiteGraph.NODE_DEFAULT_COLOR,o=o||"#555",a=a||LiteGraph.NODE_TEXT_COLOR;var f=this.ds.convertOffsetToCanvas(this.graph_mouse),m=LiteGraph.isInsideRectangle(f[0],f[1],e,t,s,r);if(f=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null,f){var O=this.canvas.getBoundingClientRect();f[0]-=O.left,f[1]-=O.top}var d=f&&LiteGraph.isInsideRectangle(f[0],f[1],e,t,s,r);l.fillStyle=m?o:u,d&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,s,r,[4]),l.fill(),n!=null&&n.constructor==String&&(l.fillStyle=a,l.textAlign="center",l.font=(r*.65|0)+"px Arial",l.fillText(n,e+s*.5,t+r*.75),l.textAlign="left");var g=d&&!this.block_click;return d&&this.blockClick(),g},LGraphCanvas.prototype.isAreaClicked=function(e,t,s,r,n){var u=this.mouse;LiteGraph.isInsideRectangle(u[0],u[1],e,t,s,r),u=this.last_click_position;var o=u&&LiteGraph.isInsideRectangle(u[0],u[1],e,t,s,r),a=o&&!this.block_click;return o&&n&&this.blockClick(),a},LGraphCanvas.prototype.renderInfo=function(e,t,s){t=t||10,s=s||this.canvas.height-80,e.save(),e.translate(t,s),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),e.fillText("I: "+this.graph.iteration,5,26),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),e.fillText("V: "+this.graph._version,5,52),e.fillText("FPS:"+this.fps.toFixed(2),5,65)):e.fillText("No graph selected",5,13),e.restore()},LGraphCanvas.prototype.drawBackCanvas=function(){var e=this.bgcanvas;(e.width!=this.canvas.width||e.height!=this.canvas.height)&&(e.width=this.canvas.width,e.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var t=this.bgctx;t.start&&t.start();var s=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(s[0],s[1],s[2],s[3]),this._graph_stack&&this._graph_stack.length){t.save(),this._graph_stack[this._graph_stack.length-1];var r=this.graph._subgraph_node;t.strokeStyle=r.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=r.bgcolor||"#AAA";for(var n="",u=1;u<this._graph_stack.length;++u)n+=this._graph_stack[u]._subgraph_node.getTitle()+" >> ";t.fillText(n+r.getTitle(),e.width*.5,40),t.restore()}var o=!1;if(this.onRenderBackground&&(o=this.onRenderBackground(e,t)),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!o&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!o){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var a=this;this._bg_img.onload=function(){a.draw(!0,!0)}}var l=null;this._pattern==null&&this._bg_img.width>0?(l=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=l):l=this._pattern,l&&(t.fillStyle=l,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.onDrawBackground&&this.onDrawBackground(t,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish&&t.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var temp_vec2=new Float32Array(2);LGraphCanvas.prototype.drawNode=function(e,t){this.current_node=e;var s=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,r=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR;e.mouseOver;var n=this.ds.scale<.6;if(this.live_mode){e.flags.collapsed||(t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas));return}var u=this.editor_alpha;if(t.globalAlpha=u,this.render_shadows&&!n?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",!(e.flags.collapsed&&e.onDrawCollapsed&&e.onDrawCollapsed(t,this)==!0)){var o=e._shape||LiteGraph.BOX_SHAPE,a=temp_vec2;temp_vec2.set(e.size);var l=e.horizontal;if(e.flags.collapsed){t.font=this.inner_text_font;var f=e.getTitle?e.getTitle():e.title;f!=null&&(e._collapsed_width=Math.min(e.size[0],t.measureText(f).width+LiteGraph.NODE_TITLE_HEIGHT*2),a[0]=e._collapsed_width,a[1]=0)}e.clip_area&&(t.save(),t.beginPath(),o==LiteGraph.BOX_SHAPE?t.rect(0,0,a[0],a[1]):o==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,a[0],a[1],[10]):o==LiteGraph.CIRCLE_SHAPE&&t.arc(a[0]*.5,a[1]*.5,a[0]*.5,0,Math.PI*2),t.clip()),e.has_errors&&(r="red"),this.drawNodeShape(e,t,a,s,r,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.onDrawForeground&&e.onDrawForeground(t,this,this.canvas),t.textAlign=l?"center":"left",t.font=this.inner_text_font;var m=!n,O=this.connecting_output,d=this.connecting_input;t.lineWidth=1;var g=0,E=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var B=null,F=null;if(e.inputs)for(var I=0;I<e.inputs.length;I++){var k=e.inputs[I];if(k.link!=null){B=k;break}}if(e.outputs)for(var I=0;I<e.outputs.length;I++){var k=e.outputs[I];!k.links||!k.links.length||(F=k)}if(B){var H=0,V=LiteGraph.NODE_TITLE_HEIGHT*-.5;l&&(H=e._collapsed_width*.5,V=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),k.type===LiteGraph.EVENT||k.shape===LiteGraph.BOX_SHAPE?t.rect(H-7+.5,V-4,14,8):k.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(H+8,V),t.lineTo(H+-4,V-4),t.lineTo(H+-4,V+4),t.closePath()):t.arc(H,V,4,0,Math.PI*2),t.fill()}if(F){var H=e._collapsed_width,V=LiteGraph.NODE_TITLE_HEIGHT*-.5;l&&(H=e._collapsed_width*.5,V=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),k.type===LiteGraph.EVENT||k.shape===LiteGraph.BOX_SHAPE?t.rect(H-7+.5,V-4,14,8):k.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(H+6,V),t.lineTo(H-6,V-4),t.lineTo(H-6,V+4),t.closePath()):t.arc(H,V,4,0,Math.PI*2),t.fill()}}}else{if(e.inputs)for(var I=0;I<e.inputs.length;I++){var k=e.inputs[I],N=k.type,T=k.shape;t.globalAlpha=u,this.connecting_output&&!LiteGraph.isValidConnection(k.type,O.type)&&(t.globalAlpha=.4*u),t.fillStyle=k.link!=null?k.color_on||this.default_connection_color_byType[N]||this.default_connection_color.input_on:k.color_off||this.default_connection_color_byTypeOff[N]||this.default_connection_color_byType[N]||this.default_connection_color.input_off;var h=e.getConnectionPos(!0,I,E);h[0]-=e.pos[0],h[1]-=e.pos[1],g<h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(g=h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.beginPath(),N=="array"&&(T=LiteGraph.GRID_SHAPE);var L=!0;if(k.type===LiteGraph.EVENT||k.shape===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):T===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),L=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,Math.PI*2),t.fill(),m){var _=k.label!=null?k.label:k.name;_&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||k.dir==LiteGraph.UP?t.fillText(_,h[0],h[1]-10):t.fillText(_,h[0]+10,h[1]+5))}}if(t.textAlign=l?"center":"right",t.strokeStyle="black",e.outputs)for(var I=0;I<e.outputs.length;I++){var k=e.outputs[I],N=k.type,T=k.shape;this.connecting_input&&!LiteGraph.isValidConnection(N,d.type)&&(t.globalAlpha=.4*u);var h=e.getConnectionPos(!1,I,E);h[0]-=e.pos[0],h[1]-=e.pos[1],g<h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5&&(g=h[1]+LiteGraph.NODE_SLOT_HEIGHT*.5),t.fillStyle=k.links&&k.links.length?k.color_on||this.default_connection_color_byType[N]||this.default_connection_color.output_on:k.color_off||this.default_connection_color_byTypeOff[N]||this.default_connection_color_byType[N]||this.default_connection_color.output_off,t.beginPath(),N=="array"&&(T=LiteGraph.GRID_SHAPE);var L=!0;if(N===LiteGraph.EVENT||T===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):T===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):T===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),L=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,Math.PI*2),t.fill(),!n&&L&&t.stroke(),m){var _=k.label!=null?k.label:k.name;_&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||k.dir==LiteGraph.DOWN?t.fillText(_,h[0],h[1]-8):t.fillText(_,h[0]-10,h[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var D=g;(l||e.widgets_up)&&(D=2),e.widgets_start_y!=null&&(D=e.widgets_start_y),this.drawNodeWidgets(e,D,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}e.clip_area&&t.restore(),t.globalAlpha=1}},LGraphCanvas.prototype.drawLinkTooltip=function(e,t){var s=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(s[0],s[1],3,0,Math.PI*2),e.fill(),t.data!=null&&!(this.onDrawLinkTooltip&&this.onDrawLinkTooltip(e,t,this)==!0)){var r=t.data,n=null;if(r.constructor===Number?n=r.toFixed(2):r.constructor===String?n='"'+r+'"':r.constructor===Boolean?n=String(r):r.toToolTip?n=r.toToolTip():n="["+r.constructor.name+"]",n!=null){n=n.substr(0,30),e.font="14px Courier New";var u=e.measureText(n),o=u.width+20,a=24;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(s[0]-o*.5,s[1]-15-a,o,a,[3]),e.moveTo(s[0]-10,s[1]-15),e.lineTo(s[0]+10,s[1]-15),e.lineTo(s[0],s[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(n,s[0],s[1]-15-a*.3)}}};var tmp_area=new Float32Array(4);LGraphCanvas.prototype.drawNodeShape=function(e,t,s,r,n,u,o){t.strokeStyle=r,t.fillStyle=n;var a=LiteGraph.NODE_TITLE_HEIGHT,l=this.ds.scale<.5,f=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,m=e.constructor.title_mode,O=!0;m==LiteGraph.TRANSPARENT_TITLE||m==LiteGraph.NO_TITLE?O=!1:m==LiteGraph.AUTOHIDE_TITLE&&o&&(O=!0);var d=tmp_area;d[0]=0,d[1]=O?-a:0,d[2]=s[0]+1,d[3]=O?s[1]+a:s[1];var g=t.globalAlpha;if(t.beginPath(),f==LiteGraph.BOX_SHAPE||l?t.fillRect(d[0],d[1],d[2],d[3]):f==LiteGraph.ROUND_SHAPE||f==LiteGraph.CARD_SHAPE?t.roundRect(d[0],d[1],d[2],d[3],f==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):f==LiteGraph.CIRCLE_SHAPE&&t.arc(s[0]*.5,s[1]*.5,s[0]*.5,0,Math.PI*2),t.fill(),!e.flags.collapsed&&O&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,d[2],2)),t.shadowColor="transparent",e.onDrawBackground&&e.onDrawBackground(t,this,this.canvas,this.graph_mouse),O||m==LiteGraph.TRANSPARENT_TITLE){if(e.onDrawTitleBar)e.onDrawTitleBar(t,a,s,this.ds.scale,r);else if(m!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var E=e.constructor.title_color||r;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var I=LGraphCanvas.gradients[E];I||(I=LGraphCanvas.gradients[E]=t.createLinearGradient(0,0,400,0),I.addColorStop(0,E),I.addColorStop(1,"#000")),t.fillStyle=I}else t.fillStyle=E;t.beginPath(),f==LiteGraph.BOX_SHAPE||l?t.rect(0,-a,s[0]+1,a):(f==LiteGraph.ROUND_SHAPE||f==LiteGraph.CARD_SHAPE)&&t.roundRect(0,-a,s[0]+1,a,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}var k=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(k=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(k=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":k);var N=10;if(e.onDrawTitleBox?e.onDrawTitleBox(t,a,s,this.ds.scale):f==LiteGraph.ROUND_SHAPE||f==LiteGraph.CIRCLE_SHAPE||f==LiteGraph.CARD_SHAPE?(l&&(t.fillStyle="black",t.beginPath(),t.arc(a*.5,a*-.5,N*.5+1,0,Math.PI*2),t.fill()),t.fillStyle=e.boxcolor||k||LiteGraph.NODE_DEFAULT_BOXCOLOR,l?t.fillRect(a*.5-N*.5,a*-.5-N*.5,N,N):(t.beginPath(),t.arc(a*.5,a*-.5,N*.5,0,Math.PI*2),t.fill())):(l&&(t.fillStyle="black",t.fillRect((a-N)*.5-1,(a+N)*-.5-1,N+2,N+2)),t.fillStyle=e.boxcolor||k||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect((a-N)*.5,(a+N)*-.5,N,N)),t.globalAlpha=g,e.onDrawTitleText&&e.onDrawTitleText(t,a,s,this.ds.scale,this.title_text_font,u),!l){t.font=this.title_text_font;var T=String(e.getTitle());T&&(u?t.fillStyle=LiteGraph.NODE_SELECTED_TITLE_COLOR:t.fillStyle=e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.measureText(T),t.fillText(T.substr(0,20),a,LiteGraph.NODE_TITLE_TEXT_Y-a),t.textAlign="left"):(t.textAlign="left",t.fillText(T,a,LiteGraph.NODE_TITLE_TEXT_Y-a)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var h=LiteGraph.NODE_TITLE_HEIGHT,L=e.size[0]-h,_=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],L+2,-h+2,h-4,h-4);t.fillStyle=_?"#888":"#555",f==LiteGraph.BOX_SHAPE||l?t.fillRect(L+2,-h+2,h-4,h-4):(t.beginPath(),t.roundRect(L+2,-h+2,h-4,h-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(L+h*.2,-h*.6),t.lineTo(L+h*.8,-h*.6),t.lineTo(L+h*.5,-h*.3),t.fill()}e.onDrawTitle&&e.onDrawTitle(t)}u&&(e.onBounding&&e.onBounding(d),m==LiteGraph.TRANSPARENT_TITLE&&(d[1]-=a,d[3]+=a),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),f==LiteGraph.BOX_SHAPE?t.rect(-6+d[0],-6+d[1],12+d[2],12+d[3]):f==LiteGraph.ROUND_SHAPE||f==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2]):f==LiteGraph.CARD_SHAPE?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[this.round_radius*2,2,this.round_radius*2,2]):f==LiteGraph.CIRCLE_SHAPE&&t.arc(s[0]*.5,s[1]*.5,s[0]*.5+6,0,Math.PI*2),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=r,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--};var margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);LGraphCanvas.prototype.drawConnections=function(e){var t=LiteGraph.getTime(),s=this.visible_area;margin_area[0]=s[0]-20,margin_area[1]=s[1]-20,margin_area[2]=s[2]+40,margin_area[3]=s[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var r=this.graph._nodes,n=0,u=r.length;n<u;++n){var o=r[n];if(!(!o.inputs||!o.inputs.length))for(var a=0;a<o.inputs.length;++a){var l=o.inputs[a];if(!(!l||l.link==null)){var f=l.link,m=this.graph.links[f];if(m){var O=this.graph.getNodeById(m.origin_id);if(O!=null){var d=m.origin_slot,g=null;d==-1?g=[O.pos[0]+10,O.pos[1]+10]:g=O.getConnectionPos(!1,d,tempA);var E=o.getConnectionPos(!0,a,tempB);if(link_bounding[0]=g[0],link_bounding[1]=g[1],link_bounding[2]=E[0]-g[0],link_bounding[3]=E[1]-g[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),!!overlapBounding(link_bounding,margin_area)){var I=O.outputs[d],k=o.inputs[a];if(!(!I||!k)){var N=I.dir||(O.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),T=k.dir||(o.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,g,E,m,!1,0,null,N,T),m&&m._last_time&&t-m._last_time<1e3){var h=2-(t-m._last_time)*.002,L=e.globalAlpha;e.globalAlpha=L*h,this.renderLink(e,g,E,m,!0,h,"white",N,T),e.globalAlpha=L}}}}}}}}e.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(e,t,s,r,n,u,o,a,l,f){r&&this.visible_links.push(r),!o&&r&&(o=r.color||LGraphCanvas.link_type_colors[r.type]),o||(o=this.default_link_color),r!=null&&this.highlighted_links[r.id]&&(o="#FFF"),a=a||LiteGraph.RIGHT,l=l||LiteGraph.LEFT;var m=distance(t,s);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",f=f||1,f>1&&(e.lineWidth=.5),e.beginPath();for(var O=0;O<f;O+=1){var d=(O-(f-1)*.5)*5;if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+d);var g=0,E=0,I=0,k=0;switch(a){case LiteGraph.LEFT:g=m*-.25;break;case LiteGraph.RIGHT:g=m*.25;break;case LiteGraph.UP:E=m*-.25;break;case LiteGraph.DOWN:E=m*.25;break}switch(l){case LiteGraph.LEFT:I=m*-.25;break;case LiteGraph.RIGHT:I=m*.25;break;case LiteGraph.UP:k=m*-.25;break;case LiteGraph.DOWN:k=m*.25;break}e.bezierCurveTo(t[0]+g,t[1]+E+d,s[0]+I,s[1]+k+d,s[0],s[1]+d)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+d);var g=0,E=0,I=0,k=0;switch(a){case LiteGraph.LEFT:g=-1;break;case LiteGraph.RIGHT:g=1;break;case LiteGraph.UP:E=-1;break;case LiteGraph.DOWN:E=1;break}switch(l){case LiteGraph.LEFT:I=-1;break;case LiteGraph.RIGHT:I=1;break;case LiteGraph.UP:k=-1;break;case LiteGraph.DOWN:k=1;break}var N=15;e.lineTo(t[0]+g*N,t[1]+E*N+d),e.lineTo(s[0]+I*N,s[1]+k*N+d),e.lineTo(s[0],s[1]+d)}else if(this.links_render_mode==LiteGraph.STRAIGHT_LINK){e.moveTo(t[0],t[1]);var T=t[0],h=t[1],L=s[0],_=s[1];a==LiteGraph.RIGHT?T+=10:h+=10,l==LiteGraph.LEFT?L-=10:_-=10,e.lineTo(T,h),e.lineTo((T+L)*.5,h),e.lineTo((T+L)*.5,_),e.lineTo(L,_),e.lineTo(s[0],s[1])}else return}this.render_connections_border&&this.ds.scale>.6&&!n&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=o,e.stroke();var D=this.computeConnectionPoint(t,s,.5,a,l);if(r&&r._pos&&(r._pos[0]=D[0],r._pos[1]=D[1]),this.ds.scale>=.6&&this.highquality_render&&l!=LiteGraph.CENTER){if(this.render_connection_arrows){var B=this.computeConnectionPoint(t,s,.25,a,l),F=this.computeConnectionPoint(t,s,.26,a,l),H=this.computeConnectionPoint(t,s,.75,a,l),V=this.computeConnectionPoint(t,s,.76,a,l),Y=0,K=0;this.render_curved_connections?(Y=-Math.atan2(F[0]-B[0],F[1]-B[1]),K=-Math.atan2(V[0]-H[0],V[1]-H[1])):K=Y=s[1]>t[1]?0:Math.PI,e.save(),e.translate(B[0],B[1]),e.rotate(Y),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(H[0],H[1]),e.rotate(K),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(D[0],D[1],5,0,Math.PI*2),e.fill()}if(u){e.fillStyle=o;for(var O=0;O<5;++O){var J=(LiteGraph.getTime()*.001+O*.2)%1,D=this.computeConnectionPoint(t,s,J,a,l);e.beginPath(),e.arc(D[0],D[1],5,0,2*Math.PI),e.fill()}}},LGraphCanvas.prototype.computeConnectionPoint=function(e,t,s,r,n){r=r||LiteGraph.RIGHT,n=n||LiteGraph.LEFT;var u=distance(e,t),o=e,a=[e[0],e[1]],l=[t[0],t[1]],f=t;switch(r){case LiteGraph.LEFT:a[0]+=u*-.25;break;case LiteGraph.RIGHT:a[0]+=u*.25;break;case LiteGraph.UP:a[1]+=u*-.25;break;case LiteGraph.DOWN:a[1]+=u*.25;break}switch(n){case LiteGraph.LEFT:l[0]+=u*-.25;break;case LiteGraph.RIGHT:l[0]+=u*.25;break;case LiteGraph.UP:l[1]+=u*-.25;break;case LiteGraph.DOWN:l[1]+=u*.25;break}var m=(1-s)*(1-s)*(1-s),O=3*((1-s)*(1-s))*s,d=3*(1-s)*(s*s),g=s*s*s,E=m*o[0]+O*a[0]+d*l[0]+g*f[0],I=m*o[1]+O*a[1]+d*l[1]+g*f[1];return[E,I]},LGraphCanvas.prototype.drawExecutionOrder=function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;for(var t=this.visible_nodes,s=0;s<t.length;++s){var r=t[s];e.fillStyle="black",e.fillRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),r.order==0&&e.strokeRect(r.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(r.order,r.pos[0]+LiteGraph.NODE_TITLE_HEIGHT*-.5,r.pos[1]-6)}e.globalAlpha=1},LGraphCanvas.prototype.drawNodeWidgets=function(e,t,s,r){if(!e.widgets||!e.widgets.length)return 0;var n=e.size[0],u=e.widgets;t+=2;var o=LiteGraph.NODE_WIDGET_HEIGHT,a=this.ds.scale>.5;s.save(),s.globalAlpha=this.editor_alpha;for(var l=LiteGraph.WIDGET_OUTLINE_COLOR,f=LiteGraph.WIDGET_BGCOLOR,m=LiteGraph.WIDGET_TEXT_COLOR,O=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,d=15,g=0;g<u.length;++g){var E=u[g],I=t;E.y&&(I=E.y),E.last_y=I,s.strokeStyle=l,s.fillStyle="#222",s.textAlign="left",E.disabled&&(s.globalAlpha*=.5);var k=E.width||n;switch(E.type){case"button":E.clicked&&(s.fillStyle="#AAA",E.clicked=!1,this.dirty_canvas=!0),s.fillRect(d,I,k-d*2,o),a&&!E.disabled&&s.strokeRect(d,I,k-d*2,o),a&&(s.textAlign="center",s.fillStyle=m,s.fillText(E.label||E.name,k*.5,I+o*.7));break;case"toggle":if(s.textAlign="left",s.strokeStyle=l,s.fillStyle=f,s.beginPath(),a?s.roundRect(d,I,k-d*2,o,[o*.5]):s.rect(d,I,k-d*2,o),s.fill(),a&&!E.disabled&&s.stroke(),s.fillStyle=E.value?"#89A":"#333",s.beginPath(),s.arc(k-d*2,I+o*.5,o*.36,0,Math.PI*2),s.fill(),a){s.fillStyle=O;const D=E.label||E.name;D!=null&&s.fillText(D,d*2,I+o*.7),s.fillStyle=E.value?m:O,s.textAlign="right",s.fillText(E.value?E.options.on||"true":E.options.off||"false",k-40,I+o*.7)}break;case"slider":s.fillStyle=f,s.fillRect(d,I,k-d*2,o);var N=E.options.max-E.options.min,T=(E.value-E.options.min)/N;if(T<0&&(T=0),T>1&&(T=1),s.fillStyle=E.options.hasOwnProperty("slider_color")?E.options.slider_color:r==E?"#89A":"#678",s.fillRect(d,I,T*(k-d*2),o),a&&!E.disabled&&s.strokeRect(d,I,k-d*2,o),E.marker){var h=(E.marker-E.options.min)/N;h<0&&(h=0),h>1&&(h=1),s.fillStyle=E.options.hasOwnProperty("marker_color")?E.options.marker_color:"#AA9",s.fillRect(d+h*(k-d*2),I,2,o)}a&&(s.textAlign="center",s.fillStyle=m,s.fillText(E.label||E.name+"  "+Number(E.value).toFixed(E.options.precision!=null?E.options.precision:3),k*.5,I+o*.7));break;case"number":case"combo":if(s.textAlign="left",s.strokeStyle=l,s.fillStyle=f,s.beginPath(),a?s.roundRect(d,I,k-d*2,o,[o*.5]):s.rect(d,I,k-d*2,o),s.fill(),a)if(E.disabled||s.stroke(),s.fillStyle=m,E.disabled||(s.beginPath(),s.moveTo(d+16,I+5),s.lineTo(d+6,I+o*.5),s.lineTo(d+16,I+o-5),s.fill(),s.beginPath(),s.moveTo(k-d-16,I+5),s.lineTo(k-d-6,I+o*.5),s.lineTo(k-d-16,I+o-5),s.fill()),s.fillStyle=O,s.fillText(E.label||E.name,d*2+5,I+o*.7),s.fillStyle=m,s.textAlign="right",E.type=="number")s.fillText(Number(E.value).toFixed(E.options.precision!==void 0?E.options.precision:3),k-d*2-20,I+o*.7);else{var L=E.value;if(E.options.values){var _=E.options.values;_.constructor===Function&&(_=_()),_&&_.constructor!==Array&&(L=_[E.value])}s.fillText(L,k-d*2-20,I+o*.7)}break;case"string":case"text":if(s.textAlign="left",s.strokeStyle=l,s.fillStyle=f,s.beginPath(),a?s.roundRect(d,I,k-d*2,o,[o*.5]):s.rect(d,I,k-d*2,o),s.fill(),a){E.disabled||s.stroke(),s.save(),s.beginPath(),s.rect(d,I,k-d*2,o),s.clip(),s.fillStyle=O;const D=E.label||E.name;D!=null&&s.fillText(D,d*2,I+o*.7),s.fillStyle=m,s.textAlign="right",s.fillText(String(E.value).substr(0,30),k-d*2,I+o*.7),s.restore()}break;default:E.draw&&E.draw(s,e,k,I,o);break}t+=(E.computeSize?E.computeSize(k)[1]:o)+4,s.globalAlpha=this.editor_alpha}s.restore(),s.textAlign="left"},LGraphCanvas.prototype.processNodeWidgets=function(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow(),i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(!(!w||w.disabled)){var widget_height=w.computeSize?w.computeSize(width)[1]:LiteGraph.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(!(w!=active_widget&&(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||w.last_y===void 0))){var old_value=w.value;switch(w.type){case"button":event.type===LiteGraph.pointerevents_method+"down"&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var old_value=w.value,nvalue=clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value)},20),this.dirty_canvas=!0;break;case"number":case"combo":var old_value=w.value;if(event.type==LiteGraph.pointerevents_method+"move"&&w.type=="number")deltaX&&(w.value+=deltaX*.1*(w.options.step||1)),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(event.type==LiteGraph.pointerevents_method+"down"){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;w.type!="number"&&(values_list=values.constructor===Array?values:Object.keys(values));var delta=x<40?-1:x>widget_width-40?1:0;if(w.type=="number")w.value+=delta*.1*(w.options.step||1),w.options.min!=null&&w.value<w.options.min&&(w.value=w.options.min),w.options.max!=null&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,values.constructor===Object?index=values_list.indexOf(String(w.value))+delta:index=values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index}else{let e=function(t,s,r){return values!=values_list&&(t=text_values.indexOf(t)),this.value=t,inner_value_change(this,t),that.dirty_canvas=!0,!1};var inner_clicked=e,text_values=values!=values_list?Object.values(values):values;new LiteGraph.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event,className:"dark",callback:e.bind(w)},ref_window)}}else if(event.type==LiteGraph.pointerevents_method+"up"&&w.type=="number"){var delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&delta==0&&this.prompt("Value",w.value,(function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){}this.value=Number(v),inner_value_change(this,this.value)}).bind(w),event)}old_value!=w.value&&setTimeout((function(){inner_value_change(this,this.value)}).bind(w),20),this.dirty_canvas=!0;break;case"toggle":event.type==LiteGraph.pointerevents_method+"down"&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":event.type==LiteGraph.pointerevents_method+"down"&&this.prompt("Value",w.value,(function(e){inner_value_change(this,e)}).bind(w),event,w.options?w.options.multiline:!1);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node));break}return old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph._version++),w}}}function inner_value_change(e,t){e.type=="number"&&(t=Number(t)),e.value=t,e.options&&e.options.property&&node.properties[e.options.property]!==void 0&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event)}return null},LGraphCanvas.prototype.drawGroups=function(e,t){if(this.graph){var s=this.graph._groups;t.save(),t.globalAlpha=.5*this.editor_alpha;for(var r=0;r<s.length;++r){var n=s[r];if(overlapBounding(this.visible_area,n._bounding)){t.fillStyle=n.color||"#335",t.strokeStyle=n.color||"#335";var u=n._pos,o=n._size;t.globalAlpha=.25*this.editor_alpha,t.beginPath(),t.rect(u[0]+.5,u[1]+.5,o[0],o[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(u[0]+o[0],u[1]+o[1]),t.lineTo(u[0]+o[0]-10,u[1]+o[1]),t.lineTo(u[0]+o[0],u[1]+o[1]-10),t.fill();var a=n.font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=a+"px Arial",t.textAlign="left",t.fillText(n.title,u[0]+4,u[1]+a)}}t.restore()}},LGraphCanvas.prototype.adjustNodesSize=function(){for(var e=this.graph._nodes,t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)},LGraphCanvas.prototype.resize=function(e,t){if(!e&&!t){var s=this.canvas.parentNode;e=s.offsetWidth,t=s.offsetHeight}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(e){if(!e){this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;return}var t=this,s=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var r=setInterval(function(){t.editor_alpha*=s,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,s<1&&t.editor_alpha<.01&&(clearInterval(r),s<1&&(t.live_mode=!0)),s>1&&t.editor_alpha>.99&&(clearInterval(r),t.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(e){},LGraphCanvas.onGroupAdd=function(e,t,s){var r=LGraphCanvas.active_canvas;r.getCanvasWindow();var n=new LiteGraph.LGraphGroup;n.pos=r.convertEventToCanvasOffset(s),r.graph.add(n)},LGraphCanvas.getBoundaryNodes=function(e){let t=null,s=null,r=null,n=null;for(const u in e){const o=e[u],[a,l]=o.pos,[f,m]=o.size;(t===null||l<t.pos[1])&&(t=o),(s===null||a+f>s.pos[0]+s.size[0])&&(s=o),(r===null||l+m>r.pos[1]+r.size[1])&&(r=o),(n===null||a<n.pos[0])&&(n=o)}return{top:t,right:s,bottom:r,left:n}},LGraphCanvas.prototype.boundaryNodesForSelection=function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))},LGraphCanvas.alignNodes=function(e,t,s){if(!e)return;const r=LGraphCanvas.active_canvas;let n=[];s===void 0?n=LGraphCanvas.getBoundaryNodes(e):n={top:s,right:s,bottom:s,left:s};for(const[u,o]of Object.entries(r.selected_nodes))switch(t){case"right":o.pos[0]=n.right.pos[0]+n.right.size[0]-o.size[0];break;case"left":o.pos[0]=n.left.pos[0];break;case"top":o.pos[1]=n.top.pos[1];break;case"bottom":o.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-o.size[1];break}r.dirty_canvas=!0,r.dirty_bgcanvas=!0},LGraphCanvas.onNodeAlign=function(e,t,s,r,n){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:u,parentMenu:r});function u(o){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,o.toLowerCase(),n)}},LGraphCanvas.onGroupAlign=function(e,t,s,r){new LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:s,callback:n,parentMenu:r});function n(u){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,u.toLowerCase())}},LGraphCanvas.onMenuAdd=function(e,t,s,r,n){var u=LGraphCanvas.active_canvas,o=u.getCanvasWindow(),a=u.graph;if(!a)return;function l(f,m){var O=LiteGraph.getNodeTypesCategories(u.filter||a.filter).filter(function(E){return E.startsWith(f)}),d=[];O.map(function(E){if(E){var I=new RegExp("^("+f+")"),k=E.replace(I,"").split("/")[0],N=f===""?k+"/":f+k+"/",T=k;T.indexOf("::")!=-1&&(T=T.split("::")[1]);var h=d.findIndex(function(L){return L.value===N});h===-1&&d.push({value:N,content:T,has_submenu:!0,callback:function(L,_,D,B){l(L.value,B)}})}});var g=LiteGraph.getNodeTypesInCategory(f.slice(0,-1),u.filter||a.filter);g.map(function(E){if(!E.skip_list){var I={value:E.type,content:E.title,has_submenu:!1,callback:function(k,N,T,h){var L=h.getFirstEvent();u.graph.beforeChange();var _=LiteGraph.createNode(k.value);_&&(_.pos=u.convertEventToCanvasOffset(L),u.graph.add(_)),n&&n(_),u.graph.afterChange()}};d.push(I)}}),new LiteGraph.ContextMenu(d,{event:s,parentMenu:m},o)}return l("",r),!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.showMenuNodeOptionalInputs=function(e,l,s,r,n){if(!n)return;var u=this,o=LGraphCanvas.active_canvas,a=o.getCanvasWindow(),l=n.optional_inputs;n.onGetInputs&&(l=n.onGetInputs());var f=[];if(l)for(var m=0;m<l.length;m++){var O=l[m];if(!O){f.push(null);continue}var d=O[0];O[2]||(O[2]={}),O[2].label&&(d=O[2].label),O[2].removable=!0;var g={content:d,value:O};O[1]==LiteGraph.ACTION&&(g.className="event"),f.push(g)}if(n.onMenuNodeInputs){var E=n.onMenuNodeInputs(f);E&&(f=E)}if(!f.length){console.log("no input entries");return}new LiteGraph.ContextMenu(f,{event:s,callback:I,parentMenu:r,node:n},a);function I(k,N,T){n&&(k.callback&&k.callback.call(u,n,k,N,T),k.value&&(n.graph.beforeChange(),n.addInput(k.value[0],k.value[1],k.value[2]),n.onNodeInputAdd&&n.onNodeInputAdd(k.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()))}return!1},LGraphCanvas.showMenuNodeOptionalOutputs=function(e,l,s,r,n){if(!n)return;var u=this,o=LGraphCanvas.active_canvas,a=o.getCanvasWindow(),l=n.optional_outputs;n.onGetOutputs&&(l=n.onGetOutputs());var f=[];if(l)for(var m=0;m<l.length;m++){var O=l[m];if(!O){f.push(null);continue}if(!(n.flags&&n.flags.skip_repeated_outputs&&n.findOutputSlot(O[0])!=-1)){var d=O[0];O[2]||(O[2]={}),O[2].label&&(d=O[2].label),O[2].removable=!0;var g={content:d,value:O};O[1]==LiteGraph.EVENT&&(g.className="event"),f.push(g)}}if(this.onMenuNodeOutputs&&(f=this.onMenuNodeOutputs(f)),LiteGraph.do_add_triggers_slots&&n.findOutputSlot("onExecuted")==-1&&f.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0}],className:"event"}),n.onMenuNodeOutputs){var E=n.onMenuNodeOutputs(f);E&&(f=E)}if(!f.length)return;new LiteGraph.ContextMenu(f,{event:s,callback:I,parentMenu:r,node:n},a);function I(k,N,T){if(n&&(k.callback&&k.callback.call(u,n,k,N,T),!!k.value)){var h=k.value[1];if(h&&(h.constructor===Object||h.constructor===Array)){var L=[];for(var _ in h)L.push({content:_,value:h[_]});return new LiteGraph.ContextMenu(L,{event:N,callback:I,parentMenu:r,node:n}),!1}else n.graph.beforeChange(),n.addOutput(k.value[0],k.value[1],k.value[2]),n.onNodeOutputAdd&&n.onNodeOutputAdd(k.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()}}return!1},LGraphCanvas.onShowMenuNodeProperties=function(e,t,s,r,n){if(!n||!n.properties)return;var u=LGraphCanvas.active_canvas,o=u.getCanvasWindow(),a=[];for(var l in n.properties){var e=n.properties[l]!==void 0?n.properties[l]:" ";typeof e=="object"&&(e=JSON.stringify(e));var f=n.getPropertyInfo(l);(f.type=="enum"||f.type=="combo")&&(e=LGraphCanvas.getPropertyPrintableValue(e,f.values)),e=LGraphCanvas.decodeHTML(e),a.push({content:"<span class='property_name'>"+(f.label?f.label:l)+"</span><span class='property_value'>"+e+"</span>",value:l})}if(!a.length)return;new LiteGraph.ContextMenu(a,{event:s,callback:m,parentMenu:r,allow_html:!0,node:n},o);function m(O,d,g,E){if(n){var I=this.getBoundingClientRect();u.showEditPropertyValue(n,O.value,{position:[I.left,I.top]})}}return!1},LGraphCanvas.decodeHTML=function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML},LGraphCanvas.onMenuResizeNode=function(e,t,s,r,n){if(n){var u=function(l){l.size=l.computeSize(),l.onResize&&l.onResize(l.size)},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)u(n);else for(var a in o.selected_nodes)u(o.selected_nodes[a]);n.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.showLinkMenu=function(e,t){var s=this,r=s.graph.getNodeById(e.origin_id),n=s.graph.getNodeById(e.target_id),u=!1;r&&r.outputs&&r.outputs[e.origin_slot]&&(u=r.outputs[e.origin_slot].type);var o=!1;n&&n.outputs&&n.outputs[e.target_slot]&&(o=n.inputs[e.target_slot].type);var a=["Add Node",null,"Delete",null],l=new LiteGraph.ContextMenu(a,{event:t,title:e.data!=null?e.data.constructor.name:null,callback:f});function f(m,O,d){switch(m){case"Add Node":LGraphCanvas.onMenuAdd(null,null,d,l,function(g){!g.inputs||!g.inputs.length||!g.outputs||!g.outputs.length||r.connectByType(e.origin_slot,g,u)&&(g.connectByType(e.target_slot,n,o),g.pos[0]-=g.size[0]*.5)});break;case"Delete":s.graph.removeLink(e.id);break}}return!1},LGraphCanvas.prototype.createDefaultNodeForSlot=function(t){var t=t||{},s=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},t),r=this,n=s.nodeFrom&&s.slotFrom!==null,u=!n&&s.nodeTo&&s.slotTo!==null;if(!n&&!u)return console.warn("No data passed to createDefaultNodeForSlot "+s.nodeFrom+" "+s.slotFrom+" "+s.nodeTo+" "+s.slotTo),!1;if(!s.nodeType)return console.warn("No type to createDefaultNodeForSlot"),!1;var o=n?s.nodeFrom:s.nodeTo,a=n?s.slotFrom:s.slotTo,l=!1;switch(typeof a){case"string":l=n?o.findOutputSlot(a,!1):o.findInputSlot(a,!1),a=n?o.outputs[a]:o.inputs[a];break;case"object":l=n?o.findOutputSlot(a.name):o.findInputSlot(a.name);break;case"number":l=a,a=n?o.outputs[a]:o.inputs[a];break;default:return console.warn("Cant get slot information "+a),!1}(a===!1||l===!1)&&console.warn("createDefaultNodeForSlot bad slotX "+a+" "+l);var f=a.type==LiteGraph.EVENT?"_event_":a.type,m=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(m&&m[f]){if(a.link,nodeNewType=!1,typeof m[f]=="object"||typeof m[f]=="array"){for(var O in m[f])if(s.nodeType==m[f][O]||s.nodeType=="AUTO"){nodeNewType=m[f][O];break}}else(s.nodeType==m[f]||s.nodeType=="AUTO")&&(nodeNewType=m[f]);if(nodeNewType){var d=!1;typeof nodeNewType=="object"&&nodeNewType.node&&(d=nodeNewType,nodeNewType=nodeNewType.node);var g=LiteGraph.createNode(nodeNewType);if(g){if(d){if(d.properties)for(var E in d.properties)g.addProperty(E,d.properties[E]);if(d.inputs){g.inputs=[];for(var E in d.inputs)g.addOutput(d.inputs[E][0],d.inputs[E][1])}if(d.outputs){g.outputs=[];for(var E in d.outputs)g.addOutput(d.outputs[E][0],d.outputs[E][1])}d.title&&(g.title=d.title),d.json&&g.configure(d.json)}return r.graph.add(g),g.pos=[s.position[0]+s.posAdd[0]+(s.posSizeFix[0]?s.posSizeFix[0]*g.size[0]:0),s.position[1]+s.posAdd[1]+(s.posSizeFix[1]?s.posSizeFix[1]*g.size[1]:0)],n?s.nodeFrom.connectByType(l,g,f):s.nodeTo.connectByTypeOutput(l,g,f),!0}else console.log("failed creating "+nodeNewType)}}return!1},LGraphCanvas.prototype.showConnectionMenu=function(t){var t=t||{},s=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},t),r=this,n=s.nodeFrom&&s.slotFrom,u=!n&&s.nodeTo&&s.slotTo;if(!n&&!u)return console.warn("No data passed to showConnectionMenu"),!1;var o=n?s.nodeFrom:s.nodeTo,a=n?s.slotFrom:s.slotTo,l=!1;switch(typeof a){case"string":l=n?o.findOutputSlot(a,!1):o.findInputSlot(a,!1),a=n?o.outputs[a]:o.inputs[a];break;case"object":l=n?o.findOutputSlot(a.name):o.findInputSlot(a.name);break;case"number":l=a,a=n?o.outputs[a]:o.inputs[a];break;default:return console.warn("Cant get slot information "+a),!1}var f=["Add Node",null];r.allow_searchbox&&(f.push("Search"),f.push(null));var m=a.type==LiteGraph.EVENT?"_event_":a.type,O=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(O&&O[m])if(typeof O[m]=="object"||typeof O[m]=="array")for(var d in O[m])f.push(O[m][d]);else f.push(O[m]);var g=new LiteGraph.ContextMenu(f,{event:s.e,title:(a&&a.name!=""?a.name+(m?" | ":""):"")+(a&&m?m:""),callback:E});function E(I,k,N){switch(I){case"Add Node":LGraphCanvas.onMenuAdd(null,null,N,g,function(T){n?s.nodeFrom.connectByType(l,T,m):s.nodeTo.connectByTypeOutput(l,T,m)});break;case"Search":n?r.showSearchBox(N,{node_from:s.nodeFrom,slot_from:a,type_filter_in:m}):r.showSearchBox(N,{node_to:s.nodeTo,slot_from:a,type_filter_out:m});break;default:r.createDefaultNodeForSlot(Object.assign(s,{position:[s.e.canvasX,s.e.canvasY],nodeType:I}));break}}return!1},LGraphCanvas.onShowPropertyEditor=function(e,t,s,r,n){var u=e.property||"title",o=n[u],a=document.createElement("div");a.is_modified=!1,a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.close=function(){a.parentNode&&a.parentNode.removeChild(a)};var l=a.querySelector(".name");l.innerText=u;var f=a.querySelector(".value");f&&(f.value=o,f.addEventListener("blur",function(h){this.focus()}),f.addEventListener("keydown",function(h){if(a.is_modified=!0,h.keyCode==27)a.close();else if(h.keyCode==13)N();else if(h.keyCode!=13&&h.target.localName!="textarea")return;h.preventDefault(),h.stopPropagation()}));var m=LGraphCanvas.active_canvas,O=m.canvas,d=O.getBoundingClientRect(),g=-20,E=-20;d&&(g-=d.left,E-=d.top),event?(a.style.left=event.clientX+g+"px",a.style.top=event.clientY+E+"px"):(a.style.left=O.width*.5+g+"px",a.style.top=O.height*.5+E+"px");var I=a.querySelector("button");I.addEventListener("click",N),O.parentNode.appendChild(a),f&&f.focus();var k=null;a.addEventListener("mouseleave",function(h){LiteGraph.dialog_close_on_mouse_leave&&!a.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(k=setTimeout(a.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),a.addEventListener("mouseenter",function(h){LiteGraph.dialog_close_on_mouse_leave&&k&&clearTimeout(k)});function N(){f&&T(f.value)}function T(h){e.type=="Number"?h=Number(h):e.type=="Boolean"&&(h=!!h),n[u]=h,a.parentNode&&a.parentNode.removeChild(a),n.setDirtyCanvas(!0,!0)}},LGraphCanvas.prototype.prompt=function(e,t,s,r,n){var u=this;e=e||"";var o=document.createElement("div");o.is_modified=!1,o.className="graphdialog rounded",n?o.innerHTML="<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":o.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",o.close=function(){u.prompt_box=null,o.parentNode&&o.parentNode.removeChild(o)};var a=LGraphCanvas.active_canvas,l=a.canvas;l.parentNode.appendChild(o),this.ds.scale>1&&(o.style.transform="scale("+this.ds.scale+")");var f=null,m=!1;LiteGraph.pointerListenerAdd(o,"leave",function(h){m||LiteGraph.dialog_close_on_mouse_leave&&!o.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(o.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),LiteGraph.pointerListenerAdd(o,"enter",function(h){LiteGraph.dialog_close_on_mouse_leave&&f&&clearTimeout(f)});var O=o.querySelectorAll("select");O&&O.forEach(function(h){h.addEventListener("click",function(L){m++}),h.addEventListener("blur",function(L){m=0}),h.addEventListener("change",function(L){m=-1})}),u.prompt_box&&u.prompt_box.close(),u.prompt_box=o;var d=o.querySelector(".name");d.innerText=e;var g=o.querySelector(".value");g.value=t;var E=g;E.addEventListener("keydown",function(h){if(o.is_modified=!0,h.keyCode==27)o.close();else if(h.keyCode==13&&h.target.localName!="textarea")s&&s(this.value),o.close();else return;h.preventDefault(),h.stopPropagation()});var I=o.querySelector("button");I.addEventListener("click",function(h){s&&s(E.value),u.setDirty(!0),o.close()});var k=l.getBoundingClientRect(),N=-20,T=-20;return k&&(N-=k.left,T-=k.top),r?(o.style.left=r.clientX+N+"px",o.style.top=r.clientY+T+"px"):(o.style.left=l.width*.5+N+"px",o.style.top=l.height*.5+T+"px"),setTimeout(function(){E.focus()},10),o},LGraphCanvas.search_limit=-1,LGraphCanvas.prototype.showSearchBox=function(e,t){var s={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};t=Object.assign(s,t||{});var r=this,n=LGraphCanvas.active_canvas,u=n.canvas,o=u.ownerDocument||document,a=document.createElement("div");if(a.className="litegraph litesearchbox graphdialog rounded",a.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(a.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",a.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),a.innerHTML+="<div class='helper'></div>",o.fullscreenElement?o.fullscreenElement.appendChild(a):(o.body.appendChild(a),o.body.style.overflow="hidden"),t.do_type_filter)var l=a.querySelector(".slot_in_type_filter"),f=a.querySelector(".slot_out_type_filter");if(a.close=function(){r.search_box=null,this.blur(),u.focus(),o.body.style.overflow="",setTimeout(function(){r.canvas.focus()},20),a.parentNode&&a.parentNode.removeChild(a)},this.ds.scale>1&&(a.style.transform="scale("+this.ds.scale+")"),t.hide_on_mouse_leave){var m=!1,O=null;LiteGraph.pointerListenerAdd(a,"enter",function(Y){O&&(clearTimeout(O),O=null)}),LiteGraph.pointerListenerAdd(a,"leave",function(Y){m||(O=setTimeout(function(){a.close()},500))}),t.do_type_filter&&(l.addEventListener("click",function(Y){m++}),l.addEventListener("blur",function(Y){m=0}),l.addEventListener("change",function(Y){m=-1}),f.addEventListener("click",function(Y){m++}),f.addEventListener("blur",function(Y){m=0}),f.addEventListener("change",function(Y){m=-1}))}r.search_box&&r.search_box.close(),r.search_box=a;var d=a.querySelector(".helper"),g=null,E=null,I=null,k=a.querySelector("input");if(k&&(k.addEventListener("blur",function(Y){r.search_box&&this.focus()}),k.addEventListener("keydown",function(Y){if(Y.keyCode==38)H(!1);else if(Y.keyCode==40)H(!0);else if(Y.keyCode==27)a.close();else if(Y.keyCode==13)V(),I?F(I.innerHTML):g?F(g):a.close();else{E&&clearInterval(E),E=setTimeout(V,250);return}return Y.preventDefault(),Y.stopPropagation(),Y.stopImmediatePropagation(),!0})),t.do_type_filter){if(l){var N=LiteGraph.slot_types_in,T=N.length;(t.type_filter_in==LiteGraph.EVENT||t.type_filter_in==LiteGraph.ACTION)&&(t.type_filter_in="_event_");for(var h=0;h<T;h++){var L=document.createElement("option");L.value=N[h],L.innerHTML=N[h],l.appendChild(L),t.type_filter_in!==!1&&(t.type_filter_in+"").toLowerCase()==(N[h]+"").toLowerCase()&&(L.selected=!0)}l.addEventListener("change",function(){V()})}if(f){var N=LiteGraph.slot_types_out,T=N.length;(t.type_filter_out==LiteGraph.EVENT||t.type_filter_out==LiteGraph.ACTION)&&(t.type_filter_out="_event_");for(var h=0;h<T;h++){var L=document.createElement("option");L.value=N[h],L.innerHTML=N[h],f.appendChild(L),t.type_filter_out!==!1&&(t.type_filter_out+"").toLowerCase()==(N[h]+"").toLowerCase()&&(L.selected=!0)}f.addEventListener("change",function(){V()})}}var _=u.getBoundingClientRect(),D=(e?e.clientX:_.left+_.width*.5)-80,B=(e?e.clientY:_.top+_.height*.5)-20;a.style.left=D+"px",a.style.top=B+"px",e.layerY>_.height-200&&(d.style.maxHeight=_.height-e.layerY-20+"px"),k.focus(),t.show_all_on_open&&V();function F(Y){if(Y)if(r.onSearchBoxSelection)r.onSearchBoxSelection(Y,e,n);else{var K=LiteGraph.searchbox_extras[Y.toLowerCase()];K&&(Y=K.type),n.graph.beforeChange();var J=LiteGraph.createNode(Y);if(J&&(J.pos=n.convertEventToCanvasOffset(e),n.graph.add(J,!1)),K&&K.data){if(K.data.properties)for(var C in K.data.properties)J.addProperty(C,K.data.properties[C]);if(K.data.inputs){J.inputs=[];for(var C in K.data.inputs)J.addOutput(K.data.inputs[C][0],K.data.inputs[C][1])}if(K.data.outputs){J.outputs=[];for(var C in K.data.outputs)J.addOutput(K.data.outputs[C][0],K.data.outputs[C][1])}K.data.title&&(J.title=K.data.title),K.data.json&&J.configure(K.data.json)}if(t.node_from){var R=!1;switch(typeof t.slot_from){case"string":R=t.node_from.findOutputSlot(t.slot_from);break;case"object":t.slot_from.name?R=t.node_from.findOutputSlot(t.slot_from.name):R=-1,R==-1&&typeof t.slot_from.slot_index<"u"&&(R=t.slot_from.slot_index);break;case"number":R=t.slot_from;break;default:R=0}typeof t.node_from.outputs[R]<"u"&&R!==!1&&R>-1&&t.node_from.connectByType(R,J,t.node_from.outputs[R].type)}if(t.node_to){var R=!1;switch(typeof t.slot_from){case"string":R=t.node_to.findInputSlot(t.slot_from);break;case"object":t.slot_from.name?R=t.node_to.findInputSlot(t.slot_from.name):R=-1,R==-1&&typeof t.slot_from.slot_index<"u"&&(R=t.slot_from.slot_index);break;case"number":R=t.slot_from;break;default:R=0}typeof t.node_to.inputs[R]<"u"&&R!==!1&&R>-1&&t.node_to.connectByTypeOutput(R,J,t.node_to.inputs[R].type)}n.graph.afterChange()}a.close()}function H(Y){var K=I;I&&I.classList.remove("selected"),I?(I=Y?I.nextSibling:I.previousSibling,I||(I=K)):I=Y?d.childNodes[0]:d.childNodes[d.childNodes.length],I&&(I.classList.add("selected"),I.scrollIntoView({block:"end",behavior:"smooth"}))}function V(){E=null;var Y=k.value;if(g=null,d.innerHTML="",!Y&&!t.show_all_if_empty)return;if(r.onSearchBox){var K=r.onSearchBox(d,Y,n);if(K)for(var J=0;J<K.length;++J)X(K[J])}else{let tt=function(et,c){var c=c||{},G={skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},M=Object.assign(G,c),U=LiteGraph.registered_node_types[et];if(R&&U.filter!=R||(!t.show_all_if_empty||Y)&&et.toLowerCase().indexOf(Y)===-1)return!1;if(t.do_type_filter&&!M.skipFilter){var q=et,Q=b.value;if(M.inTypeOverride!==!1&&(Q=M.inTypeOverride),b&&Q&&LiteGraph.registered_slot_in_types[Q]&&LiteGraph.registered_slot_in_types[Q].nodes){var j=LiteGraph.registered_slot_in_types[Q].nodes.includes(q);if(j===!1)return!1}var Q=z.value;if(M.outTypeOverride!==!1&&(Q=M.outTypeOverride),z&&Q&&LiteGraph.registered_slot_out_types[Q]&&LiteGraph.registered_slot_out_types[Q].nodes){var j=LiteGraph.registered_slot_out_types[Q].nodes.includes(q);if(j===!1)return!1}}return!0};var Z=tt,C=0;Y=Y.toLowerCase();var R=n.filter||n.graph.filter;if(t.do_type_filter&&r.search_box)var b=r.search_box.querySelector(".slot_in_type_filter"),z=r.search_box.querySelector(".slot_out_type_filter");else var b=!1,z=!1;for(var J in LiteGraph.searchbox_extras){var S=LiteGraph.searchbox_extras[J];if(!((!t.show_all_if_empty||Y)&&S.desc.toLowerCase().indexOf(Y)===-1)){var A=LiteGraph.registered_node_types[S.type];if(!(A&&A.filter!=R)&&tt(S.type)&&(X(S.desc,"searchbox_extra"),LGraphCanvas.search_limit!==-1&&C++>LGraphCanvas.search_limit))break}}var P=null;if(Array.prototype.filter)var W=Object.keys(LiteGraph.registered_node_types),P=W.filter(tt);else{P=[];for(var J in LiteGraph.registered_node_types)tt(J)&&P.push(J)}for(var J=0;J<P.length&&(X(P[J]),!(LGraphCanvas.search_limit!==-1&&C++>LGraphCanvas.search_limit));J++);if(t.show_general_after_typefiltered&&(b.value||z.value)){filtered_extra=[];for(var J in LiteGraph.registered_node_types)tt(J,{inTypeOverride:b&&b.value?"*":!1,outTypeOverride:z&&z.value?"*":!1})&&filtered_extra.push(J);for(var J=0;J<filtered_extra.length&&(X(filtered_extra[J],"generic_type"),!(LGraphCanvas.search_limit!==-1&&C++>LGraphCanvas.search_limit));J++);}if((b.value||z.value)&&d.childNodes.length==0&&t.show_general_if_none_on_typefilter){filtered_extra=[];for(var J in LiteGraph.registered_node_types)tt(J,{skipFilter:!0})&&filtered_extra.push(J);for(var J=0;J<filtered_extra.length&&(X(filtered_extra[J],"not_in_filter"),!(LGraphCanvas.search_limit!==-1&&C++>LGraphCanvas.search_limit));J++);}}function X(tt,et){var it=document.createElement("div");g||(g=tt),it.innerText=tt,it.dataset.type=escape(tt),it.className="litegraph lite-search-item",et&&(it.className+=" "+et),it.addEventListener("click",function(c){F(unescape(this.dataset.type))}),d.appendChild(it)}}return a},LGraphCanvas.prototype.showEditPropertyValue=function(e,t,s){if(!e||e.properties[t]===void 0)return;s=s||{};var r=e.getPropertyInfo(t),n=r.type,u="";if(n=="string"||n=="number"||n=="array"||n=="object")u="<input autofocus type='text' class='value'/>";else if((n=="enum"||n=="combo")&&r.values){u="<select autofocus type='text' class='value'>";for(var o in r.values){var a=o;r.values.constructor===Array&&(a=r.values[o]),u+="<option value='"+a+"' "+(a==e.properties[t]?"selected":"")+">"+r.values[o]+"</option>"}u+="</select>"}else if(n=="boolean"||n=="toggle")u="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>";else{console.warn("unknown type: "+n);return}var l=this.createDialog("<span class='name'>"+(r.label?r.label:t)+"</span>"+u+"<button>OK</button>",s),f=!1;if((n=="enum"||n=="combo")&&r.values)f=l.querySelector("select"),f.addEventListener("change",function(g){l.modified(),d(g.target.value)});else if(n=="boolean"||n=="toggle")f=l.querySelector("input"),f&&f.addEventListener("click",function(g){l.modified(),d(!!f.checked)});else if(f=l.querySelector("input"),f){f.addEventListener("blur",function(E){this.focus()});var a=e.properties[t]!==void 0?e.properties[t]:"";n!=="string"&&(a=JSON.stringify(a)),f.value=a,f.addEventListener("keydown",function(E){if(E.keyCode==27)l.close();else if(E.keyCode==13)O();else if(E.keyCode!=13){l.modified();return}E.preventDefault(),E.stopPropagation()})}f&&f.focus();var m=l.querySelector("button");m.addEventListener("click",O);function O(){d(f.value)}function d(g){r&&r.values&&r.values.constructor===Object&&r.values[g]!=null&&(g=r.values[g]),typeof e.properties[t]=="number"&&(g=Number(g)),(n=="array"||n=="object")&&(g=JSON.parse(g)),e.properties[t]=g,e.graph&&e.graph._version++,e.onPropertyChanged&&e.onPropertyChanged(t,g),s.onclose&&s.onclose(),l.close(),e.setDirtyCanvas(!0,!0)}return l},LGraphCanvas.prototype.createDialog=function(e,t){var s={checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0};t=Object.assign(s,t||{});var r=document.createElement("div");r.className="graphdialog",r.innerHTML=e,r.is_modified=!1;var n=this.canvas.getBoundingClientRect(),u=-20,o=-20;if(n&&(u-=n.left,o-=n.top),t.position?(u+=t.position[0],o+=t.position[1]):t.event?(u+=t.event.clientX,o+=t.event.clientY):(u+=this.canvas.width*.5,o+=this.canvas.height*.5),r.style.left=u+"px",r.style.top=o+"px",this.canvas.parentNode.appendChild(r),t.checkForInput){var a=[],l=!1;(a=r.querySelectorAll("input"))&&a.forEach(function(d){d.addEventListener("keydown",function(g){if(r.modified(),g.keyCode==27)r.close();else if(g.keyCode!=13)return;g.preventDefault(),g.stopPropagation()}),l||d.focus()})}r.modified=function(){r.is_modified=!0},r.close=function(){r.parentNode&&r.parentNode.removeChild(r)};var f=null,m=!1;r.addEventListener("mouseleave",function(d){m||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!r.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(f=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))}),r.addEventListener("mouseenter",function(d){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&f&&clearTimeout(f)});var O=r.querySelectorAll("select");return O&&O.forEach(function(d){d.addEventListener("click",function(g){m++}),d.addEventListener("blur",function(g){m=0}),d.addEventListener("change",function(g){m=-1})}),r},LGraphCanvas.prototype.createPanel=function(e,t){t=t||{};var s=t.window||window,r=document.createElement("div");if(r.className="litegraph dialog",r.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",r.header=r.querySelector(".dialog-header"),t.width&&(r.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(r.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",function(){r.close()}),r.header.appendChild(n)}return r.title_element=r.querySelector(".dialog-title"),r.title_element.innerText=e,r.content=r.querySelector(".dialog-content"),r.alt_content=r.querySelector(".dialog-alt-content"),r.footer=r.querySelector(".dialog-footer"),r.close=function(){r.onClose&&typeof r.onClose=="function"&&r.onClose(),r.parentNode&&r.parentNode.removeChild(r),this.parentNode&&this.parentNode.removeChild(this)},r.toggleAltContent=function(u){if(typeof u<"u")var o=u?"block":"none",a=u?"none":"block";else var o=r.alt_content.style.display!="block"?"block":"none",a=r.alt_content.style.display!="block"?"none":"block";r.alt_content.style.display=o,r.content.style.display=a},r.toggleFooterVisibility=function(u){if(typeof u<"u")var o=u?"block":"none";else var o=r.footer.style.display!="block"?"block":"none";r.footer.style.display=o},r.clear=function(){this.content.innerHTML=""},r.addHTML=function(u,o,a){var l=document.createElement("div");return o&&(l.className=o),l.innerHTML=u,a?r.footer.appendChild(l):r.content.appendChild(l),l},r.addButton=function(u,o,a){var l=document.createElement("button");return l.innerText=u,l.options=a,l.classList.add("btn"),l.addEventListener("click",o),r.footer.appendChild(l),l},r.addSeparator=function(){var u=document.createElement("div");u.className="separator",r.content.appendChild(u)},r.addWidget=function(u,o,a,l,f){l=l||{};var m=String(a);u=u.toLowerCase(),u=="number"&&(m=a.toFixed(3));var O=document.createElement("div");O.className="property",O.innerHTML="<span class='property_name'></span><span class='property_value'></span>",O.querySelector(".property_name").innerText=l.label||o;var d=O.querySelector(".property_value");if(d.innerText=m,O.dataset.property=o,O.dataset.type=l.type||u,O.options=l,O.value=a,u=="code")O.addEventListener("click",function(E){r.inner_showCodePad(this.dataset.property)});else if(u=="boolean")O.classList.add("boolean"),a&&O.classList.add("bool-on"),O.addEventListener("click",function(){var E=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",g(E,this.value)});else if(u=="string"||u=="number")d.setAttribute("contenteditable",!0),d.addEventListener("keydown",function(E){E.code=="Enter"&&(u!="string"||!E.shiftKey)&&(E.preventDefault(),this.blur())}),d.addEventListener("blur",function(){var E=this.innerText,I=this.parentNode.dataset.property,k=this.parentNode.dataset.type;k=="number"&&(E=Number(E)),g(I,E)});else if(u=="enum"||u=="combo"){var m=LGraphCanvas.getPropertyPrintableValue(a,l.values);d.innerText=m,d.addEventListener("click",function(I){var k=l.values||[],N=this.parentNode.dataset.property,T=this;new LiteGraph.ContextMenu(k,{event:I,className:"dark",callback:h},s);function h(L,_,D){return T.innerText=L,g(N,L),!1}})}r.content.appendChild(O);function g(E,I){l.callback&&l.callback(E,I,l),f&&f(E,I,l)}return O},r.onOpen&&typeof r.onOpen=="function"&&r.onOpen(),r},LGraphCanvas.getPropertyPrintableValue=function(e,t){if(!t||t.constructor===Array)return String(e);if(t.constructor===Object){var s="";for(var r in t)if(t[r]==e){s=r;break}return String(e)+" ("+s+")"}},LGraphCanvas.prototype.closePanels=function(){var e=document.querySelector("#node-panel");e&&e.close();var e=document.querySelector("#option-panel");e&&e.close()},LGraphCanvas.prototype.showShowGraphOptionsPanel=function(e,t,s,r){if(this.constructor&&this.constructor.name=="HTMLDivElement"){if(!t||!t.event||!t.event.target||!t.event.target.lgraphcanvas){console.warn("Canvas not found");return}var n=t.event.target.lgraphcanvas}else var n=this;n.closePanels();var u=n.getCanvasWindow();panel=n.createPanel("Options",{closable:!0,window:u,onOpen:function(){n.OPTIONPANEL_IS_OPEN=!0},onClose:function(){n.OPTIONPANEL_IS_OPEN=!1,n.options_panel=null}}),n.options_panel=panel,panel.id="option-panel",panel.classList.add("settings");function o(){panel.content.innerHTML="";var a=function(O,d,g){g&&g.key&&(O=g.key),g.values&&(d=Object.values(g.values).indexOf(d)),n[O]=d},l=LiteGraph.availableCanvasOptions;l.sort();for(var f in l){var m=l[f];panel.addWidget("boolean",m,n[m],{key:m,on:"True",off:"False"},a)}n.links_render_mode,panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[n.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},a),panel.addSeparator(),panel.footer.innerHTML=""}o(),n.canvas.parentNode.appendChild(panel)},LGraphCanvas.prototype.showShowNodePanel=function(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),s=this,r=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){s.NODEPANEL_IS_OPEN=!0},onClose:function(){s.NODEPANEL_IS_OPEN=!1,s.node_panel=null}});s.node_panel=r,r.id="node-panel",r.node=e,r.classList.add("settings");function n(){r.content.innerHTML="",r.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),r.addHTML("<h3>Properties</h3>");var u=function(m,O){switch(s.graph.beforeChange(e),m){case"Title":e.title=O;break;case"Mode":var d=Object.values(LiteGraph.NODE_MODES).indexOf(O);d>=0&&LiteGraph.NODE_MODES[d]?e.changeMode(d):console.warn("unexpected mode: "+O);break;case"Color":LGraphCanvas.node_colors[O]?(e.color=LGraphCanvas.node_colors[O].color,e.bgcolor=LGraphCanvas.node_colors[O].bgcolor):console.warn("unexpected color: "+O);break;default:e.setProperty(m,O);break}s.graph.afterChange(),s.dirty_canvas=!0};r.addWidget("string","Title",e.title,{},u),r.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},u);var o="";e.color!==void 0&&(o=Object.keys(LGraphCanvas.node_colors).filter(function(m){return LGraphCanvas.node_colors[m].color==e.color})),r.addWidget("combo","Color",o,{values:Object.keys(LGraphCanvas.node_colors)},u);for(var a in e.properties){var l=e.properties[a],f=e.getPropertyInfo(a);f.type,!(e.onAddPropertyToPanel&&e.onAddPropertyToPanel(a,r))&&r.addWidget(f.widget||f.type,a,l,f,u)}r.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(r),r.footer.innerHTML="",r.addButton("Delete",function(){e.block_delete||(e.graph.remove(e),r.close())}).classList.add("delete")}r.inner_showCodePad=function(u){r.classList.remove("settings"),r.classList.add("centered"),r.alt_content.innerHTML="<textarea class='code'></textarea>";var o=r.alt_content.querySelector("textarea"),a=function(){r.toggleAltContent(!1),r.toggleFooterVisibility(!0),o.parentNode.removeChild(o),r.classList.add("settings"),r.classList.remove("centered"),n()};o.value=e.properties[u],o.addEventListener("keydown",function(m){m.code=="Enter"&&m.ctrlKey&&(e.setProperty(u,o.value),a())}),r.toggleAltContent(!0),r.toggleFooterVisibility(!1),o.style.height="calc(100% - 40px)";var l=r.addButton("Assign",function(){e.setProperty(u,o.value),a()});r.alt_content.appendChild(l);var f=r.addButton("Close",a);f.style.float="right",r.alt_content.appendChild(f)},n(),this.canvas.parentNode.appendChild(r)},LGraphCanvas.prototype.showSubgraphPropertiesDialog=function(e){console.log("showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var s=this.createPanel("Subgraph Inputs",{closable:!0,width:500});s.node=e,s.classList.add("subgraph_dialog");function r(){if(s.clear(),e.inputs)for(var o=0;o<e.inputs.length;++o){var a=e.inputs[o];if(!a.not_subgraph_input){var l="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",f=s.addHTML(l,"subgraph_property");f.dataset.name=a.name,f.dataset.slot=o,f.querySelector(".name").innerText=a.name,f.querySelector(".type").innerText=a.type,f.querySelector("button").addEventListener("click",function(m){e.removeInput(Number(this.parentNode.dataset.slot)),r()})}}}var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",u=s.addHTML(n,"subgraph_property extra",!0);return u.querySelector("button").addEventListener("click",function(o){var a=this.parentNode,l=a.querySelector(".name").value,f=a.querySelector(".type").value;!l||e.findInputSlot(l)!=-1||(e.addInput(l,f),a.querySelector(".name").value="",a.querySelector(".type").value="",r())}),r(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.showSubgraphPropertiesDialogRight=function(e){var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var s=this.createPanel("Subgraph Outputs",{closable:!0,width:500});s.node=e,s.classList.add("subgraph_dialog");function r(){if(s.clear(),e.outputs)for(var a=0;a<e.outputs.length;++a){var l=e.outputs[a];if(!l.not_subgraph_output){var f="<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>",m=s.addHTML(f,"subgraph_property");m.dataset.name=l.name,m.dataset.slot=a,m.querySelector(".name").innerText=l.name,m.querySelector(".type").innerText=l.type,m.querySelector("button").addEventListener("click",function(O){e.removeOutput(Number(this.parentNode.dataset.slot)),r()})}}}var n=" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>",u=s.addHTML(n,"subgraph_property extra",!0);u.querySelector(".name").addEventListener("keydown",function(a){a.keyCode==13&&o.apply(this)}),u.querySelector("button").addEventListener("click",function(a){o.apply(this)});function o(){var a=this.parentNode,l=a.querySelector(".name").value,f=a.querySelector(".type").value;!l||e.findOutputSlot(l)!=-1||(e.addOutput(l,f),a.querySelector(".name").value="",a.querySelector(".type").value="",r())}return r(),this.canvas.parentNode.appendChild(s),s},LGraphCanvas.prototype.checkPanels=function(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),t=0;t<e.length;++t){var s=e[t];s.node&&(!s.node.graph||s.graph!=this.graph)&&s.close()}},LGraphCanvas.onMenuNodeCollapse=function(e,t,s,r,n){n.graph.beforeChange();var u=function(l){l.collapse()},o=LGraphCanvas.active_canvas;if(!o.selected_nodes||Object.keys(o.selected_nodes).length<=1)u(n);else for(var a in o.selected_nodes)u(o.selected_nodes[a]);n.graph.afterChange()},LGraphCanvas.onMenuNodePin=function(e,t,s,r,n){n.pin()},LGraphCanvas.onMenuNodeMode=function(e,t,s,r,n){new LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:s,callback:u,parentMenu:r,node:n});function u(o){if(n){var a=Object.values(LiteGraph.NODE_MODES).indexOf(o),l=function(O){a>=0&&LiteGraph.NODE_MODES[a]?O.changeMode(a):(console.warn("unexpected mode: "+o),O.changeMode(LiteGraph.ALWAYS))},f=LGraphCanvas.active_canvas;if(!f.selected_nodes||Object.keys(f.selected_nodes).length<=1)l(n);else for(var m in f.selected_nodes)l(f.selected_nodes[m])}}return!1},LGraphCanvas.onMenuNodeColors=function(e,t,s,r,n){if(!n)throw"no node for color";var u=[];u.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(var o in LGraphCanvas.node_colors){var a=LGraphCanvas.node_colors[o],e={value:o,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+a.color+"; background-color:"+a.bgcolor+"'>"+o+"</span>"};u.push(e)}new LiteGraph.ContextMenu(u,{event:s,callback:l,parentMenu:r,node:n});function l(f){if(n){var m=f.value?LGraphCanvas.node_colors[f.value]:null,O=function(E){m?E.constructor===LiteGraph.LGraphGroup?E.color=m.groupcolor:(E.color=m.color,E.bgcolor=m.bgcolor):(delete E.color,delete E.bgcolor)},d=LGraphCanvas.active_canvas;if(!d.selected_nodes||Object.keys(d.selected_nodes).length<=1)O(n);else for(var g in d.selected_nodes)O(d.selected_nodes[g]);n.setDirtyCanvas(!0,!0)}}return!1},LGraphCanvas.onMenuNodeShapes=function(e,t,s,r,n){if(!n)throw"no node passed";new LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:s,callback:u,parentMenu:r,node:n});function u(o){if(n){n.graph.beforeChange();var a=function(m){m.shape=o},l=LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)a(n);else for(var f in l.selected_nodes)a(l.selected_nodes[f]);n.graph.afterChange(),n.setDirtyCanvas(!0)}}return!1},LGraphCanvas.onMenuNodeRemove=function(e,t,s,r,n){if(!n)throw"no node passed";var u=n.graph;u.beforeChange();var o=function(f){f.removable!==!1&&u.remove(f)},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(n);else for(var l in a.selected_nodes)o(a.selected_nodes[l]);u.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodeToSubgraph=function(e,t,s,r,n){var u=n.graph,o=LGraphCanvas.active_canvas;if(o){var a=Object.values(o.selected_nodes||{});a.length||(a=[n]);var l=LiteGraph.createNode("graph/subgraph");l.pos=n.pos.concat(),u.add(l),l.buildFromNodes(a),o.deselectAllNodes(),n.setDirtyCanvas(!0,!0)}},LGraphCanvas.onMenuNodeClone=function(e,t,s,r,n){n.graph.beforeChange();var u={},o=function(f){if(f.clonable!==!1){var m=f.clone();m&&(m.pos=[f.pos[0]+5,f.pos[1]+5],f.graph.add(m),u[m.id]=m)}},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(n);else for(var l in a.selected_nodes)o(a.selected_nodes[l]);Object.keys(u).length&&a.selectNodes(u),n.graph.afterChange(),n.setDirtyCanvas(!0,!0)},LGraphCanvas.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var e=null;if(this.getMenuOptions?e=this.getMenuOptions():(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var t=this.getExtraMenuOptions(this,e);t&&(e=e.concat(t))}return e},LGraphCanvas.prototype.getNodeMenuOptions=function(e){var t=null;if(e.getMenuOptions?t=e.getMenuOptions(this):(t=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],e.resizable!==!1&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),e.onGetInputs){var s=e.onGetInputs();s&&s.length&&(t[0].disabled=!1)}if(e.onGetOutputs){var r=e.onGetOutputs();r&&r.length&&(t[1].disabled=!1)}if(e.getExtraMenuOptions){var n=e.getExtraMenuOptions(this,t);n&&(n.push(null),t=n.concat(t))}return e.clonable!==!1&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(e.removable!==!1&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.onGetNodeMenuOptions&&e.graph.onGetNodeMenuOptions(t,e),t},LGraphCanvas.prototype.getGroupMenuOptions=function(e){var t=[{content:"Title",callback:LGraphCanvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowPropertyEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}];return t},LGraphCanvas.prototype.processContextMenu=function(e,t){var s=this,r=LGraphCanvas.active_canvas,n=r.getCanvasWindow(),u=null,o={event:t,callback:m,extra:e};e&&(o.title=e.type);var a=null;if(e&&(a=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),a){if(u=[],e.getSlotMenuOptions)u=e.getSlotMenuOptions(a);else{a&&a.output&&a.output.links&&a.output.links.length&&u.push({content:"Disconnect Links",slot:a});var l=a.input||a.output;l.removable&&u.push(l.locked?"Cannot remove":{content:"Remove Slot",slot:a}),l.nameLocked||u.push({content:"Rename Slot",slot:a})}o.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==LiteGraph.ACTION&&(o.title="Action"),a.output&&a.output.type==LiteGraph.EVENT&&(o.title="Event")}else if(e)u=this.getNodeMenuOptions(e);else{u=this.getCanvasMenuOptions();var f=this.graph.getGroupOnPos(t.canvasX,t.canvasY);f&&u.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:f,options:this.getGroupMenuOptions(f)}})}if(!u)return;new LiteGraph.ContextMenu(u,o,n);function m(O,d,g){if(O){if(O.content=="Remove Slot"){var E=O.slot;e.graph.beforeChange(),E.input?e.removeInput(E.slot):E.output&&e.removeOutput(E.slot),e.graph.afterChange();return}else if(O.content=="Disconnect Links"){var E=O.slot;e.graph.beforeChange(),E.output?e.disconnectOutput(E.slot):E.input&&e.disconnectInput(E.slot),e.graph.afterChange();return}else if(O.content=="Rename Slot"){var E=O.slot,I=E.input?e.getInputInfo(E.slot):e.getOutputInfo(E.slot),k=s.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",d),N=k.querySelector("input");N&&I&&(N.value=I.label||"");var T=function(){e.graph.beforeChange(),N.value&&(I&&(I.label=N.value),s.setDirty(!0)),k.close(),e.graph.afterChange()};k.querySelector("button").addEventListener("click",T),N.addEventListener("keydown",function(L){if(k.is_modified=!0,L.keyCode==27)k.close();else if(L.keyCode==13)T();else if(L.keyCode!=13&&L.target.localName!="textarea")return;L.preventDefault(),L.stopPropagation()}),N.focus()}}}};function compareObjects(e,t){for(var s in e)if(e[s]!=t[s])return!1;return!0}LiteGraph.compareObjects=compareObjects;function distance(e,t){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))}LiteGraph.distance=distance;function colorToString(e){return"rgba("+Math.round(e[0]*255).toFixed()+","+Math.round(e[1]*255).toFixed()+","+Math.round(e[2]*255).toFixed()+","+(e.length==4?e[3].toFixed(2):"1.0")+")"}LiteGraph.colorToString=colorToString;function isInsideRectangle(e,t,s,r,n,u){return s<e&&s+n>e&&r<t&&r+u>t}LiteGraph.isInsideRectangle=isInsideRectangle;function growBounding(e,t,s){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),s<e[1]?e[1]=s:s>e[3]&&(e[3]=s)}LiteGraph.growBounding=growBounding;function isInsideBounding(e,t){return!(e[0]<t[0][0]||e[1]<t[0][1]||e[0]>t[1][0]||e[1]>t[1][1])}LiteGraph.isInsideBounding=isInsideBounding;function overlapBounding(e,t){var s=e[0]+e[2],r=e[1]+e[3],n=t[0]+t[2],u=t[1]+t[3];return!(e[0]>n||e[1]>u||s<t[0]||r<t[1])}LiteGraph.overlapBounding=overlapBounding;function hex2num(e){e.charAt(0)=="#"&&(e=e.slice(1)),e=e.toUpperCase();for(var t="0123456789ABCDEF",s=new Array(3),r=0,n,u,o=0;o<6;o+=2)n=t.indexOf(e.charAt(o)),u=t.indexOf(e.charAt(o+1)),s[r]=n*16+u,r++;return s}LiteGraph.hex2num=hex2num;function num2hex(e){for(var t="0123456789ABCDEF",s="#",r,n,u=0;u<3;u++)r=e[u]/16,n=e[u]%16,s+=t.charAt(r)+t.charAt(n);return s}LiteGraph.num2hex=num2hex;function ContextMenu(e,t){t=t||{},this.options=t;var s=this;t.parentMenu&&(t.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),t.parentMenu=null):(this.parentMenu=t.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this));var r=null;t.event&&(r=t.event.constructor.name),r!=="MouseEvent"&&r!=="CustomEvent"&&r!=="PointerEvent"&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. ("+r+")"),t.event=null);var n=document.createElement("div");n.className="litegraph litecontextmenu litemenubar-panel",t.className&&(n.className+=" "+t.className),n.style.minWidth=100,n.style.minHeight=100,n.style.pointerEvents="none",setTimeout(function(){n.style.pointerEvents="auto"},100),LiteGraph.pointerListenerAdd(n,"up",function(k){return k.preventDefault(),!0},!0),n.addEventListener("contextmenu",function(k){return k.button!=2||k.preventDefault(),!1},!0),LiteGraph.pointerListenerAdd(n,"down",function(k){if(k.button==2)return s.close(),k.preventDefault(),!0},!0);function u(k){var N=parseInt(n.style.top);return n.style.top=(N+k.deltaY*t.scroll_speed).toFixed()+"px",k.preventDefault(),!0}if(t.scroll_speed||(t.scroll_speed=.1),n.addEventListener("wheel",u,!0),n.addEventListener("mousewheel",u,!0),this.root=n,t.title){var o=document.createElement("div");o.className="litemenu-title",o.innerHTML=t.title,n.appendChild(o)}for(var a=0;a<e.length;a++){var l=e.constructor==Array?e[a]:a;l!=null&&l.constructor!==String&&(l=l.content===void 0?String(l):l.content);var f=e[a];this.addItem(l,f,t)}LiteGraph.pointerListenerAdd(n,"enter",function(k){n.closing_timer&&clearTimeout(n.closing_timer)});var m=document;t.event&&(m=t.event.target.ownerDocument),m||(m=document),m.fullscreenElement?m.fullscreenElement.appendChild(n):m.body.appendChild(n);var O=t.left||0,d=t.top||0;if(t.event){if(O=t.event.clientX-10,d=t.event.clientY-10,t.title&&(d-=20),t.parentMenu){var g=t.parentMenu.root.getBoundingClientRect();O=g.left+g.width}var E=document.body.getBoundingClientRect(),I=n.getBoundingClientRect();E.height==0&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),E.width&&O>E.width-I.width-10&&(O=E.width-I.width-10),E.height&&d>E.height-I.height-10&&(d=E.height-I.height-10)}n.style.left=O+"px",n.style.top=d+"px",t.scale&&(n.style.transform="scale("+t.scale+")")}ContextMenu.prototype.addItem=function(e,t,s){var r=this;s=s||{};var n=document.createElement("div");n.className="litemenu-entry submenu";var u=!1;t===null?n.classList.add("separator"):(n.innerHTML=t&&t.title?t.title:e,n.value=t,t&&(t.disabled&&(u=!0,n.classList.add("disabled")),(t.submenu||t.has_submenu)&&n.classList.add("has_submenu")),typeof t=="function"?(n.dataset.value=e,n.onclick_callback=t):n.dataset.value=t,t.className&&(n.className+=" "+t.className)),this.root.appendChild(n),u||n.addEventListener("click",a),!u&&s.autoopen&&LiteGraph.pointerListenerAdd(n,"enter",o);function o(l){var f=this.value;!f||!f.has_submenu||a.call(this,l)}function a(l){var f=this.value,m=!0;if(r.current_submenu&&r.current_submenu.close(l),s.callback){var O=s.callback.call(this,f,s,l,r,s.node);O===!0&&(m=!1)}if(f){if(f.callback&&!s.ignore_item_callbacks&&f.disabled!==!0){var O=f.callback.call(this,f,s,l,r,s.extra);O===!0&&(m=!1)}if(f.submenu){if(!f.submenu.options)throw"ContextMenu submenu needs options";new r.constructor(f.submenu.options,{callback:f.submenu.callback,event:l,parentMenu:r,ignore_item_callbacks:f.submenu.ignore_item_callbacks,title:f.submenu.title,extra:f.submenu.extra,autoopen:s.autoopen}),m=!1}}m&&!r.lock&&r.close()}return n},ContextMenu.prototype.close=function(e,t){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!t&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,e===void 0?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,LiteGraph.pointerevents_method+"leave",e)),this.current_submenu&&this.current_submenu.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},ContextMenu.trigger=function(e,t,s,r){var n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!0,!0,s),n.srcElement=r,e.dispatchEvent?e.dispatchEvent(n):e.__events&&e.__events.dispatchEvent(n),n},ContextMenu.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},ContextMenu.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},ContextMenu.isCursorOverElement=function(e,t){var s=e.clientX,r=e.clientY,n=t.getBoundingClientRect();return n?r>n.top&&r<n.top+n.height&&s>n.left&&s<n.left+n.width:!1},LiteGraph.ContextMenu=ContextMenu,LiteGraph.closeAllContextMenus=function(e){e=e||window;var t=e.document.querySelectorAll(".litecontextmenu");if(t.length){for(var s=[],r=0;r<t.length;r++)s.push(t[r]);for(var r=0;r<s.length;r++)s[r].close?s[r].close():s[r].parentNode&&s[r].parentNode.removeChild(s[r])}},LiteGraph.extendClass=function(e,t){for(var s in t)e.hasOwnProperty(s)||(e[s]=t[s]);if(t.prototype)for(var s in t.prototype)t.prototype.hasOwnProperty(s)&&(e.prototype.hasOwnProperty(s)||(t.prototype.__lookupGetter__(s)?e.prototype.__defineGetter__(s,t.prototype.__lookupGetter__(s)):e.prototype[s]=t.prototype[s],t.prototype.__lookupSetter__(s)&&e.prototype.__defineSetter__(s,t.prototype.__lookupSetter__(s))))};function CurveEditor(e){this.points=e,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}CurveEditor.sampleCurve=function(e,t){if(t){for(var s=0;s<t.length-1;++s){var r=t[s],n=t[s+1];if(!(n[0]<e)){var u=n[0]-r[0];if(Math.abs(u)<1e-5)return r[1];var o=(e-r[0])/u;return r[1]*(1-o)+n[1]*o}}return 0}},CurveEditor.prototype.draw=function(e,t,s,r,n,u){var o=this.points;if(o){this.size=t;var a=t[0]-this.margin*2,l=t[1]-this.margin*2;n=n||"#666",e.save(),e.translate(this.margin,this.margin),r&&(e.fillStyle="#111",e.fillRect(0,0,a,l),e.fillStyle="#222",e.fillRect(a*.5,0,1,l),e.strokeStyle="#333",e.strokeRect(0,0,a,l)),e.strokeStyle=n,u&&(e.globalAlpha=.5),e.beginPath();for(var f=0;f<o.length;++f){var m=o[f];e.lineTo(m[0]*a,(1-m[1])*l)}if(e.stroke(),e.globalAlpha=1,!u)for(var f=0;f<o.length;++f){var m=o[f];e.fillStyle=this.selected==f?"#FFF":this.nearest==f?"#DDD":"#AAA",e.beginPath(),e.arc(m[0]*a,(1-m[1])*l,2,0,Math.PI*2),e.fill()}e.restore()}},CurveEditor.prototype.onMouseDown=function(e,t){var s=this.points;if(s&&!(e[1]<0)){var r=this.size[0]-this.margin*2,n=this.size[1]-this.margin*2,u=e[0]-this.margin,o=e[1]-this.margin,a=[u,o],l=30/t.ds.scale;if(this.selected=this.getCloserPoint(a,l),this.selected==-1){var f=[u/r,1-o/n];s.push(f),s.sort(function(m,O){return m[0]-O[0]}),this.selected=s.indexOf(f),this.must_update=!0}if(this.selected!=-1)return!0}},CurveEditor.prototype.onMouseMove=function(e,t){var s=this.points;if(s){var r=this.selected;if(!(r<0)){var n=(e[0]-this.margin)/(this.size[0]-this.margin*2),u=(e[1]-this.margin)/(this.size[1]-this.margin*2),o=[e[0]-this.margin,e[1]-this.margin],a=30/t.ds.scale;this._nearest=this.getCloserPoint(o,a);var l=s[r];if(l){var f=r==0||r==s.length-1;if(!f&&(e[0]<-10||e[0]>this.size[0]+10||e[1]<-10||e[1]>this.size[1]+10)){s.splice(r,1),this.selected=-1;return}f?l[0]=r==0?0:1:l[0]=clamp(n,0,1),l[1]=1-clamp(u,0,1),s.sort(function(m,O){return m[0]-O[0]}),this.selected=s.indexOf(l),this.must_update=!0}}}},CurveEditor.prototype.onMouseUp=function(e,t){return this.selected=-1,!1},CurveEditor.prototype.getCloserPoint=function(e,t){var s=this.points;if(!s)return-1;t=t||30;for(var r=this.size[0]-this.margin*2,n=this.size[1]-this.margin*2,u=s.length,o=[0,0],a=1e6,l=-1,f=0;f<u;++f){var m=s[f];o[0]=m[0]*r,o[1]=(1-m[1])*n,o[0]<e[0];var O=vec2.distance(e,o);O>a||O>t||(l=f,a=O)}return l},LiteGraph.CurveEditor=CurveEditor,LiteGraph.getParameterNames=function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},LiteGraph.pointerListenerAdd=function(e,t,s,r=!1){if(!(!e||!e.addEventListener||!t||typeof s!="function")){var n=LiteGraph.pointerevents_method,u=t;if(n=="pointer"&&!window.PointerEvent)switch(console.warn("sMethod=='pointer' && !window.PointerEvent"),console.log("Converting pointer["+u+"] : down move up cancel enter TO touchstart touchmove touchend, etc .."),u){case"down":{n="touch",u="start";break}case"move":{n="touch";break}case"up":{n="touch",u="end";break}case"cancel":{n="touch";break}case"enter":{console.log("debug: Should I send a move event?");break}default:console.warn("PointerEvent not available in this browser ? The event "+u+" would not be called")}switch(u){case"down":case"up":case"move":case"over":case"out":case"enter":e.addEventListener(n+u,s,r);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(n!="mouse")return e.addEventListener(n+u,s,r);default:return e.addEventListener(u,s,r)}}},LiteGraph.pointerListenerRemove=function(e,t,s,r=!1){if(!(!e||!e.removeEventListener||!t||typeof s!="function"))switch(t){case"down":case"up":case"move":case"over":case"out":case"enter":(LiteGraph.pointerevents_method=="pointer"||LiteGraph.pointerevents_method=="mouse")&&e.removeEventListener(LiteGraph.pointerevents_method+t,s,r);case"leave":case"cancel":case"gotpointercapture":case"lostpointercapture":if(LiteGraph.pointerevents_method=="pointer")return e.removeEventListener(LiteGraph.pointerevents_method+t,s,r);default:return e.removeEventListener(t,s,r)}};function clamp(e,t,s){return t>e?t:s<e?s:e}global.clamp=clamp,typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)})})(litegraph),exports$1.LiteGraph=litegraph.LiteGraph,exports$1.LGraph=litegraph.LGraph,exports$1.LLink=litegraph.LLink,exports$1.LGraphNode=litegraph.LGraphNode,exports$1.LGraphGroup=litegraph.LGraphGroup,exports$1.DragAndScale=litegraph.DragAndScale,exports$1.LGraphCanvas=litegraph.LGraphCanvas,exports$1.ContextMenu=litegraph.ContextMenu,(function(e){var t=e.LiteGraph;function s(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}s.title="Time",s.desc="Time",s.prototype.onExecute=function(){this.setOutputData(0,this.graph.globaltime*1e3),this.setOutputData(1,this.graph.globaltime)},t.registerNodeType("basic/time",s);function r(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new t.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}r.title="Subgraph",r.desc="Graph inside a node",r.title_color="#334",r.prototype.onGetInputs=function(){return[["enabled","boolean"]]},r.prototype.onDblClick=function(C,R,b){var z=this;setTimeout(function(){b.openSubgraph(z.subgraph)},10)},r.prototype.onAction=function(C,R){this.subgraph.onAction(C,R)},r.prototype.onExecute=function(){if(this.enabled=this.getInputOrProperty("enabled"),!!this.enabled){if(this.inputs)for(var C=0;C<this.inputs.length;C++){var R=this.inputs[C],b=this.getInputData(C);this.subgraph.setInputData(R.name,b)}if(this.subgraph.runStep(),this.outputs)for(var C=0;C<this.outputs.length;C++){var z=this.outputs[C],b=this.subgraph.getOutputData(z.name);this.setOutputData(C,b)}}},r.prototype.sendEventToAllNodes=function(C,R,b){this.enabled&&this.subgraph.sendEventToAllNodes(C,R,b)},r.prototype.onDrawBackground=function(C,R,b,z){if(this.flags.collapsed)return;var S=this.size[1]-t.NODE_TITLE_HEIGHT+.5,A=t.isInsideRectangle(z[0],z[1],this.pos[0],this.pos[1]+S,this.size[0],t.NODE_TITLE_HEIGHT);let P=t.isInsideRectangle(z[0],z[1],this.pos[0],this.pos[1]+S,this.size[0]/2,t.NODE_TITLE_HEIGHT);C.fillStyle=A?"#555":"#222",C.beginPath(),this._shape==t.BOX_SHAPE?P?C.rect(0,S,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):C.rect(this.size[0]/2,S,this.size[0]/2+1,t.NODE_TITLE_HEIGHT):P?C.roundRect(0,S,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]):C.roundRect(this.size[0]/2,S,this.size[0]/2+1,t.NODE_TITLE_HEIGHT,[0,0,8,8]),A?C.fill():C.fillRect(0,S,this.size[0]+1,t.NODE_TITLE_HEIGHT),C.textAlign="center",C.font="24px Arial",C.fillStyle=A?"#DDD":"#999",C.fillText("+",this.size[0]*.25,S+24),C.fillText("+",this.size[0]*.75,S+24)},r.prototype.onMouseDown=function(C,R,b){var z=this.size[1]-t.NODE_TITLE_HEIGHT+.5;console.log(0),R[1]>z&&(R[0]<this.size[0]/2?(console.log(1),b.showSubgraphPropertiesDialog(this)):(console.log(2),b.showSubgraphPropertiesDialogRight(this)))},r.prototype.computeSize=function(){var C=this.inputs?this.inputs.length:0,R=this.outputs?this.outputs.length:0;return[200,Math.max(C,R)*t.NODE_SLOT_HEIGHT+t.NODE_TITLE_HEIGHT]},r.prototype.onSubgraphTrigger=function(C,R){var b=this.findOutputSlot(C);b!=-1&&this.triggerSlot(b)},r.prototype.onSubgraphNewInput=function(C,R){var b=this.findInputSlot(C);b==-1&&this.addInput(C,R)},r.prototype.onSubgraphRenamedInput=function(C,R){var b=this.findInputSlot(C);if(b!=-1){var z=this.getInputInfo(b);z.name=R}},r.prototype.onSubgraphTypeChangeInput=function(C,R){var b=this.findInputSlot(C);if(b!=-1){var z=this.getInputInfo(b);z.type=R}},r.prototype.onSubgraphRemovedInput=function(C){var R=this.findInputSlot(C);R!=-1&&this.removeInput(R)},r.prototype.onSubgraphNewOutput=function(C,R){var b=this.findOutputSlot(C);b==-1&&this.addOutput(C,R)},r.prototype.onSubgraphRenamedOutput=function(C,R){var b=this.findOutputSlot(C);if(b!=-1){var z=this.getOutputInfo(b);z.name=R}},r.prototype.onSubgraphTypeChangeOutput=function(C,R){var b=this.findOutputSlot(C);if(b!=-1){var z=this.getOutputInfo(b);z.type=R}},r.prototype.onSubgraphRemovedOutput=function(C){var R=this.findOutputSlot(C);R!=-1&&this.removeOutput(R)},r.prototype.getExtraMenuOptions=function(C){var R=this;return[{content:"Open",callback:function(){C.openSubgraph(R.subgraph)}}]},r.prototype.onResize=function(C){C[1]+=20},r.prototype.serialize=function(){var C=t.LGraphNode.prototype.serialize.call(this);return C.subgraph=this.subgraph.serialize(),C},r.prototype.reassignSubgraphUUIDs=function(C){const R={nodeIDs:{},linkIDs:{}};for(const b of C.nodes){const z=b.id,S=t.uuidv4();if(b.id=S,R.nodeIDs[z]||R.nodeIDs[S])throw new Error(`New/old node UUID wasn't unique in changed map! ${z} ${S}`);R.nodeIDs[z]=S,R.nodeIDs[S]=z}for(const b of C.links){const z=b[0],S=t.uuidv4();if(b[0]=S,R.linkIDs[z]||R.linkIDs[S])throw new Error(`New/old link UUID wasn't unique in changed map! ${z} ${S}`);R.linkIDs[z]=S,R.linkIDs[S]=z;const A=b[1],P=b[3];if(!R.nodeIDs[A])throw new Error(`Old node UUID not found in mapping! ${A}`);if(b[1]=R.nodeIDs[A],!R.nodeIDs[P])throw new Error(`Old node UUID not found in mapping! ${P}`);b[3]=R.nodeIDs[P]}for(const b of C.nodes){if(b.inputs)for(const z of b.inputs)z.link&&(z.link=R.linkIDs[z.link]);if(b.outputs)for(const z of b.outputs)z.links&&(z.links=z.links.map(S=>R.linkIDs[S]))}for(const b of C.nodes)if(b.type==="graph/subgraph"){const z=reassignGraphUUIDs(b.subgraph);R.nodeIDs.assign(z.nodeIDs),R.linkIDs.assign(z.linkIDs)}},r.prototype.clone=function(){var C=t.createNode(this.type),R=this.serialize();if(t.use_uuids){const b=t.cloneObject(R.subgraph);this.reassignSubgraphUUIDs(b),R.subgraph=b}return delete R.id,delete R.inputs,delete R.outputs,C.configure(R),C},r.prototype.buildFromNodes=function(C){for(var R={},b=0,z=0;z<C.length;++z){var S=C[z];R[S.id]=S,b=Math.min(S.pos[0],b),Math.max(S.pos[0],b)}for(var z=0;z<C.length;++z){var S=C[z];if(S.inputs)for(var A=0;A<S.inputs.length;++A){var P=S.inputs[A];if(!(!P||!P.link)){var W=S.graph.links[P.link];W&&(R[W.origin_id]||this.subgraph.addInput(P.name,W.type))}}if(S.outputs)for(var A=0;A<S.outputs.length;++A){var X=S.outputs[A];if(!(!X||!X.links||!X.links.length))for(var Z=!1,tt=0;tt<X.links.length;++tt){var W=S.graph.links[X.links[tt]];if(W&&!R[W.target_id]){Z=!0;break}}}}},t.Subgraph=r,t.registerNodeType("graph/subgraph",r);function n(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var C=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(R){R&&C.setProperty("name",R)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(R){C.setProperty("type",R)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(R){C.setProperty("value",R)}),this.widgets_up=!0,this.size=[180,90]}n.title="Input",n.desc="Input of the graph",n.prototype.onConfigure=function(){this.updateType()},n.prototype.updateType=function(){var C=this.properties.type;this.type_widget.value=C,this.outputs[0].type!=C&&(t.isValidConnection(this.outputs[0].type,C)||this.disconnectOutput(0),this.outputs[0].type=C),C=="number"?(this.value_widget.type="number",this.value_widget.value=0):C=="boolean"?(this.value_widget.type="toggle",this.value_widget.value=!0):C=="string"?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,C)},n.prototype.onPropertyChanged=function(C,R){if(C=="name"){if(R==""||R==this.name_in_graph||R=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,R):this.graph.addInput(R,this.properties.type)),this.name_widget.value=R,this.name_in_graph=R}else C=="type"&&this.updateType()},n.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},n.prototype.onAction=function(C,R){this.properties.type==t.EVENT&&this.triggerSlot(0,R)},n.prototype.onExecute=function(){var C=this.properties.name,R=this.graph.inputs[C];if(!R){this.setOutputData(0,this.properties.value);return}this.setOutputData(0,R.value!==void 0?R.value:this.properties.value)},n.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)},t.GraphInput=n,t.registerNodeType("graph/input",n);function u(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}u.title="Output",u.desc="Output of the graph",u.prototype.onPropertyChanged=function(C,R){if(C=="name"){if(R==""||R==this.name_in_graph||R=="enabled")return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,R):this.graph.addOutput(R,this.properties.type)),this.name_widget.value=R,this.name_in_graph=R}else C=="type"&&this.updateType()},u.prototype.updateType=function(){var C=this.properties.type;this.type_widget&&(this.type_widget.value=C),this.inputs[0].type!=C&&((C=="action"||C=="event")&&(C=t.EVENT),t.isValidConnection(this.inputs[0].type,C)||this.disconnectInput(0),this.inputs[0].type=C),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,C)},u.prototype.onExecute=function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)},u.prototype.onAction=function(C,R){this.properties.type==t.ACTION&&this.graph.trigger(this.properties.name,R)},u.prototype.onRemoved=function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)},u.prototype.getTitle=function(){return this.flags.collapsed?this.properties.name:this.title},t.GraphOutput=u,t.registerNodeType("graph/output",u);function o(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}o.title="Const Number",o.desc="Constant number",o.prototype.onExecute=function(){this.setOutputData(0,parseFloat(this.properties.value))},o.prototype.getTitle=function(){return this.flags.collapsed?this.properties.value:this.title},o.prototype.setValue=function(C){this.setProperty("value",C)},o.prototype.onDrawBackground=function(C){this.outputs[0].label=this.properties.value.toFixed(3)},t.registerNodeType("basic/const",o);function a(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}a.title="Const Boolean",a.desc="Constant boolean",a.prototype.getTitle=o.prototype.getTitle,a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},a.prototype.setValue=o.prototype.setValue,a.prototype.onGetInputs=function(){return[["toggle",t.ACTION]]},a.prototype.onAction=function(C){this.setValue(!this.properties.value)},t.registerNodeType("basic/boolean",a);function l(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}l.title="Const String",l.desc="Constant string",l.prototype.getTitle=o.prototype.getTitle,l.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},l.prototype.setValue=o.prototype.setValue,l.prototype.onDropFile=function(C){var R=this,b=new FileReader;b.onload=function(z){R.setProperty("value",z.target.result)},b.readAsText(C)},t.registerNodeType("basic/string",l);function f(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}f.title="Const Object",f.desc="Constant Object",f.prototype.onExecute=function(){this.setOutputData(0,this._object)},t.registerNodeType("basic/object",f);function m(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}m.title="Const File",m.desc="Fetches a file from an url",m["@type"]={type:"enum",values:["text","arraybuffer","blob","json"]},m.prototype.onPropertyChanged=function(C,R){C=="url"&&(R==null||R==""?this._data=null:this.fetchFile(R))},m.prototype.onExecute=function(){var C=this.getInputData(0)||this.properties.url;C&&(C!=this._url||this._type!=this.properties.type)&&this.fetchFile(C),this.setOutputData(0,this._data)},m.prototype.setValue=o.prototype.setValue,m.prototype.fetchFile=function(C){var R=this;if(!C||C.constructor!==String){R._data=null,R.boxcolor=null;return}this._url=C,this._type=this.properties.type,C.substr(0,4)=="http"&&t.proxy&&(C=t.proxy+C.substr(C.indexOf(":")+3)),fetch(C).then(function(b){if(!b.ok)throw new Error("File not found");if(R.properties.type=="arraybuffer")return b.arrayBuffer();if(R.properties.type=="text")return b.text();if(R.properties.type=="json")return b.json();if(R.properties.type=="blob")return b.blob()}).then(function(b){R._data=b,R.boxcolor="#AEA"}).catch(function(b){R._data=null,R.boxcolor="red",console.error("error fetching file:",C)})},m.prototype.onDropFile=function(C){var R=this;this._url=C.name,this._type=this.properties.type,this.properties.url=C.name;var b=new FileReader;if(b.onload=function(z){R.boxcolor="#AEA";var S=z.target.result;R.properties.type=="json"&&(S=JSON.parse(S)),R._data=S},R.properties.type=="arraybuffer")b.readAsArrayBuffer(C);else if(R.properties.type=="text"||R.properties.type=="json")b.readAsText(C);else if(R.properties.type=="blob")return b.readAsBinaryString(C)},t.registerNodeType("basic/file",m);function O(){this.addInput("parse",t.ACTION),this.addInput("json","string"),this.addOutput("done",t.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}O.title="JSON Parse",O.desc="Parses JSON String into object",O.prototype.parse=function(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch{this.boxcolor="red"}},O.prototype.onExecute=function(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)},O.prototype.onAction=function(C){C=="parse"&&this.parse()},t.registerNodeType("basic/jsonparse",O);function d(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}d.title="Const Data",d.desc="Constant Data",d.prototype.onPropertyChanged=function(C,R){if(this.widget.value=R,!(R==null||R==""))try{this._value=JSON.parse(R),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},d.prototype.onExecute=function(){this.setOutputData(0,this._value)},d.prototype.setValue=o.prototype.setValue,t.registerNodeType("basic/data",d);function g(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}g.title="Const Array",g.desc="Constant Array",g.prototype.onPropertyChanged=function(C,R){if(this.widget.value=R,!(R==null||R==""))try{R[0]!="["?this._value=JSON.parse("["+R+"]"):this._value=JSON.parse(R),this.boxcolor="#AEA"}catch{this.boxcolor="red"}},g.prototype.onExecute=function(){var C=this.getInputData(0);if(C&&C.length){this._value||(this._value=new Array),this._value.length=C.length;for(var R=0;R<C.length;++R)this._value[R]=C[R]}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)},g.prototype.setValue=o.prototype.setValue,t.registerNodeType("basic/array",g);function E(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}E.title="Set Array",E.desc="Sets index of array",E.prototype.onExecute=function(){var C=this.getInputData(0);if(C){var R=this.getInputData(1);R!==void 0&&(this.properties.index&&(C[Math.floor(this.properties.index)]=R),this.setOutputData(0,C))}},t.registerNodeType("basic/set_array",E);function I(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}I.title="Array[i]",I.desc="Returns an element from an array",I.prototype.onExecute=function(){var C=this.getInputData(0),R=this.getInputData(1);R==null&&(R=this.properties.index),!(C==null||R==null)&&this.setOutputData(0,C[Math.floor(Number(R))])},t.registerNodeType("basic/array[]",I);function k(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}k.title="Table[row][col]",k.desc="Returns an element from a table",k.prototype.onExecute=function(){var C=this.getInputData(0),b=this.getInputData(1),R=this.getInputData(2);if(b==null&&(b=this.properties.row),R==null&&(R=this.properties.column),!(C==null||b==null||R==null)){var b=C[Math.floor(Number(b))];b?this.setOutputData(0,b[Math.floor(Number(R))]):this.setOutputData(0,null)}},t.registerNodeType("basic/table[][]",k);function N(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}N.title="Object property",N.desc="Outputs the property of an object",N.prototype.setValue=function(C){this.properties.value=C,this.widget.value=C},N.prototype.getTitle=function(){return this.flags.collapsed?"in."+this.properties.value:this.title},N.prototype.onPropertyChanged=function(C,R){this.widget.value=R},N.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,C[this.properties.value])},t.registerNodeType("basic/object_property",N);function T(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}T.title="Object keys",T.desc="Outputs an array with the keys of an object",T.prototype.onExecute=function(){var C=this.getInputData(0);C!=null&&this.setOutputData(0,Object.keys(C))},t.registerNodeType("basic/object_keys",T);function h(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}h.title="Set Object",h.desc="Adds propertiesrty to object",h.prototype.onExecute=function(){var C=this.getInputData(0);if(C){var R=this.getInputData(1);R!==void 0&&(this.properties.property&&(C[this.properties.property]=R),this.setOutputData(0,C))}},t.registerNodeType("basic/set_object",h);function L(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var C=this;this.addWidget("button","clear","",function(){C._result={}}),this.size=this.computeSize()}L.title="Merge Objects",L.desc="Creates an object copying properties from others",L.prototype.onExecute=function(){var C=this.getInputData(0),R=this.getInputData(1),b=this._result;if(C)for(var z in C)b[z]=C[z];if(R)for(var z in R)b[z]=R[z];this.setOutputData(0,b)},t.registerNodeType("basic/merge_objects",L);function _(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:_.LITEGRAPH},this.value=null}_.title="Variable",_.desc="store/read variable value",_.LITEGRAPH=0,_.GRAPH=1,_.GLOBALSCOPE=2,_["@container"]={type:"enum",values:{litegraph:_.LITEGRAPH,graph:_.GRAPH,global:_.GLOBALSCOPE}},_.prototype.onExecute=function(){var C=this.getContainer();if(this.isInputConnected(0)){this.value=this.getInputData(0),C[this.properties.varname]=this.value,this.setOutputData(0,this.value);return}this.setOutputData(0,C[this.properties.varname])},_.prototype.getContainer=function(){switch(this.properties.container){case _.GRAPH:return this.graph?this.graph.vars:{};case _.GLOBALSCOPE:return e;case _.LITEGRAPH:default:return t.Globals}},_.prototype.getTitle=function(){return this.properties.varname},t.registerNodeType("basic/variable",_),t.wrapFunctionAsNode("basic/length",D,[""],"number");function D(C){return C&&C.length!=null?Number(C.length):0}t.wrapFunctionAsNode("basic/not",function(C){return!C},[""],"boolean");function B(){this.size=[60,30],this.addInput("data",0),this.addInput("download",t.ACTION),this.properties={filename:"data.json"},this.value=null;var C=this;this.addWidget("button","Download","",function(R){C.value&&C.downloadAsFile()})}B.title="Download",B.desc="Download some data",B.prototype.downloadAsFile=function(){if(this.value!=null){var C=null;this.value.constructor===String?C=this.value:C=JSON.stringify(this.value);var R=new Blob([C]),b=URL.createObjectURL(R),z=document.createElement("a");z.setAttribute("href",b),z.setAttribute("download",this.properties.filename),z.style.display="none",document.body.appendChild(z),z.click(),document.body.removeChild(z),setTimeout(function(){URL.revokeObjectURL(b)},1e3*60)}},B.prototype.onAction=function(C,R){var b=this;setTimeout(function(){b.downloadAsFile()},100)},B.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},B.prototype.getTitle=function(){return this.flags.collapsed?this.properties.filename:this.title},t.registerNodeType("basic/download",B);function F(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}F.title="Watch",F.desc="Show value of input",F.prototype.onExecute=function(){this.inputs[0]&&(this.value=this.getInputData(0))},F.prototype.getTitle=function(){return this.flags.collapsed?this.inputs[0].label:this.title},F.toString=function(C){if(C==null)return"null";if(C.constructor===Number)return C.toFixed(3);if(C.constructor===Array){for(var R="[",b=0;b<C.length;++b)R+=F.toString(C[b])+(b+1!=C.length?",":"");return R+="]",R}else return String(C)},F.prototype.onDrawBackground=function(C){this.inputs[0].label=F.toString(this.value)},t.registerNodeType("basic/watch",F);function H(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}H.title="Cast",H.desc="Allows to connect different types",H.prototype.onExecute=function(){this.setOutputData(0,this.getInputData(0))},t.registerNodeType("basic/cast",H);function V(){this.mode=t.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",t.EVENT),this.addInput("msg",0)}V.title="Console",V.desc="Show value inside the console",V.prototype.onAction=function(C,R){var b=this.getInputData(1);b||(b=this.properties.msg),b||(b="Event: "+R),C=="log"?console.log(b):C=="warn"?console.warn(b):C=="error"&&console.error(b)},V.prototype.onExecute=function(){var C=this.getInputData(1);C||(C=this.properties.msg),C!=null&&typeof C<"u"&&(this.properties.msg=C,console.log(C))},V.prototype.onGetInputs=function(){return[["log",t.ACTION],["warn",t.ACTION],["error",t.ACTION]]},t.registerNodeType("basic/console",V);function Y(){this.mode=t.ON_EVENT,this.addProperty("msg",""),this.addInput("",t.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}Y.title="Alert",Y.desc="Show an alert window",Y.color="#510",Y.prototype.onConfigure=function(C){this.widget.value=C.properties.msg},Y.prototype.onAction=function(C,R){var b=this.properties.msg;setTimeout(function(){alert(b)},10)},t.registerNodeType("basic/alert",Y);function K(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}K.prototype.onConfigure=function(C){C.properties.onExecute&&t.allow_scripts?this.compileCode(C.properties.onExecute):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},K.title="Script",K.desc="executes a code (max 256 characters)",K.widgets_info={onExecute:{type:"code"}},K.prototype.onPropertyChanged=function(C,R){C=="onExecute"&&t.allow_scripts?this.compileCode(R):console.warn("Script not compiled, LiteGraph.allow_scripts is false")},K.prototype.compileCode=function(C){if(this._func=null,C.length>256)console.warn("Script too long, max 256 chars");else{for(var R=C.toLowerCase(),b=["script","body","document","eval","nodescript","function"],z=0;z<b.length;++z)if(R.indexOf(b[z])!=-1){console.warn("invalid script");return}try{this._func=new Function("A","B","C","DATA","node",C)}catch(S){console.error("Error parsing script"),console.error(S)}}},K.prototype.onExecute=function(){if(this._func)try{var C=this.getInputData(0),R=this.getInputData(1),b=this.getInputData(2);this.setOutputData(0,this._func(C,R,b,this.data,this))}catch(z){console.error("Error in script"),console.error(z)}},K.prototype.onGetOutputs=function(){return[["C",""]]},t.registerNodeType("basic/script",K);function J(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:J.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:J.values}),this.size=[80,60]}J.values=["==","!="],J["@OP"]={type:"enum",title:"operation",values:J.values},J.title="Compare *",J.desc="evaluates condition between A and B",J.prototype.getTitle=function(){return"*A "+this.properties.OP+" *B"},J.prototype.onExecute=function(){var C=this.getInputData(0);C===void 0?C=this.properties.A:this.properties.A=C;var R=this.getInputData(1);R===void 0?R=this.properties.B:this.properties.B=R;var b=!1;if(typeof C==typeof R)switch(this.properties.OP){case"==":case"!=":switch(b=!0,typeof C){case"object":var z=Object.getOwnPropertyNames(C),S=Object.getOwnPropertyNames(R);if(z.length!=S.length){b=!1;break}for(var A=0;A<z.length;A++){var P=z[A];if(C[P]!==R[P]){b=!1;break}}break;default:b=C==R}this.properties.OP=="!="&&(b=!b);break}this.setOutputData(0,b),this.setOutputData(1,!b)},t.registerNodeType("basic/CompareValues",J)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.size=[60,30],this.addInput("event",t.ACTION)}s.title="Log Event",s.desc="Log event in console",s.prototype.onAction=function(I,k,N){console.log(I,k)},t.registerNodeType("events/log",s);function r(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",t.EVENT),this.addOutput("change",t.EVENT),this.addOutput("false",t.EVENT),this.properties={only_on_change:!0},this.prev=0}r.title="TriggerEvent",r.desc="Triggers event if input evaluates to true",r.prototype.onExecute=function(I,k){var N=this.getInputData(0),T=N!=this.prev;this.prev===0&&(T=!1);var h=T&&this.properties.only_on_change||!T&&!this.properties.only_on_change;N&&h&&this.triggerSlot(0,I,null,k),!N&&h&&this.triggerSlot(2,I,null,k),T&&this.triggerSlot(1,I,null,k),this.prev=N},t.registerNodeType("events/trigger",r);function n(){var I=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){I.addInput("",t.ACTION),I.addOutput("",t.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}n.title="Sequence",n.desc="Triggers a sequence of events when an event arrives",n.prototype.getTitle=function(){return""},n.prototype.onAction=function(I,k,N){if(this.outputs){N=N||{};for(var T=0;T<this.outputs.length;++T)this.outputs[T],N.action_call?N.action_call=N.action_call+"_seq_"+T:N.action_call=this.id+"_"+(I||"action")+"_seq_"+T+"_"+Math.floor(Math.random()*9999),this.triggerSlot(T,k,null,N)}},t.registerNodeType("events/sequence",n);function u(){var I=this;this.addInput("",t.ACTION),this.addInput("",t.ACTION),this.addOutput("",t.EVENT),this.addWidget("button","+",null,function(){I.addInput("",t.ACTION),I.size[0]=90}),this.size=[90,70],this.ready=[]}u.title="WaitAll",u.desc="Wait until all input events arrive then triggers output",u.prototype.getTitle=function(){return""},u.prototype.onDrawBackground=function(I){if(!this.flags.collapsed)for(var k=0;k<this.inputs.length;++k){var N=k*t.NODE_SLOT_HEIGHT+10;I.fillStyle=this.ready[k]?"#AFB":"#000",I.fillRect(20,N,10,10)}},u.prototype.onAction=function(I,k,N,T){if(T!=null){this.ready.length=this.outputs.length,this.ready[T]=!0;for(var h=0;h<this.ready.length;++h)if(!this.ready[h])return;this.reset(),this.triggerSlot(0)}},u.prototype.reset=function(){this.ready.length=0},t.registerNodeType("events/waitAll",u);function o(){var I=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("index","number"),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT),this.addOutput("",t.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){I.addOutput("",t.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}o.title="Stepper",o.desc="Trigger events sequentially when an tick arrives",o.prototype.onDrawBackground=function(I){if(!this.flags.collapsed){var k=this.properties.index||0;I.fillStyle="#AFB";var N=this.size[0],T=(k+1)*t.NODE_SLOT_HEIGHT+4;I.beginPath(),I.moveTo(N-30,T),I.lineTo(N-30,T+t.NODE_SLOT_HEIGHT),I.lineTo(N-15,T+t.NODE_SLOT_HEIGHT*.5),I.fill()}},o.prototype.onExecute=function(){var I=this.getInputData(0);I!=null&&(I=Math.floor(I),I=clamp(I,0,this.outputs?this.outputs.length-2:0),I!=this.properties.index&&(this.properties.index=I,this.triggerSlot(I+1))),this.setOutputData(0,this.properties.index)},o.prototype.onAction=function(I,k){if(I=="reset")this.properties.index=0;else if(I=="step"){this.triggerSlot(this.properties.index+1,k);var N=this.outputs?this.outputs.length-1:0;this.properties.index=(this.properties.index+1)%N}},t.registerNodeType("events/stepper",o);function a(){this.size=[60,30],this.addInput("event",t.ACTION),this.addOutput("event",t.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}a.title="Filter Event",a.desc="Blocks events that do not match the filter",a.prototype.onAction=function(I,k,N){if(k!=null&&!(this.properties.equal_to&&this.properties.equal_to!=k)){if(this.properties.has_property){var T=k[this.properties.has_property];if(T==null||this.properties.property_equal_to&&this.properties.property_equal_to!=T)return}this.triggerSlot(0,k,null,N)}},t.registerNodeType("events/filter",a);function l(){this.addInput("in",t.ACTION),this.addInput("cond","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.size=[120,60],this._value=!1}l.title="Branch",l.desc="If condition is true, outputs triggers true, otherwise false",l.prototype.onExecute=function(){this._value=this.getInputData(1)},l.prototype.onAction=function(I,k,N){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,k,null,N)},t.registerNodeType("events/branch",l);function f(){this.addInput("inc",t.ACTION),this.addInput("dec",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("change",t.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}f.title="Counter",f.desc="Counts events",f.prototype.getTitle=function(){return this.flags.collapsed?String(this.num):this.title},f.prototype.onAction=function(I,k,N){var T=this.num;I=="inc"?this.num+=1:I=="dec"?this.num-=1:I=="reset"&&(this.num=0),this.num!=T&&this.trigger("change",this.num)},f.prototype.onDrawBackground=function(I){this.flags.collapsed||(I.fillStyle="#AAA",I.font="20px Arial",I.textAlign="center",I.fillText(this.num,this.size[0]*.5,this.size[1]*.5))},f.prototype.onExecute=function(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)},t.registerNodeType("events/counter",f);function m(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",t.ACTION),this.addOutput("on_time",t.EVENT),this._pending=[]}m.title="Delay",m.desc="Delays one event",m.prototype.onAction=function(I,k,N){var T=this.properties.time_in_ms;T<=0?this.trigger(null,k,N):this._pending.push([T,k])},m.prototype.onExecute=function(I,k){var N=this.graph.elapsed_time*1e3;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var T=0;T<this._pending.length;++T){var h=this._pending[T];h[0]-=N,!(h[0]>0)&&(this._pending.splice(T,1),--T,this.trigger(null,h[1],k))}},m.prototype.onGetInputs=function(){return[["event",t.ACTION],["time_in_ms","number"]]},t.registerNodeType("events/delay",m);function O(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",t.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}O.title="Timer",O.desc="Sends an event every N milliseconds",O.prototype.onStart=function(){this.time=0},O.prototype.getTitle=function(){return"Timer: "+this.last_interval.toString()+"ms"},O.on_color="#AAA",O.off_color="#222",O.prototype.onDrawBackground=function(){this.boxcolor=this.triggered?O.on_color:O.off_color,this.triggered=!1},O.prototype.onExecute=function(){var I=this.graph.elapsed_time*1e3,k=this.time==0;if(this.time+=I,this.last_interval=Math.max(1,this.getInputOrProperty("interval")|0),!k&&(this.time<this.last_interval||isNaN(this.last_interval))){this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!1);return}this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&this.inputs.length>1&&this.inputs[1]&&this.setOutputData(1,!0)},O.prototype.onGetInputs=function(){return[["interval","number"]]},O.prototype.onGetOutputs=function(){return[["tick","boolean"]]},t.registerNodeType("events/timer",O);function d(){this.addInput("go",t.ACTION),this.addInput("green",t.ACTION),this.addInput("red",t.ACTION),this.addOutput("continue",t.EVENT),this.addOutput("blocked",t.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var I=this;this.addWidget("button","reset","",function(){I._ready=!1})}d.title="Semaphore Event",d.desc="Until both events are not triggered, it doesnt continue.",d.prototype.onExecute=function(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"},d.prototype.onAction=function(I,k){I=="go"?this.triggerSlot(this._ready?0:1):I=="green"?this._ready=!0:I=="red"&&(this._ready=!1)},t.registerNodeType("events/semaphore",d);function g(){this.addInput("in",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("out",t.EVENT),this._once=!1,this.properties={};var I=this;this.addWidget("button","reset","",function(){I._once=!1})}g.title="Once",g.desc="Only passes an event once, then gets locked",g.prototype.onAction=function(I,k){I=="in"&&!this._once?(this._once=!0,this.triggerSlot(0,k)):I=="reset"&&(this._once=!1)},t.registerNodeType("events/once",g);function E(){this.addInput("data",0),this.addInput("assign",t.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var I=this;this.addWidget("button","store","",function(){I.properties.data=I._last_value})}E.title="Data Store",E.desc="Stores data and only changes when event is received",E.prototype.onExecute=function(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)},E.prototype.onAction=function(I,k,N){this.properties.data=this._last_value},E.prototype.onSerialize=function(I){I.data!=null&&(this.properties.serialize==!1||I.data.constructor!==String&&I.data.constructor!==Number&&I.data.constructor!==Boolean&&I.data.constructor!==Array&&I.data.constructor!==Object)&&(I.data=null)},t.registerNodeType("basic/data_store",E)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addOutput("",t.EVENT),this.addOutput("","boolean"),this.addProperty("text","click me"),this.addProperty("font_size",30),this.addProperty("message",""),this.size=[164,84],this.clicked=!1}s.title="Button",s.desc="Triggers an event",s.font="Arial",s.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){var g=10;if(d.fillStyle="black",d.fillRect(g+1,g+1,this.size[0]-g*2,this.size[1]-g*2),d.fillStyle="#AAF",d.fillRect(g-1,g-1,this.size[0]-g*2,this.size[1]-g*2),d.fillStyle=this.clicked?"white":this.mouseOver?"#668":"#334",d.fillRect(g,g,this.size[0]-g*2,this.size[1]-g*2),this.properties.text||this.properties.text===0){var E=this.properties.font_size||30;d.textAlign="center",d.fillStyle=this.clicked?"black":"white",d.font=E+"px "+s.font,d.fillText(this.properties.text,this.size[0]*.5,this.size[1]*.5+E*.3),d.textAlign="left"}}},s.prototype.onMouseDown=function(d,g){if(g[0]>1&&g[1]>1&&g[0]<this.size[0]-2&&g[1]<this.size[1]-2)return this.clicked=!0,this.setOutputData(1,this.clicked),this.triggerSlot(0,this.properties.message),!0},s.prototype.onExecute=function(){this.setOutputData(1,this.clicked)},s.prototype.onMouseUp=function(d){this.clicked=!1},t.registerNodeType("widget/button",s);function r(){this.addInput("","boolean"),this.addInput("e",t.ACTION),this.addOutput("v","boolean"),this.addOutput("e",t.EVENT),this.properties={font:"",value:!1},this.size=[160,44]}r.title="Toggle",r.desc="Toggles between true or false",r.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){var g=this.size[1]*.5,E=.25,I=this.size[1]*.8;d.font=this.properties.font||(g*.8).toFixed(0)+"px Arial";var k=d.measureText(this.title).width,N=(this.size[0]-(k+g))*.5;d.fillStyle="#AAA",d.fillRect(N,I-g,g,g),d.fillStyle=this.properties.value?"#AEF":"#000",d.fillRect(N+g*E,I-g+g*E,g*(1-E*2),g*(1-E*2)),d.textAlign="left",d.fillStyle="#AAA",d.fillText(this.title,g*1.2+N,I*.85),d.textAlign="left"}},r.prototype.onAction=function(d){this.properties.value=!this.properties.value,this.trigger("e",this.properties.value)},r.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d),this.setOutputData(0,this.properties.value)},r.prototype.onMouseDown=function(d,g){if(g[0]>1&&g[1]>1&&g[0]<this.size[0]-2&&g[1]<this.size[1]-2)return this.properties.value=!this.properties.value,this.graph._version++,this.trigger("e",this.properties.value),!0},t.registerNodeType("widget/toggle",r);function n(){this.addOutput("","number"),this.size=[80,60],this.properties={min:-1e3,max:1e3,value:1,step:1},this.old_y=-1,this._remainder=0,this._precision=0,this.mouse_captured=!1}n.title="Number",n.desc="Widget to select number value",n.pixels_threshold=10,n.markers_color="#666",n.prototype.onDrawForeground=function(d){var g=this.size[0]*.5,E=this.size[1];E>30?(d.fillStyle=n.markers_color,d.beginPath(),d.moveTo(g,E*.1),d.lineTo(g+E*.1,E*.2),d.lineTo(g+E*-.1,E*.2),d.fill(),d.beginPath(),d.moveTo(g,E*.9),d.lineTo(g+E*.1,E*.8),d.lineTo(g+E*-.1,E*.8),d.fill(),d.font=(E*.7).toFixed(1)+"px Arial"):d.font=(E*.8).toFixed(1)+"px Arial",d.textAlign="center",d.font=(E*.7).toFixed(1)+"px Arial",d.fillStyle="#EEE",d.fillText(this.properties.value.toFixed(this._precision),g,E*.75)},n.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},n.prototype.onPropertyChanged=function(d,g){var E=(this.properties.step+"").split(".");this._precision=E.length>1?E[1].length:0},n.prototype.onMouseDown=function(d,g){if(!(g[1]<0))return this.old_y=d.canvasY,this.captureInput(!0),this.mouse_captured=!0,!0},n.prototype.onMouseMove=function(d){if(this.mouse_captured){var g=this.old_y-d.canvasY;d.shiftKey&&(g*=10),(d.metaKey||d.altKey)&&(g*=.1),this.old_y=d.canvasY;var E=this._remainder+g/n.pixels_threshold;this._remainder=E%1,E=E|0;var I=clamp(this.properties.value+E*this.properties.step,this.properties.min,this.properties.max);this.properties.value=I,this.graph._version++,this.setDirtyCanvas(!0)}},n.prototype.onMouseUp=function(d,g){if(d.click_time<200){var E=g[1]>this.size[1]*.5?-1:1;this.properties.value=clamp(this.properties.value+E*this.properties.step,this.properties.min,this.properties.max),this.graph._version++,this.setDirtyCanvas(!0)}this.mouse_captured&&(this.mouse_captured=!1,this.captureInput(!1))},t.registerNodeType("widget/number",n);function u(){this.addOutput("","string"),this.addOutput("change",t.EVENT),this.size=[80,60],this.properties={value:"A",values:"A;B;C"},this.old_y=-1,this.mouse_captured=!1,this._values=this.properties.values.split(";");var d=this;this.widgets_up=!0,this.widget=this.addWidget("combo","",this.properties.value,function(g){d.properties.value=g,d.triggerSlot(1,g)},{property:"value",values:this._values})}u.title="Combo",u.desc="Widget to select from a list",u.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},u.prototype.onPropertyChanged=function(d,g){d=="values"?(this._values=g.split(";"),this.widget.options.values=this._values):d=="value"&&(this.widget.value=g)},t.registerNodeType("widget/combo",u);function o(){this.addOutput("","number"),this.size=[64,84],this.properties={min:0,max:1,value:.5,color:"#7AF",precision:2},this.value=-1}o.title="Knob",o.desc="Circular controller",o.size=[80,100],o.prototype.onDrawForeground=function(d){if(!this.flags.collapsed){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min));var g=this.size[0]*.5,E=this.size[1]*.5,I=Math.min(this.size[0],this.size[1])*.5-5;d.globalAlpha=1,d.save(),d.translate(g,E),d.rotate(Math.PI*.75),d.fillStyle="rgba(0,0,0,0.5)",d.beginPath(),d.moveTo(0,0),d.arc(0,0,I,0,Math.PI*1.5),d.fill(),d.strokeStyle="black",d.fillStyle=this.properties.color,d.lineWidth=2,d.beginPath(),d.moveTo(0,0),d.arc(0,0,I-4,0,Math.PI*1.5*Math.max(.01,this.value)),d.closePath(),d.fill(),d.lineWidth=1,d.globalAlpha=1,d.restore(),d.fillStyle="black",d.beginPath(),d.arc(g,E,I*.75,0,Math.PI*2,!0),d.fill(),d.fillStyle=this.mouseOver?"white":this.properties.color,d.beginPath();var k=this.value*Math.PI*1.5+Math.PI*.75;d.arc(g+Math.cos(k)*I*.65,E+Math.sin(k)*I*.65,I*.05,0,Math.PI*2,!0),d.fill(),d.fillStyle=this.mouseOver?"white":"#AAA",d.font=Math.floor(I*.5)+"px Arial",d.textAlign="center",d.fillText(this.properties.value.toFixed(this.properties.precision),g,E+I*.15)}},o.prototype.onExecute=function(){this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},o.prototype.onMouseDown=function(d){return this.center=[this.size[0]*.5,this.size[1]*.5+20],this.radius=this.size[0]*.5,d.canvasY-this.pos[1]<20||t.distance([d.canvasX,d.canvasY],[this.pos[0]+this.center[0],this.pos[1]+this.center[1]])>this.radius?!1:(this.oldmouse=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],this.captureInput(!0),!0)},o.prototype.onMouseMove=function(d){if(this.oldmouse){var g=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],E=this.value;E-=(g[1]-this.oldmouse[1])*.01,E>1?E=1:E<0&&(E=0),this.value=E,this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.oldmouse=g,this.setDirtyCanvas(!0)}},o.prototype.onMouseUp=function(d){this.oldmouse&&(this.oldmouse=null,this.captureInput(!1))},o.prototype.onPropertyChanged=function(d,g){if(d=="min"||d=="max"||d=="value")return this.properties[d]=parseFloat(g),!0},t.registerNodeType("widget/knob",o);function a(){this.addOutput("","number"),this.properties={value:.5,min:0,max:1,text:"V"};var d=this;this.size=[140,40],this.slider=this.addWidget("slider","V",this.properties.value,function(g){d.properties.value=g},this.properties),this.widgets_up=!0}a.title="Inner Slider",a.prototype.onPropertyChanged=function(d,g){d=="value"&&(this.slider.value=g)},a.prototype.onExecute=function(){this.setOutputData(0,this.properties.value)},t.registerNodeType("widget/internal_slider",a);function l(){this.size=[160,26],this.addOutput("","number"),this.properties={color:"#7AF",min:0,max:1,value:.5},this.value=-1}l.title="H.Slider",l.desc="Linear slider controller",l.prototype.onDrawForeground=function(d){this.value==-1&&(this.value=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min)),d.globalAlpha=1,d.lineWidth=1,d.fillStyle="#000",d.fillRect(2,2,this.size[0]-4,this.size[1]-4),d.fillStyle=this.properties.color,d.beginPath(),d.rect(4,4,(this.size[0]-8)*this.value,this.size[1]-8),d.fill()},l.prototype.onExecute=function(){this.properties.value=this.properties.min+(this.properties.max-this.properties.min)*this.value,this.setOutputData(0,this.properties.value),this.boxcolor=t.colorToString([this.value,this.value,this.value])},l.prototype.onMouseDown=function(d){return d.canvasY-this.pos[1]<0?!1:(this.oldmouse=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],this.captureInput(!0),!0)},l.prototype.onMouseMove=function(d){if(this.oldmouse){var g=[d.canvasX-this.pos[0],d.canvasY-this.pos[1]],E=this.value,I=g[0]-this.oldmouse[0];E+=I/this.size[0],E>1?E=1:E<0&&(E=0),this.value=E,this.oldmouse=g,this.setDirtyCanvas(!0)}},l.prototype.onMouseUp=function(d){this.oldmouse=null,this.captureInput(!1)},l.prototype.onMouseLeave=function(d){},t.registerNodeType("widget/hslider",l);function f(){this.size=[160,26],this.addInput("","number"),this.properties={min:0,max:1,value:0,color:"#AAF"}}f.title="Progress",f.desc="Shows data in linear progress",f.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d)},f.prototype.onDrawForeground=function(d){d.lineWidth=1,d.fillStyle=this.properties.color;var g=(this.properties.value-this.properties.min)/(this.properties.max-this.properties.min);g=Math.min(1,g),g=Math.max(0,g),d.fillRect(2,2,(this.size[0]-4)*g,this.size[1]-4)},t.registerNodeType("widget/progress",f);function m(){this.addInputs("",0),this.properties={value:"...",font:"Arial",fontsize:18,color:"#AAA",align:"left",glowSize:0,decimals:1}}m.title="Text",m.desc="Shows the input value",m.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"led_text",text:"LED",type:"minibutton"},{name:"normal_text",text:"Normal",type:"minibutton"}],m.prototype.onDrawForeground=function(d){d.fillStyle=this.properties.color;var g=this.properties.value;this.properties.glowSize?(d.shadowColor=this.properties.color,d.shadowOffsetX=0,d.shadowOffsetY=0,d.shadowBlur=this.properties.glowSize):d.shadowColor="transparent";var E=this.properties.fontsize;if(d.textAlign=this.properties.align,d.font=E.toString()+"px "+this.properties.font,this.str=typeof g=="number"?g.toFixed(this.properties.decimals):g,typeof this.str=="string")for(var I=this.str.replace(/[\r\n]/g,"\\n").split("\\n"),k=0;k<I.length;k++)d.fillText(I[k],this.properties.align=="left"?15:this.size[0]-15,E*-.15+E*(parseInt(k)+1));d.shadowColor="transparent",this.last_ctx=d,d.textAlign="left"},m.prototype.onExecute=function(){var d=this.getInputData(0);d!=null&&(this.properties.value=d)},m.prototype.resize=function(){if(this.last_ctx){var d=this.str.split("\\n");this.last_ctx.font=this.properties.fontsize+"px "+this.properties.font;for(var g=0,E=0;E<d.length;E++){var I=this.last_ctx.measureText(d[E]).width;g<I&&(g=I)}this.size[0]=g+20,this.size[1]=4+d.length*this.properties.fontsize,this.setDirtyCanvas(!0)}},m.prototype.onPropertyChanged=function(d,g){return this.properties[d]=g,this.str=typeof g=="number"?g.toFixed(3):g,!0},t.registerNodeType("widget/text",m);function O(){this.size=[200,100],this.properties={borderColor:"#ffffff",bgcolorTop:"#f0f0f0",bgcolorBottom:"#e0e0e0",shadowSize:2,borderRadius:3}}O.title="Panel",O.desc="Non interactive panel",O.widgets=[{name:"update",text:"Update",type:"button"}],O.prototype.createGradient=function(d){if(this.properties.bgcolorTop==""||this.properties.bgcolorBottom==""){this.lineargradient=0;return}this.lineargradient=d.createLinearGradient(0,0,0,this.size[1]),this.lineargradient.addColorStop(0,this.properties.bgcolorTop),this.lineargradient.addColorStop(1,this.properties.bgcolorBottom)},O.prototype.onDrawForeground=function(d){this.flags.collapsed||(this.lineargradient==null&&this.createGradient(d),this.lineargradient&&(d.lineWidth=1,d.strokeStyle=this.properties.borderColor,d.fillStyle=this.lineargradient,this.properties.shadowSize?(d.shadowColor="#000",d.shadowOffsetX=0,d.shadowOffsetY=0,d.shadowBlur=this.properties.shadowSize):d.shadowColor="transparent",d.roundRect(0,0,this.size[0]-1,this.size[1]-1,this.properties.shadowSize),d.fill(),d.shadowColor="transparent",d.stroke()))},t.registerNodeType("widget/panel",O)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",t.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}s.title="Gamepad",s.desc="gets the input of the gamepad",s.CENTER=0,s.LEFT=1,s.RIGHT=2,s.UP=4,s.DOWN=8,s.zero=new Float32Array(2),s.buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"],s.prototype.onExecute=function(){var r=this.getGamepad(),n=this.properties.threshold||0;if(r&&(this._left_axis[0]=Math.abs(r.xbox.axes.lx)>n?r.xbox.axes.lx:0,this._left_axis[1]=Math.abs(r.xbox.axes.ly)>n?r.xbox.axes.ly:0,this._right_axis[0]=Math.abs(r.xbox.axes.rx)>n?r.xbox.axes.rx:0,this._right_axis[1]=Math.abs(r.xbox.axes.ry)>n?r.xbox.axes.ry:0,this._triggers[0]=Math.abs(r.xbox.axes.ltrigger)>n?r.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(r.xbox.axes.rtrigger)>n?r.xbox.axes.rtrigger:0),this.outputs)for(var u=0;u<this.outputs.length;u++){var o=this.outputs[u];if(!(!o.links||!o.links.length)){var a=null;if(r)switch(o.name){case"left_axis":a=this._left_axis;break;case"right_axis":a=this._right_axis;break;case"left_x_axis":a=this._left_axis[0];break;case"left_y_axis":a=this._left_axis[1];break;case"right_x_axis":a=this._right_axis[0];break;case"right_y_axis":a=this._right_axis[1];break;case"trigger_left":a=this._triggers[0];break;case"trigger_right":a=this._triggers[1];break;case"a_button":a=r.xbox.buttons.a?1:0;break;case"b_button":a=r.xbox.buttons.b?1:0;break;case"x_button":a=r.xbox.buttons.x?1:0;break;case"y_button":a=r.xbox.buttons.y?1:0;break;case"lb_button":a=r.xbox.buttons.lb?1:0;break;case"rb_button":a=r.xbox.buttons.rb?1:0;break;case"ls_button":a=r.xbox.buttons.ls?1:0;break;case"rs_button":a=r.xbox.buttons.rs?1:0;break;case"hat_left":a=r.xbox.hatmap&s.LEFT;break;case"hat_right":a=r.xbox.hatmap&s.RIGHT;break;case"hat_up":a=r.xbox.hatmap&s.UP;break;case"hat_down":a=r.xbox.hatmap&s.DOWN;break;case"hat":a=r.xbox.hatmap;break;case"start_button":a=r.xbox.buttons.start?1:0;break;case"back_button":a=r.xbox.buttons.back?1:0;break;case"button_pressed":for(var l=0;l<this._current_buttons.length;++l)this._current_buttons[l]&&!this._previous_buttons[l]&&this.triggerSlot(u,s.buttons[l]);break}else switch(o.name){case"button_pressed":break;case"left_axis":case"right_axis":a=s.zero;break;default:a=0}this.setOutputData(u,a)}}},s.mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11},s.mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"],s.prototype.getGamepad=function(){var r=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!r)return null;var n=r.call(navigator),u=null;this._previous_buttons.set(this._current_buttons);for(var o=this.properties.gamepad_index;o<4;o++)if(n[o]){u=n[o];var a=this.xbox_mapping;a||(a=this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:s.CENTER}),a.axes.lx=u.axes[0],a.axes.ly=u.axes[1],a.axes.rx=u.axes[2],a.axes.ry=u.axes[3],a.axes.ltrigger=u.buttons[6].value,a.axes.rtrigger=u.buttons[7].value,a.hat="",a.hatmap=s.CENTER;for(var l=0;l<u.buttons.length;l++)if(this._current_buttons[l]=u.buttons[l].pressed,l<12)a.buttons[s.mapping_array[l]]=u.buttons[l].pressed,u.buttons[l].was_pressed&&this.trigger(s.mapping_array[l]+"_button_event");else switch(l){case 12:u.buttons[l].pressed&&(a.hat+="up",a.hatmap|=s.UP);break;case 13:u.buttons[l].pressed&&(a.hat+="down",a.hatmap|=s.DOWN);break;case 14:u.buttons[l].pressed&&(a.hat+="left",a.hatmap|=s.LEFT);break;case 15:u.buttons[l].pressed&&(a.hat+="right",a.hatmap|=s.RIGHT);break;case 16:a.buttons.home=u.buttons[l].pressed;break}return u.xbox=a,u}},s.prototype.onDrawBackground=function(r){if(!this.flags.collapsed){var n=this._left_axis,u=this._right_axis;r.strokeStyle="#88A",r.strokeRect((n[0]+1)*.5*this.size[0]-4,(n[1]+1)*.5*this.size[1]-4,8,8),r.strokeStyle="#8A8",r.strokeRect((u[0]+1)*.5*this.size[0]-4,(u[1]+1)*.5*this.size[1]-4,8,8);var o=this.size[1]/this._current_buttons.length;r.fillStyle="#AEB";for(var a=0;a<this._current_buttons.length;++a)this._current_buttons[a]&&r.fillRect(0,o*a,6,o)}},s.prototype.onGetOutputs=function(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",t.EVENT],["b_button_event",t.EVENT],["x_button_event",t.EVENT],["y_button_event",t.EVENT],["lb_button_event",t.EVENT],["rb_button_event",t.EVENT],["ls_button_event",t.EVENT],["rs_button_event",t.EVENT],["start_button_event",t.EVENT],["back_button_event",t.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",t.EVENT]]},t.registerNodeType("input/gamepad",s)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}s.title="Converter",s.desc="type A to type B",s.prototype.onExecute=function(){var b=this.getInputData(0);if(b!=null&&this.outputs)for(var z=0;z<this.outputs.length;z++){var S=this.outputs[z];if(!(!S.links||!S.links.length)){var A=null;switch(S.name){case"number":A=b.length?b[0]:parseFloat(b);break;case"vec2":case"vec3":case"vec4":var A=null,P=1;switch(S.name){case"vec2":P=2;break;case"vec3":P=3;break;case"vec4":P=4;break}var A=new Float32Array(P);if(b.length)for(var W=0;W<b.length&&W<A.length;W++)A[W]=b[W];else A[0]=parseFloat(b);break}this.setOutputData(z,A)}}},s.prototype.onGetOutputs=function(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]},t.registerNodeType("math/converter",s);function r(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}r.title="Bypass",r.desc="removes the type",r.prototype.onExecute=function(){var b=this.getInputData(0);this.setOutputData(0,b)},t.registerNodeType("math/bypass",r);function n(){this.addInput("in"),this.addOutput("out")}n.title="to Number",n.desc="Cast to number",n.prototype.onExecute=function(){var b=this.getInputData(0);this.setOutputData(0,Number(b))},t.registerNodeType("math/to_number",n);function u(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}u.title="Range",u.desc="Convert a number from one range to another",u.prototype.getTitle=function(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title},u.prototype.onExecute=function(){if(this.inputs)for(var b=0;b<this.inputs.length;b++){var z=this.inputs[b],S=this.getInputData(b);S!==void 0&&(this.properties[z.name]=S)}var S=this.properties.in;(S==null||S.constructor!==Number)&&(S=0);var A=this.properties.in_min,P=this.properties.in_max,W=this.properties.out_min,X=this.properties.out_max;this._last_v=(S-A)/(P-A)*(X-W)+W,this.setOutputData(0,this._last_v),this.setOutputData(1,clamp(this._last_v,W,X))},u.prototype.onDrawBackground=function(b){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"},u.prototype.onGetInputs=function(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]},t.registerNodeType("math/range",u);function o(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}o.title="Rand",o.desc="Random number",o.prototype.onExecute=function(){if(this.inputs)for(var b=0;b<this.inputs.length;b++){var z=this.inputs[b],S=this.getInputData(b);S!==void 0&&(this.properties[z.name]=S)}var A=this.properties.min,P=this.properties.max;this._last_v=Math.random()*(P-A)+A,this.setOutputData(0,this._last_v)},o.prototype.onDrawBackground=function(b){this.outputs[0].label=(this._last_v||0).toFixed(3)},o.prototype.onGetInputs=function(){return[["min","number"],["max","number"]]},t.registerNodeType("math/rand",o);function a(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}a.title="Noise",a.desc="Random number with temporal continuity",a.data=null,a.getValue=function(P,z){if(!a.data){a.data=new Float32Array(1024);for(var S=0;S<a.data.length;++S)a.data[S]=Math.random()}P=P%1024,P<0&&(P+=1024);var A=Math.floor(P),P=P-A,W=a.data[A],X=a.data[A==1023?0:A+1];return z&&(P=P*P*P*(P*(P*6-15)+10)),W*(1-P)+X*P},a.prototype.onExecute=function(){var b=this.getInputData(0)||0,z=this.properties.octaves||1,S=0,A=1,P=this.properties.seed||0;b+=P;for(var W=this.properties.speed||1,X=0,Z=0;Z<z&&(S+=a.getValue(b*(1+Z)*W,this.properties.smooth)*A,X+=A,A*=this.properties.persistence,!(A<.001));++Z);S/=X;var tt=this.properties.min,et=this.properties.max;this._last_v=S*(et-tt)+tt,this.setOutputData(0,this._last_v)},a.prototype.onDrawBackground=function(b){this.outputs[0].label=(this._last_v||0).toFixed(3)},t.registerNodeType("math/noise",a);function l(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}l.title="Spikes",l.desc="spike every random time",l.prototype.onExecute=function(){var b=this.graph.elapsed_time;this._remaining_time-=b,this._blink_time-=b;var z=0;if(this._blink_time>0){var S=this._blink_time/this.properties.duration;z=1/(Math.pow(S*8-4,4)+1)}this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,z)},t.registerNodeType("math/spikes",l);function f(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}f.title="Clamp",f.desc="Clamp number between min and max",f.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&(b=Math.max(this.properties.min,b),b=Math.min(this.properties.max,b),this.setOutputData(0,b))},f.prototype.getCode=function(b){var z="";return this.isInputConnected(0)&&(z+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),z},t.registerNodeType("math/clamp",f);function m(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}m.title="Lerp",m.desc="Linear Interpolation",m.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=0);var z=this.getInputData(1);z==null&&(z=0);var S=this.properties.f,A=this.getInputData(2);A!==void 0&&(S=A),this.setOutputData(0,b*(1-S)+z*S)},m.prototype.onGetInputs=function(){return[["f","number"]]},t.registerNodeType("math/lerp",m);function O(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}O.title="Abs",O.desc="Absolute",O.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&this.setOutputData(0,Math.abs(b))},t.registerNodeType("math/abs",O);function d(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}d.title="Floor",d.desc="Floor number to remove fractional part",d.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&this.setOutputData(0,Math.floor(b))},t.registerNodeType("math/floor",d);function g(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}g.title="Frac",g.desc="Returns fractional part",g.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&this.setOutputData(0,b%1)},t.registerNodeType("math/frac",g);function E(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}E.title="Smoothstep",E.desc="Smoothstep",E.prototype.onExecute=function(){var b=this.getInputData(0);if(b!==void 0){var z=this.properties.A,S=this.properties.B;b=clamp((b-z)/(S-z),0,1),b=b*b*(3-2*b),this.setOutputData(0,b)}},t.registerNodeType("math/smoothstep",E);function I(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}I.title="Scale",I.desc="v * factor",I.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&this.setOutputData(0,b*this.properties.factor)},t.registerNodeType("math/scale",I);function k(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}k.title="Gate",k.desc="if v is true, then outputs A, otherwise B",k.prototype.onExecute=function(){var b=this.getInputData(0);this.setOutputData(0,this.getInputData(b?1:2))},t.registerNodeType("math/gate",k);function N(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}N.title="Average",N.desc="Average Filter",N.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=0);var z=this._values.length;this._values[this._current%z]=b,this._current+=1,this._current>z&&(this._current=0);for(var S=0,A=0;A<z;++A)S+=this._values[A];this.setOutputData(0,S/z)},N.prototype.onPropertyChanged=function(b,z){z<1&&(z=1),this.properties.samples=Math.round(z);var S=this._values;this._values=new Float32Array(this.properties.samples),S.length<=this._values.length?this._values.set(S):this._values.set(S.subarray(0,this._values.length))},t.registerNodeType("math/average",N);function T(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}T.title="TendTo",T.desc="moves the output value always closer to the input",T.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=0);var z=this.properties.factor;this._value==null?this._value=b:this._value=this._value*(1-z)+b*z,this.setOutputData(0,this._value)},t.registerNodeType("math/tendTo",T);function h(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:h.values}),this._func=h.funcs[this.properties.OP],this._result=[]}h.values=["+","-","*","/","%","^","max","min"],h.funcs={"+":function(b,z){return b+z},"-":function(b,z){return b-z},x:function(b,z){return b*z},X:function(b,z){return b*z},"*":function(b,z){return b*z},"/":function(b,z){return b/z},"%":function(b,z){return b%z},"^":function(b,z){return Math.pow(b,z)},max:function(b,z){return Math.max(b,z)},min:function(b,z){return Math.min(b,z)}},h.title="Operation",h.desc="Easy math operators",h["@OP"]={type:"enum",title:"operation",values:h.values},h.size=[100,60],h.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},h.prototype.setValue=function(b){typeof b=="string"&&(b=parseFloat(b)),this.properties.value=b},h.prototype.onPropertyChanged=function(b,z){b=="OP"&&(this._func=h.funcs[this.properties.OP],this._func||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(S){return S}))},h.prototype.onExecute=function(){var b=this.getInputData(0),z=this.getInputData(1);b!=null?b.constructor===Number&&(this.properties.A=b):b=this.properties.A,z!=null?this.properties.B=z:z=this.properties.B;var S=h.funcs[this.properties.OP],A;if(b.constructor===Number)A=0,A=S(b,z);else if(b.constructor===Array){A=this._result,A.length=b.length;for(var P=0;P<b.length;++P)A[P]=S(b[P],z)}else{A={};for(var P in b)A[P]=S(b[P],z)}this.setOutputData(0,A)},h.prototype.onDrawBackground=function(b){this.flags.collapsed||(b.font="40px Arial",b.fillStyle="#666",b.textAlign="center",b.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+t.NODE_TITLE_HEIGHT)*.5),b.textAlign="left")},t.registerNodeType("math/operation",h),t.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),t.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});function L(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}L.title="Compare",L.desc="compares between two values",L.prototype.onExecute=function(){var b=this.getInputData(0),z=this.getInputData(1);b!==void 0?this.properties.A=b:b=this.properties.A,z!==void 0?this.properties.B=z:z=this.properties.B;for(var S=0,A=this.outputs.length;S<A;++S){var P=this.outputs[S];if(!(!P.links||!P.links.length)){var W;switch(P.name){case"A==B":W=b==z;break;case"A!=B":W=b!=z;break;case"A>B":W=b>z;break;case"A<B":W=b<z;break;case"A<=B":W=b<=z;break;case"A>=B":W=b>=z;break}this.setOutputData(S,W)}}},L.prototype.onGetOutputs=function(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]},t.registerNodeType("math/compare",L),t.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),t.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),t.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),t.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),t.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),t.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});function _(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:_.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:_.values}),this.size=[80,60]}_.values=[">","<","==","!=","<=",">=","||","&&"],_["@OP"]={type:"enum",title:"operation",values:_.values},_.title="Condition",_.desc="evaluates condition between A and B",_.prototype.getTitle=function(){return"A "+this.properties.OP+" B"},_.prototype.onExecute=function(){var b=this.getInputData(0);b===void 0?b=this.properties.A:this.properties.A=b;var z=this.getInputData(1);z===void 0?z=this.properties.B:this.properties.B=z;var S=!0;switch(this.properties.OP){case">":S=b>z;break;case"<":S=b<z;break;case"==":S=b==z;break;case"!=":S=b!=z;break;case"<=":S=b<=z;break;case">=":S=b>=z;break;case"||":S=b||z;break;case"&&":S=b&&z;break}this.setOutputData(0,S),this.setOutputData(1,!S)},t.registerNodeType("math/condition",_);function D(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}D.title="Branch",D.desc="If condition is true, outputs IN in true, otherwise in false",D.prototype.onExecute=function(){var b=this.getInputData(0),z=this.getInputData(1);z?(this.setOutputData(0,b),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,b))},t.registerNodeType("math/branch",D);function B(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}B.title="Accumulate",B.desc="Increments a value every time",B.prototype.onExecute=function(){this.properties.value===null&&(this.properties.value=0);var b=this.getInputData(0);b!==null?this.properties.value+=b:this.properties.value+=this.properties.increment,this.setOutputData(0,this.properties.value)},t.registerNodeType("math/accumulate",B);function F(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}F.title="Trigonometry",F.desc="Sin Cos Tan",F.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=0);var z=this.properties.amplitude,S=this.findInputSlot("amplitude");S!=-1&&(z=this.getInputData(S));var A=this.properties.offset;S=this.findInputSlot("offset"),S!=-1&&(A=this.getInputData(S));for(var P=0,W=this.outputs.length;P<W;++P){var X=this.outputs[P],Z;switch(X.name){case"sin":Z=Math.sin(b);break;case"cos":Z=Math.cos(b);break;case"tan":Z=Math.tan(b);break;case"asin":Z=Math.asin(b);break;case"acos":Z=Math.acos(b);break;case"atan":Z=Math.atan(b);break}this.setOutputData(P,z*Z+A)}},F.prototype.onGetInputs=function(){return[["v","number"],["amplitude","number"],["offset","number"]]},F.prototype.onGetOutputs=function(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]},t.registerNodeType("math/trigonometry",F),t.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),t.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),t.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});function H(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(b,z,S){S.properties.formula=b}),this.addWidget("toggle","allow",t.allow_scripts,function(b){t.allow_scripts=b}),this._func=null}H.title="Formula",H.desc="Compute formula",H.size=[160,100],N.prototype.onPropertyChanged=function(b,z){b=="formula"&&(this.code_widget.value=z)},H.prototype.onExecute=function(){if(t.allow_scripts){var b=this.getInputData(0),z=this.getInputData(1);b!=null?this.properties.x=b:b=this.properties.x,z!=null?this.properties.y=z:z=this.properties.y,this.properties.formula;var S;try{(!this._func||this._func_code!=this.properties.formula)&&(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),S=this._func(b,z,this.graph.globaltime),this.boxcolor=null}catch{this.boxcolor="red"}this.setOutputData(0,S)}},H.prototype.getTitle=function(){return this._func_code||"Formula"},H.prototype.onDrawBackground=function(){var b=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=b)},t.registerNodeType("math/formula",H);function V(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}V.title="Vec2->XY",V.desc="vector 2 to components",V.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&(this.setOutputData(0,b[0]),this.setOutputData(1,b[1]))},t.registerNodeType("math3d/vec2-to-xy",V);function Y(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}Y.title="XY->Vec2",Y.desc="components to vector2",Y.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=this.properties.x);var z=this.getInputData(1);z==null&&(z=this.properties.y);var S=this._data;S[0]=b,S[1]=z,this.setOutputData(0,S)},t.registerNodeType("math3d/xy-to-vec2",Y);function K(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}K.title="Vec3->XYZ",K.desc="vector 3 to components",K.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&(this.setOutputData(0,b[0]),this.setOutputData(1,b[1]),this.setOutputData(2,b[2]))},t.registerNodeType("math3d/vec3-to-xyz",K);function J(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}J.title="XYZ->Vec3",J.desc="components to vector3",J.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=this.properties.x);var z=this.getInputData(1);z==null&&(z=this.properties.y);var S=this.getInputData(2);S==null&&(S=this.properties.z);var A=this._data;A[0]=b,A[1]=z,A[2]=S,this.setOutputData(0,A)},t.registerNodeType("math3d/xyz-to-vec3",J);function C(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}C.title="Vec4->XYZW",C.desc="vector 4 to components",C.prototype.onExecute=function(){var b=this.getInputData(0);b!=null&&(this.setOutputData(0,b[0]),this.setOutputData(1,b[1]),this.setOutputData(2,b[2]),this.setOutputData(3,b[3]))},t.registerNodeType("math3d/vec4-to-xyzw",C);function R(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}R.title="XYZW->Vec4",R.desc="components to vector4",R.prototype.onExecute=function(){var b=this.getInputData(0);b==null&&(b=this.properties.x);var z=this.getInputData(1);z==null&&(z=this.properties.y);var S=this.getInputData(2);S==null&&(S=this.properties.z);var A=this.getInputData(3);A==null&&(A=this.properties.w);var P=this._data;P[0]=b,P[1]=z,P[2]=S,P[3]=A,this.setOutputData(0,P)},t.registerNodeType("math3d/xyzw-to-vec4",R)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addInput("T","vec3"),this.addInput("R","vec3"),this.addInput("S","vec3"),this.addOutput("mat4","mat4"),this.properties={T:[0,0,0],R:[0,0,0],S:[1,1,1],R_in_degrees:!0},this._result=mat4.create(),this._must_update=!0}s.title="mat4",s.temp_quat=new Float32Array([0,0,0,1]),s.temp_mat4=new Float32Array(16),s.temp_vec3=new Float32Array(3),s.prototype.onPropertyChanged=function(N,T){this._must_update=!0},s.prototype.onExecute=function(){var N=this._result,T=s.temp_quat,h=s.temp_mat4,L=s.temp_vec3,_=this.getInputData(0),D=this.getInputData(1),B=this.getInputData(2);(this._must_update||_||D||B)&&(_=_||this.properties.T,D=D||this.properties.R,B=B||this.properties.S,mat4.identity(N),mat4.translate(N,N,_),this.properties.R_in_degrees?(L.set(D),vec3.scale(L,L,DEG2RAD),quat.fromEuler(T,L)):quat.fromEuler(T,D),mat4.fromQuat(h,T),mat4.multiply(N,N,h),mat4.scale(N,N,B)),this.setOutputData(0,N)},t.registerNodeType("math3d/mat4",s);function r(){this.addInput("A","number,vec3"),this.addInput("B","number,vec3"),this.addOutput("=","number,vec3"),this.addProperty("OP","+","enum",{values:r.values}),this._result=vec3.create()}r.values=["+","-","*","/","%","^","max","min","dot","cross"],t.registerSearchboxExtra("math3d/operation","CROSS()",{properties:{OP:"cross"},title:"CROSS()"}),t.registerSearchboxExtra("math3d/operation","DOT()",{properties:{OP:"dot"},title:"DOT()"}),r.title="Operation",r.desc="Easy math 3D operators",r["@OP"]={type:"enum",title:"operation",values:r.values},r.size=[100,60],r.prototype.getTitle=function(){return this.properties.OP=="max"||this.properties.OP=="min"?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"},r.prototype.onExecute=function(){var N=this.getInputData(0),T=this.getInputData(1);if(!(N==null||T==null)){N.constructor===Number&&(N=[N,N,N]),T.constructor===Number&&(T=[T,T,T]);var h=this._result;switch(this.properties.OP){case"+":h=vec3.add(h,N,T);break;case"-":h=vec3.sub(h,N,T);break;case"x":case"X":case"*":h=vec3.mul(h,N,T);break;case"/":h=vec3.div(h,N,T);break;case"%":h[0]=N[0]%T[0],h[1]=N[1]%T[1],h[2]=N[2]%T[2];break;case"^":h[0]=Math.pow(N[0],T[0]),h[1]=Math.pow(N[1],T[1]),h[2]=Math.pow(N[2],T[2]);break;case"max":h[0]=Math.max(N[0],T[0]),h[1]=Math.max(N[1],T[1]),h[2]=Math.max(N[2],T[2]);break;case"min":h[0]=Math.min(N[0],T[0]),h[1]=Math.min(N[1],T[1]),h[2]=Math.min(N[2],T[2]);case"dot":h=vec3.dot(N,T);break;case"cross":vec3.cross(h,N,T);break;default:console.warn("Unknown operation: "+this.properties.OP)}this.setOutputData(0,h)}},r.prototype.onDrawBackground=function(N){this.flags.collapsed||(N.font="40px Arial",N.fillStyle="#666",N.textAlign="center",N.fillText(this.properties.OP,this.size[0]*.5,(this.size[1]+t.NODE_TITLE_HEIGHT)*.5),N.textAlign="left")},t.registerNodeType("math3d/operation",r);function n(){this.addInput("in","vec3"),this.addInput("f","number"),this.addOutput("out","vec3"),this.properties={f:1},this._data=new Float32Array(3)}n.title="vec3_scale",n.desc="scales the components of a vec3",n.prototype.onExecute=function(){var N=this.getInputData(0);if(N!=null){var T=this.getInputData(1);T==null&&(T=this.properties.f);var h=this._data;h[0]=N[0]*T,h[1]=N[1]*T,h[2]=N[2]*T,this.setOutputData(0,h)}},t.registerNodeType("math3d/vec3-scale",n);function u(){this.addInput("in","vec3"),this.addOutput("out","number")}u.title="vec3_length",u.desc="returns the module of a vector",u.prototype.onExecute=function(){var N=this.getInputData(0);if(N!=null){var T=Math.sqrt(N[0]*N[0]+N[1]*N[1]+N[2]*N[2]);this.setOutputData(0,T)}},t.registerNodeType("math3d/vec3-length",u);function o(){this.addInput("in","vec3"),this.addOutput("out","vec3"),this._data=new Float32Array(3)}o.title="vec3_normalize",o.desc="returns the vector normalized",o.prototype.onExecute=function(){var N=this.getInputData(0);if(N!=null){var T=Math.sqrt(N[0]*N[0]+N[1]*N[1]+N[2]*N[2]),h=this._data;h[0]=N[0]/T,h[1]=N[1]/T,h[2]=N[2]/T,this.setOutputData(0,h)}},t.registerNodeType("math3d/vec3-normalize",o);function a(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addInput("f","vec3"),this.addOutput("out","vec3"),this.properties={f:.5},this._data=new Float32Array(3)}a.title="vec3_lerp",a.desc="returns the interpolated vector",a.prototype.onExecute=function(){var N=this.getInputData(0);if(N!=null){var T=this.getInputData(1);if(T!=null){var h=this.getInputOrProperty("f"),L=this._data;L[0]=N[0]*(1-h)+T[0]*h,L[1]=N[1]*(1-h)+T[1]*h,L[2]=N[2]*(1-h)+T[2]*h,this.setOutputData(0,L)}}},t.registerNodeType("math3d/vec3-lerp",a);function l(){this.addInput("A","vec3"),this.addInput("B","vec3"),this.addOutput("out","number")}if(l.title="vec3_dot",l.desc="returns the dot product",l.prototype.onExecute=function(){var N=this.getInputData(0);if(N!=null){var T=this.getInputData(1);if(T!=null){var h=N[0]*T[0]+N[1]*T[1]+N[2]*T[2];this.setOutputData(0,h)}}},t.registerNodeType("math3d/vec3-dot",l),e.glMatrix){let N=function(){this.addOutput("quat","quat"),this.properties={x:0,y:0,z:0,w:1,normalize:!1},this._value=quat.create()},T=function(){this.addInputs([["degrees","number"],["axis","vec3"]]),this.addOutput("quat","quat"),this.properties={angle:90,axis:vec3.fromValues(0,1,0)},this._value=quat.create()},h=function(){this.addInput("euler","vec3"),this.addOutput("quat","quat"),this.properties={euler:[0,0,0],use_yaw_pitch_roll:!1},this._degs=vec3.create(),this._value=quat.create()},L=function(){this.addInput(["quat","quat"]),this.addOutput("euler","vec3"),this._value=vec3.create()},_=function(){this.addInputs([["vec3","vec3"],["quat","quat"]]),this.addOutput("result","vec3"),this.properties={vec:[0,0,1]}},D=function(){this.addInputs([["A","quat"],["B","quat"]]),this.addOutput("A*B","quat"),this._value=quat.create()},B=function(){this.addInputs([["A","quat"],["B","quat"],["factor","number"]]),this.addOutput("slerp","quat"),this.addProperty("factor",.5),this._value=quat.create()},F=function(){this.addInput("vec3","vec3"),this.addOutput("remap","vec3"),this.addOutput("clamped","vec3"),this.properties={clamp:!0,range_min:[-1,-1,0],range_max:[1,1,0],target_min:[-1,-1,0],target_max:[1,1,0]},this._value=vec3.create(),this._clamped=vec3.create()};var f=N,m=T,O=h,d=L,g=_,E=D,I=B,k=F;N.title="Quaternion",N.desc="quaternion",N.prototype.onExecute=function(){this._value[0]=this.getInputOrProperty("x"),this._value[1]=this.getInputOrProperty("y"),this._value[2]=this.getInputOrProperty("z"),this._value[3]=this.getInputOrProperty("w"),this.properties.normalize&&quat.normalize(this._value,this._value),this.setOutputData(0,this._value)},N.prototype.onGetInputs=function(){return[["x","number"],["y","number"],["z","number"],["w","number"]]},t.registerNodeType("math3d/quaternion",N),T.title="Rotation",T.desc="quaternion rotation",T.prototype.onExecute=function(){var H=this.getInputData(0);H==null&&(H=this.properties.angle);var V=this.getInputData(1);V==null&&(V=this.properties.axis);var Y=quat.setAxisAngle(this._value,V,H*.0174532925);this.setOutputData(0,Y)},t.registerNodeType("math3d/rotation",T),h.title="Euler->Quat",h.desc="Converts euler angles (in degrees) to quaternion",h.prototype.onExecute=function(){var H=this.getInputData(0);H==null&&(H=this.properties.euler),vec3.scale(this._degs,H,DEG2RAD),this.properties.use_yaw_pitch_roll&&(this._degs=[this._degs[2],this._degs[0],this._degs[1]]);var V=quat.fromEuler(this._value,this._degs);this.setOutputData(0,V)},t.registerNodeType("math3d/euler_to_quat",h),L.title="Euler->Quat",L.desc="Converts rotX,rotY,rotZ in degrees to quat",L.prototype.onExecute=function(){var H=this.getInputData(0);H&&(quat.toEuler(this._value,H),vec3.scale(this._value,this._value,DEG2RAD),this.setOutputData(0,this._value))},t.registerNodeType("math3d/quat_to_euler",L),_.title="Rot. Vec3",_.desc="rotate a point",_.prototype.onExecute=function(){var H=this.getInputData(0);H==null&&(H=this.properties.vec);var V=this.getInputData(1);V==null?this.setOutputData(H):this.setOutputData(0,vec3.transformQuat(vec3.create(),H,V))},t.registerNodeType("math3d/rotate_vec3",_),D.title="Mult. Quat",D.desc="rotate quaternion",D.prototype.onExecute=function(){var H=this.getInputData(0);if(H!=null){var V=this.getInputData(1);if(V!=null){var Y=quat.multiply(this._value,H,V);this.setOutputData(0,Y)}}},t.registerNodeType("math3d/mult-quat",D),B.title="Quat Slerp",B.desc="quaternion spherical interpolation",B.prototype.onExecute=function(){var H=this.getInputData(0);if(H!=null){var V=this.getInputData(1);if(V!=null){var Y=this.properties.factor;this.getInputData(2)!=null&&(Y=this.getInputData(2));var K=quat.slerp(this._value,H,V,Y);this.setOutputData(0,K)}}},t.registerNodeType("math3d/quat-slerp",B),F.title="Remap Range",F.desc="remap a 3D range",F.prototype.onExecute=function(){var H=this.getInputData(0);H&&this._value.set(H);for(var V=this.properties.range_min,Y=this.properties.range_max,K=this.properties.target_min,J=this.properties.target_max,C=0;C<3;++C){var R=Y[C]-V[C];if(this._clamped[C]=clamp(this._value[C],V[C],Y[C]),R==0){this._value[C]=(K[C]+J[C])*.5;continue}var b=(this._value[C]-V[C])/R;this.properties.clamp&&(b=clamp(b,0,1));var z=J[C]-K[C];this._value[C]=K[C]+b*z}this.setOutputData(0,this._value),this.setOutputData(1,this._clamped)},t.registerNodeType("math3d/remap_range",F)}else t.debug&&console.warn("No glmatrix found, some Math3D nodes may not work")})(litegraph),(function(e){var t=e.LiteGraph;function s(m){if(m&&m.constructor===Object)try{return JSON.stringify(m)}catch{return String(m)}return String(m)}t.wrapFunctionAsNode("string/toString",s,[""],"string");function r(m,O){return m==O}t.wrapFunctionAsNode("string/compare",r,["string","string"],"boolean");function n(m,O){return m===void 0?O:O===void 0?m:m+O}t.wrapFunctionAsNode("string/concatenate",n,["string","string"],"string");function u(m,O){return m===void 0||O===void 0?!1:m.indexOf(O)!=-1}t.wrapFunctionAsNode("string/contains",u,["string","string"],"boolean");function o(m){return m!=null&&m.constructor===String?m.toUpperCase():m}t.wrapFunctionAsNode("string/toUpperCase",o,["string"],"string");function a(m,O){if(O==null&&(O=this.properties.separator),m==null)return[];if(m.constructor===String)return m.split(O||" ");if(m.constructor===Array){for(var d=[],g=0;g<m.length;++g)typeof m[g]=="string"&&(d[g]=m[g].split(O||" "));return d}return null}t.wrapFunctionAsNode("string/split",a,["string,array","string"],"array",{separator:","});function l(m){return m!=null&&m.constructor===Number?m.toFixed(this.properties.precision):m}t.wrapFunctionAsNode("string/toFixed",l,["number"],"string",{precision:0});function f(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}f.title="toTable",f.desc="Splits a string to table",f.prototype.onExecute=function(){var m=this.getInputData(0);if(m){var O=this.properties.separator||",";(m!=this._str||O!=this._last_separator)&&(this._last_separator=O,this._str=m,this._table=m.split(`
`).map(function(d){return d.trim().split(O)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0)}},t.registerNodeType("string/toTable",f)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}s.title="Selector",s.desc="selects an output",s.prototype.onDrawBackground=function(f){if(!this.flags.collapsed){f.fillStyle="#AFB";var m=(this.selected+1)*t.NODE_SLOT_HEIGHT+6;f.beginPath(),f.moveTo(50,m),f.lineTo(50,m+t.NODE_SLOT_HEIGHT),f.lineTo(34,m+t.NODE_SLOT_HEIGHT*.5),f.fill()}},s.prototype.onExecute=function(){var f=this.getInputData(0);(f==null||f.constructor!==Number)&&(f=0),this.selected=f=Math.round(f)%(this.inputs.length-1);var m=this.getInputData(f+1);m!==void 0&&this.setOutputData(0,m)},s.prototype.onGetInputs=function(){return[["E",0],["F",0],["G",0],["H",0]]},t.registerNodeType("logic/selector",s);function r(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}r.title="Sequence",r.desc="select one element from a sequence from a string",r.prototype.onPropertyChanged=function(f,m){f=="sequence"&&(this.values=m.split(","))},r.prototype.onExecute=function(){var f=this.getInputData(1);f&&f!=this.current_sequence&&(this.values=f.split(","),this.current_sequence=f);var m=this.getInputData(0);m==null&&(m=0),this.index=m=Math.round(m)%this.values.length,this.setOutputData(0,this.values[m])},t.registerNodeType("logic/sequence",r);function n(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}n.title="AND",n.desc="Return true if all inputs are true",n.prototype.onExecute=function(){var f=!0;for(var m in this.inputs)if(!this.getInputData(m)){var f=!1;break}this.setOutputData(0,f)},n.prototype.onGetInputs=function(){return[["and","boolean"]]},t.registerNodeType("logic/AND",n);function u(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}u.title="OR",u.desc="Return true if at least one input is true",u.prototype.onExecute=function(){var f=!1;for(var m in this.inputs)if(this.getInputData(m)){f=!0;break}this.setOutputData(0,f)},u.prototype.onGetInputs=function(){return[["or","boolean"]]},t.registerNodeType("logic/OR",u);function o(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}o.title="NOT",o.desc="Return the logical negation",o.prototype.onExecute=function(){var f=!this.getInputData(0);this.setOutputData(0,f)},t.registerNodeType("logic/NOT",o);function a(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}a.title="bool == bool",a.desc="Compare for logical equality",a.prototype.onExecute=function(){var f=null,m=!0;for(var O in this.inputs)if(f===null)f=this.getInputData(O);else if(f!=this.getInputData(O)){m=!1;break}this.setOutputData(0,m)},a.prototype.onGetInputs=function(){return[["bool","boolean"]]},t.registerNodeType("logic/CompareBool",a);function l(){this.properties={},this.addInput("onTrigger",t.ACTION),this.addInput("condition","boolean"),this.addOutput("true",t.EVENT),this.addOutput("false",t.EVENT),this.mode=t.ON_TRIGGER}l.title="Branch",l.desc="Branch execution on condition",l.prototype.onExecute=function(f,m){var O=this.getInputData(1);O?this.triggerSlot(0):this.triggerSlot(1)},t.registerNodeType("logic/IF",l)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.addInput("A","Number"),this.addInput("B","Number"),this.addInput("C","Number"),this.addInput("D","Number"),this.values=[[],[],[],[]],this.properties={scale:2}}s.title="Plot",s.desc="Plots data over time",s.colors=["#FFF","#F99","#9F9","#99F"],s.prototype.onExecute=function(g){if(!this.flags.collapsed)for(var E=this.size,I=0;I<4;++I){var k=this.getInputData(I);if(k!=null){var N=this.values[I];N.push(k),N.length>E[0]&&N.shift()}}},s.prototype.onDrawBackground=function(g){if(!this.flags.collapsed){var E=this.size,I=.5*E[1]/this.properties.scale,k=s.colors,N=E[1]*.5;if(g.fillStyle="#000",g.fillRect(0,0,E[0],E[1]),g.strokeStyle="#555",g.beginPath(),g.moveTo(0,N),g.lineTo(E[0],N),g.stroke(),this.inputs)for(var T=0;T<4;++T){var h=this.values[T];if(!(!this.inputs[T]||!this.inputs[T].link)){g.strokeStyle=k[T],g.beginPath();var L=h[0]*I*-1+N;g.moveTo(0,clamp(L,0,E[1]));for(var _=1;_<h.length&&_<E[0];++_){var L=h[_]*I*-1+N;g.lineTo(_,clamp(L,0,E[1]))}g.stroke()}}}},t.registerNodeType("graphics/plot",s);function r(){this.addOutput("frame","image"),this.properties={url:""}}r.title="Image",r.desc="Image loader",r.widgets=[{name:"load",text:"Load",type:"button"}],r.supported_extensions=["jpg","jpeg","png","gif"],r.prototype.onAdded=function(){this.properties.url!=""&&this.img==null&&this.loadImage(this.properties.url)},r.prototype.onDrawBackground=function(g){this.flags.collapsed||this.img&&this.size[0]>5&&this.size[1]>5&&this.img.width&&g.drawImage(this.img,0,0,this.size[0],this.size[1])},r.prototype.onExecute=function(){this.img||(this.boxcolor="#000"),this.img&&this.img.width?this.setOutputData(0,this.img):this.setOutputData(0,null),this.img&&this.img.dirty&&(this.img.dirty=!1)},r.prototype.onPropertyChanged=function(g,E){return this.properties[g]=E,g=="url"&&E!=""&&this.loadImage(E),!0},r.prototype.loadImage=function(g,E){if(g==""){this.img=null;return}this.img=document.createElement("img"),g.substr(0,4)=="http"&&t.proxy&&(g=t.proxy+g.substr(g.indexOf(":")+3)),this.img.src=g,this.boxcolor="#F95";var I=this;this.img.onload=function(){E&&E(this),console.log("Image loaded, size: "+I.img.width+"x"+I.img.height),this.dirty=!0,I.boxcolor="#9F9",I.setDirtyCanvas(!0)},this.img.onerror=function(){console.log("error loading the image:"+g)}},r.prototype.onWidget=function(g,E){E.name=="load"&&this.loadImage(this.properties.url)},r.prototype.onDropFile=function(g){var E=this;this._url&&URL.revokeObjectURL(this._url),this._url=URL.createObjectURL(g),this.properties.url=this._url,this.loadImage(this._url,function(I){E.size[1]=I.height/I.width*E.size[0]})},t.registerNodeType("graphics/image",r);function n(){this.addInput("f","number"),this.addOutput("Color","color"),this.properties={colorA:"#444444",colorB:"#44AAFF",colorC:"#44FFAA",colorD:"#FFFFFF"}}n.title="Palette",n.desc="Generates a color",n.prototype.onExecute=function(){var g=[];this.properties.colorA!=null&&g.push(hex2num(this.properties.colorA)),this.properties.colorB!=null&&g.push(hex2num(this.properties.colorB)),this.properties.colorC!=null&&g.push(hex2num(this.properties.colorC)),this.properties.colorD!=null&&g.push(hex2num(this.properties.colorD));var E=this.getInputData(0);if(E==null&&(E=.5),E>1?E=1:E<0&&(E=0),g.length!=0){var I=[0,0,0];if(E==0)I=g[0];else if(E==1)I=g[g.length-1];else{var k=(g.length-1)*E,N=g[Math.floor(k)],T=g[Math.floor(k)+1],h=k-Math.floor(k);I[0]=N[0]*(1-h)+T[0]*h,I[1]=N[1]*(1-h)+T[1]*h,I[2]=N[2]*(1-h)+T[2]*h}for(var L=0;L<I.length;L++)I[L]/=255;this.boxcolor=colorToString(I),this.setOutputData(0,I)}},t.registerNodeType("color/palette",n);function u(){this.addInput("","image,canvas"),this.size=[200,200]}u.title="Frame",u.desc="Frame viewerew",u.widgets=[{name:"resize",text:"Resize box",type:"button"},{name:"view",text:"View Image",type:"button"}],u.prototype.onDrawBackground=function(g){this.frame&&!this.flags.collapsed&&g.drawImage(this.frame,0,0,this.size[0],this.size[1])},u.prototype.onExecute=function(){this.frame=this.getInputData(0),this.setDirtyCanvas(!0)},u.prototype.onWidget=function(g,E){if(E.name=="resize"&&this.frame){var I=this.frame.width,k=this.frame.height;!I&&this.frame.videoWidth!=null&&(I=this.frame.videoWidth,k=this.frame.videoHeight),I&&k&&(this.size=[I,k]),this.setDirtyCanvas(!0,!0)}else E.name=="view"&&this.show()},u.prototype.show=function(){showElement&&this.frame&&showElement(this.frame)},t.registerNodeType("graphics/frame",u);function o(){this.addInputs([["img1","image"],["img2","image"],["fade","number"]]),this.addOutput("","image"),this.properties={fade:.5,width:512,height:512}}o.title="Image fade",o.desc="Fades between images",o.widgets=[{name:"resizeA",text:"Resize to A",type:"button"},{name:"resizeB",text:"Resize to B",type:"button"}],o.prototype.onAdded=function(){this.createCanvas();var g=this.canvas.getContext("2d");g.fillStyle="#000",g.fillRect(0,0,this.properties.width,this.properties.height)},o.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},o.prototype.onExecute=function(){var g=this.canvas.getContext("2d");this.canvas.width=this.canvas.width;var E=this.getInputData(0);E!=null&&g.drawImage(E,0,0,this.canvas.width,this.canvas.height);var I=this.getInputData(2);I==null?I=this.properties.fade:this.properties.fade=I,g.globalAlpha=I;var k=this.getInputData(1);k!=null&&g.drawImage(k,0,0,this.canvas.width,this.canvas.height),g.globalAlpha=1,this.setOutputData(0,this.canvas),this.setDirtyCanvas(!0)},t.registerNodeType("graphics/imagefade",o);function a(){this.addInput("","image"),this.addOutput("","image"),this.properties={width:256,height:256,x:0,y:0,scale:1},this.size=[50,20]}a.title="Crop",a.desc="Crop Image",a.prototype.onAdded=function(){this.createCanvas()},a.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.width=this.properties.width,this.canvas.height=this.properties.height},a.prototype.onExecute=function(){var g=this.getInputData(0);if(g)if(g.width){var E=this.canvas.getContext("2d");E.drawImage(g,-this.properties.x,-this.properties.y,g.width*this.properties.scale,g.height*this.properties.scale),this.setOutputData(0,this.canvas)}else this.setOutputData(0,null)},a.prototype.onDrawBackground=function(g){this.flags.collapsed||this.canvas&&g.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.size[0],this.size[1])},a.prototype.onPropertyChanged=function(g,E){return this.properties[g]=E,g=="scale"?(this.properties[g]=parseFloat(E),this.properties[g]==0&&(console.error("Error in scale"),this.properties[g]=1)):this.properties[g]=parseInt(E),this.createCanvas(),!0},t.registerNodeType("graphics/cropImage",a);function l(){this.addInput("clear",t.ACTION),this.addOutput("","canvas"),this.properties={width:512,height:512,autoclear:!0},this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")}l.title="Canvas",l.desc="Canvas to render stuff",l.prototype.onExecute=function(){var g=this.canvas,E=this.properties.width|0,I=this.properties.height|0;g.width!=E&&(g.width=E),g.height!=I&&(g.height=I),this.properties.autoclear&&this.ctx.clearRect(0,0,g.width,g.height),this.setOutputData(0,g)},l.prototype.onAction=function(g,E){g=="clear"&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},t.registerNodeType("graphics/canvas",l);function f(){this.addInput("canvas","canvas"),this.addInput("img","image,canvas"),this.addInput("x","number"),this.addInput("y","number"),this.properties={x:0,y:0,opacity:1}}f.title="DrawImage",f.desc="Draws image into a canvas",f.prototype.onExecute=function(){var g=this.getInputData(0);if(g){var E=this.getInputOrProperty("img");if(E){var I=this.getInputOrProperty("x"),k=this.getInputOrProperty("y"),N=g.getContext("2d");N.drawImage(E,I,k)}}},t.registerNodeType("graphics/drawImage",f);function m(){this.addInput("canvas","canvas"),this.addInput("x","number"),this.addInput("y","number"),this.addInput("w","number"),this.addInput("h","number"),this.properties={x:0,y:0,w:10,h:10,color:"white",opacity:1}}m.title="DrawRectangle",m.desc="Draws rectangle in canvas",m.prototype.onExecute=function(){var g=this.getInputData(0);if(g){var E=this.getInputOrProperty("x"),I=this.getInputOrProperty("y"),k=this.getInputOrProperty("w"),N=this.getInputOrProperty("h"),T=g.getContext("2d");T.fillRect(E,I,k,N)}},t.registerNodeType("graphics/drawRectangle",m);function O(){this.addInput("t","number"),this.addOutputs([["frame","image"],["t","number"],["d","number"]]),this.properties={url:"",use_proxy:!0}}O.title="Video",O.desc="Video playback",O.widgets=[{name:"play",text:"PLAY",type:"minibutton"},{name:"stop",text:"STOP",type:"minibutton"},{name:"demo",text:"Demo video",type:"button"},{name:"mute",text:"Mute video",type:"button"}],O.prototype.onExecute=function(){if(this.properties.url&&(this.properties.url!=this._video_url&&this.loadVideo(this.properties.url),!(!this._video||this._video.width==0))){var g=this.getInputData(0);g&&g>=0&&g<=1&&(this._video.currentTime=g*this._video.duration,this._video.pause()),this._video.dirty=!0,this.setOutputData(0,this._video),this.setOutputData(1,this._video.currentTime),this.setOutputData(2,this._video.duration),this.setDirtyCanvas(!0)}},O.prototype.onStart=function(){this.play()},O.prototype.onStop=function(){this.stop()},O.prototype.loadVideo=function(g){this._video_url=g;var E=g.substr(0,10).indexOf(":"),I="";E!=-1&&(I=g.substr(0,E));var k="";I&&(k=g.substr(0,g.indexOf("/",I.length+3)),k=k.substr(I.length+3)),this.properties.use_proxy&&I&&t.proxy&&k!=location.host&&(g=t.proxy+g.substr(g.indexOf(":")+3)),this._video=document.createElement("video"),this._video.src=g,this._video.type="type=video/mp4",this._video.muted=!0,this._video.autoplay=!0;var N=this;this._video.addEventListener("loadedmetadata",function(T){console.log("Duration: "+this.duration+" seconds"),console.log("Size: "+this.videoWidth+","+this.videoHeight),N.setDirtyCanvas(!0),this.width=this.videoWidth,this.height=this.videoHeight}),this._video.addEventListener("progress",function(T){console.log("video loading...")}),this._video.addEventListener("error",function(T){if(console.error("Error loading video: "+this.src),this.error)switch(this.error.code){case this.error.MEDIA_ERR_ABORTED:console.error("You stopped the video.");break;case this.error.MEDIA_ERR_NETWORK:console.error("Network error - please try again later.");break;case this.error.MEDIA_ERR_DECODE:console.error("Video is broken..");break;case this.error.MEDIA_ERR_SRC_NOT_SUPPORTED:console.error("Sorry, your browser can't play this video.");break}}),this._video.addEventListener("ended",function(T){console.log("Video Ended."),this.play()})},O.prototype.onPropertyChanged=function(g,E){return this.properties[g]=E,g=="url"&&E!=""&&this.loadVideo(E),!0},O.prototype.play=function(){this._video&&this._video.videoWidth&&this._video.play()},O.prototype.playPause=function(){this._video&&(this._video.paused?this.play():this.pause())},O.prototype.stop=function(){this._video&&(this._video.pause(),this._video.currentTime=0)},O.prototype.pause=function(){this._video&&(console.log("Video paused"),this._video.pause())},O.prototype.onWidget=function(g,E){},t.registerNodeType("graphics/video",O);function d(){this.addOutput("Webcam","image"),this.properties={filterFacingMode:!1,facingMode:"user"},this.boxcolor="black",this.frame=0}d.title="Webcam",d.desc="Webcam image",d.is_webcam_open=!1,d.prototype.openStream=function(){if(!navigator.mediaDevices.getUserMedia){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0;var g={audio:!1,video:this.properties.filterFacingMode?{facingMode:this.properties.facingMode}:!0};navigator.mediaDevices.getUserMedia(g).then(this.streamReady.bind(this)).catch(I);var E=this;function I(k){console.log("Webcam rejected",k),E._webcam_stream=!1,d.is_webcam_open=!1,E.boxcolor="red",E.trigger("stream_error")}},d.prototype.closeStream=function(){if(this._webcam_stream){var g=this._webcam_stream.getTracks();if(g.length)for(var E=0;E<g.length;++E)g[E].stop();d.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},d.prototype.onPropertyChanged=function(g,E){g=="facingMode"&&(this.properties.facingMode=E,this.closeStream(),this.openStream())},d.prototype.onRemoved=function(){this.closeStream()},d.prototype.streamReady=function(g){this._webcam_stream=g,this.boxcolor="green";var E=this._video;E||(E=document.createElement("video"),E.autoplay=!0,E.srcObject=g,this._video=E,E.onloadedmetadata=function(I){console.log(I),d.is_webcam_open=!0}),this.trigger("stream_ready",E)},d.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){this._video.frame=++this.frame,this._video.width=this._video.videoWidth,this._video.height=this._video.videoHeight,this.setOutputData(0,this._video);for(var g=1;g<this.outputs.length;++g)if(this.outputs[g])switch(this.outputs[g].name){case"width":this.setOutputData(g,this._video.videoWidth);break;case"height":this.setOutputData(g,this._video.videoHeight);break}}},d.prototype.getExtraMenuOptions=function(g){var E=this,I=E.properties.show?"Hide Frame":"Show Frame";return[{content:I,callback:function(){E.properties.show=!E.properties.show}}]},d.prototype.onDrawBackground=function(g){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._video&&(g.save(),g.drawImage(this._video,0,0,this.size[0],this.size[1]),g.restore())},d.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",t.EVENT],["stream_closed",t.EVENT],["stream_error",t.EVENT]]},t.registerNodeType("graphics/webcam",d)})(litegraph),(function(e){var t=e.LiteGraph,s=e.LGraphCanvas;if(e.LGraphTexture=null,typeof GL>"u")return;s.link_type_colors.Texture="#987";function r(){this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",filter:!0},this.size=[r.image_preview_size,r.image_preview_size]}e.LGraphTexture=r,r.title="Texture",r.desc="Texture",r.widgets_info={name:{widget:"texture"},filter:{widget:"checkbox"}},r.loadTextureCallback=null,r.image_preview_size=256,r.UNDEFINED=0,r.PASS_THROUGH=1,r.COPY=2,r.LOW=3,r.HIGH=4,r.REUSE=5,r.DEFAULT=2,r.MODE_VALUES={undefined:r.UNDEFINED,"pass through":r.PASS_THROUGH,copy:r.COPY,low:r.LOW,high:r.HIGH,reuse:r.REUSE,default:r.DEFAULT},r.getTexturesContainer=function(){return gl.textures},r.loadTexture=function(c,G){G=G||{};var M=c;M.substr(0,7)=="http://"&&t.proxy&&(M=t.proxy+M.substr(7));var U=r.getTexturesContainer(),q=U[c]=GL.Texture.fromURL(M,G);return q},r.getTexture=function(c){var G=this.getTexturesContainer();if(!G)throw"Cannot load texture, container of textures not found";var M=G[c];return!M&&c&&c[0]!=":"?this.loadTexture(c):M},r.getTargetTexture=function(c,G,M){if(!c)throw"LGraphTexture.getTargetTexture expects a reference texture";var U=null;switch(M){case r.LOW:U=gl.UNSIGNED_BYTE;break;case r.HIGH:U=gl.HIGH_PRECISION_FORMAT;break;case r.REUSE:return c;case r.COPY:default:U=c?c.type:gl.UNSIGNED_BYTE;break}return(!G||G.width!=c.width||G.height!=c.height||G.type!=U||G.format!=c.format)&&(G=new GL.Texture(c.width,c.height,{type:U,format:c.format,filter:gl.LINEAR})),G},r.getTextureType=function(c,G){var M=G?G.type:gl.UNSIGNED_BYTE;switch(c){case r.HIGH:M=gl.HIGH_PRECISION_FORMAT;break;case r.LOW:M=gl.UNSIGNED_BYTE;break}return M},r.getWhiteTexture=function(){if(this._white_texture)return this._white_texture;var c=this._white_texture=GL.Texture.fromMemory(1,1,[255,255,255,255],{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return c},r.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var c=new Uint8Array(512*512*4),G=0;G<512*512*4;++G)c[G]=Math.random()*255;var M=GL.Texture.fromMemory(512,512,c,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=M,M},r.prototype.onDropFile=function(c,G,M){if(!c)this._drop_texture=null,this.properties.name="";else{var U=null;if(typeof c=="string")U=GL.Texture.fromURL(c);else if(G.toLowerCase().indexOf(".dds")!=-1)U=GL.Texture.fromDDSInMemory(c);else{var q=new Blob([M]),j=URL.createObjectURL(q);U=GL.Texture.fromURL(j)}this._drop_texture=U,this.properties.name=G}},r.prototype.getExtraMenuOptions=function(c){var G=this;if(this._drop_texture)return[{content:"Clear",callback:function(){G._drop_texture=null,G.properties.name=""}}]},r.prototype.onExecute=function(){var c=null;if(this.isOutputConnected(1)&&(c=this.getInputData(0)),!c&&this._drop_texture&&(c=this._drop_texture),!c&&this.properties.name&&(c=r.getTexture(this.properties.name)),!c){this.setOutputData(0,null),this.setOutputData(1,"");return}this._last_tex=c,this.properties.filter===!1?c.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST):c.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR),this.setOutputData(0,c),this.setOutputData(1,c.fullpath||c.filename);for(var G=2;G<this.outputs.length;G++){var M=this.outputs[G];if(M){var U=null;M.name=="width"?U=c.width:M.name=="height"?U=c.height:M.name=="aspect"&&(U=c.width/c.height),this.setOutputData(G,U)}}},r.prototype.onResourceRenamed=function(c,G){this.properties.name==c&&(this.properties.name=G)},r.prototype.onDrawBackground=function(c){if(!(this.flags.collapsed||this.size[1]<=20)){if(this._drop_texture&&c.webgl){c.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);return}if(this._last_preview_tex!=this._last_tex)if(c.webgl)this._canvas=this._last_tex;else{var G=r.generateLowResTexturePreview(this._last_tex);if(!G)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(G)}this._canvas&&(c.save(),c.webgl||(c.translate(0,this.size[1]),c.scale(1,-1)),c.drawImage(this._canvas,0,0,this.size[0],this.size[1]),c.restore())}},r.generateLowResTexturePreview=function(c){if(!c)return null;var G=r.image_preview_size,M=c;if(c.format==gl.DEPTH_COMPONENT)return null;(c.width>G||c.height>G)&&(M=this._preview_temp_tex,this._preview_temp_tex||(M=new GL.Texture(G,G,{minFilter:gl.NEAREST}),this._preview_temp_tex=M),c.copyTo(M),c=M);var U=this._preview_canvas;return U||(U=createCanvas(G,G),this._preview_canvas=U),M&&M.toCanvas(U),U},r.prototype.getResources=function(c){return this.properties.name&&(c[this.properties.name]=GL.Texture),c},r.prototype.onGetInputs=function(){return[["in","Texture"]]},r.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["aspect","number"]]},r.replaceCode=function(c,G){return c.replace(/\{\{[a-zA-Z0-9_]*\}\}/g,function(M){return M=M.replace(/[\{\}]/g,""),G[M]||""})},t.registerNodeType("texture/texture",r);function n(){this.addInput("Texture","Texture"),this.properties={flipY:!1},this.size=[r.image_preview_size,r.image_preview_size]}n.title="Preview",n.desc="Show a texture in the graph canvas",n.allow_preview=!1,n.prototype.onDrawBackground=function(c){if(!this.flags.collapsed&&!(!c.webgl&&!n.allow_preview)){var G=this.getInputData(0);if(G){var M=null;!G.handle&&c.webgl?M=G:M=r.generateLowResTexturePreview(G),c.save(),this.properties.flipY&&(c.translate(0,this.size[1]),c.scale(1,-1)),c.drawImage(M,0,0,this.size[0],this.size[1]),c.restore()}}},t.registerNodeType("texture/preview",n);function u(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("name","string"),this.properties={name:"",generate_mipmaps:!1}}u.title="Save",u.desc="Save a texture in the repository",u.prototype.getPreviewTexture=function(){return this._texture},u.prototype.onExecute=function(){var c=this.getInputData(0);if(c){if(this.properties.generate_mipmaps&&(c.bind(0),c.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(c.texture_type),c.unbind(0)),this.properties.name)if(r.storeTexture)r.storeTexture(this.properties.name,c);else{var G=r.getTexturesContainer();G[this.properties.name]=c}this._texture=c,this.setOutputData(0,c),this.setOutputData(1,this.properties.name)}},t.registerNodeType("texture/save",u);function o(){this.addInput("Texture","Texture"),this.addInput("TextureB","Texture"),this.addInput("value","number"),this.addOutput("Texture","Texture"),this.help="<p>pixelcode must be vec3, uvcode must be vec2, is optional</p>				<p><strong>uv:</strong> tex. coords</p><p><strong>color:</strong> texture <strong>colorB:</strong> textureB</p><p><strong>time:</strong> scene time <strong>value:</strong> input value</p><p>For multiline you must type: result = ...</p>",this.properties={value:1,pixelcode:"color + colorB * value",uvcode:"",precision:r.DEFAULT},this.has_error=!1}o.widgets_info={uvcode:{widget:"code"},pixelcode:{widget:"code"},precision:{widget:"combo",values:r.MODE_VALUES}},o.title="Operation",o.desc="Texture shader operation",o.presets={},o.prototype.getExtraMenuOptions=function(c){var G=this,M=G.properties.show?"Hide Texture":"Show Texture";return[{content:M,callback:function(){G.properties.show=!G.properties.show}}]},o.prototype.onPropertyChanged=function(){this.has_error=!1},o.prototype.onDrawBackground=function(c){this.flags.collapsed||this.size[1]<=20||!this.properties.show||this._tex&&this._tex.gl==c&&(c.save(),c.drawImage(this._tex,0,0,this.size[0],this.size[1]),c.restore())},o.prototype.onExecute=function(){var c=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}var G=this.getInputData(1);if(!(!this.properties.uvcode&&!this.properties.pixelcode)){var M=512,U=512;c?(M=c.width,U=c.height):G&&(M=G.width,U=G.height),G||(G=GL.Texture.getWhiteTexture());var q=r.getTextureType(this.properties.precision,c);!c&&!this._tex?this._tex=new GL.Texture(M,U,{type:q,format:gl.RGBA,filter:gl.LINEAR}):this._tex=r.getTargetTexture(c||this._tex,this._tex,this.properties.precision);var j="";this.properties.uvcode&&(j="uv = "+this.properties.uvcode,this.properties.uvcode.indexOf(";")!=-1&&(j=this.properties.uvcode));var Q="";this.properties.pixelcode&&(Q="result = "+this.properties.pixelcode,this.properties.pixelcode.indexOf(";")!=-1&&(Q=this.properties.pixelcode));var $=this._shader;if(!this.has_error&&(!$||this._shader_code!=j+"|"+Q)){var rt=r.replaceCode(o.pixel_shader,{UV_CODE:j,PIXEL_CODE:Q});try{$=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,rt),this.boxcolor="#00FF00"}catch(ot){GL.Shader.dumpErrorToConsole(ot,Shader.SCREEN_VERTEX_SHADER,rt),this.boxcolor="#FF0000",this.has_error=!0;return}this._shader=$,this._shader_code=j+"|"+Q}if(this._shader){var nt=this.getInputData(2);nt!=null?this.properties.value=nt:nt=parseFloat(this.properties.value);var st=this.graph.getTime();this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),c&&c.bind(0),G&&G.bind(1);var ot=Mesh.getScreenQuad();$.uniforms({u_texture:0,u_textureB:1,value:nt,texSize:[M,U,1/M,1/U],time:st}).draw(ot)}),this.setOutputData(0,this._tex)}}}},o.pixel_shader=`precision highp float;
				
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				varying vec2 v_coord;
				uniform vec4 texSize;
				uniform float time;
				uniform float value;
				
				void main() {
					vec2 uv = v_coord;
					{{UV_CODE}};
					vec4 color4 = texture2D(u_texture, uv);
					vec3 color = color4.rgb;
					vec4 color4B = texture2D(u_textureB, uv);
					vec3 colorB = color4B.rgb;
					vec3 result = color;
					float alpha = 1.0;
					{{PIXEL_CODE}};
					gl_FragColor = vec4(result, alpha);
				}
				`,o.registerPreset=function(c,G){o.presets[c]=G},o.registerPreset("",""),o.registerPreset("bypass","color"),o.registerPreset("add","color + colorB * value"),o.registerPreset("substract","(color - colorB) * value"),o.registerPreset("mate","mix( color, colorB, color4B.a * value)"),o.registerPreset("invert","vec3(1.0) - color"),o.registerPreset("multiply","color * colorB * value"),o.registerPreset("divide","(color / colorB) / value"),o.registerPreset("difference","abs(color - colorB) * value"),o.registerPreset("max","max(color, colorB) * value"),o.registerPreset("min","min(color, colorB) * value"),o.registerPreset("displace","texture2D(u_texture, uv + (colorB.xy - vec2(0.5)) * value).xyz"),o.registerPreset("grayscale","vec3(color.x + color.y + color.z) * value / 3.0"),o.registerPreset("saturation","mix( vec3(color.x + color.y + color.z) / 3.0, color, value )"),o.registerPreset("normalmap",`
				float z0 = texture2D(u_texture, uv + vec2(-texSize.z, -texSize.w) ).x;
				float z1 = texture2D(u_texture, uv + vec2(0.0, -texSize.w) ).x;
				float z2 = texture2D(u_texture, uv + vec2(texSize.z, -texSize.w) ).x;
				float z3 = texture2D(u_texture, uv + vec2(-texSize.z, 0.0) ).x;
				float z4 = color.x;
				float z5 = texture2D(u_texture, uv + vec2(texSize.z, 0.0) ).x;
				float z6 = texture2D(u_texture, uv + vec2(-texSize.z, texSize.w) ).x;
				float z7 = texture2D(u_texture, uv + vec2(0.0, texSize.w) ).x;
				float z8 = texture2D(u_texture, uv + vec2(texSize.z, texSize.w) ).x;
				vec3 normal = vec3( z2 + 2.0*z4 + z7 - z0 - 2.0*z3 - z5, z5 + 2.0*z6 + z7 -z0 - 2.0*z1 - z2, 1.0 );
				normal.xy *= value;
				result.xyz = normalize(normal) * 0.5 + vec3(0.5);
			`),o.registerPreset("threshold","vec3(color.x > colorB.x * value ? 1.0 : 0.0,color.y > colorB.y * value ? 1.0 : 0.0,color.z > colorB.z * value ? 1.0 : 0.0)"),o.prototype.onInspect=function(c){var G=this;c.addCombo("Presets","",{values:Object.keys(o.presets),callback:function(M){var U=o.presets[M];U&&(G.setProperty("pixelcode",U),G.title=M,c.refresh())}})},t.registerNodeType("texture/operation",o);function a(){this.addOutput("out","Texture"),this.properties={code:"",u_value:1,u_color:[1,1,1,1],width:512,height:512,precision:r.DEFAULT},this.properties.code=a.pixel_shader,this._uniforms={u_value:1,u_color:vec4.create(),in_texture:0,texSize:vec4.create(),time:0}}a.title="Shader",a.desc="Texture shader",a.widgets_info={code:{type:"code",lang:"glsl"},precision:{widget:"combo",values:r.MODE_VALUES}},a.prototype.onPropertyChanged=function(c,G){if(c=="code"){var M=this.getShader();if(M){var U=M.uniformInfo;if(this.inputs)for(var q={},j=0;j<this.inputs.length;++j){var Q=this.getInputInfo(j);if(Q){if(U[Q.name]&&!q[Q.name]){q[Q.name]=!0;continue}this.removeInput(j),j--}}for(var j in U){var Q=M.uniformInfo[j];if(Q.loc!==null&&j!="time"){var $="number";if(this._shader.samplers[j])$="texture";else switch(Q.size){case 1:$="number";break;case 2:$="vec2";break;case 3:$="vec3";break;case 4:$="vec4";break;case 9:$="mat3";break;case 16:$="mat4";break;default:continue}var rt=this.findInputSlot(j);if(rt==-1){this.addInput(j,$);continue}var nt=this.getInputInfo(rt);if(!nt)this.addInput(j,$);else{if(nt.type==$)continue;this.removeInput(rt,$),this.addInput(j,$)}}}}}},a.prototype.getShader=function(){if(this._shader&&this._shader_code==this.properties.code)return this._shader;if(this._shader_code=this.properties.code,this._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,this.properties.code),this._shader)this.boxcolor="green";else return this.boxcolor="red",null;return this._shader},a.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getShader();if(c){var G=0,M=null;if(this.inputs)for(var U=0;U<this.inputs.length;++U){var q=this.getInputInfo(U),j=this.getInputData(U);j!=null&&(j.constructor===GL.Texture&&(j.bind(G),M||(M=j),j=G,G++),c.setUniform(q.name,j))}var Q=this._uniforms,$=r.getTextureType(this.properties.precision,M),rt=this.properties.width|0,nt=this.properties.height|0;rt==0&&(rt=M?M.width:gl.canvas.width),nt==0&&(nt=M?M.height:gl.canvas.height),Q.texSize[0]=rt,Q.texSize[1]=nt,Q.texSize[2]=1/rt,Q.texSize[3]=1/nt,Q.time=this.graph.getTime(),Q.u_value=this.properties.u_value,Q.u_color.set(this.properties.u_color),(!this._tex||this._tex.type!=$||this._tex.width!=rt||this._tex.height!=nt)&&(this._tex=new GL.Texture(rt,nt,{type:$,format:gl.RGBA,filter:gl.LINEAR}));var st=this._tex;st.drawTo(function(){c.uniforms(Q).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._tex)}}},a.pixel_shader=`precision highp float;
		
		varying vec2 v_coord;
		uniform float time; //time in seconds
		uniform vec4 texSize; //tex resolution
		uniform float u_value;
		uniform vec4 u_color;

		void main() {
			vec2 uv = v_coord;
			vec3 color = vec3(0.0);
			//your code here
			color.xy=uv;

			gl_FragColor = vec4(color, 1.0);
		}
		`,t.registerNodeType("texture/shader",a);function l(){this.addInput("in","Texture"),this.addInput("scale","vec2"),this.addInput("offset","vec2"),this.addOutput("out","Texture"),this.properties={offset:vec2.fromValues(0,0),scale:vec2.fromValues(1,1),precision:r.DEFAULT}}l.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},l.title="Scale/Offset",l.desc="Applies an scaling and offseting",l.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!this.isOutputConnected(0)||!c)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}var G=c.width,M=c.height,U=this.precision===r.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT;this.precision===r.DEFAULT&&(U=c.type),(!this._tex||this._tex.width!=G||this._tex.height!=M||this._tex.type!=U)&&(this._tex=new GL.Texture(G,M,{type:U,format:gl.RGBA,filter:gl.LINEAR}));var q=this._shader;q||(q=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,l.pixel_shader));var j=this.getInputData(1);j?(this.properties.scale[0]=j[0],this.properties.scale[1]=j[1]):j=this.properties.scale;var Q=this.getInputData(2);Q?(this.properties.offset[0]=Q[0],this.properties.offset[1]=Q[1]):Q=this.properties.offset,this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),c.bind(0);var $=Mesh.getScreenQuad();q.uniforms({u_texture:0,u_scale:j,u_offset:Q}).draw($)}),this.setOutputData(0,this._tex)}},l.pixel_shader=`precision highp float;
				
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				varying vec2 v_coord;
				uniform vec2 u_scale;
				uniform vec2 u_offset;
				
				void main() {
					vec2 uv = v_coord;
					uv = uv / u_scale - u_offset;
					gl_FragColor = texture2D(u_texture, uv);
				}
				`,t.registerNodeType("texture/scaleOffset",l);function f(){this.addInput("in","Texture"),this.addInput("warp","Texture"),this.addInput("factor","number"),this.addOutput("out","Texture"),this.properties={factor:.01,scale:[1,1],offset:[0,0],precision:r.DEFAULT},this._uniforms={u_texture:0,u_textureB:1,u_factor:1,u_scale:vec2.create(),u_offset:vec2.create()}}f.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},f.title="Warp",f.desc="Texture warp operation",f.prototype.onExecute=function(){var c=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}var G=this.getInputData(1),M=512,U=512;gl.UNSIGNED_BYTE,c?(M=c.width,U=c.height,c.type):G&&(M=G.width,U=G.height,G.type),!c&&!this._tex?this._tex=new GL.Texture(M,U,{type:this.precision===r.LOW?gl.UNSIGNED_BYTE:gl.HIGH_PRECISION_FORMAT,format:gl.RGBA,filter:gl.LINEAR}):this._tex=r.getTargetTexture(c||this._tex,this._tex,this.properties.precision);var q=this._shader;q||(q=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,f.pixel_shader));var j=this.getInputData(2);j!=null?this.properties.factor=j:j=parseFloat(this.properties.factor);var Q=this._uniforms;Q.u_factor=j,Q.u_scale.set(this.properties.scale),Q.u_offset.set(this.properties.offset),this._tex.drawTo(function(){gl.disable(gl.DEPTH_TEST),gl.disable(gl.CULL_FACE),gl.disable(gl.BLEND),c&&c.bind(0),G&&G.bind(1);var $=Mesh.getScreenQuad();q.uniforms(Q).draw($)}),this.setOutputData(0,this._tex)}},f.pixel_shader=`precision highp float;
				
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				varying vec2 v_coord;
				uniform float u_factor;
				uniform vec2 u_scale;
				uniform vec2 u_offset;
				
				void main() {
					vec2 uv = v_coord;
					uv += ( texture2D(u_textureB, uv).rg - vec2(0.5)) * u_factor * u_scale + u_offset;
					gl_FragColor = texture2D(u_texture, uv);
				}
				`,t.registerNodeType("texture/warp",f);function m(){this.addInput("Texture","Texture"),this.properties={additive:!1,antialiasing:!1,filter:!0,disable_alpha:!1,gamma:1,viewport:[0,0,1,1]},this.size[0]=130}m.title="to Viewport",m.desc="Texture to viewport",m._prev_viewport=new Float32Array(4),m.prototype.onDrawBackground=function(c){if(!(this.flags.collapsed||this.size[1]<=40)){var G=this.getInputData(0);G&&c.drawImage(c==gl?G:gl.canvas,10,30,this.size[0]-20,this.size[1]-40)}},m.prototype.onExecute=function(){var c=this.getInputData(0);if(c){this.properties.disable_alpha?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),this.properties.additive?gl.blendFunc(gl.SRC_ALPHA,gl.ONE):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),gl.disable(gl.DEPTH_TEST);var G=this.properties.gamma||1;this.isInputConnected(1)&&(G=this.getInputData(1)),c.setParameter(gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST);var M=m._prev_viewport;M.set(gl.viewport_data);var U=this.properties.viewport;if(gl.viewport(M[0]+M[2]*U[0],M[1]+M[3]*U[1],M[2]*U[2],M[3]*U[3]),gl.getViewport(),this.properties.antialiasing){m._shader||(m._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,m.aa_pixel_shader));var q=Mesh.getScreenQuad();c.bind(0),m._shader.uniforms({u_texture:0,uViewportSize:[c.width,c.height],u_igamma:1/G,inverseVP:[1/c.width,1/c.height]}).draw(q)}else G!=1?(m._gamma_shader||(m._gamma_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,m.gamma_pixel_shader)),c.toViewport(m._gamma_shader,{u_texture:0,u_igamma:1/G})):c.toViewport();gl.viewport(M[0],M[1],M[2],M[3])}},m.prototype.onGetInputs=function(){return[["gamma","number"]]},m.aa_pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec2 uViewportSize;
				uniform vec2 inverseVP;
				uniform float u_igamma;
				#define FXAA_REDUCE_MIN   (1.0/ 128.0)
				#define FXAA_REDUCE_MUL   (1.0 / 8.0)
				#define FXAA_SPAN_MAX     8.0
				
				/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */
				vec4 applyFXAA(sampler2D tex, vec2 fragCoord)
				{
					vec4 color = vec4(0.0);
					/*vec2 inverseVP = vec2(1.0 / uViewportSize.x, 1.0 / uViewportSize.y);*/
					vec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * inverseVP).xyz;
					vec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * inverseVP).xyz;
					vec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * inverseVP).xyz;
					vec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * inverseVP).xyz;
					vec3 rgbM  = texture2D(tex, fragCoord  * inverseVP).xyz;
					vec3 luma = vec3(0.299, 0.587, 0.114);
					float lumaNW = dot(rgbNW, luma);
					float lumaNE = dot(rgbNE, luma);
					float lumaSW = dot(rgbSW, luma);
					float lumaSE = dot(rgbSE, luma);
					float lumaM  = dot(rgbM,  luma);
					float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));
					float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));
					
					vec2 dir;
					dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
					dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));
					
					float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
					
					float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);
					dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * inverseVP;
					
					vec3 rgbA = 0.5 * (texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz + 
						texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);
					vec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz + 
						texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);
					
					//return vec4(rgbA,1.0);
					float lumaB = dot(rgbB, luma);
					if ((lumaB < lumaMin) || (lumaB > lumaMax))
						color = vec4(rgbA, 1.0);
					else
						color = vec4(rgbB, 1.0);
					if(u_igamma != 1.0)
						color.xyz = pow( color.xyz, vec3(u_igamma) );
					return color;
				}
				
				void main() {
				   gl_FragColor = applyFXAA( u_texture, v_coord * uViewportSize) ;
				}
				`,m.gamma_pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform float u_igamma;
				void main() {
					vec4 color = texture2D( u_texture, v_coord);
					color.xyz = pow(color.xyz, vec3(u_igamma) );
				   gl_FragColor = color;
				}
				`,t.registerNodeType("texture/toviewport",m);function O(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:0,generate_mipmaps:!1,precision:r.DEFAULT}}O.title="Copy",O.desc="Copy Texture",O.widgets_info={size:{widget:"combo",values:[0,32,64,128,256,512,1024,2048]},precision:{widget:"combo",values:r.MODE_VALUES}},O.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!c&&!this._temp_texture)&&this.isOutputConnected(0)){if(c){var G=c.width,M=c.height;this.properties.size!=0&&(G=this.properties.size,M=this.properties.size);var U=this._temp_texture,q=c.type;if(this.properties.precision===r.LOW?q=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(q=gl.HIGH_PRECISION_FORMAT),!U||U.width!=G||U.height!=M||U.type!=q){var j=gl.LINEAR;this.properties.generate_mipmaps&&isPowerOfTwo(G)&&isPowerOfTwo(M)&&(j=gl.LINEAR_MIPMAP_LINEAR),this._temp_texture=new GL.Texture(G,M,{type:q,format:gl.RGBA,minFilter:j,magFilter:gl.LINEAR})}c.copyTo(this._temp_texture),this.properties.generate_mipmaps&&(this._temp_texture.bind(0),gl.generateMipmap(this._temp_texture.texture_type),this._temp_texture.unbind(0))}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/copy",O);function d(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={iterations:1,generate_mipmaps:!1,precision:r.DEFAULT}}d.title="Downsample",d.desc="Downsample Texture",d.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:r.MODE_VALUES}},d.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!c&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!c||c.texture_type!==GL.TEXTURE_2D)){if(this.properties.iterations<1){this.setOutputData(0,c);return}var G=d._shader;G||(d._shader=G=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,d.pixel_shader));var M=c.width|0,U=c.height|0,q=c.type;this.properties.precision===r.LOW?q=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(q=gl.HIGH_PRECISION_FORMAT);var j=this.properties.iterations||1,Q=c,$=null,rt=[],nt={type:q,format:c.format},st=vec2.create(),ot={u_offset:st};this._texture&&GL.Texture.releaseTemporary(this._texture);for(var at=0;at<j&&(st[0]=1/M,st[1]=1/U,M=M>>1||0,U=U>>1||0,$=GL.Texture.getTemporary(M,U,nt),rt.push($),Q.setParameter(GL.TEXTURE_MAG_FILTER,GL.NEAREST),Q.copyTo($,G,ot),!(M==1&&U==1));++at)Q=$;this._texture=rt.pop();for(var at=0;at<rt.length;++at)GL.Texture.releaseTemporary(rt[at]);this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},d.pixel_shader=`precision highp float;
				precision highp float;
				uniform sampler2D u_texture;
				uniform vec2 u_offset;
				varying vec2 v_coord;
				
				void main() {
					vec4 color = texture2D(u_texture, v_coord );
					color += texture2D(u_texture, v_coord + vec2( u_offset.x, 0.0 ) );
					color += texture2D(u_texture, v_coord + vec2( 0.0, u_offset.y ) );
					color += texture2D(u_texture, v_coord + vec2( u_offset.x, u_offset.y ) );
				   gl_FragColor = color * 0.25;
				}
				`,t.registerNodeType("texture/downsample",d);function g(){this.addInput("Texture","Texture"),this.addOutput("","Texture"),this.properties={size:[512,512],generate_mipmaps:!1,precision:r.DEFAULT}}g.title="Resize",g.desc="Resize Texture",g.widgets_info={iterations:{type:"number",step:1,precision:0,min:0},precision:{widget:"combo",values:r.MODE_VALUES}},g.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!c&&!this._temp_texture)&&this.isOutputConnected(0)&&!(!c||c.texture_type!==GL.TEXTURE_2D)){var G=this.properties.size[0]|0,M=this.properties.size[1]|0;G==0&&(G=c.width),M==0&&(M=c.height);var U=c.type;this.properties.precision===r.LOW?U=gl.UNSIGNED_BYTE:this.properties.precision===r.HIGH&&(U=gl.HIGH_PRECISION_FORMAT),(!this._texture||this._texture.width!=G||this._texture.height!=M||this._texture.type!=U)&&(this._texture=new GL.Texture(G,M,{type:U})),c.copyTo(this._texture),this.properties.generate_mipmaps&&(this._texture.bind(0),gl.generateMipmap(this._texture.texture_type),this._texture.unbind(0)),this.setOutputData(0,this._texture)}},t.registerNodeType("texture/resize",g);function E(){this.addInput("Texture","Texture"),this.addOutput("tex","Texture"),this.addOutput("avg","vec4"),this.addOutput("lum","number"),this.properties={use_previous_frame:!0,high_quality:!1},this._uniforms={u_texture:0,u_mipmap_offset:0},this._luminance=new Float32Array(4)}E.title="Average",E.desc=`Compute a partial average (32 random samples) of a texture and stores it as a 1x1 pixel texture.
 If high_quality is true, then it generates the mipmaps first and reads from the lower one.`,E.prototype.onExecute=function(){this.properties.use_previous_frame||this.updateAverage();var c=this._luminance;this.setOutputData(0,this._temp_texture),this.setOutputData(1,c),this.setOutputData(2,(c[0]+c[1]+c[2])/3)},E.prototype.onPreRenderExecute=function(){this.updateAverage()},E.prototype.updateAverage=function(){var c=this.getInputData(0);if(c&&!(!this.isOutputConnected(0)&&!this.isOutputConnected(1)&&!this.isOutputConnected(2))){if(!E._shader){E._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,E.pixel_shader);for(var G=new Float32Array(16),M=0;M<G.length;++M)G[M]=Math.random();E._shader.uniforms({u_samples_a:G.subarray(0,16),u_samples_b:G.subarray(16,32)})}var U=this._temp_texture,q=gl.UNSIGNED_BYTE;c.type!=q&&(q=gl.FLOAT),(!U||U.type!=q)&&(this._temp_texture=new GL.Texture(1,1,{type:q,format:gl.RGBA,filter:gl.NEAREST})),this._uniforms.u_mipmap_offset=0,this.properties.high_quality&&((!this._temp_pot2_texture||this._temp_pot2_texture.type!=q)&&(this._temp_pot2_texture=new GL.Texture(512,512,{type:q,format:gl.RGBA,minFilter:gl.LINEAR_MIPMAP_LINEAR,magFilter:gl.LINEAR})),c.copyTo(this._temp_pot2_texture),c=this._temp_pot2_texture,c.bind(0),gl.generateMipmap(GL.TEXTURE_2D),this._uniforms.u_mipmap_offset=9);var j=E._shader,Q=this._uniforms;if(Q.u_mipmap_offset=this.properties.mipmap_offset,gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){c.toViewport(j,Q)}),this.isOutputConnected(1)||this.isOutputConnected(2)){var $=this._temp_texture.getPixels();if($){var rt=this._luminance,q=this._temp_texture.type;rt.set($),q==gl.UNSIGNED_BYTE?vec4.scale(rt,rt,1/255):q==GL.HALF_FLOAT||q==GL.HALF_FLOAT_OES}}}},E.pixel_shader=`precision highp float;
				precision highp float;
				uniform mat4 u_samples_a;
				uniform mat4 u_samples_b;
				uniform sampler2D u_texture;
				uniform float u_mipmap_offset;
				varying vec2 v_coord;
				
				void main() {
					vec4 color = vec4(0.0);
					//random average
					for(int i = 0; i < 4; ++i)
						for(int j = 0; j < 4; ++j)
						{
							color += texture2D(u_texture, vec2( u_samples_a[i][j], u_samples_b[i][j] ), u_mipmap_offset );
							color += texture2D(u_texture, vec2( 1.0 - u_samples_a[i][j], 1.0 - u_samples_b[i][j] ), u_mipmap_offset );
						}
				   gl_FragColor = color * 0.03125;
				}
				`,t.registerNodeType("texture/average",E);function I(){this.addInput("in","Texture"),this.addInput("factor","Number"),this.addOutput("out","Texture"),this.properties={factor:.5},this._uniforms={u_texture:0,u_textureB:1,u_factor:this.properties.factor}}I.title="Smooth",I.desc="Smooth texture over time",I.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!c||!this.isOutputConnected(0))){I._shader||(I._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,I.pixel_shader));var G=this._temp_texture;if(!G||G.type!=c.type||G.width!=c.width||G.height!=c.height){var M={type:c.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(c.width,c.height,M),this._temp_texture2=new GL.Texture(c.width,c.height,M),c.copyTo(this._temp_texture2)}var U=this._temp_texture,q=this._temp_texture2,j=I._shader,Q=this._uniforms;Q.u_factor=1-this.getInputOrProperty("factor"),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),U.drawTo(function(){q.bind(1),c.toViewport(j,Q)}),this.setOutputData(0,U),this._temp_texture=q,this._temp_texture2=U}},I.pixel_shader=`precision highp float;
				precision highp float;
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				uniform float u_factor;
				varying vec2 v_coord;
				
				void main() {
					gl_FragColor = mix( texture2D( u_texture, v_coord ), texture2D( u_textureB, v_coord ), u_factor );
				}
				`,t.registerNodeType("texture/temporal_smooth",I);function k(){this.addInput("in","Texture"),this.addOutput("avg","Texture"),this.addOutput("array","Texture"),this.properties={samples:64,frames_interval:1},this._uniforms={u_texture:0,u_textureB:1,u_samples:this.properties.samples,u_isamples:1/this.properties.samples},this.frame=0}k.title="Lineal Avg Smooth",k.desc="Smooth texture linearly over time",k["@samples"]={type:"number",min:1,max:64,step:1,precision:1},k.prototype.getPreviewTexture=function(){return this._temp_texture2},k.prototype.onExecute=function(){var c=this.getInputData(0);if(!(!c||!this.isOutputConnected(0))){k._shader||(k._shader_copy=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,k.pixel_shader_copy),k._shader_avg=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,k.pixel_shader_avg));var G=clamp(this.properties.samples,0,64),M=this.frame,U=this.properties.frames_interval;if(U==0||M%U==0){var q=this._temp_texture;if(!q||q.type!=c.type||q.width!=G){var j={type:c.type,format:gl.RGBA,filter:gl.NEAREST};this._temp_texture=new GL.Texture(G,1,j),this._temp_texture2=new GL.Texture(G,1,j),this._temp_texture_out=new GL.Texture(1,1,j)}var Q=this._temp_texture,$=this._temp_texture2,rt=k._shader_copy,nt=k._shader_avg,st=this._uniforms;st.u_samples=G,st.u_isamples=1/G,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),Q.drawTo(function(){$.bind(1),c.toViewport(rt,st)}),this._temp_texture_out.drawTo(function(){Q.toViewport(nt,st)}),this.setOutputData(0,this._temp_texture_out),this._temp_texture=$,this._temp_texture2=Q}else this.setOutputData(0,this._temp_texture_out);this.setOutputData(1,this._temp_texture2),this.frame++}},k.pixel_shader_copy=`precision highp float;
				precision highp float;
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				uniform float u_isamples;
				varying vec2 v_coord;
				
				void main() {
					if( v_coord.x <= u_isamples )
						gl_FragColor = texture2D( u_texture, vec2(0.5) );
					else
						gl_FragColor = texture2D( u_textureB, v_coord - vec2(u_isamples,0.0) );
				}
				`,k.pixel_shader_avg=`precision highp float;
				precision highp float;
				uniform sampler2D u_texture;
				uniform int u_samples;
				uniform float u_isamples;
				varying vec2 v_coord;
				
				void main() {
					vec4 color = vec4(0.0);
					for(int i = 0; i < 64; ++i)
					{
						color += texture2D( u_texture, vec2( float(i)*u_isamples,0.0) );
						if(i == (u_samples - 1))
							break;
					}
					gl_FragColor = color * u_isamples;
				}
				`,t.registerNodeType("texture/linear_avg_smooth",k);function N(){this.addInput("Image","image"),this.addOutput("","Texture"),this.properties={}}N.title="Image to Texture",N.desc="Uploads an image to the GPU",N.prototype.onExecute=function(){var c=this.getInputData(0);if(c){var G=c.videoWidth||c.width,M=c.videoHeight||c.height;if(c.gltexture){this.setOutputData(0,c.gltexture);return}var U=this._temp_texture;(!U||U.width!=G||U.height!=M)&&(this._temp_texture=new GL.Texture(G,M,{format:gl.RGBA,filter:gl.LINEAR}));try{this._temp_texture.uploadImage(c)}catch(q){console.error("image comes from an unsafe location, cannot be uploaded to webgl: "+q);return}this.setOutputData(0,this._temp_texture)}},t.registerNodeType("texture/imageToTexture",N);function T(){this.addInput("Texture","Texture"),this.addInput("LUT","Texture"),this.addInput("Intensity","number"),this.addOutput("","Texture"),this.properties={enabled:!0,intensity:1,precision:r.DEFAULT,texture:null},T._shader||(T._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,T.pixel_shader))}T.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:r.MODE_VALUES}},T.title="LUT",T.desc="Apply LUT to Texture",T.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,c);return}if(c){var G=this.getInputData(1);if(G||(G=r.getTexture(this.properties.texture)),!G){this.setOutputData(0,c);return}G.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var M=this.properties.intensity;this.isInputConnected(2)&&(this.properties.intensity=M=this.getInputData(2)),this._tex=r.getTargetTexture(c,this._tex,this.properties.precision),this._tex.drawTo(function(){G.bind(1),c.toViewport(T._shader,{u_texture:0,u_textureB:1,u_amount:M})}),this.setOutputData(0,this._tex)}}},T.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				uniform float u_amount;
				
				void main() {
					 lowp vec4 textureColor = clamp( texture2D(u_texture, v_coord), vec4(0.0), vec4(1.0) );
					 mediump float blueColor = textureColor.b * 63.0;
					 mediump vec2 quad1;
					 quad1.y = floor(floor(blueColor) / 8.0);
					 quad1.x = floor(blueColor) - (quad1.y * 8.0);
					 mediump vec2 quad2;
					 quad2.y = floor(ceil(blueColor) / 8.0);
					 quad2.x = ceil(blueColor) - (quad2.y * 8.0);
					 highp vec2 texPos1;
					 texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
					 texPos1.y = 1.0 - ((quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
					 highp vec2 texPos2;
					 texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.r);
					 texPos2.y = 1.0 - ((quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * textureColor.g));
					 lowp vec4 newColor1 = texture2D(u_textureB, texPos1);
					 lowp vec4 newColor2 = texture2D(u_textureB, texPos2);
					 lowp vec4 newColor = mix(newColor1, newColor2, fract(blueColor));
					 gl_FragColor = vec4( mix( textureColor.rgb, newColor.rgb, u_amount), textureColor.w);
				}
				`,t.registerNodeType("texture/LUT",T);function h(){this.addInput("Texture","Texture"),this.addInput("Atlas","Texture"),this.addOutput("","Texture"),this.properties={enabled:!0,num_row_symbols:4,symbol_size:16,brightness:1,colorize:!1,filter:!1,invert:!1,precision:r.DEFAULT,generate_mipmaps:!1,texture:null},h._shader||(h._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,h.pixel_shader)),this._uniforms={u_texture:0,u_textureB:1,u_row_simbols:4,u_simbol_size:16,u_res:vec2.create()}}h.widgets_info={texture:{widget:"texture"},precision:{widget:"combo",values:r.MODE_VALUES}},h.title="Encode",h.desc="Apply a texture atlas to encode a texture",h.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH||this.properties.enabled===!1){this.setOutputData(0,c);return}if(c){var G=this.getInputData(1);if(G||(G=r.getTexture(this.properties.texture)),!G){this.setOutputData(0,c);return}G.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,this.properties.filter?gl.LINEAR:gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.bindTexture(gl.TEXTURE_2D,null);var M=this._uniforms;M.u_row_simbols=Math.floor(this.properties.num_row_symbols),M.u_symbol_size=this.properties.symbol_size,M.u_brightness=this.properties.brightness,M.u_invert=this.properties.invert?1:0,M.u_colorize=this.properties.colorize?1:0,this._tex=r.getTargetTexture(c,this._tex,this.properties.precision),M.u_res[0]=this._tex.width,M.u_res[1]=this._tex.height,this._tex.bind(0),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),this._tex.drawTo(function(){G.bind(1),c.toViewport(h._shader,M)}),this.properties.generate_mipmaps&&(this._tex.bind(0),gl.generateMipmap(this._tex.texture_type),this._tex.unbind(0)),this.setOutputData(0,this._tex)}}},h.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform sampler2D u_textureB;
				uniform float u_row_simbols;
				uniform float u_symbol_size;
				uniform float u_brightness;
				uniform float u_invert;
				uniform float u_colorize;
				uniform vec2 u_res;
				
				void main() {
					vec2 total_symbols = u_res / u_symbol_size;
					vec2 uv = floor(v_coord * total_symbols) / total_symbols; //pixelate 
					vec2 local_uv = mod(v_coord * u_res, u_symbol_size) / u_symbol_size;
					lowp vec4 textureColor = texture2D(u_texture, uv );
					float lum = clamp(u_brightness * (textureColor.x + textureColor.y + textureColor.z)/3.0,0.0,1.0);
					if( u_invert == 1.0 ) lum = 1.0 - lum;
					float index = floor( lum * (u_row_simbols * u_row_simbols - 1.0));
					float col = mod( index, u_row_simbols );
					float row = u_row_simbols - floor( index / u_row_simbols ) - 1.0;
					vec2 simbol_uv = ( vec2( col, row ) + local_uv ) / u_row_simbols;
					vec4 color = texture2D( u_textureB, simbol_uv );
					if(u_colorize == 1.0)
						color *= textureColor;
					gl_FragColor = color;
				}
				`,t.registerNodeType("texture/encode",h);function L(){this.addInput("Texture","Texture"),this.addOutput("R","Texture"),this.addOutput("G","Texture"),this.addOutput("B","Texture"),this.addOutput("A","Texture"),L._shader||(L._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,L.pixel_shader))}L.title="Texture to Channels",L.desc="Split texture channels",L.prototype.onExecute=function(){var c=this.getInputData(0);if(c){this._channels||(this._channels=Array(4));for(var G=gl.RGB,M=0,U=0;U<4;U++)this.isOutputConnected(U)?((!this._channels[U]||this._channels[U].width!=c.width||this._channels[U].height!=c.height||this._channels[U].type!=c.type||this._channels[U].format!=G)&&(this._channels[U]=new GL.Texture(c.width,c.height,{type:c.type,format:G,filter:gl.LINEAR})),M++):this._channels[U]=null;if(M){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);for(var q=Mesh.getScreenQuad(),j=L._shader,Q=[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]],U=0;U<4;U++)this._channels[U]&&(this._channels[U].drawTo(function(){c.bind(0),j.uniforms({u_texture:0,u_mask:Q[U]}).draw(q)}),this.setOutputData(U,this._channels[U]))}}},L.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec4 u_mask;
				
				void main() {
				   gl_FragColor = vec4( vec3( length( texture2D(u_texture, v_coord) * u_mask )), 1.0 );
				}
				`,t.registerNodeType("texture/textureChannels",L);function _(){this.addInput("R","Texture"),this.addInput("G","Texture"),this.addInput("B","Texture"),this.addInput("A","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:r.DEFAULT,R:1,G:1,B:1,A:1},this._color=vec4.create(),this._uniforms={u_textureR:0,u_textureG:1,u_textureB:2,u_textureA:3,u_color:this._color}}_.title="Channels to Texture",_.desc="Split texture channels",_.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},_.prototype.onExecute=function(){var c=r.getWhiteTexture(),G=this.getInputData(0)||c,M=this.getInputData(1)||c,U=this.getInputData(2)||c,q=this.getInputData(3)||c;gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var j=Mesh.getScreenQuad();_._shader||(_._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,_.pixel_shader));var Q=_._shader,$=Math.max(G.width,M.width,U.width,q.width),rt=Math.max(G.height,M.height,U.height,q.height),nt=this.properties.precision==r.HIGH?r.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._texture||this._texture.width!=$||this._texture.height!=rt||this._texture.type!=nt)&&(this._texture=new GL.Texture($,rt,{type:nt,format:gl.RGBA,filter:gl.LINEAR}));var st=this._color;st[0]=this.properties.R,st[1]=this.properties.G,st[2]=this.properties.B,st[3]=this.properties.A;var ot=this._uniforms;this._texture.drawTo(function(){G.bind(0),M.bind(1),U.bind(2),q.bind(3),Q.uniforms(ot).draw(j)}),this.setOutputData(0,this._texture)},_.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_textureR;
				uniform sampler2D u_textureG;
				uniform sampler2D u_textureB;
				uniform sampler2D u_textureA;
				uniform vec4 u_color;
				
				void main() {
				   gl_FragColor = u_color * vec4( 							texture2D(u_textureR, v_coord).r,							texture2D(u_textureG, v_coord).r,							texture2D(u_textureB, v_coord).r,							texture2D(u_textureA, v_coord).r);
				}
				`,t.registerNodeType("texture/channelsTexture",_);function D(){this.addOutput("Texture","Texture"),this._tex_color=vec4.create(),this.properties={color:vec4.create(),precision:r.DEFAULT}}D.title="Color",D.desc="Generates a 1x1 texture with a constant color",D.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},D.prototype.onDrawBackground=function(c){var G=this.properties.color;c.fillStyle="rgb("+Math.floor(clamp(G[0],0,1)*255)+","+Math.floor(clamp(G[1],0,1)*255)+","+Math.floor(clamp(G[2],0,1)*255)+")",this.flags.collapsed?this.boxcolor=c.fillStyle:c.fillRect(0,0,this.size[0],this.size[1])},D.prototype.onExecute=function(){var c=this.properties.precision==r.HIGH?r.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._tex||this._tex.type!=c)&&(this._tex=new GL.Texture(1,1,{format:gl.RGBA,type:c,minFilter:gl.NEAREST}));var G=this.properties.color;if(this.inputs)for(var M=0;M<this.inputs.length;M++){var U=this.inputs[M],q=this.getInputData(M);if(q!==void 0)switch(U.name){case"RGB":case"RGBA":G.set(q);break;case"R":G[0]=q;break;case"G":G[1]=q;break;case"B":G[2]=q;break;case"A":G[3]=q;break}}vec4.sqrDist(this._tex_color,G)>.001&&(this._tex_color.set(G),this._tex.fill(G)),this.setOutputData(0,this._tex)},D.prototype.onGetInputs=function(){return[["RGB","vec3"],["RGBA","vec4"],["R","number"],["G","number"],["B","number"],["A","number"]]},t.registerNodeType("texture/color",D);function B(){this.addInput("A","color"),this.addInput("B","color"),this.addOutput("Texture","Texture"),this.properties={angle:0,scale:1,A:[0,0,0],B:[1,1,1],texture_size:32},B._shader||(B._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,B.pixel_shader)),this._uniforms={u_angle:0,u_colorA:vec3.create(),u_colorB:vec3.create()}}B.title="Gradient",B.desc="Generates a gradient",B["@A"]={type:"color"},B["@B"]={type:"color"},B["@texture_size"]={type:"enum",values:[32,64,128,256,512]},B.prototype.onExecute=function(){gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var c=GL.Mesh.getScreenQuad(),G=B._shader,M=this.getInputData(0);M||(M=this.properties.A);var U=this.getInputData(1);U||(U=this.properties.B);for(var q=2;q<this.inputs.length;q++){var j=this.inputs[q],Q=this.getInputData(q);Q!==void 0&&(this.properties[j.name]=Q)}var $=this._uniforms;this._uniforms.u_angle=this.properties.angle*DEG2RAD,this._uniforms.u_scale=this.properties.scale,vec3.copy($.u_colorA,M),vec3.copy($.u_colorB,U);var rt=parseInt(this.properties.texture_size);(!this._tex||this._tex.width!=rt)&&(this._tex=new GL.Texture(rt,rt,{format:gl.RGB,filter:gl.LINEAR})),this._tex.drawTo(function(){G.uniforms($).draw(c)}),this.setOutputData(0,this._tex)},B.prototype.onGetInputs=function(){return[["angle","number"],["scale","number"]]},B.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform float u_angle;
				uniform float u_scale;
				uniform vec3 u_colorA;
				uniform vec3 u_colorB;
				
				vec2 rotate(vec2 v, float angle)
				{
					vec2 result;
					float _cos = cos(angle);
					float _sin = sin(angle);
					result.x = v.x * _cos - v.y * _sin;
					result.y = v.x * _sin + v.y * _cos;
					return result;
				}
				void main() {
					float f = (rotate(u_scale * (v_coord - vec2(0.5)), u_angle) + vec2(0.5)).x;
					vec3 color = mix(u_colorA,u_colorB,clamp(f,0.0,1.0));
				   gl_FragColor = vec4(color,1.0);
				}
				`,t.registerNodeType("texture/gradient",B);function F(){this.addInput("A","Texture"),this.addInput("B","Texture"),this.addInput("Mixer","Texture"),this.addOutput("Texture","Texture"),this.properties={factor:.5,size_from_biggest:!0,invert:!1,precision:r.DEFAULT},this._uniforms={u_textureA:0,u_textureB:1,u_textureMix:2,u_mix:vec4.create()}}F.title="Mix",F.desc="Generates a texture mixing two textures",F.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},F.prototype.onExecute=function(){var c=this.getInputData(0);if(this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}var G=this.getInputData(1);if(!(!c||!G)){var M=this.getInputData(2),U=this.getInputData(3);this._tex=r.getTargetTexture(this.properties.size_from_biggest&&G.width>c.width?G:c,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var q=Mesh.getScreenQuad(),j=null,Q=this._uniforms;if(M)j=F._shader_tex,j||(j=F._shader_tex=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,F.pixel_shader,{MIX_TEX:""}));else{j=F._shader_factor,j||(j=F._shader_factor=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,F.pixel_shader));var $=U??this.properties.factor;Q.u_mix.set([$,$,$,$])}var rt=this.properties.invert;this._tex.drawTo(function(){c.bind(rt?1:0),G.bind(rt?0:1),M&&M.bind(2),j.uniforms(Q).draw(q)}),this.setOutputData(0,this._tex)}}},F.prototype.onGetInputs=function(){return[["factor","number"]]},F.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_textureA;
				uniform sampler2D u_textureB;
				#ifdef MIX_TEX
					uniform sampler2D u_textureMix;
				#else
					uniform vec4 u_mix;
				#endif
				
				void main() {
					#ifdef MIX_TEX
					   vec4 f = texture2D(u_textureMix, v_coord);
					#else
					   vec4 f = u_mix;
					#endif
				   gl_FragColor = mix( texture2D(u_textureA, v_coord), texture2D(u_textureB, v_coord), f );
				}
				`,t.registerNodeType("texture/mix",F);function H(){this.addInput("Tex.","Texture"),this.addOutput("Edges","Texture"),this.properties={invert:!0,threshold:!1,factor:1,precision:r.DEFAULT},H._shader||(H._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,H.pixel_shader))}H.title="Edges",H.desc="Detects edges",H.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},H.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}if(c){this._tex=r.getTargetTexture(c,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var G=Mesh.getScreenQuad(),M=H._shader,U=this.properties.invert,q=this.properties.factor,j=this.properties.threshold?1:0;this._tex.drawTo(function(){c.bind(0),M.uniforms({u_texture:0,u_isize:[1/c.width,1/c.height],u_factor:q,u_threshold:j,u_invert:U?1:0}).draw(G)}),this.setOutputData(0,this._tex)}}},H.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec2 u_isize;
				uniform int u_invert;
				uniform float u_factor;
				uniform float u_threshold;
				
				void main() {
					vec4 center = texture2D(u_texture, v_coord);
					vec4 up = texture2D(u_texture, v_coord + u_isize * vec2(0.0,1.0) );
					vec4 down = texture2D(u_texture, v_coord + u_isize * vec2(0.0,-1.0) );
					vec4 left = texture2D(u_texture, v_coord + u_isize * vec2(1.0,0.0) );
					vec4 right = texture2D(u_texture, v_coord + u_isize * vec2(-1.0,0.0) );
					vec4 diff = abs(center - up) + abs(center - down) + abs(center - left) + abs(center - right);
					diff *= u_factor;
					if(u_invert == 1)
						diff.xyz = vec3(1.0) - diff.xyz;
					if( u_threshold == 0.0 )
						gl_FragColor = vec4( diff.xyz, center.a );
					else
						gl_FragColor = vec4( diff.x > 0.5 ? 1.0 : 0.0, diff.y > 0.5 ? 1.0 : 0.0, diff.z > 0.5 ? 1.0 : 0.0, center.a );
				}
				`,t.registerNodeType("texture/edges",H);function V(){this.addInput("Texture","Texture"),this.addInput("Distance","number"),this.addInput("Range","number"),this.addOutput("Texture","Texture"),this.properties={distance:100,range:50,only_depth:!1,high_precision:!1},this._uniforms={u_texture:0,u_distance:100,u_range:50,u_camera_planes:null}}V.title="Depth Range",V.desc="Generates a texture with a depth range",V.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(c){var G=gl.UNSIGNED_BYTE;this.properties.high_precision&&(G=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=G||this._temp_texture.width!=c.width||this._temp_texture.height!=c.height)&&(this._temp_texture=new GL.Texture(c.width,c.height,{type:G,format:gl.RGBA,filter:gl.LINEAR}));var M=this._uniforms,U=this.properties.distance;this.isInputConnected(1)&&(U=this.getInputData(1),this.properties.distance=U);var q=this.properties.range;this.isInputConnected(2)&&(q=this.getInputData(2),this.properties.range=q),M.u_distance=U,M.u_range=q,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var j=Mesh.getScreenQuad();V._shader||(V._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,V.pixel_shader),V._shader_onlydepth=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,V.pixel_shader,{ONLY_DEPTH:""}));var Q=this.properties.only_depth?V._shader_onlydepth:V._shader,$=null;c.near_far_planes?$=c.near_far_planes:window.LS&&LS.Renderer._main_camera?$=LS.Renderer._main_camera._uniforms.u_camera_planes:$=[.1,1e3],M.u_camera_planes=$,this._temp_texture.drawTo(function(){c.bind(0),Q.uniforms(M).draw(j)}),this._temp_texture.near_far_planes=$,this.setOutputData(0,this._temp_texture)}}},V.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec2 u_camera_planes;
				uniform float u_distance;
				uniform float u_range;
				
				float LinearDepth()
				{
					float zNear = u_camera_planes.x;
					float zFar = u_camera_planes.y;
					float depth = texture2D(u_texture, v_coord).x;
					depth = depth * 2.0 - 1.0;
					return zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
				}
				
				void main() {
					float depth = LinearDepth();
					#ifdef ONLY_DEPTH
					   gl_FragColor = vec4(depth);
					#else
						float diff = abs(depth * u_camera_planes.y - u_distance);
						float dof = 1.0;
						if(diff <= u_range)
							dof = diff / u_range;
					   gl_FragColor = vec4(dof);
					#endif
				}
				`,t.registerNodeType("texture/depth_range",V);function Y(){this.addInput("Texture","Texture"),this.addOutput("Texture","Texture"),this.properties={precision:r.DEFAULT,invert:!1},this._uniforms={u_texture:0,u_camera_planes:null,u_ires:vec2.create()}}Y.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},Y.title="Linear Depth",Y.desc="Creates a color texture with linear depth",Y.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(!(!c||c.format!=gl.DEPTH_COMPONENT&&c.format!=gl.DEPTH_STENCIL)){var G=this.properties.precision==r.HIGH?gl.HIGH_PRECISION_FORMAT:gl.UNSIGNED_BYTE;(!this._temp_texture||this._temp_texture.type!=G||this._temp_texture.width!=c.width||this._temp_texture.height!=c.height)&&(this._temp_texture=new GL.Texture(c.width,c.height,{type:G,format:gl.RGB,filter:gl.LINEAR}));var M=this._uniforms;M.u_invert=this.properties.invert?1:0,gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var U=Mesh.getScreenQuad();Y._shader||(Y._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Y.pixel_shader));var q=Y._shader,j=null;c.near_far_planes?j=c.near_far_planes:window.LS&&LS.Renderer._main_camera?j=LS.Renderer._main_camera._uniforms.u_camera_planes:j=[.1,1e3],M.u_camera_planes=j,M.u_ires.set([0,0]),this._temp_texture.drawTo(function(){c.bind(0),q.uniforms(M).draw(U)}),this._temp_texture.near_far_planes=j,this.setOutputData(0,this._temp_texture)}}},Y.pixel_shader=`precision highp float;
				precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec2 u_camera_planes;
				uniform int u_invert;
				uniform vec2 u_ires;
				
				void main() {
					float zNear = u_camera_planes.x;
					float zFar = u_camera_planes.y;
					float depth = texture2D(u_texture, v_coord + u_ires*0.5).x * 2.0 - 1.0;
					float f = zNear * (depth + 1.0) / (zFar + zNear - depth * (zFar - zNear));
					if( u_invert == 1 )
						f = 1.0 - f;
					gl_FragColor = vec4(vec3(f),1.0);
				}
				`,t.registerNodeType("texture/linear_depth",Y);function K(){this.addInput("Texture","Texture"),this.addInput("Iterations","number"),this.addInput("Intensity","number"),this.addOutput("Blurred","Texture"),this.properties={intensity:1,iterations:1,preserve_aspect:!1,scale:[1,1],precision:r.DEFAULT}}K.title="Blur",K.desc="Blur a texture",K.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},K.max_iterations=20,K.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){var G=this._final_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(G=this._final_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR}));var M=this.properties.iterations;if(this.isInputConnected(1)&&(M=this.getInputData(1),this.properties.iterations=M),M=Math.min(Math.floor(M),K.max_iterations),M==0){this.setOutputData(0,c);return}var U=this.properties.intensity;this.isInputConnected(2)&&(U=this.getInputData(2),this.properties.intensity=U);var q=t.camera_aspect;!q&&window.gl!==void 0&&(q=gl.canvas.height/gl.canvas.width),q||(q=1),q=this.properties.preserve_aspect?q:1;var j=this.properties.scale||[1,1];c.applyBlur(q*j[0],j[1],U,G);for(var Q=1;Q<M;++Q)G.applyBlur(q*j[0]*(Q+1),j[1]*(Q+1),U);this.setOutputData(0,G)}},t.registerNodeType("texture/blur",K);function J(){this.intensity=.5,this.persistence=.6,this.iterations=8,this.threshold=.8,this.scale=1,this.dirt_texture=null,this.dirt_factor=.5,this._textures=[],this._uniforms={u_intensity:1,u_texture:0,u_glow_texture:1,u_threshold:0,u_texel_size:vec2.create()}}J.prototype.applyFX=function(c,G,M,U){var q=c.width,j=c.height,Q={format:c.format,type:c.type,minFilter:GL.LINEAR,magFilter:GL.LINEAR,wrap:gl.CLAMP_TO_EDGE},$=this._uniforms,rt=this._textures,ut=J._cut_shader;ut||(ut=J._cut_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,J.cut_pixel_shader)),gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),$.u_threshold=this.threshold;var nt=rt[0]=GL.Texture.getTemporary(q,j,Q);c.blit(nt,ut.uniforms($));var st=nt,ot=this.iterations;ot=clamp(ot,1,16)|0;var at=$.u_texel_size,lt=this.intensity;$.u_intensity=1,$.u_delta=this.scale;var ut=J._shader;ut||(ut=J._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,J.scale_pixel_shader));for(var ht=1;ht<ot&&(q=q>>1,(j|0)>1&&(j=j>>1),!(q<2));ht++)nt=rt[ht]=GL.Texture.getTemporary(q,j,Q),at[0]=1/st.width,at[1]=1/st.height,st.blit(nt,ut.uniforms($)),st=nt;for(U&&(at[0]=1/st.width,at[1]=1/st.height,$.u_intensity=lt,$.u_delta=1,st.blit(U,ut.uniforms($))),gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),$.u_intensity=this.persistence,$.u_delta=.5,ht-=2;ht>=0;ht--)nt=rt[ht],rt[ht]=null,at[0]=1/st.width,at[1]=1/st.height,st.blit(nt,ut.uniforms($)),GL.Texture.releaseTemporary(st),st=nt;if(gl.disable(gl.BLEND),M&&st.blit(M),G){var dt=G,pt=this.dirt_texture,ct=this.dirt_factor;$.u_intensity=lt,ut=pt?J._dirt_final_shader:J._final_shader,ut||(pt?ut=J._dirt_final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,J.final_pixel_shader,{USE_DIRT:""}):ut=J._final_shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,J.final_pixel_shader)),dt.drawTo(function(){c.bind(0),st.bind(1),pt&&(ut.setUniform("u_dirt_factor",ct),ut.setUniform("u_dirt_texture",pt.bind(2))),ut.toViewport($)})}GL.Texture.releaseTemporary(st)},J.cut_pixel_shader=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform float u_threshold;
			void main() {
				gl_FragColor = max( texture2D( u_texture, v_coord ) - vec4( u_threshold ), vec4(0.0) );
			}`,J.scale_pixel_shader=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform vec2 u_texel_size;
			uniform float u_delta;
			uniform float u_intensity;
			
			vec4 sampleBox(vec2 uv) {
				vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
				vec4 s = texture2D( u_texture, uv + o.xy ) + texture2D( u_texture, uv + o.zy) + texture2D( u_texture, uv + o.xw) + texture2D( u_texture, uv + o.zw);
				return s * 0.25;
			}
			void main() {
				gl_FragColor = u_intensity * sampleBox( v_coord );
			}`,J.final_pixel_shader=`precision highp float;
			varying vec2 v_coord;
			uniform sampler2D u_texture;
			uniform sampler2D u_glow_texture;
			#ifdef USE_DIRT
				uniform sampler2D u_dirt_texture;
			#endif
			uniform vec2 u_texel_size;
			uniform float u_delta;
			uniform float u_intensity;
			uniform float u_dirt_factor;
			
			vec4 sampleBox(vec2 uv) {
				vec4 o = u_texel_size.xyxy * vec2(-u_delta, u_delta).xxyy;
				vec4 s = texture2D( u_glow_texture, uv + o.xy ) + texture2D( u_glow_texture, uv + o.zy) + texture2D( u_glow_texture, uv + o.xw) + texture2D( u_glow_texture, uv + o.zw);
				return s * 0.25;
			}
			void main() {
				vec4 glow = sampleBox( v_coord );
				#ifdef USE_DIRT
					glow = mix( glow, glow * texture2D( u_dirt_texture, v_coord ), u_dirt_factor );
				#endif
				gl_FragColor = texture2D( u_texture, v_coord ) + u_intensity * glow;
			}`;function C(){this.addInput("in","Texture"),this.addInput("dirt","Texture"),this.addOutput("out","Texture"),this.addOutput("glow","Texture"),this.properties={enabled:!0,intensity:1,persistence:.99,iterations:16,threshold:0,scale:1,dirt_factor:.5,precision:r.DEFAULT},this.fx=new J}C.title="Glow",C.desc="Filters a texture giving it a glow effect",C.widgets_info={iterations:{type:"number",min:0,max:16,step:1,precision:0},threshold:{type:"number",min:0,max:10,step:.01,precision:2},precision:{widget:"combo",values:r.MODE_VALUES}},C.prototype.onGetInputs=function(){return[["enabled","boolean"],["threshold","number"],["intensity","number"],["persistence","number"],["iterations","number"],["dirt_factor","number"]]},C.prototype.onGetOutputs=function(){return[["average","Texture"]]},C.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isAnyOutputConnected()){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,c);return}c.width,c.height;var G=this.fx;G.threshold=this.getInputOrProperty("threshold"),G.iterations=this.getInputOrProperty("iterations"),G.intensity=this.getInputOrProperty("intensity"),G.persistence=this.getInputOrProperty("persistence"),G.dirt_texture=this.getInputData(1),G.dirt_factor=this.getInputOrProperty("dirt_factor"),G.scale=this.properties.scale;var M=r.getTextureType(this.properties.precision,c),U=null;this.isOutputConnected(2)&&(U=this._average_texture,(!U||U.type!=c.type||U.format!=c.format)&&(U=this._average_texture=new GL.Texture(1,1,{type:c.type,format:c.format,filter:gl.LINEAR})));var q=null;this.isOutputConnected(1)&&(q=this._glow_texture,(!q||q.width!=c.width||q.height!=c.height||q.type!=M||q.format!=c.format)&&(q=this._glow_texture=new GL.Texture(c.width,c.height,{type:M,format:c.format,filter:gl.LINEAR})));var j=null;this.isOutputConnected(0)&&(j=this._final_texture,(!j||j.width!=c.width||j.height!=c.height||j.type!=M||j.format!=c.format)&&(j=this._final_texture=new GL.Texture(c.width,c.height,{type:M,format:c.format,filter:gl.LINEAR}))),G.applyFX(c,j,q,U),this.isOutputConnected(0)&&this.setOutputData(0,j),this.isOutputConnected(1)&&this.setOutputData(1,U),this.isOutputConnected(2)&&this.setOutputData(2,q)}},t.registerNodeType("texture/glow",C);function R(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={intensity:1,radius:5}}R.title="Kuwahara Filter",R.desc="Filters a texture giving an artistic oil canvas painting",R.max_radius=10,R._shaders=[],R.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){var G=this._temp_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(this._temp_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR}));var M=this.properties.radius;if(M=Math.min(Math.floor(M),R.max_radius),M==0){this.setOutputData(0,c);return}var U=this.properties.intensity,q=t.camera_aspect;!q&&window.gl!==void 0&&(q=gl.canvas.height/gl.canvas.width),q||(q=1),q=this.properties.preserve_aspect?q:1,R._shaders[M]||(R._shaders[M]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,R.pixel_shader,{RADIUS:M.toFixed(0)}));var j=R._shaders[M],Q=GL.Mesh.getScreenQuad();c.bind(0),this._temp_texture.drawTo(function(){j.uniforms({u_texture:0,u_intensity:U,u_resolution:[c.width,c.height],u_iResolution:[1/c.width,1/c.height]}).draw(Q)}),this.setOutputData(0,this._temp_texture)}},R.pixel_shader=`
		precision highp float;
		varying vec2 v_coord;
		uniform sampler2D u_texture;
		uniform float u_intensity;
		uniform vec2 u_resolution;
		uniform vec2 u_iResolution;
		#ifndef RADIUS
			#define RADIUS 7
		#endif
		void main() {
		
			const int radius = RADIUS;
			vec2 fragCoord = v_coord;
			vec2 src_size = u_iResolution;
			vec2 uv = v_coord;
			float n = float((radius + 1) * (radius + 1));
			int i;
			int j;
			vec3 m0 = vec3(0.0); vec3 m1 = vec3(0.0); vec3 m2 = vec3(0.0); vec3 m3 = vec3(0.0);
			vec3 s0 = vec3(0.0); vec3 s1 = vec3(0.0); vec3 s2 = vec3(0.0); vec3 s3 = vec3(0.0);
			vec3 c;
			
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
					m0 += c;
					s0 += c * c;
				}
			}
			
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
					m1 += c;
					s1 += c * c;
				}
			}
			
			for (int j = 0; j <= radius; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
					m2 += c;
					s2 += c * c;
				}
			}
			
			for (int j = 0; j <= radius; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					c = texture2D(u_texture, uv + vec2(i,j) * src_size).rgb;
					m3 += c;
					s3 += c * c;
				}
			}
			
			float min_sigma2 = 1e+2;
			m0 /= n;
			s0 = abs(s0 / n - m0 * m0);
			
			float sigma2 = s0.r + s0.g + s0.b;
			if (sigma2 < min_sigma2) {
				min_sigma2 = sigma2;
				gl_FragColor = vec4(m0, 1.0);
			}
			
			m1 /= n;
			s1 = abs(s1 / n - m1 * m1);
			
			sigma2 = s1.r + s1.g + s1.b;
			if (sigma2 < min_sigma2) {
				min_sigma2 = sigma2;
				gl_FragColor = vec4(m1, 1.0);
			}
			
			m2 /= n;
			s2 = abs(s2 / n - m2 * m2);
			
			sigma2 = s2.r + s2.g + s2.b;
			if (sigma2 < min_sigma2) {
				min_sigma2 = sigma2;
				gl_FragColor = vec4(m2, 1.0);
			}
			
			m3 /= n;
			s3 = abs(s3 / n - m3 * m3);
			
			sigma2 = s3.r + s3.g + s3.b;
			if (sigma2 < min_sigma2) {
				min_sigma2 = sigma2;
				gl_FragColor = vec4(m3, 1.0);
			}
		}
		`,t.registerNodeType("texture/kuwahara",R);function b(){this.addInput("Texture","Texture"),this.addOutput("Filtered","Texture"),this.properties={sigma:1.4,k:1.6,p:21.7,epsilon:79,phi:.017}}b.title="XDoG Filter",b.desc="Filters a texture giving an artistic ink style",b.max_radius=10,b._shaders=[],b.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){var G=this._temp_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(this._temp_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR})),b._xdog_shader||(b._xdog_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,b.xdog_pixel_shader));var M=b._xdog_shader,U=GL.Mesh.getScreenQuad(),q=this.properties.sigma,j=this.properties.k,Q=this.properties.p,$=this.properties.epsilon,rt=this.properties.phi;c.bind(0),this._temp_texture.drawTo(function(){M.uniforms({src:0,sigma:q,k:j,p:Q,epsilon:$,phi:rt,cvsWidth:c.width,cvsHeight:c.height}).draw(U)}),this.setOutputData(0,this._temp_texture)}},b.xdog_pixel_shader=`
		precision highp float;
		uniform sampler2D src;

		uniform float cvsHeight;
		uniform float cvsWidth;

		uniform float sigma;
		uniform float k;
		uniform float p;
		uniform float epsilon;
		uniform float phi;
		varying vec2 v_coord;

		float cosh(float val)
		{
			float tmp = exp(val);
			float cosH = (tmp + 1.0 / tmp) / 2.0;
			return cosH;
		}

		float tanh(float val)
		{
			float tmp = exp(val);
			float tanH = (tmp - 1.0 / tmp) / (tmp + 1.0 / tmp);
			return tanH;
		}

		float sinh(float val)
		{
			float tmp = exp(val);
			float sinH = (tmp - 1.0 / tmp) / 2.0;
			return sinH;
		}

		void main(void){
			vec3 destColor = vec3(0.0);
			float tFrag = 1.0 / cvsHeight;
			float sFrag = 1.0 / cvsWidth;
			vec2 Frag = vec2(sFrag,tFrag);
			vec2 uv = gl_FragCoord.st;
			float twoSigmaESquared = 2.0 * sigma * sigma;
			float twoSigmaRSquared = twoSigmaESquared * k * k;
			int halfWidth = int(ceil( 1.0 * sigma * k ));

			const int MAX_NUM_ITERATION = 99999;
			vec2 sum = vec2(0.0);
			vec2 norm = vec2(0.0);

			for(int cnt=0;cnt<MAX_NUM_ITERATION;cnt++){
				if(cnt > (2*halfWidth+1)*(2*halfWidth+1)){break;}
				int i = int(cnt / (2*halfWidth+1)) - halfWidth;
				int j = cnt - halfWidth - int(cnt / (2*halfWidth+1)) * (2*halfWidth+1);

				float d = length(vec2(i,j));
				vec2 kernel = vec2( exp( -d * d / twoSigmaESquared ), 
									exp( -d * d / twoSigmaRSquared ));

				vec2 L = texture2D(src, (uv + vec2(i,j)) * Frag).xx;

				norm += kernel;
				sum += kernel * L;
			}

			sum /= norm;

			float H = 100.0 * ((1.0 + p) * sum.x - p * sum.y);
			float edge = ( H > epsilon )? 1.0 : 1.0 + tanh( phi * (H - epsilon));
			destColor = vec3(edge);
			gl_FragColor = vec4(destColor, 1.0);
		}`,t.registerNodeType("texture/xDoG",b);function z(){this.addOutput("Webcam","Texture"),this.properties={texture_name:"",facingMode:"user"},this.boxcolor="black",this.version=0}z.title="Webcam",z.desc="Webcam texture",z.is_webcam_open=!1,z.prototype.openStream=function(){if(!navigator.getUserMedia)return;this._waiting_confirmation=!0;var c={audio:!1,video:{facingMode:this.properties.facingMode}};navigator.mediaDevices.getUserMedia(c).then(this.streamReady.bind(this)).catch(M);var G=this;function M(U){z.is_webcam_open=!1,console.log("Webcam rejected",U),G._webcam_stream=!1,G.boxcolor="red",G.trigger("stream_error")}},z.prototype.closeStream=function(){if(this._webcam_stream){var c=this._webcam_stream.getTracks();if(c.length)for(var G=0;G<c.length;++G)c[G].stop();z.is_webcam_open=!1,this._webcam_stream=null,this._video=null,this.boxcolor="black",this.trigger("stream_closed")}},z.prototype.streamReady=function(c){this._webcam_stream=c,this.boxcolor="green";var G=this._video;G||(G=document.createElement("video"),G.autoplay=!0,G.srcObject=c,this._video=G,G.onloadedmetadata=function(M){z.is_webcam_open=!0,console.log(M)}),this.trigger("stream_ready",G)},z.prototype.onPropertyChanged=function(c,G){c=="facingMode"&&(this.properties.facingMode=G,this.closeStream(),this.openStream())},z.prototype.onRemoved=function(){if(this._webcam_stream){var c=this._webcam_stream.getTracks();if(c.length)for(var G=0;G<c.length;++G)c[G].stop();this._webcam_stream=null,this._video=null}},z.prototype.onDrawBackground=function(c){this.flags.collapsed||this.size[1]<=20||this._video&&(c.save(),c.webgl?this._video_texture&&c.drawImage(this._video_texture,0,0,this.size[0],this.size[1]):c.drawImage(this._video,0,0,this.size[0],this.size[1]),c.restore())},z.prototype.onExecute=function(){if(this._webcam_stream==null&&!this._waiting_confirmation&&this.openStream(),!(!this._video||!this._video.videoWidth)){var c=this._video.videoWidth,G=this._video.videoHeight,M=this._video_texture;if((!M||M.width!=c||M.height!=G)&&(this._video_texture=new GL.Texture(c,G,{format:gl.RGB,filter:gl.LINEAR})),this._video_texture.uploadImage(this._video),this._video_texture.version=++this.version,this.properties.texture_name){var U=r.getTexturesContainer();U[this.properties.texture_name]=this._video_texture}this.setOutputData(0,this._video_texture);for(var q=1;q<this.outputs.length;++q)if(this.outputs[q])switch(this.outputs[q].name){case"width":this.setOutputData(q,this._video.videoWidth);break;case"height":this.setOutputData(q,this._video.videoHeight);break}}},z.prototype.onGetOutputs=function(){return[["width","number"],["height","number"],["stream_ready",t.EVENT],["stream_closed",t.EVENT],["stream_error",t.EVENT]]},t.registerNodeType("texture/webcam",z);function S(){this.addInput("in","Texture"),this.addInput("f","number"),this.addOutput("out","Texture"),this.properties={enabled:!0,factor:1,precision:r.LOW},this._uniforms={u_texture:0,u_factor:1}}S.title="Lens FX",S.desc="distortion and chromatic aberration",S.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},S.prototype.onGetInputs=function(){return[["enabled","boolean"]]},S.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,c);return}var G=this._temp_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(G=this._temp_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR}));var M=S._shader;M||(M=S._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,S.pixel_shader));var U=this.getInputData(1);U==null&&(U=this.properties.factor);var q=this._uniforms;q.u_factor=U,gl.disable(gl.DEPTH_TEST),G.drawTo(function(){c.bind(0),M.uniforms(q).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,G)}},S.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform float u_factor;
				vec2 barrelDistortion(vec2 coord, float amt) {
					vec2 cc = coord - 0.5;
					float dist = dot(cc, cc);
					return coord + cc * dist * amt;
				}
				
				float sat( float t )
				{
					return clamp( t, 0.0, 1.0 );
				}
				
				float linterp( float t ) {
					return sat( 1.0 - abs( 2.0*t - 1.0 ) );
				}
				
				float remap( float t, float a, float b ) {
					return sat( (t - a) / (b - a) );
				}
				
				vec4 spectrum_offset( float t ) {
					vec4 ret;
					float lo = step(t,0.5);
					float hi = 1.0-lo;
					float w = linterp( remap( t, 1.0/6.0, 5.0/6.0 ) );
					ret = vec4(lo,1.0,hi, 1.) * vec4(1.0-w, w, 1.0-w, 1.);
				
					return pow( ret, vec4(1.0/2.2) );
				}
				
				const float max_distort = 2.2;
				const int num_iter = 12;
				const float reci_num_iter_f = 1.0 / float(num_iter);
				
				void main()
				{	
					vec2 uv=v_coord;
					vec4 sumcol = vec4(0.0);
					vec4 sumw = vec4(0.0);	
					for ( int i=0; i<num_iter;++i )
					{
						float t = float(i) * reci_num_iter_f;
						vec4 w = spectrum_offset( t );
						sumw += w;
						sumcol += w * texture2D( u_texture, barrelDistortion(uv, .6 * max_distort*t * u_factor ) );
					}
					gl_FragColor = sumcol / sumw;
				}`,t.registerNodeType("texture/lensfx",S);function A(){this.addInput("in",""),this.properties={precision:r.LOW,width:0,height:0,channels:1},this.addOutput("out","Texture")}A.title="Data->Tex",A.desc="Generates or applies a curve to a texture",A.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},A.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(c){var G=this.properties.channels,M=this.properties.width,U=this.properties.height;(!M||!U)&&(M=Math.floor(c.length/G),U=1);var q=gl.RGBA;G==3?q=gl.RGB:G==1&&(q=gl.LUMINANCE);var j=this._temp_texture,Q=r.getTextureType(this.properties.precision);(!j||j.width!=M||j.height!=U||j.type!=Q)&&(j=this._temp_texture=new GL.Texture(M,U,{type:Q,format:q,filter:gl.LINEAR})),j.uploadData(c),this.setOutputData(0,j)}}},t.registerNodeType("texture/fromdata",A);function P(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={precision:r.LOW,split_channels:!1},this._values=new Uint8Array(256*4),this._values.fill(255),this._curve_texture=null,this._uniforms={u_texture:0,u_curve:1,u_range:1},this._must_update=!0,this._points={RGB:[[0,0],[1,1]],R:[[0,0],[1,1]],G:[[0,0],[1,1]],B:[[0,0],[1,1]]},this.curve_editor=null,this.addWidget("toggle","Split Channels",!1,"split_channels"),this.addWidget("combo","Channel","RGB",{values:["RGB","R","G","B"]}),this.curve_offset=68,this.size=[240,160]}P.title="Curve",P.desc="Generates or applies a curve to a texture",P.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},P.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0),G=this._temp_texture;if(!c){(this._must_update||!this._curve_texture)&&this.updateCurve(),this.setOutputData(0,this._curve_texture);return}var M=r.getTextureType(this.properties.precision,c);(!G||G.type!=M||G.width!=c.width||G.height!=c.height||G.format!=c.format)&&(G=this._temp_texture=new GL.Texture(c.width,c.height,{type:M,format:c.format,filter:gl.LINEAR}));var U=P._shader;U||(U=P._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,P.pixel_shader)),(this._must_update||!this._curve_texture)&&this.updateCurve();var q=this._uniforms,j=this._curve_texture;G.drawTo(function(){gl.disable(gl.DEPTH_TEST),c.bind(0),j.bind(1),U.uniforms(q).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,G)}},P.prototype.sampleCurve=function(c,M){var M=M||this._points.RGB;if(M){for(var U=0;U<M.length-1;++U){var q=M[U],j=M[U+1];if(!(j[0]<c)){var Q=j[0]-q[0];if(Math.abs(Q)<1e-5)return q[1];var $=(c-q[0])/Q;return q[1]*(1-$)+j[1]*$}}return 0}},P.prototype.updateCurve=function(){for(var c=this._values,G=c.length/4,M=this.properties.split_channels,U=0;U<G;++U){if(M)c[U*4]=clamp(this.sampleCurve(U/G,this._points.R)*255,0,255),c[U*4+1]=clamp(this.sampleCurve(U/G,this._points.G)*255,0,255),c[U*4+2]=clamp(this.sampleCurve(U/G,this._points.B)*255,0,255);else{var q=this.sampleCurve(U/G);c[U*4]=c[U*4+1]=c[U*4+2]=clamp(q*255,0,255)}c[U*4+3]=255}this._curve_texture||(this._curve_texture=new GL.Texture(256,1,{format:gl.RGBA,magFilter:gl.LINEAR,wrap:gl.CLAMP_TO_EDGE})),this._curve_texture.uploadData(c,null,!0)},P.prototype.onSerialize=function(c){var G={};for(var M in this._points)G[M]=this._points[M].concat();c.curves=G},P.prototype.onConfigure=function(c){this._points=c.curves,this.curve_editor&&(curve_editor.points=this._points),this._must_update=!0},P.prototype.onMouseDown=function(c,G,M){if(this.curve_editor){var U=this.curve_editor.onMouseDown([G[0],G[1]-this.curve_offset],M);return U&&this.captureInput(!0),U}},P.prototype.onMouseMove=function(c,G,M){if(this.curve_editor)return this.curve_editor.onMouseMove([G[0],G[1]-this.curve_offset],M)},P.prototype.onMouseUp=function(c,G,M){if(this.curve_editor)return this.curve_editor.onMouseUp([G[0],G[1]-this.curve_offset],M);this.captureInput(!1)},P.channel_line_colors={RGB:"#666",R:"#F33",G:"#3F3",B:"#33F"},P.prototype.onDrawBackground=function(c,G){if(!this.flags.collapsed){this.curve_editor||(this.curve_editor=new t.CurveEditor(this._points.R)),c.save(),c.translate(0,this.curve_offset);var M=this.widgets[1].value;this.properties.split_channels?(M=="RGB"&&(this.widgets[1].value=M="R",this.widgets[1].disabled=!1),this.curve_editor.points=this._points.R,this.curve_editor.draw(c,[this.size[0],this.size[1]-this.curve_offset],G,"#111",P.channel_line_colors.R,!0),c.globalCompositeOperation="lighten",this.curve_editor.points=this._points.G,this.curve_editor.draw(c,[this.size[0],this.size[1]-this.curve_offset],G,null,P.channel_line_colors.G,!0),this.curve_editor.points=this._points.B,this.curve_editor.draw(c,[this.size[0],this.size[1]-this.curve_offset],G,null,P.channel_line_colors.B,!0),c.globalCompositeOperation="source-over"):(this.widgets[1].value=M="RGB",this.widgets[1].disabled=!0),this.curve_editor.points=this._points[M],this.curve_editor.draw(c,[this.size[0],this.size[1]-this.curve_offset],G,this.properties.split_channels?null:"#111",P.channel_line_colors[M]),c.restore()}},P.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform sampler2D u_curve;
				uniform float u_range;
				
				void main() {
					vec4 color = texture2D( u_texture, v_coord ) * u_range;
					color.x = texture2D( u_curve, vec2( color.x, 0.5 ) ).x;
					color.y = texture2D( u_curve, vec2( color.y, 0.5 ) ).y;
					color.z = texture2D( u_curve, vec2( color.z, 0.5 ) ).z;
					//color.w = texture2D( u_curve, vec2( color.w, 0.5 ) ).w;
					gl_FragColor = color;
				}`,t.registerNodeType("texture/curve",P);function W(){this.addInput("in","Texture"),this.addInput("exp","number"),this.addOutput("out","Texture"),this.properties={exposition:1,precision:r.LOW},this._uniforms={u_texture:0,u_exposition:1}}W.title="Exposition",W.desc="Controls texture exposition",W.widgets_info={exposition:{widget:"slider",min:0,max:3},precision:{widget:"combo",values:r.MODE_VALUES}},W.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){var G=this._temp_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(G=this._temp_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR}));var M=W._shader;M||(M=W._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,W.pixel_shader)),this.properties.exposition;var U=this.getInputData(1);U!=null&&(this.properties.exposition=U);var q=this._uniforms;G.drawTo(function(){gl.disable(gl.DEPTH_TEST),c.bind(0),M.uniforms(q).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,G)}},W.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform float u_exposition;
				
				void main() {
					vec4 color = texture2D( u_texture, v_coord );
					gl_FragColor = vec4( color.xyz * u_exposition, color.a );
				}`,t.registerNodeType("texture/exposition",W);function X(){this.addInput("in","Texture"),this.addInput("avg","number,Texture"),this.addOutput("out","Texture"),this.properties={enabled:!0,scale:1,gamma:1,average_lum:1,lum_white:1,precision:r.LOW},this._uniforms={u_texture:0,u_lumwhite2:1,u_igamma:1,u_scale:1,u_average_lum:1}}X.title="Tone Mapping",X.desc="Applies Tone Mapping to convert from high to low",X.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES}},X.prototype.onGetInputs=function(){return[["enabled","boolean"]]},X.prototype.onExecute=function(){var c=this.getInputData(0);if(c&&this.isOutputConnected(0)){if(this.properties.precision===r.PASS_THROUGH||this.getInputOrProperty("enabled")===!1){this.setOutputData(0,c);return}var G=this._temp_texture;(!G||G.width!=c.width||G.height!=c.height||G.type!=c.type)&&(G=this._temp_texture=new GL.Texture(c.width,c.height,{type:c.type,format:gl.RGBA,filter:gl.LINEAR}));var M=this.getInputData(1);M==null&&(M=this.properties.average_lum);var U=this._uniforms,q=null;M.constructor===Number?(this.properties.average_lum=M,U.u_average_lum=this.properties.average_lum,q=X._shader,q||(q=X._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.pixel_shader))):M.constructor===GL.Texture&&(U.u_average_texture=M.bind(1),q=X._shader_texture,q||(q=X._shader_texture=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,X.pixel_shader,{AVG_TEXTURE:""}))),U.u_lumwhite2=this.properties.lum_white*this.properties.lum_white,U.u_scale=this.properties.scale,U.u_igamma=1/this.properties.gamma,gl.disable(gl.DEPTH_TEST),G.drawTo(function(){c.bind(0),q.uniforms(U).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,this._temp_texture)}},X.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform float u_scale;
				#ifdef AVG_TEXTURE
					uniform sampler2D u_average_texture;
				#else
					uniform float u_average_lum;
				#endif
				uniform float u_lumwhite2;
				uniform float u_igamma;
				vec3 RGB2xyY (vec3 rgb)
				{
					 const mat3 RGB2XYZ = mat3(0.4124, 0.3576, 0.1805,
											   0.2126, 0.7152, 0.0722,
											   0.0193, 0.1192, 0.9505);
					vec3 XYZ = RGB2XYZ * rgb;
					
					float f = (XYZ.x + XYZ.y + XYZ.z);
					return vec3(XYZ.x / f,
								XYZ.y / f,
								XYZ.y);
				}
				
				void main() {
					vec4 color = texture2D( u_texture, v_coord );
					vec3 rgb = color.xyz;
					float average_lum = 0.0;
					#ifdef AVG_TEXTURE
						vec3 pixel = texture2D(u_average_texture,vec2(0.5)).xyz;
						average_lum = (pixel.x + pixel.y + pixel.z) / 3.0;
					#else
						average_lum = u_average_lum;
					#endif
					//Ld - this part of the code is the same for both versions
					float lum = dot(rgb, vec3(0.2126, 0.7152, 0.0722));
					float L = (u_scale / average_lum) * lum;
					float Ld = (L * (1.0 + L / u_lumwhite2)) / (1.0 + L);
					//first
					//vec3 xyY = RGB2xyY(rgb);
					//xyY.z *= Ld;
					//rgb = xyYtoRGB(xyY);
					//second
					rgb = (rgb / lum) * Ld;
					rgb = max(rgb,vec3(0.001));
					rgb = pow( rgb, vec3( u_igamma ) );
					gl_FragColor = vec4( rgb, color.a );
				}`,t.registerNodeType("texture/tonemapping",X);function Z(){this.addOutput("out","Texture"),this.properties={width:512,height:512,seed:0,persistence:.1,octaves:8,scale:1,offset:[0,0],amplitude:1,precision:r.DEFAULT},this._key=0,this._texture=null,this._uniforms={u_persistence:.1,u_seed:0,u_offset:vec2.create(),u_scale:1,u_viewport:vec2.create()}}Z.title="Perlin",Z.desc="Generates a perlin noise texture",Z.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1},octaves:{type:"number",precision:0,step:1,min:1,max:50}},Z.prototype.onGetInputs=function(){return[["seed","number"],["persistence","number"],["octaves","number"],["scale","number"],["amplitude","number"],["offset","vec2"]]},Z.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.properties.width|0,G=this.properties.height|0;c==0&&(c=gl.viewport_data[2]),G==0&&(G=gl.viewport_data[3]);var M=r.getTextureType(this.properties.precision),U=this._texture;(!U||U.width!=c||U.height!=G||U.type!=M)&&(U=this._texture=new GL.Texture(c,G,{type:M,format:gl.RGB,filter:gl.LINEAR}));var q=this.getInputOrProperty("persistence"),j=this.getInputOrProperty("octaves"),Q=this.getInputOrProperty("offset"),$=this.getInputOrProperty("scale"),rt=this.getInputOrProperty("amplitude"),nt=this.getInputOrProperty("seed"),st=""+c+G+M+q+j+$+nt+Q[0]+Q[1]+rt;if(st==this._key){this.setOutputData(0,U);return}this._key=st;var ot=this._uniforms;ot.u_persistence=q,ot.u_octaves=j,ot.u_offset.set(Q),ot.u_scale=$,ot.u_amplitude=rt,ot.u_seed=nt*128,ot.u_viewport[0]=c,ot.u_viewport[1]=G;var at=Z._shader;at||(at=Z._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,Z.pixel_shader)),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),U.drawTo(function(){at.uniforms(ot).draw(GL.Mesh.getScreenQuad())}),this.setOutputData(0,U)}},Z.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform vec2 u_offset;
				uniform float u_scale;
				uniform float u_persistence;
				uniform int u_octaves;
				uniform float u_amplitude;
				uniform vec2 u_viewport;
				uniform float u_seed;
				#define M_PI 3.14159265358979323846
				
				float rand(vec2 c){	return fract(sin(dot(c.xy ,vec2( 12.9898 + u_seed,78.233 + u_seed))) * 43758.5453); }
				
				float noise(vec2 p, float freq ){
					float unit = u_viewport.x/freq;
					vec2 ij = floor(p/unit);
					vec2 xy = mod(p,unit)/unit;
					//xy = 3.*xy*xy-2.*xy*xy*xy;
					xy = .5*(1.-cos(M_PI*xy));
					float a = rand((ij+vec2(0.,0.)));
					float b = rand((ij+vec2(1.,0.)));
					float c = rand((ij+vec2(0.,1.)));
					float d = rand((ij+vec2(1.,1.)));
					float x1 = mix(a, b, xy.x);
					float x2 = mix(c, d, xy.x);
					return mix(x1, x2, xy.y);
				}
				
				float pNoise(vec2 p, int res){
					float persistance = u_persistence;
					float n = 0.;
					float normK = 0.;
					float f = 4.;
					float amp = 1.0;
					int iCount = 0;
					for (int i = 0; i<50; i++){
						n+=amp*noise(p, f);
						f*=2.;
						normK+=amp;
						amp*=persistance;
						if (iCount >= res)
							break;
						iCount++;
					}
					float nf = n/normK;
					return nf*nf*nf*nf;
				}
				void main() {
					vec2 uv = v_coord * u_scale * u_viewport + u_offset * u_scale;
					vec4 color = vec4( pNoise( uv, u_octaves ) * u_amplitude );
					gl_FragColor = color;
				}`,t.registerNodeType("texture/perlin",Z);function tt(){this.addInput("v"),this.addOutput("out","Texture"),this.properties={code:tt.default_code,width:512,height:512,clear:!0,precision:r.DEFAULT,use_html_canvas:!1},this._func=null,this._temp_texture=null,this.compileCode()}tt.title="Canvas2D",tt.desc="Executes Canvas2D code inside a texture or the viewport.",tt.help="Set width and height to 0 to match viewport size.",tt.default_code=`//vars: canvas,ctx,time
ctx.fillStyle='red';
ctx.fillRect(0,0,50,50);
`,tt.widgets_info={precision:{widget:"combo",values:r.MODE_VALUES},code:{type:"code"},width:{type:"number",precision:0,step:1},height:{type:"number",precision:0,step:1}},tt.prototype.onPropertyChanged=function(c,G){c=="code"&&this.compileCode(G)},tt.prototype.compileCode=function(c){if(this._func=null,!!t.allow_scripts)try{this._func=new Function("canvas","ctx","time","script","v",c),this.boxcolor="#00FF00"}catch(G){this.boxcolor="#FF0000",console.error("Error parsing script"),console.error(G)}},tt.prototype.onExecute=function(){var c=this._func;!c||!this.isOutputConnected(0)||this.executeDraw(c)},tt.prototype.executeDraw=function(c){var G=this.properties.width||gl.canvas.width,M=this.properties.height||gl.canvas.height,U=this._temp_texture,q=r.getTextureType(this.properties.precision);(!U||U.width!=G||U.height!=M||U.type!=q)&&(U=this._temp_texture=new GL.Texture(G,M,{format:gl.RGBA,filter:gl.LINEAR,type:q}));var j=this.getInputData(0),Q=this.properties,$=this,rt=this.graph.getTime(),nt=gl,st=gl.canvas;if((this.properties.use_html_canvas||!e.enableWebGLCanvas)&&(this._canvas?(st=this._canvas,nt=this._ctx):(st=this._canvas=createCanvas(G.height),nt=this._ctx=st.getContext("2d")),st.width=G,st.height=M),nt==gl)U.drawTo(function(){gl.start2D(),Q.clear&&(gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT));try{c.draw?c.draw.call($,st,nt,rt,c,j):c.call($,st,nt,rt,c,j),$.boxcolor="#00FF00"}catch(ot){$.boxcolor="#FF0000",console.error("Error executing script"),console.error(ot)}gl.finish2D()});else{Q.clear&&nt.clearRect(0,0,st.width,st.height);try{c.draw?c.draw.call(this,st,nt,rt,c,j):c.call(this,st,nt,rt,c,j),this.boxcolor="#00FF00"}catch(ot){this.boxcolor="#FF0000",console.error("Error executing script"),console.error(ot)}U.uploadImage(st)}this.setOutputData(0,U)},t.registerNodeType("texture/canvas2D",tt);function et(){this.addInput("in","Texture"),this.addOutput("out","Texture"),this.properties={key_color:vec3.fromValues(0,1,0),threshold:.8,slope:.2,precision:r.DEFAULT}}et.title="Matte",et.desc="Extracts background",et.widgets_info={key_color:{widget:"color"},precision:{widget:"combo",values:r.MODE_VALUES}},et.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(this.properties.precision===r.PASS_THROUGH){this.setOutputData(0,c);return}if(c){this._tex=r.getTargetTexture(c,this._tex,this.properties.precision),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST),this._uniforms||(this._uniforms={u_texture:0,u_key_color:this.properties.key_color,u_threshold:1,u_slope:1});var G=this._uniforms,M=Mesh.getScreenQuad(),U=et._shader;U||(U=et._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,et.pixel_shader)),G.u_key_color=this.properties.key_color,G.u_threshold=this.properties.threshold,G.u_slope=this.properties.slope,this._tex.drawTo(function(){c.bind(0),U.uniforms(G).draw(M)}),this.setOutputData(0,this._tex)}}},et.pixel_shader=`precision highp float;
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				uniform vec3 u_key_color;
				uniform float u_threshold;
				uniform float u_slope;
				
				void main() {
					vec3 color = texture2D( u_texture, v_coord ).xyz;
					float diff = length( normalize(color) - normalize(u_key_color) );
					float edge = u_threshold * (1.0 - u_slope);
					float alpha = smoothstep( edge, u_threshold, diff);
					gl_FragColor = vec4( color, alpha );
				}`,t.registerNodeType("texture/matte",et);function it(){this.addInput("in","texture"),this.addInput("yaw","number"),this.addOutput("out","texture"),this.properties={yaw:0}}it.title="CubemapToTexture2D",it.desc="Transforms a CUBEMAP texture into a TEXTURE2D in Polar Representation",it.prototype.onExecute=function(){if(this.isOutputConnected(0)){var c=this.getInputData(0);if(!(!c||c.texture_type!=GL.TEXTURE_CUBE_MAP)){this._last_tex&&(this._last_tex.height!=c.height||this._last_tex.type!=c.type)&&(this._last_tex=null);var G=this.getInputOrProperty("yaw");this._last_tex=GL.Texture.cubemapToTexture2D(c,c.height,this._last_tex,!0,G),this.setOutputData(0,this._last_tex)}}},t.registerNodeType("texture/cubemapToTexture2D",it)})(litegraph),(function(e){if(typeof GL>"u")return;var t=e.LiteGraph;e.LGraphCanvas;var s="#345",r=t.Shaders={};r.GLSL_types=["float","vec2","vec3","vec4","mat3","mat4","sampler2D","samplerCube"];var n=r.GLSL_types_const=["float","vec2","vec3","vec4"],u={radians:"T radians(T degrees)",degrees:"T degrees(T radians)",sin:"T sin(T angle)",cos:"T cos(T angle)",tan:"T tan(T angle)",asin:"T asin(T x)",acos:"T acos(T x)",atan:"T atan(T x)",atan2:"T atan(T x,T y)",pow:"T pow(T x,T y)",exp:"T exp(T x)",log:"T log(T x)",exp2:"T exp2(T x)",log2:"T log2(T x)",sqrt:"T sqrt(T x)",inversesqrt:"T inversesqrt(T x)",abs:"T abs(T x)",sign:"T sign(T x)",floor:"T floor(T x)",round:"T round(T x)",ceil:"T ceil(T x)",fract:"T fract(T x)",mod:"T mod(T x,T y)",min:"T min(T x,T y)",max:"T max(T x,T y)",clamp:"T clamp(T x,T minVal = 0.0,T maxVal = 1.0)",mix:"T mix(T x,T y,T a)",step:"T step(T edge, T edge2, T x)",smoothstep:"T smoothstep(T edge, T edge2, T x)",length:"float length(T x)",distance:"float distance(T p0, T p1)",normalize:"T normalize(T x)",dot:"float dot(T x,T y)",cross:"vec3 cross(vec3 x,vec3 y)",reflect:"vec3 reflect(vec3 V,vec3 N)",refract:"vec3 refract(vec3 V,vec3 N, float IOR)"},o={},a=[];l(),r.ALL_TYPES="float,vec2,vec3,vec4";function l(){a.length=0;for(var S in u){var A=u[S],P=A.indexOf(" "),W=A.substr(0,P),X=A.indexOf("(",P),Z=A.substr(P,X-P).trim(),tt=A.substr(X+1,A.length-X-2).split(",");for(var et in tt){var it=tt[et].split(" ").filter(function(c){return c});tt[et]={type:it[0].trim(),name:it[1].trim()},it[2]=="="&&(tt[et].value=it[3].trim())}o[S]={return_type:W,func:Z,params:tt},a.push(Z)}}function f(S,A){A.color=s,A.filter="shader",A.prototype.clearDestination=function(){this.shader_destination={}},A.prototype.propagateDestination=function(W){if(this.shader_destination[W]=!0,this.inputs)for(var X=0;X<this.inputs.length;++X){var Z=this.getInputNode(X);Z&&Z.propagateDestination(W)}},A.prototype.onPropertyChanged||(A.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++}),t.registerNodeType("shader::"+S,A)}function m(S,A){return"VAR_"+(A||"TEMP")+"_"+S.id}function O(S,A){if(!S.inputs)return null;var P=S.getInputLink(A);if(!P)return null;var W=S.graph.getNodeById(P.origin_id);return W?W.getOutputVarName?W.getOutputVarName(P.origin_slot):"link_"+W.id+"_"+P.origin_slot:null}function d(S,A){return S.isOutputConnected(A)?"link_"+S.id+"_"+A:null}r.registerShaderNode=f,r.getInputLinkID=O,r.getOutputLinkID=d,r.getShaderNodeVarName=m,r.parseGLSLDescriptions=l;var g=t.valueToGLSL=function(A,P,W){var X=5;if(W!=null&&(X=W),!P)if(A.constructor===Number)P="float";else if(A.length)switch(A.length){case 2:P="vec2";break;case 3:P="vec3";break;case 4:P="vec4";break;case 9:P="mat3";break;case 16:P="mat4";break;default:throw"unknown type for glsl value size"}else throw"unknown type for glsl value: "+A.constructor;switch(P){case"float":return A.toFixed(X);case"vec2":return"vec2("+A[0].toFixed(X)+","+A[1].toFixed(X)+")";case"color3":case"vec3":return"vec3("+A[0].toFixed(X)+","+A[1].toFixed(X)+","+A[2].toFixed(X)+")";case"color4":case"vec4":return"vec4("+A[0].toFixed(X)+","+A[1].toFixed(X)+","+A[2].toFixed(X)+","+A[3].toFixed(X)+")";case"mat3":return"mat3(1.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,1.0)";case"mat4":return"mat4(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0)";default:throw P}return""},E=t.varToTypeGLSL=function(A,P,W){if(P==W)return A;if(A==null)switch(W){case"float":return"0.0";case"vec2":return"vec2(0.0)";case"vec3":return"vec3(0.0)";case"vec4":return"vec4(0.0,0.0,0.0,1.0)";default:return null}if(!W)throw"error: no output type specified";if(W=="float")switch(P){case"vec2":case"vec3":case"vec4":return A+".x";default:return"0.0"}else if(W=="vec2")switch(P){case"float":return"vec2("+A+")";case"vec3":case"vec4":return A+".xy";default:return"vec2(0.0)"}else if(W=="vec3")switch(P){case"float":return"vec3("+A+")";case"vec2":return"vec3("+A+",0.0)";case"vec4":return A+".xyz";default:return"vec3(0.0)"}else if(W=="vec4")switch(P){case"float":return"vec4("+A+")";case"vec2":return"vec4("+A+",0.0,1.0)";case"vec3":return"vec4("+A+",1.0)";default:return"vec4(0.0,0.0,0.0,1.0)"}throw"type cannot be converted"},I=t.convertVarToGLSLType=function(A,P,W){if(P==W)return A;if(P=="float")return W+"("+A+")";if(W=="vec2")return"vec2("+A+".xy)";if(W=="vec3"){if(P=="vec2")return"vec3("+A+",0.0)";if(P=="vec4")return"vec4("+A+".xyz)"}if(W=="vec4"){if(P=="vec2")return"vec4("+A+",0.0,0.0)";if(W=="vec3")return"vec4("+A+",1.0)"}return null};function k(){this.vs_template="",this.fs_template="",this.buffer_names={uvs:"v_coord"},this.extra={},this._functions={},this._uniforms={},this._codeparts={},this._uniform_value=null}k.prototype.clear=function(){this._uniforms={},this._functions={},this._codeparts={},this._uniform_value=null,this.extra={}},k.prototype.addUniform=function(S,A,P){this._uniforms[S]=A,P!=null&&(this._uniform_value||(this._uniform_value={}),this._uniform_value[S]=P)},k.prototype.addFunction=function(S,A){this._functions[S]=A},k.prototype.addCode=function(S,A,P){P=P||{"":""};for(var W in P){var X=W?W+"_"+S:S;this._codeparts[X]?this._codeparts[X]+=A+`
`:this._codeparts[X]=A+`
`}},k.prototype.computeCodeBlocks=function(S,A){this.clear();var P=S.findNodesByType("shader::output/vertex");P=P&&P.length?P[0]:null;var W=S.findNodesByType("shader::output/fragcolor");if(W=W&&W.length?W[0]:null,!W)return null;S.sendEventToAllNodes("clearDestination"),P&&P.propagateDestination("vs"),W&&W.propagateDestination("fs"),S.sendEventToAllNodes("onGetCode",this);var X="";for(var Z in this._uniforms)X+="uniform "+this._uniforms[Z]+" "+Z+`;
`;if(A)for(var Z in A)X+="uniform "+A[Z]+" "+Z+`;
`;var tt="";for(var Z in this._functions)tt+="//"+Z+`
`+this._functions[Z]+`
`;var et=this._codeparts;return et.uniforms=X,et.functions=tt,et},k.prototype.computeShaderCode=function(S){var A=this.computeCodeBlocks(S),P=GL.Shader.replaceCodeUsingContext(this.vs_template,A),W=GL.Shader.replaceCodeUsingContext(this.fs_template,A);return{vs_code:P,fs_code:W}},k.prototype.computeShader=function(S,A){var P=this.computeShaderCode(S);if(console.log(P.vs_code,P.fs_code),!t.catch_exceptions)return this._shader_error=!0,A?A.updateShader(P.vs_code,P.fs_code):A=new GL.Shader(P.vs_code,P.fs_code),this._shader_error=!1,A;try{return A?A.updateShader(P.vs_code,P.fs_code):A=new GL.Shader(P.vs_code,P.fs_code),this._shader_error=!1,A}catch(W){return this._shader_error||(console.error(W),W.indexOf("Fragment shader")!=-1?console.log(P.fs_code.split(`
`).map(function(X,Z){return Z+".- "+X}).join(`
`)):console.log(P.vs_code)),this._shader_error=!0,null}return null},k.prototype.getShader=function(S){if(this._shader&&this._shader._version==S._version)return this._shader;var A=this.computeShader(S,this._shader);return A?(this._shader=A,A._version=S._version,A):null},k.prototype.fillUniforms=function(S,A){if(this._uniform_value)for(var P in this._uniform_value){var W=this._uniform_value[P];W!=null&&(W.constructor===Function?S[P]=W.call(this,A):W.constructor===GL.Texture||(S[P]=W))}},t.ShaderContext=t.Shaders.Context=k;function N(){this.subgraph=new t.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.filter="shader",this.addInput("in","texture"),this.addOutput("out","texture"),this.properties={width:0,height:0,alpha:!1,precision:typeof LGraphTexture<"u"?LGraphTexture.DEFAULT:2};var S=this.subgraph.findNodesByType("shader::input/uniform")[0];S.pos=[200,300];var A=t.createNode("shader::texture/sampler2D");A.pos=[400,300],this.subgraph.add(A);var P=t.createNode("shader::output/fragcolor");P.pos=[600,300],this.subgraph.add(P),S.connect(0,A),A.connect(0,P),this.size=[180,60],this.redraw_on_mouse=!0,this._uniforms={},this._shader=null,this._context=new k,this._context.vs_template=`#define VERTEX
`+GL.Shader.SCREEN_VERTEX_SHADER,this._context.fs_template=N.template}N.template=`
		#define FRAGMENT
		precision highp float;
		varying vec2 v_coord;
		{{varying}}
		{{uniforms}}
		{{functions}}
		{{fs_functions}}
		void main() {

		vec2 uv = v_coord;
		vec4 fragcolor = vec4(0.0);
		vec4 fragcolor1 = vec4(0.0);
		{{fs_code}}
		gl_FragColor = fragcolor;
		}
			`,N.widgets_info={precision:{widget:"combo",values:LGraphTexture.MODE_VALUES}},N.title="ShaderGraph",N.desc="Builds a shader using a graph",N.input_node_type="input/uniform",N.output_node_type="output/fragcolor",N.title_color=s,N.prototype.onSerialize=function(S){S.subgraph=this.subgraph.serialize()},N.prototype.onConfigure=function(S){this.subgraph.configure(S.subgraph)},N.prototype.onExecute=function(){if(this.isOutputConnected(0)){var S=this.getInputData(0);S&&S.constructor!=GL.Texture&&(S=null);var A=this.properties.width|0,P=this.properties.height|0;A==0&&(A=S?S.width:gl.viewport_data[2]),P==0&&(P=S?S.height:gl.viewport_data[3]);var W=LGraphTexture.getTextureType(this.properties.precision,S),X=this._texture;(!X||X.width!=A||X.height!=P||X.type!=W)&&(X=this._texture=new GL.Texture(A,P,{type:W,format:this.alpha?gl.RGBA:gl.RGB,filter:gl.LINEAR}));var Z=this.getShader(this.subgraph);if(Z){var tt=this._uniforms;this._context.fillUniforms(tt);var et=0;if(this.inputs)for(var it=0;it<this.inputs.length;++it){var c=this.inputs[it],G=this.getInputData(it);c.type=="texture"&&(G||(G=GL.Texture.getWhiteTexture()),G=G.bind(et++)),G!=null&&(tt["u_"+c.name]=G)}var M=GL.Mesh.getScreenQuad();gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),X.drawTo(function(){Z.uniforms(tt),Z.draw(M)}),this.setOutputData(0,X)}}},N.prototype.onInputAdded=function(S){var A=t.createNode("shader::input/uniform");A.setProperty("name",S.name),A.setProperty("type",S.type),this.subgraph.add(A)},N.prototype.onInputRemoved=function(S,A){for(var P=this.subgraph.findNodesByType("shader::input/uniform"),W=0;W<P.length;++W){var X=P[W];X.properties.name==A.name&&this.subgraph.remove(X)}},N.prototype.computeSize=function(){var S=this.inputs?this.inputs.length:0,A=this.outputs?this.outputs.length:0;return[200,Math.max(S,A)*t.NODE_SLOT_HEIGHT+t.NODE_TITLE_HEIGHT+10]},N.prototype.getShader=function(){var S=this._context.getShader(this.subgraph);return S?this.boxcolor=null:this.boxcolor="red",S},N.prototype.onDrawBackground=function(S,A,P,W){if(!this.flags.collapsed){var X=this.getOutputData(0),Z=this.inputs?this.inputs.length*t.NODE_SLOT_HEIGHT:0;X&&S==X.gl&&this.size[1]>Z+t.NODE_TITLE_HEIGHT&&S.drawImage(X,10,tt,this.size[0]-20,this.size[1]-Z-t.NODE_TITLE_HEIGHT);var tt=this.size[1]-t.NODE_TITLE_HEIGHT+.5,et=t.isInsideRectangle(W[0],W[1],this.pos[0],this.pos[1]+tt,this.size[0],t.NODE_TITLE_HEIGHT);S.fillStyle=et?"#555":"#222",S.beginPath(),this._shape==t.BOX_SHAPE?S.rect(0,tt,this.size[0]+1,t.NODE_TITLE_HEIGHT):S.roundRect(0,tt,this.size[0]+1,t.NODE_TITLE_HEIGHT,0,8),S.fill(),S.textAlign="center",S.font="24px Arial",S.fillStyle=et?"#DDD":"#999",S.fillText("+",this.size[0]*.5,tt+24)}},N.prototype.onMouseDown=function(S,A,P){var W=this.size[1]-t.NODE_TITLE_HEIGHT+.5;A[1]>W&&P.showSubgraphPropertiesDialog(this)},N.prototype.onDrawSubgraphBackground=function(S){},N.prototype.getExtraMenuOptions=function(S){var A=this,P=[{content:"Print Code",callback:function(){var W=A._context.computeShaderCode();console.log(W.vs_code,W.fs_code)}}];return P},t.registerNodeType("texture/shaderGraph",N);function T(){this.addOutput("out",""),this.properties={name:"",type:""}}T.title="Uniform",T.desc="Input data for the shader",T.prototype.getTitle=function(){return this.properties.name&&this.flags.collapsed?this.properties.type+" "+this.properties.name:"Uniform"},T.prototype.onPropertyChanged=function(S,A){this.outputs[0].name=this.properties.type+" "+this.properties.name},T.prototype.onGetCode=function(S){if(this.shader_destination){var A=this.properties.type;if(!A){if(!S.onGetPropertyInfo)return;var P=S.onGetPropertyInfo(this.property.name);if(!P)return;A=P.type}A=="number"?A="float":A=="texture"&&(A="sampler2D"),r.GLSL_types.indexOf(A)!=-1&&(S.addUniform("u_"+this.properties.name,A),this.setOutputData(0,A))}},T.prototype.getOutputVarName=function(S){return"u_"+this.properties.name},f("input/uniform",T);function h(){this.addOutput("out","vec2"),this.properties={name:"coord",type:"vec2"}}h.title="Attribute",h.desc="Input data from mesh attribute",h.prototype.getTitle=function(){return"att. "+this.properties.name},h.prototype.onGetCode=function(S){if(this.shader_destination){var A=this.properties.type;!A||r.GLSL_types.indexOf(A)==-1||(A=="number"&&(A="float"),this.properties.name!="coord"&&S.addCode("varying"," varying "+A+" v_"+this.properties.name+";"),this.setOutputData(0,A))}},h.prototype.getOutputVarName=function(S){return"v_"+this.properties.name},f("input/attribute",h);function L(){this.addInput("tex","sampler2D"),this.addInput("uv","vec2"),this.addOutput("rgba","vec4"),this.addOutput("rgb","vec3")}L.title="Sampler2D",L.desc="Reads a pixel from a texture",L.prototype.onGetCode=function(S){if(this.shader_destination){var A=O(this,0),P=m(this),W="vec4 "+P+` = vec4(0.0);
`;if(A){var X=O(this,1)||S.buffer_names.uvs;W+=P+" = texture2D("+A+","+X+`);
`}var Z=d(this,0);Z&&(W+="vec4 "+d(this,0)+" = "+P+`;
`);var tt=d(this,1);tt&&(W+="vec3 "+d(this,1)+" = "+P+`.xyz;
`),S.addCode("code",W,this.shader_destination),this.setOutputData(0,"vec4"),this.setOutputData(1,"vec3")}},f("texture/sampler2D",L);function _(){this.addOutput("","float"),this.properties={type:"float",value:0},this.addWidget("combo","type","float",null,{values:n,property:"type"}),this.updateWidgets()}_.title="const",_.prototype.getTitle=function(){return this.flags.collapsed?g(this.properties.value,this.properties.type,2):"Const"},_.prototype.onPropertyChanged=function(S,A){S=="type"&&(this.outputs[0].type!=A&&(this.disconnectOutput(0),this.outputs[0].type=A),this.widgets.length=1,this.updateWidgets()),S=="value"&&(A.length?(this.widgets[1].value=A[1],A.length>2&&(this.widgets[2].value=A[2]),A.length>3&&(this.widgets[3].value=A[3])):this.widgets[1].value=A)},_.prototype.updateWidgets=function(P){var A=this,P=this.properties.value,W={step:.01};switch(this.properties.type){case"float":this.properties.value=0,this.addWidget("number","v",0,{step:.01,property:"value"});break;case"vec2":this.properties.value=P&&P.length==2?[P[0],P[1]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(X){A.properties.value[0]=X},W),this.addWidget("number","y",this.properties.value[1],function(X){A.properties.value[1]=X},W);break;case"vec3":this.properties.value=P&&P.length==3?[P[0],P[1],P[2]]:[0,0,0],this.addWidget("number","x",this.properties.value[0],function(X){A.properties.value[0]=X},W),this.addWidget("number","y",this.properties.value[1],function(X){A.properties.value[1]=X},W),this.addWidget("number","z",this.properties.value[2],function(X){A.properties.value[2]=X},W);break;case"vec4":this.properties.value=P&&P.length==4?[P[0],P[1],P[2],P[3]]:[0,0,0,0],this.addWidget("number","x",this.properties.value[0],function(X){A.properties.value[0]=X},W),this.addWidget("number","y",this.properties.value[1],function(X){A.properties.value[1]=X},W),this.addWidget("number","z",this.properties.value[2],function(X){A.properties.value[2]=X},W),this.addWidget("number","w",this.properties.value[3],function(X){A.properties.value[3]=X},W);break;default:console.error("unknown type for constant")}},_.prototype.onGetCode=function(S){if(this.shader_destination){var A=g(this.properties.value,this.properties.type),P=d(this,0);if(P){var W="	"+this.properties.type+" "+P+" = "+A+";";S.addCode("code",W,this.shader_destination),this.setOutputData(0,this.properties.type)}}},f("const/const",_);function D(){this.addInput("xy","vec2"),this.addInput("x","float"),this.addInput("y","float"),this.addOutput("xy","vec2"),this.addOutput("x","float"),this.addOutput("y","float"),this.properties={x:0,y:0}}D.title="vec2",D.varmodes=["xy","x","y"],D.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},D.prototype.onGetCode=function(S){if(this.shader_destination){for(var A=this.properties,P=m(this),W="	vec2 "+P+" = "+g([A.x,A.y])+`;
`,X=0;X<D.varmodes.length;++X){var Z=D.varmodes[X],tt=O(this,X);tt&&(W+="	"+P+"."+Z+" = "+tt+`;
`)}for(var X=0;X<D.varmodes.length;++X){var Z=D.varmodes[X],et=d(this,X);if(et){var it=n[Z.length-1];W+="	"+it+" "+et+" = "+P+"."+Z+`;
`,this.setOutputData(X,it)}}S.addCode("code",W,this.shader_destination)}},f("const/vec2",D);function B(){this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("xy","vec2"),this.addInput("xz","vec2"),this.addInput("yz","vec2"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("xz","vec2"),this.addOutput("yz","vec2"),this.properties={x:0,y:0,z:0}}B.title="vec3",B.varmodes=["xyz","x","y","z","xy","xz","yz"],B.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},B.prototype.onGetCode=function(S){if(this.shader_destination){for(var A=this.properties,P=m(this),W="vec3 "+P+" = "+g([A.x,A.y,A.z])+`;
`,X=0;X<B.varmodes.length;++X){var Z=B.varmodes[X],tt=O(this,X);tt&&(W+="	"+P+"."+Z+" = "+tt+`;
`)}for(var X=0;X<B.varmodes.length;++X){var Z=B.varmodes[X],et=d(this,X);if(et){var it=n[Z.length-1];W+="	"+it+" "+et+" = "+P+"."+Z+`;
`,this.setOutputData(X,it)}}S.addCode("code",W,this.shader_destination)}},f("const/vec3",B);function F(){this.addInput("xyzw","vec4"),this.addInput("xyz","vec3"),this.addInput("x","float"),this.addInput("y","float"),this.addInput("z","float"),this.addInput("w","float"),this.addInput("xy","vec2"),this.addInput("yz","vec2"),this.addInput("zw","vec2"),this.addOutput("xyzw","vec4"),this.addOutput("xyz","vec3"),this.addOutput("x","float"),this.addOutput("y","float"),this.addOutput("z","float"),this.addOutput("xy","vec2"),this.addOutput("yz","vec2"),this.addOutput("zw","vec2"),this.properties={x:0,y:0,z:0,w:0}}F.title="vec4",F.varmodes=["xyzw","xyz","x","y","z","w","xy","yz","zw"],F.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},F.prototype.onGetCode=function(S){if(this.shader_destination){for(var A=this.properties,P=m(this),W="vec4 "+P+" = "+g([A.x,A.y,A.z,A.w])+`;
`,X=0;X<F.varmodes.length;++X){var Z=F.varmodes[X],tt=O(this,X);tt&&(W+="	"+P+"."+Z+" = "+tt+`;
`)}for(var X=0;X<F.varmodes.length;++X){var Z=F.varmodes[X],et=d(this,X);if(et){var it=n[Z.length-1];W+="	"+it+" "+et+" = "+P+"."+Z+`;
`,this.setOutputData(X,it)}}S.addCode("code",W,this.shader_destination)}},f("const/vec4",F);function H(){this.addInput("color",r.ALL_TYPES),this.block_delete=!0}H.title="FragColor",H.desc="Pixel final color",H.prototype.onGetCode=function(S){var A=O(this,0);if(A){var P=this.getInputData(0),W=E(A,P,"vec4");S.addCode("fs_code","fragcolor = "+W+";")}},f("output/fragcolor",H);function V(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("out",""),this.properties={operation:"*"},this.addWidget("combo","op.",this.properties.operation,{property:"operation",values:V.operations})}V.title="Operation",V.operations=["+","-","*","/"],V.prototype.getTitle=function(){return this.flags.collapsed?"A"+this.properties.operation+"B":"Operation"},V.prototype.onGetCode=function(S){if(this.shader_destination&&this.isOutputConnected(0)){for(var A=[],P=0;P<3;++P)A.push({name:O(this,P),type:this.getInputData(P)||"float"});var W=d(this,0);if(W){for(var X=A[0].type,Z=X,tt=this.properties.operation,et=[],P=0;P<2;++P){var it=A[P].name;it==null&&(it=p.value!=null?p.value:"(1.0)",A[P].type="float"),A[P].type!=X&&(A[P].type=="float"&&(tt=="*"||tt=="/")||(it=I(it,A[P].type,X))),et.push(it)}S.addCode("code",Z+" "+W+" = "+et[0]+tt+et[1]+";",this.shader_destination),this.setOutputData(0,Z)}}},f("math/operation",V);function Y(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("out",""),this.properties={func:"floor"},this._current="floor",this.addWidget("combo","func",this.properties.func,{property:"func",values:a})}Y.title="Func",Y.prototype.onPropertyChanged=function(S,A){if(this.graph&&this.graph._version++,S=="func"){var P=o[A];if(!P)return;for(var W=P.params.length;W<this.inputs.length;++W)this.removeInput(W);for(var W=0;W<P.params.length;++W){var X=P.params[W];this.inputs[W]?this.inputs[W].name=X.name+(X.value?" ("+X.value+")":""):this.addInput(X.name,r.ALL_TYPES)}}},Y.prototype.getTitle=function(){return this.flags.collapsed?this.properties.func:"Func"},Y.prototype.onGetCode=function(S){if(this.shader_destination&&this.isOutputConnected(0)){for(var A=[],P=0;P<3;++P)A.push({name:O(this,P),type:this.getInputData(P)||"float"});var W=d(this,0);if(W){var X=o[this.properties.func];if(X){var Z=A[0].type,tt=X.return_type;tt=="T"&&(tt=Z);for(var et=[],P=0;P<X.params.length;++P){var it=X.params[P],c=A[P].name;c==null&&(c=it.value!=null?it.value:"(1.0)",A[P].type="float"),(it.type=="T"&&A[P].type!=Z||it.type!="T"&&A[P].type!=Z)&&(c=I(c,A[P].type,Z)),et.push(c)}S.addFunction("round",`float round(float v){ return floor(v+0.5); }
vec2 round(vec2 v){ return floor(v+vec2(0.5));}
vec3 round(vec3 v){ return floor(v+vec3(0.5));}
vec4 round(vec4 v){ return floor(v+vec4(0.5)); }
`),S.addCode("code",tt+" "+W+" = "+X.func+"("+et.join(",")+");",this.shader_destination),this.setOutputData(0,tt)}}}},f("math/func",Y);function K(){this.addInput("A",r.ALL_TYPES),this.addInput("B",r.ALL_TYPES),this.addOutput("C","vec4"),this.properties={code:"C = A+B",type:"vec4"},this.addWidget("text","code",this.properties.code,{property:"code"}),this.addWidget("combo","type",this.properties.type,{values:["float","vec2","vec3","vec4"],property:"type"})}K.title="Snippet",K.prototype.onPropertyChanged=function(S,A){this.graph&&this.graph._version++,S=="type"&&this.outputs[0].type!=A&&(this.disconnectOutput(0),this.outputs[0].type=A)},K.prototype.getTitle=function(){return this.flags.collapsed?this.properties.code:"Snippet"},K.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=O(this,0);A||(A="1.0");var P=O(this,1);P||(P="1.0");var W=d(this,0);if(W){var X=this.getInputData(0)||"float",Z=this.getInputData(1)||"float",tt=this.properties.type;if(X=="T"||Z=="T")return null;var et="funcSnippet"+this.id,it=`
`+tt+" "+et+"( "+X+" A, "+Z+` B) {
`;it+="	"+tt+" C = "+tt+`(0.0);
`,it+="	"+this.properties.code+`;
`,it+=`	return C;
}
`,S.addCode("functions",it,this.shader_destination),S.addCode("code",tt+" "+W+" = "+et+"("+A+","+P+");",this.shader_destination),this.setOutputData(0,tt)}}},f("utils/snippet",K);function J(){this.addOutput("out","float")}J.title="Rand",J.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=d(this,0);S.addUniform("u_rand"+this.id,"float",function(){return Math.random()}),S.addCode("code","float "+A+" = u_rand"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},f("input/rand",J);function C(){this.addInput("out",r.ALL_TYPES),this.addInput("scale","float"),this.addOutput("out","float"),this.properties={type:"noise",scale:1},this.addWidget("combo","type",this.properties.type,{property:"type",values:C.NOISE_TYPES}),this.addWidget("number","scale",this.properties.scale,{property:"scale"})}C.NOISE_TYPES=["noise","rand"],C.title="noise",C.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=O(this,0),P=d(this,0),W=this.getInputData(0);A||(W="vec2",A=S.buffer_names.uvs),S.addFunction("noise",C.shader_functions),S.addUniform("u_noise_scale"+this.id,"float",this.properties.scale),W=="float"?S.addCode("code","float "+P+" = snoise( vec2("+A+") * u_noise_scale"+this.id+");",this.shader_destination):W=="vec2"||W=="vec3"?S.addCode("code","float "+P+" = snoise("+A+" * u_noise_scale"+this.id+");",this.shader_destination):W=="vec4"&&S.addCode("code","float "+P+" = snoise("+A+".xyz * u_noise_scale"+this.id+");",this.shader_destination),this.setOutputData(0,"float")}},f("math/noise",C),C.shader_functions=`
		vec3 permute(vec3 x) { return mod(((x*34.0)+1.0)*x, 289.0); }
		
		float snoise(vec2 v){
		  const vec4 C = vec4(0.211324865405187, 0.366025403784439,-0.577350269189626, 0.024390243902439);
		  vec2 i  = floor(v + dot(v, C.yy) );
		  vec2 x0 = v -   i + dot(i, C.xx);
		  vec2 i1;
		  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
		  vec4 x12 = x0.xyxy + C.xxzz;
		  x12.xy -= i1;
		  i = mod(i, 289.0);
		  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))
		  + i.x + vec3(0.0, i1.x, 1.0 ));
		  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)), 0.0);
		  m = m*m ;
		  m = m*m ;
		  vec3 x = 2.0 * fract(p * C.www) - 1.0;
		  vec3 h = abs(x) - 0.5;
		  vec3 ox = floor(x + 0.5);
		  vec3 a0 = x - ox;
		  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );
		  vec3 g;
		  g.x  = a0.x  * x0.x  + h.x  * x0.y;
		  g.yz = a0.yz * x12.xz + h.yz * x12.yw;
		  return 130.0 * dot(m, g);
		}
		vec4 permute(vec4 x){return mod(((x*34.0)+1.0)*x, 289.0);}
		vec4 taylorInvSqrt(vec4 r){return 1.79284291400159 - 0.85373472095314 * r;}
		
		float snoise(vec3 v){ 
		  const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;
		  const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);
		
		// First corner
		  vec3 i  = floor(v + dot(v, C.yyy) );
		  vec3 x0 =   v - i + dot(i, C.xxx) ;
		
		// Other corners
		  vec3 g = step(x0.yzx, x0.xyz);
		  vec3 l = 1.0 - g;
		  vec3 i1 = min( g.xyz, l.zxy );
		  vec3 i2 = max( g.xyz, l.zxy );
		
		  //  x0 = x0 - 0. + 0.0 * C 
		  vec3 x1 = x0 - i1 + 1.0 * C.xxx;
		  vec3 x2 = x0 - i2 + 2.0 * C.xxx;
		  vec3 x3 = x0 - 1. + 3.0 * C.xxx;
		
		// Permutations
		  i = mod(i, 289.0 ); 
		  vec4 p = permute( permute( permute( 
		             i.z + vec4(0.0, i1.z, i2.z, 1.0 ))
		           + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) 
		           + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));
		
		// Gradients
		// ( N*N points uniformly over a square, mapped onto an octahedron.)
		  float n_ = 1.0/7.0; // N=7
		  vec3  ns = n_ * D.wyz - D.xzx;
		
		  vec4 j = p - 49.0 * floor(p * ns.z *ns.z);  //  mod(p,N*N)
		
		  vec4 x_ = floor(j * ns.z);
		  vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)
		
		  vec4 x = x_ *ns.x + ns.yyyy;
		  vec4 y = y_ *ns.x + ns.yyyy;
		  vec4 h = 1.0 - abs(x) - abs(y);
		
		  vec4 b0 = vec4( x.xy, y.xy );
		  vec4 b1 = vec4( x.zw, y.zw );
		
		  vec4 s0 = floor(b0)*2.0 + 1.0;
		  vec4 s1 = floor(b1)*2.0 + 1.0;
		  vec4 sh = -step(h, vec4(0.0));
		
		  vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;
		  vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;
		
		  vec3 p0 = vec3(a0.xy,h.x);
		  vec3 p1 = vec3(a0.zw,h.y);
		  vec3 p2 = vec3(a1.xy,h.z);
		  vec3 p3 = vec3(a1.zw,h.w);
		
		//Normalise gradients
		  vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));
		  p0 *= norm.x;
		  p1 *= norm.y;
		  p2 *= norm.z;
		  p3 *= norm.w;
		
		// Mix final noise value
		  vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
		  m = m * m;
		  return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1),dot(p2,x2), dot(p3,x3) ) );
		}
		
		vec3 hash3( vec2 p ){
		    vec3 q = vec3( dot(p,vec2(127.1,311.7)), 
						   dot(p,vec2(269.5,183.3)), 
						   dot(p,vec2(419.2,371.9)) );
			return fract(sin(q)*43758.5453);
		}
		vec4 hash4( vec3 p ){
		    vec4 q = vec4( dot(p,vec3(127.1,311.7,257.3)), 
						   dot(p,vec3(269.5,183.3,335.1)), 
						   dot(p,vec3(314.5,235.1,467.3)), 
						   dot(p,vec3(419.2,371.9,114.9)) );
			return fract(sin(q)*43758.5453);
		}
		
		float iqnoise( in vec2 x, float u, float v ){
		    vec2 p = floor(x);
		    vec2 f = fract(x);
			
			float k = 1.0+63.0*pow(1.0-v,4.0);
			
			float va = 0.0;
			float wt = 0.0;
		    for( int j=-2; j<=2; j++ )
		    for( int i=-2; i<=2; i++ )
		    {
		        vec2 g = vec2( float(i),float(j) );
				vec3 o = hash3( p + g )*vec3(u,u,1.0);
				vec2 r = g - f + o.xy;
				float d = dot(r,r);
				float ww = pow( 1.0-smoothstep(0.0,1.414,sqrt(d)), k );
				va += o.z*ww;
				wt += ww;
		    }
			
		    return va/wt;
		}
		`;function R(){this.addOutput("out","float")}R.title="Time",R.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=d(this,0);S.addUniform("u_time"+this.id,"float",function(){return getTime()*.001}),S.addCode("code","float "+A+" = u_time"+this.id+";",this.shader_destination),this.setOutputData(0,"float")}},f("input/time",R);function b(){this.addInput("in","T"),this.addOutput("out","float")}b.title="Dither",b.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=O(this,0),P="float",W=d(this,0),X=this.getInputData(0);A=E(A,X,"float"),S.addFunction("dither8x8",b.dither_func),S.addCode("code",P+" "+W+" = dither8x8("+A+");",this.shader_destination),this.setOutputData(0,P)}},b.dither_values=[.515625,.140625,.640625,.046875,.546875,.171875,.671875,.765625,.265625,.890625,.390625,.796875,.296875,.921875,.421875,.203125,.703125,.078125,.578125,.234375,.734375,.109375,.609375,.953125,.453125,.828125,.328125,.984375,.484375,.859375,.359375,.0625,.5625,.1875,.6875,.03125,.53125,.15625,.65625,.8125,.3125,.9375,.4375,.78125,.28125,.90625,.40625,.25,.75,.125,.625,.21875,.71875,.09375,.59375,1.0001,.5,.875,.375,.96875,.46875,.84375,.34375],b.dither_func=`
				float dither8x8(float brightness) {
				  vec2 position = vec2(0.0);
				  #ifdef FRAGMENT
					position = gl_FragCoord.xy;
				  #endif
				  int x = int(mod(position.x, 8.0));
				  int y = int(mod(position.y, 8.0));
				  int index = x + y * 8;
				  float limit = 0.0;
				  if (x < 8) {
					if(index==0) limit = 0.015625;
					`+b.dither_values.map(function(S,A){return"else if(index== "+(A+1)+") limit = "+S+";"}).join(`
`)+`
				  }
				  return brightness < limit ? 0.0 : 1.0;
				}
`,f("math/dither",b);function z(){this.addInput("",r.ALL_TYPES),this.addOutput("",""),this.properties={min_value:0,max_value:1,min_value2:0,max_value2:1},this.addWidget("number","min",0,{step:.1,property:"min_value"}),this.addWidget("number","max",1,{step:.1,property:"max_value"}),this.addWidget("number","min2",0,{step:.1,property:"min_value2"}),this.addWidget("number","max2",1,{step:.1,property:"max_value2"})}z.title="Remap",z.prototype.onPropertyChanged=function(){this.graph&&this.graph._version++},z.prototype.onConnectionsChange=function(){var S=this.getInputDataType(0);this.outputs[0].type=S||"T"},z.prototype.onGetCode=function(S){if(!(!this.shader_destination||!this.isOutputConnected(0))){var A=O(this,0),P=d(this,0);if(!(!A&&!P)){var W=this.getInputDataType(0);if(this.outputs[0].type=W,W=="T"){console.warn("node type is T and cannot be resolved");return}if(!A){S.addCode("code","	"+W+" "+P+" = "+W+`(0.0);
`);return}var X=g(this.properties.min_value),Z=g(this.properties.max_value),tt=g(this.properties.min_value2),et=g(this.properties.max_value2);S.addCode("code",W+" "+P+" = ( ("+A+" - "+X+") / ("+Z+" - "+X+") ) * ("+et+" - "+tt+") + "+tt+";",this.shader_destination),this.setOutputData(0,W)}}},f("math/remap",z)})(litegraph),(function(e){var t=e.LiteGraph,s=new Float32Array(16),r=new Float32Array(16),n=new Float32Array(16),u=new Float32Array(16),o={u_view:s,u_projection:r,u_viewprojection:n,u_model:u};t.LGraphRender={onRequestCameraMatrices:null};function a(){return Math.random()*1e5|0}function l(){this.addInput("obj",""),this.addInput("radius","number"),this.addOutput("out","geometry"),this.addOutput("points","[vec3]"),this.properties={radius:1,num_points:4096,generate_normals:!0,regular:!1,mode:l.SPHERE,force_update:!1},this.points=new Float32Array(this.properties.num_points*3),this.normals=new Float32Array(this.properties.num_points*3),this.must_update=!0,this.version=0;var _=this;this.addWidget("button","update",null,function(){_.must_update=!0}),this.geometry={vertices:null,_id:a()},this._old_obj=null,this._last_radius=null}e.LGraphPoints3D=l,l.RECTANGLE=1,l.CIRCLE=2,l.CUBE=10,l.SPHERE=11,l.HEMISPHERE=12,l.INSIDE_SPHERE=13,l.OBJECT=20,l.OBJECT_UNIFORMLY=21,l.OBJECT_INSIDE=22,l.MODE_VALUES={rectangle:l.RECTANGLE,circle:l.CIRCLE,cube:l.CUBE,sphere:l.SPHERE,hemisphere:l.HEMISPHERE,inside_sphere:l.INSIDE_SPHERE,object:l.OBJECT,object_uniformly:l.OBJECT_UNIFORMLY,object_inside:l.OBJECT_INSIDE},l.widgets_info={mode:{widget:"combo",values:l.MODE_VALUES}},l.title="list of points",l.desc="returns an array of points",l.prototype.onPropertyChanged=function(_,D){this.must_update=!0},l.prototype.onExecute=function(){var _=this.getInputData(0);(_!=this._old_obj||_&&_._version!=this._old_obj_version)&&(this._old_obj=_,this.must_update=!0);var D=this.getInputData(1);D==null&&(D=this.properties.radius),this._last_radius!=D&&(this._last_radius=D,this.must_update=!0),(this.must_update||this.properties.force_update)&&(this.must_update=!1,this.updatePoints()),this.geometry.vertices=this.points,this.geometry.normals=this.normals,this.geometry._version=this.version,this.setOutputData(0,this.geometry)},l.prototype.updatePoints=function(){var _=this.properties.num_points|0;_<1&&(_=1),(!this.points||this.points.length!=_*3)&&(this.points=new Float32Array(_*3)),this.properties.generate_normals?(!this.normals||this.normals.length!=this.points.length)&&(this.normals=new Float32Array(this.points.length)):this.normals=null;var D=this._last_radius||this.properties.radius,B=this.properties.mode,F=this.getInputData(0);this._old_obj_version=F?F._version:null,this.points=l.generatePoints(D,_,B,this.points,this.normals,this.properties.regular,F),this.version++},l.generatePoints=function(_,D,B,F,H,V,Y){var K=D*3;(!F||F.length!=K)&&(F=new Float32Array(K));var J=new Float32Array(3),C=new Float32Array([0,1,0]);if(V){if(B==l.RECTANGLE){for(var R=Math.floor(Math.sqrt(D)),b=0;b<R;++b)for(var z=0;z<R;++z){var S=b*3+z*3*R;F[S]=(b/R-.5)*_*2,F[S+1]=0,F[S+2]=(z/R-.5)*_*2}if(F=new Float32Array(F.subarray(0,R*R*3)),H)for(var b=0;b<H.length;b+=3)H.set(C,b)}else if(B==l.SPHERE){for(var R=Math.floor(Math.sqrt(D)),b=0;b<R;++b)for(var z=0;z<R;++z){var S=b*3+z*3*R;polarToCartesian(J,b/R*2*Math.PI,(z/R-.5)*2*Math.PI,_),F[S]=J[0],F[S+1]=J[1],F[S+2]=J[2]}F=new Float32Array(F.subarray(0,R*R*3)),H&&l.generateSphericalNormals(F,H)}else if(B==l.CIRCLE){for(var b=0;b<K;b+=3){var A=2*Math.PI*(b/K);F[b]=Math.cos(A)*_,F[b+1]=0,F[b+2]=Math.sin(A)*_}if(H)for(var b=0;b<H.length;b+=3)H.set(C,b)}}else if(B==l.RECTANGLE){for(var b=0;b<K;b+=3)F[b]=(Math.random()-.5)*_*2,F[b+1]=0,F[b+2]=(Math.random()-.5)*_*2;if(H)for(var b=0;b<H.length;b+=3)H.set(C,b)}else if(B==l.CUBE){for(var b=0;b<K;b+=3)F[b]=(Math.random()-.5)*_*2,F[b+1]=(Math.random()-.5)*_*2,F[b+2]=(Math.random()-.5)*_*2;if(H)for(var b=0;b<H.length;b+=3)H.set(C,b)}else B==l.SPHERE?(l.generateSphere(F,K,_),H&&l.generateSphericalNormals(F,H)):B==l.HEMISPHERE?(l.generateHemisphere(F,K,_),H&&l.generateSphericalNormals(F,H)):B==l.CIRCLE?(l.generateInsideCircle(F,K,_),H&&l.generateSphericalNormals(F,H)):B==l.INSIDE_SPHERE?(l.generateInsideSphere(F,K,_),H&&l.generateSphericalNormals(F,H)):B==l.OBJECT?l.generateFromObject(F,H,K,Y,!1):B==l.OBJECT_UNIFORMLY?l.generateFromObject(F,H,K,Y,!0):B==l.OBJECT_INSIDE?l.generateFromInsideObject(F,K,Y):console.warn("wrong mode in LGraphPoints3D");return F},l.generateSphericalNormals=function(_,D){for(var B=new Float32Array(3),F=0;F<D.length;F+=3)B[0]=_[F],B[1]=_[F+1],B[2]=_[F+2],vec3.normalize(B,B),D.set(B,F)},l.generateSphere=function(_,D,B){for(var F=0;F<D;F+=3){var H=Math.random(),V=Math.random(),Y=2*Math.cos(2*Math.PI*H)*Math.sqrt(V*(1-V)),K=1-2*V,J=2*Math.sin(2*Math.PI*H)*Math.sqrt(V*(1-V));_[F]=Y*B,_[F+1]=K*B,_[F+2]=J*B}},l.generateHemisphere=function(_,D,B){for(var F=0;F<D;F+=3){var H=Math.random(),V=Math.random(),Y=Math.cos(2*Math.PI*H)*Math.sqrt(1-V*V),K=V,J=Math.sin(2*Math.PI*H)*Math.sqrt(1-V*V);_[F]=Y*B,_[F+1]=K*B,_[F+2]=J*B}},l.generateInsideCircle=function(_,D,B){for(var F=0;F<D;F+=3){var H=Math.random(),V=Math.random(),Y=Math.cos(2*Math.PI*H)*Math.sqrt(1-V*V),K=Math.sin(2*Math.PI*H)*Math.sqrt(1-V*V);_[F]=Y*B,_[F+1]=0,_[F+2]=K*B}},l.generateInsideSphere=function(_,D,B){for(var F=0;F<D;F+=3){var H=Math.random(),V=Math.random(),Y=H*2*Math.PI,K=Math.acos(2*V-1),J=Math.cbrt(Math.random())*B,C=Math.sin(Y),R=Math.cos(Y),b=Math.sin(K),z=Math.cos(K);_[F]=J*b*R,_[F+1]=J*b*C,_[F+2]=J*z}};function f(_,D){var B=_.length,F=0,H=0,V=B;if(B==0)return-1;if(B==1)return 0;for(;V>=F;){H=(V+F)*.5|0;var Y=_[H];if(Y==D)return H;if(F==V-1)return F;Y<D?F=H:V=H}return H}l.generateFromObject=function(_,D,B,F,H){if(F){var V=null,Y=null,K=null,J=null;if(F.constructor===GL.Mesh&&(V=F.vertexBuffers.vertices.data,Y=F.vertexBuffers.normals?F.vertexBuffers.normals.data:null,K=F.indexBuffers.indices?F.indexBuffers.indices.data:null,K||(K=F.indexBuffers.triangles?F.indexBuffers.triangles.data:null)),!V)return null;var C=K?K.length/3:V.length/9,R=0;if(H){J=new Float32Array(C);for(var b=0;b<C;++b){K?(it=K[b*3]*3,c=K[b*3+1]*3,G=K[b*3+2]*3):(it=b*9,c=b*9+3,G=b*9+6);var z=V.subarray(it,it+3),S=V.subarray(c,c+3),A=V.subarray(G,G+3),P=vec3.distance(z,S),W=vec3.distance(S,A),X=vec3.distance(A,z),Z=(P+W+X)/2;R+=Math.sqrt(Z*(Z-P)*(Z-W)*(Z-X)),J[b]=R}for(var b=0;b<C;++b)J[b]/=R}for(var b=0;b<B;b+=3){var tt=Math.random(),et=H?f(J,tt):Math.floor(tt*C),it=0,c=0,G=0;K?(it=K[et*3]*3,c=K[et*3+1]*3,G=K[et*3+2]*3):(it=et*9,c=et*9+3,G=et*9+6);var Z=Math.random(),M=Math.random(),U=Math.sqrt(Z),q=1-U,j=U*(1-M),Q=M*U;if(_[b]=q*V[it]+j*V[c]+Q*V[G],_[b+1]=q*V[it+1]+j*V[c+1]+Q*V[G+1],_[b+2]=q*V[it+2]+j*V[c+2]+Q*V[G+2],D&&Y){D[b]=q*Y[it]+j*Y[c]+Q*Y[G],D[b+1]=q*Y[it+1]+j*Y[c+1]+Q*Y[G+1],D[b+2]=q*Y[it+2]+j*Y[c+2]+Q*Y[G+2];var $=D.subarray(b,b+3);vec3.normalize($,$)}}}},l.generateFromInsideObject=function(_,D,B){if(!(!B||B.constructor!==GL.Mesh)){var F=B.getBoundingBox();B.octree||(B.octree=new GL.Octree(B));for(var H=B.octree,V=vec3.create(),Y=vec3.fromValues(1,0,0),K=vec3.create(),J=0,C=0;J<D&&C<_.length*10;){C+=1;var R=vec3.random(K);R[0]=(R[0]*2-1)*F[3]+F[0],R[1]=(R[1]*2-1)*F[4]+F[1],R[2]=(R[2]*2-1)*F[5]+F[2],V.set(R);var b=H.testRay(V,Y,0,1e4,!0,GL.Octree.ALL);!b||b.length%2==0||(_.set(R,J),J+=3)}}},t.registerNodeType("geometry/points3D",l);function m(){this.addInput("points","geometry"),this.addOutput("instances","[mat4]"),this.properties={mode:1,autoupdate:!0},this.must_update=!0,this.matrices=[],this.first_time=!0}m.NORMAL=0,m.VERTICAL=1,m.SPHERICAL=2,m.RANDOM=3,m.RANDOM_VERTICAL=4,m.modes={normal:0,vertical:1,spherical:2,random:3,random_vertical:4},m.widgets_info={mode:{widget:"combo",values:m.modes}},m.title="points to inst",m.prototype.onExecute=function(){var _=this.getInputData(0);if(!_){this.setOutputData(0,null);return}if(this.isOutputConnected(0)){var D=_._version!=this._version||_._id!=this._geometry_id;(D&&this.properties.autoupdate||this.first_time)&&(this.first_time=!1,this.updateInstances(_)),this.setOutputData(0,this.matrices)}},m.prototype.updateInstances=function(_){var D=_.vertices;if(!D)return null;var B=_.normals,F=this.matrices,H=D.length/3;F.length!=H&&(F.length=H);var V=mat4.create(),Y=vec3.create();vec3.create();var K=vec3.fromValues(0,1,0),J=vec3.fromValues(0,0,-1);vec3.fromValues(1,0,0);for(var C=quat.create(),R=vec3.create(),b=vec3.create(),z=vec3.create(),S=0;S<D.length;S+=3){var A=S/3,P=F[A];P||(P=F[A]=mat4.create()),P.set(V);var W=D.subarray(S,S+3);switch(this.properties.mode){case m.NORMAL:if(mat4.setTranslation(P,W),B){var X=B.subarray(S,S+3);z.set(X),vec3.normalize(z,z),vec3.cross(b,J,z),vec3.normalize(b,b),vec3.cross(R,b,z),vec3.normalize(R,R),P.set(b,0),P.set(z,4),P.set(R,8),mat4.setTranslation(P,W)}break;case m.VERTICAL:mat4.setTranslation(P,W);break;case m.SPHERICAL:R.set(W),vec3.normalize(R,R),vec3.cross(b,K,R),vec3.normalize(b,b),vec3.cross(z,R,b),vec3.normalize(z,z),P.set(b,0),P.set(z,4),P.set(R,8),mat4.setTranslation(P,W);break;case m.RANDOM:Y[0]=Math.random()*2-1,Y[1]=Math.random()*2-1,Y[2]=Math.random()*2-1,vec3.normalize(Y,Y),quat.setAxisAngle(C,Y,Math.random()*2*Math.PI),mat4.fromQuat(P,C),mat4.setTranslation(P,W);break;case m.RANDOM_VERTICAL:quat.setAxisAngle(C,K,Math.random()*2*Math.PI),mat4.fromQuat(P,C),mat4.setTranslation(P,W);break}}this._version=_._version,this._geometry_id=_._id},t.registerNodeType("geometry/points_to_instances",m);function O(){this.addInput("in","geometry,[mat4]"),this.addInput("mat4","mat4"),this.addOutput("out","geometry"),this.properties={},this.geometry={type:"triangles",vertices:null,_id:a(),_version:0},this._last_geometry_id=-1,this._last_version=-1,this._last_key="",this.must_update=!0}O.title="Transform",O.prototype.onExecute=function(){var _=this.getInputData(0),D=this.getInputData(1);if(_){if(_.constructor===Array){if(_.length==0||(this.outputs[0].type="[mat4]",!this.isOutputConnected(0)))return;if(!D){this.setOutputData(0,_);return}this._output||(this._output=new Array),this._output.length!=_.length&&(this._output.length=_.length);for(var B=0;B<_.length;++B){var F=this._output[B];F||(F=this._output[B]=mat4.create()),mat4.multiply(F,_[B],D)}this.setOutputData(0,this._output);return}if(!(!_.vertices||!_.vertices.length)){var H=_;if(this.outputs[0].type="geometry",!!this.isOutputConnected(0)){if(!D){this.setOutputData(0,H);return}var V=typedArrayToArray(D).join(",");(this.must_update||H._id!=this._last_geometry_id||H._version!=this._last_version||V!=this._last_key)&&(this.updateGeometry(H,D),this._last_key=V,this._last_version=H._version,this._last_geometry_id=H._id,this.must_update=!1),this.setOutputData(0,this.geometry)}}}},O.prototype.updateGeometry=function(_,D){var B=_.vertices,F=this.geometry.vertices;(!F||F.length!=B.length)&&(F=this.geometry.vertices=new Float32Array(B.length));for(var H=vec3.create(),V=0,Y=F.length;V<Y;V+=3)H[0]=B[V],H[1]=B[V+1],H[2]=B[V+2],mat4.multiplyVec3(H,D,H),F[V]=H[0],F[V+1]=H[1],F[V+2]=H[2];if(_.normals){(!this.geometry.normals||this.geometry.normals.length!=_.normals.length)&&(this.geometry.normals=new Float32Array(_.normals.length));var K=this.geometry.normals,J=mat4.invert(mat4.create(),D);J&&mat4.transpose(J,J);for(var C=_.normals,V=0,Y=K.length;V<Y;V+=3)H[0]=C[V],H[1]=C[V+1],H[2]=C[V+2],mat4.multiplyVec3(H,J,H),K[V]=H[0],K[V+1]=H[1],K[V+2]=H[2]}this.geometry.type=_.type,this.geometry._version++},t.registerNodeType("geometry/transform",O);function d(){this.addInput("sides","number"),this.addInput("radius","number"),this.addOutput("out","geometry"),this.properties={sides:6,radius:1,uvs:!1},this.geometry={type:"line_loop",vertices:null,_id:a()},this.geometry_id=-1,this.version=-1,this.must_update=!0,this.last_info={sides:-1,radius:-1}}d.title="Polygon",d.prototype.onExecute=function(){if(this.isOutputConnected(0)){var _=this.getInputOrProperty("sides"),D=this.getInputOrProperty("radius");_=Math.max(3,_)|0,(this.last_info.sides!=_||this.last_info.radius!=D)&&this.updateGeometry(_,D),this.setOutputData(0,this.geometry)}},d.prototype.updateGeometry=function(_,D){var B=3*_,F=this.geometry.vertices;(!F||F.length!=B)&&(F=this.geometry.vertices=new Float32Array(3*_));var H=Math.PI*2/_,V=this.properties.uvs;V&&(uvs=this.geometry.coords=new Float32Array(3*_));for(var Y=0;Y<_;++Y){var K=H*-Y,J=Math.cos(K)*D,C=0,R=Math.sin(K)*D;F[Y*3]=J,F[Y*3+1]=C,F[Y*3+2]=R}this.geometry._id=++this.geometry_id,this.geometry._version=++this.version,this.last_info.sides=_,this.last_info.radius=D},t.registerNodeType("geometry/polygon",d);function g(){this.addInput("","geometry"),this.addOutput("","geometry"),this.properties={top_cap:!0,bottom_cap:!0,offset:[0,100,0]},this.version=-1,this._last_geo_version=-1,this._must_update=!0}g.title="extrude",g.prototype.onPropertyChanged=function(_,D){this._must_update=!0},g.prototype.onExecute=function(){var _=this.getInputData(0);!_||!this.isOutputConnected(0)||((_.version!=this._last_geo_version||this._must_update)&&(this._geo=this.extrudeGeometry(_,this._geo),this._geo&&(this._geo.version=this.version++),this._must_update=!1),this.setOutputData(0,this._geo))},g.prototype.extrudeGeometry=function(_){var D=_.vertices,B=D.length/3,F=vec3.create(),H=vec3.create(),V=vec3.create(),Y=vec3.create(),K=new Float32Array(this.properties.offset);if(_.type=="line_loop")for(var J=new Float32Array(B*6*3),C=0,R=0,b=D.length;R<b;R+=3)F[0]=D[R],F[1]=D[R+1],F[2]=D[R+2],R+3<b?(H[0]=D[R+3],H[1]=D[R+4],H[2]=D[R+5]):(H[0]=D[0],H[1]=D[1],H[2]=D[2]),vec3.add(V,F,K),vec3.add(Y,H,K),J.set(F,C),C+=3,J.set(H,C),C+=3,J.set(V,C),C+=3,J.set(H,C),C+=3,J.set(Y,C),C+=3,J.set(V,C),C+=3;var z={_id:a(),type:"triangles",vertices:J};return z},t.registerNodeType("geometry/extrude",g);function E(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={code:"V[1] += 0.01 * Math.sin(I + T*0.001);",execute_every_frame:!1},this.geometry=null,this.geometry_id=-1,this.version=-1,this.must_update=!0,this.vertices=null,this.func=null}E.title="geoeval",E.desc="eval code",E.widgets_info={code:{widget:"code"}},E.prototype.onConfigure=function(_){this.compileCode()},E.prototype.compileCode=function(){if(this.properties.code)try{this.func=new Function("V","I","T",this.properties.code),this.boxcolor="#AFA",this.must_update=!0}catch{this.boxcolor="red"}},E.prototype.onPropertyChanged=function(_,D){_=="code"&&(this.properties.code=D,this.compileCode())},E.prototype.onExecute=function(){var _=this.getInputData(0);if(_){if(!this.func){this.setOutputData(0,_);return}if(this.geometry_id!=_._id||this.version!=_._version||this.must_update||this.properties.execute_every_frame){this.must_update=!1,this.geometry_id=_._id,this.properties.execute_every_frame?this.version++:this.version=_._version;var D=this.func,B=getTime();this.geometry||(this.geometry={});for(var F in _)_[F]!=null&&(_[F].constructor==Float32Array?this.geometry[F]=new Float32Array(_[F]):this.geometry[F]=_[F]);this.geometry._id=_._id,this.properties.execute_every_frame?this.geometry._version=this.version:this.geometry._version=_._version+1;var H=vec3.create(),V=this.vertices;!V||this.vertices.length!=_.vertices.length?V=this.vertices=new Float32Array(_.vertices):V.set(_.vertices);for(var F=0;F<V.length;F+=3)H[0]=V[F],H[1]=V[F+1],H[2]=V[F+2],D(H,F/3,B),V[F]=H[0],V[F+1]=H[1],V[F+2]=H[2];this.geometry.vertices=V}this.setOutputData(0,this.geometry)}},t.registerNodeType("geometry/eval",E);function I(){this.addInput("in","geometry"),this.addOutput("out","geometry"),this.properties={min_dist:.4,max_dist:.5,max_connections:0,probability:1},this.geometry_id=-1,this.version=-1,this.my_version=1,this.must_update=!0}if(I.title="connect points",I.desc="adds indices between near points",I.prototype.onPropertyChanged=function(_,D){this.must_update=!0},I.prototype.onExecute=function(){var _=this.getInputData(0);if(_){if(this.geometry_id!=_._id||this.version!=_._version||this.must_update){this.must_update=!1,this.geometry_id=_._id,this.version=_._version,this.geometry={};for(var D in _)this.geometry[D]=_[D];this.geometry._id=a(),this.geometry._version=this.my_version++;for(var B=_.vertices,F=B.length,H=this.properties.min_dist,V=this.properties.max_dist,Y=this.properties.probability,K=this.properties.max_connections,J=[],D=0;D<F;D+=3)for(var C=B[D],R=B[D+1],b=B[D+2],z=0,S=D+3;S<F;S+=3){var A=B[S],P=B[S+1],W=B[S+2],X=Math.sqrt((C-A)*(C-A)+(R-P)*(R-P)+(b-W)*(b-W));if(!(X>V||X<H||Y<1&&Y<Math.random())&&(J.push(D/3,S/3),z+=1,K&&z>K))break}this.geometry.indices=this.indices=new Uint32Array(J)}this.indices&&this.indices.length?(this.geometry.indices=this.indices,this.setOutputData(0,this.geometry)):this.setOutputData(0,null)}},t.registerNodeType("geometry/connectPoints",I),typeof GL>"u")return;function k(){this.addInput("mesh","mesh"),this.addOutput("out","geometry"),this.geometry={},this.last_mesh=null}k.title="to geometry",k.desc="converts a mesh to geometry",k.prototype.onExecute=function(){var _=this.getInputData(0);if(_){if(_!=this.last_mesh){this.last_mesh=_;for(i in _.vertexBuffers){var D=_.vertexBuffers[i];this.geometry[i]=D.data}_.indexBuffers.triangles&&(this.geometry.indices=_.indexBuffers.triangles.data),this.geometry._id=a(),this.geometry._version=0}this.setOutputData(0,this.geometry),this.geometry&&this.setOutputData(1,this.geometry.vertices)}},t.registerNodeType("geometry/toGeometry",k);function N(){this.addInput("in","geometry"),this.addOutput("mesh","mesh"),this.properties={},this.version=-1,this.mesh=null}N.title="Geo to Mesh",N.prototype.updateMesh=function(_){this.mesh||(this.mesh=new GL.Mesh);for(var D in _)if(D[0]!="_"){var B=_[D],F=GL.Mesh.common_buffers[D];if(!(!F&&D!="indices")){var H=F?F.spacing:3,V=this.mesh.vertexBuffers[D];!V||V.data.length!=B.length?V=new GL.Buffer(D=="indices"?GL.ELEMENT_ARRAY_BUFFER:GL.ARRAY_BUFFER,B,H,GL.DYNAMIC_DRAW):(V.data.set(B),V.upload(GL.DYNAMIC_DRAW)),this.mesh.addBuffer(D,V)}}if(this.mesh.vertexBuffers.normals&&this.mesh.vertexBuffers.normals.data.length!=this.mesh.vertexBuffers.vertices.data.length){for(var Y=new Float32Array([0,1,0]),K=new Float32Array(this.mesh.vertexBuffers.vertices.data.length),D=0;D<K.length;D+=3)K.set(Y,D);V=new GL.Buffer(GL.ARRAY_BUFFER,K,3),this.mesh.addBuffer("normals",V)}return this.mesh.updateBoundingBox(),this.geometry_id=this.mesh.id=_._id,this.version=this.mesh.version=_._version,this.mesh},N.prototype.onExecute=function(){var _=this.getInputData(0);_&&((this.version!=_._version||this.geometry_id!=_._id)&&this.updateMesh(_),this.setOutputData(0,this.mesh))},t.registerNodeType("geometry/toMesh",N);function T(){this.addInput("mesh","mesh"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,primitive:GL.TRIANGLES,additive:!1,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.model_matrix=mat4.create(),this.uniforms={u_color:this.color,u_model:this.model_matrix}}T.title="Render Mesh",T.desc="renders a mesh flat",T.PRIMITIVE_VALUES={points:GL.POINTS,lines:GL.LINES,line_loop:GL.LINE_LOOP,line_strip:GL.LINE_STRIP,triangles:GL.TRIANGLES,triangle_fan:GL.TRIANGLE_FAN,triangle_strip:GL.TRIANGLE_STRIP},T.widgets_info={primitive:{widget:"combo",values:T.PRIMITIVE_VALUES},color:{widget:"color"}},T.prototype.onExecute=function(){if(this.properties.enabled){var _=this.getInputData(0);if(_){if(!t.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}t.LGraphRender.onRequestCameraMatrices(s,r,n);var D=null,B=this.getInputData(2);B?(D=gl.shaders.textured,D||(D=gl.shaders.textured=new GL.Shader(L.vertex_shader_code,L.fragment_shader_code,{USE_TEXTURE:""}))):(D=gl.shaders.flat,D||(D=gl.shaders.flat=new GL.Shader(L.vertex_shader_code,L.fragment_shader_code))),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var F=this.model_matrix,H=this.getInputData(1);H?F.set(H):mat4.identity(F),this.uniforms.u_point_size=1;var V=this.properties.primitive;D.uniforms(o),D.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);var Y="indices";_.indexBuffers.triangles&&(Y="triangles"),D.draw(_,V,Y),gl.disable(gl.BLEND),gl.depthMask(!0)}}},t.registerNodeType("geometry/render_mesh",T);function h(){this.addInput("size","number"),this.addOutput("out","mesh"),this.properties={type:1,size:1,subdivisions:32},this.version=Math.random()*1e5|0,this.last_info={type:-1,size:-1,subdivisions:-1}}h.title="Primitive",h.VALID={CUBE:1,PLANE:2,CYLINDER:3,SPHERE:4,CIRCLE:5,HEMISPHERE:6,ICOSAHEDRON:7,CONE:8,QUAD:9},h.widgets_info={type:{widget:"combo",values:h.VALID}},h.prototype.onExecute=function(){if(this.isOutputConnected(0)){var _=this.getInputOrProperty("size");(this.last_info.type!=this.properties.type||this.last_info.size!=_||this.last_info.subdivisions!=this.properties.subdivisions)&&this.updateMesh(this.properties.type,_,this.properties.subdivisions),this.setOutputData(0,this._mesh)}},h.prototype.updateMesh=function(_,D,B){switch(B=Math.max(0,B)|0,_){case 1:this._mesh=GL.Mesh.cube({size:D,normals:!0,coords:!0});break;case 2:this._mesh=GL.Mesh.plane({size:D,xz:!0,detail:B,normals:!0,coords:!0});break;case 3:this._mesh=GL.Mesh.cylinder({size:D,subdivisions:B,normals:!0,coords:!0});break;case 4:this._mesh=GL.Mesh.sphere({size:D,long:B,lat:B,normals:!0,coords:!0});break;case 5:this._mesh=GL.Mesh.circle({size:D,slices:B,normals:!0,coords:!0});break;case 6:this._mesh=GL.Mesh.sphere({size:D,long:B,lat:B,normals:!0,coords:!0,hemi:!0});break;case 7:this._mesh=GL.Mesh.icosahedron({size:D,subdivisions:B});break;case 8:this._mesh=GL.Mesh.cone({radius:D,height:D,subdivisions:B});break;case 9:this._mesh=GL.Mesh.plane({size:D,xz:!1,detail:B,normals:!0,coords:!0});break}this.last_info.type=_,this.last_info.size=D,this.last_info.subdivisions=B,this._mesh.version=this.version++},t.registerNodeType("geometry/mesh_primitive",h);function L(){this.addInput("in","geometry"),this.addInput("mat4","mat4"),this.addInput("tex","texture"),this.properties={enabled:!0,point_size:.1,fixed_size:!1,additive:!0,color:[1,1,1],opacity:1},this.color=vec4.create([1,1,1,1]),this.uniforms={u_point_size:1,u_perspective:1,u_point_perspective:1,u_color:this.color},this.geometry_id=-1,this.version=-1,this.mesh=null}L.title="renderPoints",L.desc="render points with a texture",L.widgets_info={color:{widget:"color"}},L.prototype.updateMesh=function(_){this.buffer,!this.buffer||!this.buffer.data||this.buffer.data.length!=_.vertices.length?this.buffer=new GL.Buffer(GL.ARRAY_BUFFER,_.vertices,3,GL.DYNAMIC_DRAW):(this.buffer.data.set(_.vertices),this.buffer.upload(GL.DYNAMIC_DRAW)),this.mesh||(this.mesh=new GL.Mesh),this.mesh.addBuffer("vertices",this.buffer),this.geometry_id=this.mesh.id=_._id,this.version=this.mesh.version=_._version},L.prototype.onExecute=function(){if(this.properties.enabled){var _=this.getInputData(0);if(_){if((this.version!=_._version||this.geometry_id!=_._id)&&this.updateMesh(_),!t.LGraphRender.onRequestCameraMatrices){console.warn("cannot render geometry, LiteGraph.onRequestCameraMatrices is null, remember to fill this with a callback(view_matrix, projection_matrix,viewprojection_matrix) to use 3D rendering from the graph");return}t.LGraphRender.onRequestCameraMatrices(s,r,n);var D=null,B=this.getInputData(2);B?(D=gl.shaders.textured_points,D||(D=gl.shaders.textured_points=new GL.Shader(L.vertex_shader_code,L.fragment_shader_code,{USE_TEXTURED_POINTS:""}))):(D=gl.shaders.points,D||(D=gl.shaders.points=new GL.Shader(L.vertex_shader_code,L.fragment_shader_code,{USE_POINTS:""}))),this.color.set(this.properties.color),this.color[3]=this.properties.opacity;var F=this.getInputData(1);F?u.set(F):mat4.identity(u),this.uniforms.u_point_size=this.properties.point_size,this.uniforms.u_point_perspective=this.properties.fixed_size?0:1,this.uniforms.u_perspective=gl.viewport_data[3]*r[5],D.uniforms(o),D.uniforms(this.uniforms),this.properties.opacity>=1?gl.disable(gl.BLEND):gl.enable(gl.BLEND),gl.enable(gl.DEPTH_TEST),this.properties.additive?(gl.blendFunc(gl.SRC_ALPHA,gl.ONE),gl.depthMask(!1)):gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA),D.draw(this.mesh,GL.POINTS),gl.disable(gl.BLEND),gl.depthMask(!0)}}},t.registerNodeType("geometry/render_points",L),L.vertex_shader_code=`				precision mediump float;
				attribute vec3 a_vertex;
				varying vec3 v_vertex;
				attribute vec3 a_normal;
				varying vec3 v_normal;
				#ifdef USE_COLOR
					attribute vec4 a_color;
					varying vec4 v_color;
				#endif
				attribute vec2 a_coord;
				varying vec2 v_coord;
				#ifdef USE_SIZE
					attribute float a_extra;
				#endif
				#ifdef USE_INSTANCING
					attribute mat4 u_model;
				#else
					uniform mat4 u_model;
				#endif
				uniform mat4 u_viewprojection;
				uniform float u_point_size;
				uniform float u_perspective;
				uniform float u_point_perspective;
				float computePointSize(float radius, float w)
				{
					if(radius < 0.0)
						return -radius;
					return u_perspective * radius / w;
				}
				void main() {
					v_coord = a_coord;
					#ifdef USE_COLOR
						v_color = a_color;
					#endif
					v_vertex = ( u_model * vec4( a_vertex, 1.0 )).xyz;
					v_normal = ( u_model * vec4( a_normal, 0.0 )).xyz;
					gl_Position = u_viewprojection * vec4(v_vertex,1.0);
					gl_PointSize = u_point_size;
					#ifdef USE_SIZE
						gl_PointSize = a_extra;
					#endif
					if(u_point_perspective != 0.0)
						gl_PointSize = computePointSize( gl_PointSize, gl_Position.w );
				}			`,L.fragment_shader_code=`				precision mediump float;
				uniform vec4 u_color;
				#ifdef USE_COLOR
					varying vec4 v_color;
				#endif
				varying vec2 v_coord;
				uniform sampler2D u_texture;
				void main() {
					vec4 color = u_color;
					#ifdef USE_TEXTURED_POINTS
						color *= texture2D(u_texture, gl_PointCoord.xy);
					#else
						#ifdef USE_TEXTURE
						  color *= texture2D(u_texture, v_coord);
						  if(color.a < 0.1)
							discard;
						#endif
						#ifdef USE_POINTS
							float dist = length( gl_PointCoord.xy - vec2(0.5) );
							if( dist > 0.45 )
								discard;
						#endif
					#endif
					#ifdef USE_COLOR
						color *= v_color;
					#endif
					gl_FragColor = color;
				}			`})(litegraph),(function(e){var t=e.LiteGraph,s=e.LGraphTexture;if(typeof GL<"u"){let a=function(){this.addInput("Texture","Texture"),this.addInput("Aberration","number"),this.addInput("Distortion","number"),this.addInput("Blur","number"),this.addOutput("Texture","Texture"),this.properties={aberration:1,distortion:1,blur:1,precision:s.DEFAULT},a._shader||(a._shader=new GL.Shader(GL.Shader.SCREEN_VERTEX_SHADER,a.pixel_shader),a._texture=new GL.Texture(3,1,{format:gl.RGB,wrap:gl.CLAMP_TO_EDGE,magFilter:gl.LINEAR,minFilter:gl.LINEAR,pixel_data:[255,0,0,0,255,0,0,0,255]}))},l=function(){this.addInput("Texture","Texture"),this.addInput("Blurred","Texture"),this.addInput("Mask","Texture"),this.addInput("Threshold","number"),this.addOutput("Texture","Texture"),this.properties={shape:"",size:10,alpha:1,threshold:1,high_precision:!1}},f=function(){this.addInput("Texture","Texture"),this.addInput("value1","number"),this.addInput("value2","number"),this.addOutput("Texture","Texture"),this.properties={fx:"halftone",value1:1,value2:1,precision:s.DEFAULT}},m=function(){this.addInput("Tex.","Texture"),this.addInput("intensity","number"),this.addOutput("Texture","Texture"),this.properties={intensity:1,invert:!1,precision:s.DEFAULT},m._shader||(m._shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,m.pixel_shader))};var r=a,n=l,u=f,o=m;a.title="Lens",a.desc="Camera Lens distortion",a.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},a.prototype.onExecute=function(){var O=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,O);return}if(O){this._tex=s.getTargetTexture(O,this._tex,this.properties.precision);var d=this.properties.aberration;this.isInputConnected(1)&&(d=this.getInputData(1),this.properties.aberration=d);var g=this.properties.distortion;this.isInputConnected(2)&&(g=this.getInputData(2),this.properties.distortion=g);var E=this.properties.blur;this.isInputConnected(3)&&(E=this.getInputData(3),this.properties.blur=E),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var I=Mesh.getScreenQuad(),k=a._shader;this._tex.drawTo(function(){O.bind(0),k.uniforms({u_texture:0,u_aberration:d,u_distortion:g,u_blur:E}).draw(I)}),this.setOutputData(0,this._tex)}},a.pixel_shader=`precision highp float;
					precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform vec2 u_camera_planes;
					uniform float u_aberration;
					uniform float u_distortion;
					uniform float u_blur;
					
					void main() {
						vec2 coord = v_coord;
						float dist = distance(vec2(0.5), coord);
						vec2 dist_coord = coord - vec2(0.5);
						float percent = 1.0 + ((0.5 - dist) / 0.5) * u_distortion;
						dist_coord *= percent;
						coord = dist_coord + vec2(0.5);
						vec4 color = texture2D(u_texture,coord, u_blur * dist);
						color.r = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0+0.01*u_aberration), u_blur * dist ).r;
						color.b = texture2D(u_texture,vec2(0.5) + dist_coord * (1.0-0.01*u_aberration), u_blur * dist ).b;
						gl_FragColor = color;
					}
					`,t.registerNodeType("fx/lens",a),e.LGraphFXLens=a,l.title="Bokeh",l.desc="applies an Bokeh effect",l.widgets_info={shape:{widget:"texture"}},l.prototype.onExecute=function(){var O=this.getInputData(0),d=this.getInputData(1),g=this.getInputData(2);if(!O||!g||!this.properties.shape){this.setOutputData(0,O);return}d||(d=O);var E=s.getTexture(this.properties.shape);if(E){var I=this.properties.threshold;this.isInputConnected(3)&&(I=this.getInputData(3),this.properties.threshold=I);var k=gl.UNSIGNED_BYTE;this.properties.high_precision&&(k=gl.half_float_ext?gl.HALF_FLOAT_OES:gl.FLOAT),(!this._temp_texture||this._temp_texture.type!=k||this._temp_texture.width!=O.width||this._temp_texture.height!=O.height)&&(this._temp_texture=new GL.Texture(O.width,O.height,{type:k,format:gl.RGBA,filter:gl.LINEAR})),this.properties.size;var N=l._first_shader;N||(N=l._first_shader=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,l._first_pixel_shader));var T=l._second_shader;T||(T=l._second_shader=new GL.Shader(l._second_vertex_shader,l._second_pixel_shader));var h=this._points_mesh;(!h||h._width!=O.width||h._height!=O.height||h._spacing!=2)&&(h=this.createPointsMesh(O.width,O.height,2));var L=Mesh.getScreenQuad(),_=this.properties.size;this.properties.min_light;var D=this.properties.alpha;gl.disable(gl.DEPTH_TEST),gl.disable(gl.BLEND),this._temp_texture.drawTo(function(){O.bind(0),d.bind(1),g.bind(2),N.uniforms({u_texture:0,u_texture_blur:1,u_mask:2,u_texsize:[O.width,O.height]}).draw(L)}),this._temp_texture.drawTo(function(){gl.enable(gl.BLEND),gl.blendFunc(gl.ONE,gl.ONE),O.bind(0),E.bind(3),T.uniforms({u_texture:0,u_mask:2,u_shape:3,u_alpha:D,u_threshold:I,u_pointSize:_,u_itexsize:[1/O.width,1/O.height]}).draw(h,gl.POINTS)}),this.setOutputData(0,this._temp_texture)}},l.prototype.createPointsMesh=function(O,d,g){for(var E=Math.round(O/g),I=Math.round(d/g),k=new Float32Array(E*I*2),N=-1,T=2/O*g,h=2/d*g,L=0;L<I;++L){for(var _=-1,D=0;D<E;++D){var B=L*E*2+D*2;k[B]=_,k[B+1]=N,_+=T}N+=h}return this._points_mesh=GL.Mesh.load({vertices2D:k}),this._points_mesh._width=O,this._points_mesh._height=d,this._points_mesh._spacing=g,this._points_mesh},l._first_pixel_shader=`precision highp float;
					precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform sampler2D u_texture_blur;
					uniform sampler2D u_mask;
					
					void main() {
						vec4 color = texture2D(u_texture, v_coord);
						vec4 blurred_color = texture2D(u_texture_blur, v_coord);
						float mask = texture2D(u_mask, v_coord).x;
					   gl_FragColor = mix(color, blurred_color, mask);
					}
					`,l._second_vertex_shader=`precision highp float;
					attribute vec2 a_vertex2D;
					varying vec4 v_color;
					uniform sampler2D u_texture;
					uniform sampler2D u_mask;
					uniform vec2 u_itexsize;
					uniform float u_pointSize;
					uniform float u_threshold;
					void main() {
						vec2 coord = a_vertex2D * 0.5 + 0.5;
						v_color = texture2D( u_texture, coord );
						v_color += texture2D( u_texture, coord + vec2(u_itexsize.x, 0.0) );
						v_color += texture2D( u_texture, coord + vec2(0.0, u_itexsize.y));
						v_color += texture2D( u_texture, coord + u_itexsize);
						v_color *= 0.25;
						float mask = texture2D(u_mask, coord).x;
						float luminance = length(v_color) * mask;
						/*luminance /= (u_pointSize*u_pointSize)*0.01 */;
						luminance -= u_threshold;
						if(luminance < 0.0)
						{
							gl_Position.x = -100.0;
							return;
						}
						gl_PointSize = u_pointSize;
						gl_Position = vec4(a_vertex2D,0.0,1.0);
					}
					`,l._second_pixel_shader=`precision highp float;
					varying vec4 v_color;
					uniform sampler2D u_shape;
					uniform float u_alpha;
					
					void main() {
						vec4 color = texture2D( u_shape, gl_PointCoord );
						color *= v_color * u_alpha;
						gl_FragColor = color;
					}
`,t.registerNodeType("fx/bokeh",l),e.LGraphFXBokeh=l,f.title="FX",f.desc="applies an FX from a list",f.widgets_info={fx:{widget:"combo",values:["halftone","pixelate","lowpalette","noise","gamma"]},precision:{widget:"combo",values:s.MODE_VALUES}},f.shaders={},f.prototype.onExecute=function(){if(this.isOutputConnected(0)){var O=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,O);return}if(O){this._tex=s.getTargetTexture(O,this._tex,this.properties.precision);var d=this.properties.value1;this.isInputConnected(1)&&(d=this.getInputData(1),this.properties.value1=d);var g=this.properties.value2;this.isInputConnected(2)&&(g=this.getInputData(2),this.properties.value2=g);var E=this.properties.fx,I=f.shaders[E];if(!I){var k=f["pixel_shader_"+E];if(!k)return;I=f.shaders[E]=new GL.Shader(Shader.SCREEN_VERTEX_SHADER,k)}gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var N=Mesh.getScreenQuad(),T=e.LS?LS.Renderer._current_camera:null,h;T?h=[LS.Renderer._current_camera.near,LS.Renderer._current_camera.far]:h=[1,100];var L=null;E=="noise"&&(L=s.getNoiseTexture()),this._tex.drawTo(function(){O.bind(0),E=="noise"&&L.bind(1),I.uniforms({u_texture:0,u_noise:1,u_size:[O.width,O.height],u_rand:[Math.random(),Math.random()],u_value1:d,u_value2:g,u_camera_planes:h}).draw(N)}),this.setOutputData(0,this._tex)}}},f.pixel_shader_halftone=`precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform vec2 u_camera_planes;
					uniform vec2 u_size;
					uniform float u_value1;
					uniform float u_value2;
					
					float pattern() {
						float s = sin(u_value1 * 3.1415), c = cos(u_value1 * 3.1415);
						vec2 tex = v_coord * u_size.xy;
						vec2 point = vec2(
						   c * tex.x - s * tex.y ,
						   s * tex.x + c * tex.y 
						) * u_value2;
						return (sin(point.x) * sin(point.y)) * 4.0;
					}
					void main() {
						vec4 color = texture2D(u_texture, v_coord);
						float average = (color.r + color.g + color.b) / 3.0;
						gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);
					}
`,f.pixel_shader_pixelate=`precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform vec2 u_camera_planes;
					uniform vec2 u_size;
					uniform float u_value1;
					uniform float u_value2;
					
					void main() {
						vec2 coord = vec2( floor(v_coord.x * u_value1) / u_value1, floor(v_coord.y * u_value2) / u_value2 );
						vec4 color = texture2D(u_texture, coord);
						gl_FragColor = color;
					}
`,f.pixel_shader_lowpalette=`precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform vec2 u_camera_planes;
					uniform vec2 u_size;
					uniform float u_value1;
					uniform float u_value2;
					
					void main() {
						vec4 color = texture2D(u_texture, v_coord);
						gl_FragColor = floor(color * u_value1) / u_value1;
					}
`,f.pixel_shader_noise=`precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform sampler2D u_noise;
					uniform vec2 u_size;
					uniform float u_value1;
					uniform float u_value2;
					uniform vec2 u_rand;
					
					void main() {
						vec4 color = texture2D(u_texture, v_coord);
						vec3 noise = texture2D(u_noise, v_coord * vec2(u_size.x / 512.0, u_size.y / 512.0) + u_rand).xyz - vec3(0.5);
						gl_FragColor = vec4( color.xyz + noise * u_value1, color.a );
					}
`,f.pixel_shader_gamma=`precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform float u_value1;
					
					void main() {
						vec4 color = texture2D(u_texture, v_coord);
						float gamma = 1.0 / u_value1;
						gl_FragColor = vec4( pow( color.xyz, vec3(gamma) ), color.a );
					}
`,t.registerNodeType("fx/generic",f),e.LGraphFXGeneric=f,m.title="Vigneting",m.desc="Vigneting",m.widgets_info={precision:{widget:"combo",values:s.MODE_VALUES}},m.prototype.onExecute=function(){var O=this.getInputData(0);if(this.properties.precision===s.PASS_THROUGH){this.setOutputData(0,O);return}if(O){this._tex=s.getTargetTexture(O,this._tex,this.properties.precision);var d=this.properties.intensity;this.isInputConnected(1)&&(d=this.getInputData(1),this.properties.intensity=d),gl.disable(gl.BLEND),gl.disable(gl.DEPTH_TEST);var g=Mesh.getScreenQuad(),E=m._shader,I=this.properties.invert;this._tex.drawTo(function(){O.bind(0),E.uniforms({u_texture:0,u_intensity:d,u_isize:[1/O.width,1/O.height],u_invert:I?1:0}).draw(g)}),this.setOutputData(0,this._tex)}},m.pixel_shader=`precision highp float;
					precision highp float;
					varying vec2 v_coord;
					uniform sampler2D u_texture;
					uniform float u_intensity;
					uniform int u_invert;
					
					void main() {
						float luminance = 1.0 - length( v_coord - vec2(0.5) ) * 1.414;
						vec4 color = texture2D(u_texture, v_coord);
						if(u_invert == 1)
							luminance = 1.0 - luminance;
						luminance = mix(1.0, luminance, u_intensity);
					   gl_FragColor = vec4( luminance * color.xyz, color.a);
					}
					`,t.registerNodeType("fx/vigneting",m),e.LGraphFXVigneting=m}})(litegraph),(function(e){var t=e.LiteGraph,s="#243";function r(T){this.channel=0,this.cmd=0,this.data=new Uint32Array(3),T&&this.setup(T)}t.MIDIEvent=r,r.prototype.fromJSON=function(T){this.setup(T.data)},r.prototype.setup=function(T){var h=T;T.constructor===Object&&(h=T.data),this.data.set(h);var L=h[0];this.status=L;var _=L&240;L>=240?this.cmd=L:this.cmd=_,this.cmd==r.NOTEON&&this.velocity==0&&(this.cmd=r.NOTEOFF),this.cmd_str=r.commands[this.cmd]||"",(_>=r.NOTEON||_<=r.NOTEOFF)&&(this.channel=L&15)},Object.defineProperty(r.prototype,"velocity",{get:function(){return this.cmd==r.NOTEON?this.data[2]:-1},set:function(T){this.data[2]=T},enumerable:!0}),r.notes=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],r.note_to_index={A:0,"A#":1,B:2,C:3,"C#":4,D:5,"D#":6,E:7,F:8,"F#":9,G:10,"G#":11},Object.defineProperty(r.prototype,"note",{get:function(){return this.cmd!=r.NOTEON?-1:r.toNoteString(this.data[1],!0)},set:function(T){throw"notes cannot be assigned this way, must modify the data[1]"},enumerable:!0}),Object.defineProperty(r.prototype,"octave",{get:function(){if(this.cmd!=r.NOTEON)return-1;var T=this.data[1]-24;return Math.floor(T/12+1)},set:function(T){throw"octave cannot be assigned this way, must modify the data[1]"},enumerable:!0}),r.prototype.getPitch=function(){return Math.pow(2,(this.data[1]-69)/12)*440},r.computePitch=function(T){return Math.pow(2,(T-69)/12)*440},r.prototype.getCC=function(){return this.data[1]},r.prototype.getCCValue=function(){return this.data[2]},r.prototype.getPitchBend=function(){return this.data[1]+(this.data[2]<<7)-8192},r.computePitchBend=function(T,h){return T+(h<<7)-8192},r.prototype.setCommandFromString=function(T){this.cmd=r.computeCommandFromString(T)},r.computeCommandFromString=function(T){if(!T)return 0;if(T&&T.constructor===Number)return T;switch(T=T.toUpperCase(),T){case"NOTE ON":case"NOTEON":return r.NOTEON;case"NOTE OFF":case"NOTEOFF":return r.NOTEON;case"KEY PRESSURE":case"KEYPRESSURE":return r.KEYPRESSURE;case"CONTROLLER CHANGE":case"CONTROLLERCHANGE":case"CC":return r.CONTROLLERCHANGE;case"PROGRAM CHANGE":case"PROGRAMCHANGE":case"PC":return r.PROGRAMCHANGE;case"CHANNEL PRESSURE":case"CHANNELPRESSURE":return r.CHANNELPRESSURE;case"PITCH BEND":case"PITCHBEND":return r.PITCHBEND;case"TIME TICK":case"TIMETICK":return r.TIMETICK;default:return Number(T)}},r.toNoteString=function(T,h){T=Math.round(T);var L=T-21,_=Math.floor((T-24)/12+1);return L=L%12,L<0&&(L=12+L),r.notes[L]+(h?"":_)},r.NoteStringToPitch=function(T){T=T.toUpperCase();var h=T[0],L=4;T[1]=="#"?(h+="#",T.length>2&&(L=Number(T[2]))):T.length>1&&(L=Number(T[1]));var _=r.note_to_index[h];return _==null?null:(L-1)*12+_+21},r.prototype.toString=function(){var T=""+this.channel+". ";switch(this.cmd){case r.NOTEON:T+="NOTEON "+r.toNoteString(this.data[1]);break;case r.NOTEOFF:T+="NOTEOFF "+r.toNoteString(this.data[1]);break;case r.CONTROLLERCHANGE:T+="CC "+this.data[1]+" "+this.data[2];break;case r.PROGRAMCHANGE:T+="PC "+this.data[1];break;case r.PITCHBEND:T+="PITCHBEND "+this.getPitchBend();break;case r.KEYPRESSURE:T+="KEYPRESS "+this.data[1];break}return T},r.prototype.toHexString=function(){for(var T="",h=0;h<this.data.length;h++)T+=this.data[h].toString(16)+" "},r.prototype.toJSON=function(){return{data:[this.data[0],this.data[1],this.data[2]],object_class:"MIDIEvent"}},r.NOTEOFF=128,r.NOTEON=144,r.KEYPRESSURE=160,r.CONTROLLERCHANGE=176,r.PROGRAMCHANGE=192,r.CHANNELPRESSURE=208,r.PITCHBEND=224,r.TIMETICK=248,r.commands={128:"note off",144:"note on",160:"key pressure",176:"controller change",192:"program change",208:"channel pressure",224:"pitch bend",240:"system",242:"Song pos",243:"Song select",246:"Tune request",248:"time tick",250:"Start Song",251:"Continue Song",252:"Stop Song",254:"Sensing",255:"Reset"},r.commands_short={128:"NOTEOFF",144:"NOTEOFF",160:"KEYP",176:"CC",192:"PC",208:"CP",224:"PB",240:"SYS",242:"POS",243:"SELECT",246:"TUNEREQ",248:"TT",250:"START",251:"CONTINUE",252:"STOP",254:"SENS",255:"RESET"},r.commands_reversed={};for(var n in r.commands)r.commands_reversed[r.commands[n]]=n;function u(T,h){if(!navigator.requestMIDIAccess){this.error="not suppoorted",h?h("Not supported"):console.error("MIDI NOT SUPPORTED, enable by chrome://flags");return}this.on_ready=T,this.state={note:[],cc:[]},this.input_ports=null,this.input_ports_info=[],this.output_ports=null,this.output_ports_info=[],navigator.requestMIDIAccess().then(this.onMIDISuccess.bind(this),this.onMIDIFailure.bind(this))}u.input=null,u.MIDIEvent=r,u.prototype.onMIDISuccess=function(T){console.log("MIDI ready!"),console.log(T),this.midi=T,this.updatePorts(),this.on_ready&&this.on_ready(this)},u.prototype.updatePorts=function(){var T=this.midi;this.input_ports=T.inputs,this.input_ports_info=[],this.output_ports=T.outputs,this.output_ports_info=[];for(var h=0,_=this.input_ports.values(),D=_.next();D&&D.done===!1;){var L=D.value;this.input_ports_info.push(L),console.log("Input port [type:'"+L.type+"'] id:'"+L.id+"' manufacturer:'"+L.manufacturer+"' name:'"+L.name+"' version:'"+L.version+"'"),h++,D=_.next()}this.num_input_ports=h,h=0;for(var _=this.output_ports.values(),D=_.next();D&&D.done===!1;){var L=D.value;this.output_ports_info.push(L),console.log("Output port [type:'"+L.type+"'] id:'"+L.id+"' manufacturer:'"+L.manufacturer+"' name:'"+L.name+"' version:'"+L.version+"'"),h++,D=_.next()}this.num_output_ports=h},u.prototype.onMIDIFailure=function(T){console.error("Failed to get MIDI access - "+T)},u.prototype.openInputPort=function(T,h){var L=this.input_ports.get("input-"+T);if(!L)return!1;u.input=this;var _=this;return L.onmidimessage=function(D){var B=new r(D.data);_.updateState(B),h&&h(D.data,B),u.on_message&&u.on_message(D.data,B)},console.log("port open: ",L),!0},u.parseMsg=function(T){},u.prototype.updateState=function(T){switch(T.cmd){case r.NOTEON:this.state.note[T.value1|0]=T.value2;break;case r.NOTEOFF:this.state.note[T.value1|0]=0;break;case r.CONTROLLERCHANGE:this.state.cc[T.getCC()]=T.getCCValue();break}},u.prototype.sendMIDI=function(T,h){if(h){var L=this.output_ports_info[T];L&&(u.output=this,h.constructor===r?L.send(h.data):L.send(h))}};function o(){this.addOutput("on_midi",t.EVENT),this.addOutput("out","midi"),this.properties={port:0},this._last_midi_event=null,this._current_midi_event=null,this.boxcolor="#AAA",this._last_time=0;var T=this;new u(function(h){T._midi=h,T._waiting&&T.onStart(),T._waiting=!1})}o.MIDIInterface=u,o.title="MIDI Input",o.desc="Reads MIDI from a input port",o.color=s,o.prototype.getPropertyInfo=function(T){if(this._midi&&T=="port"){for(var h={},L=0;L<this._midi.input_ports_info.length;++L){var _=this._midi.input_ports_info[L];h[L]=L+".- "+_.name+" version:"+_.version}return{type:"enum",values:h}}},o.prototype.onStart=function(){this._midi?this._midi.openInputPort(this.properties.port,this.onMIDIEvent.bind(this)):this._waiting=!0},o.prototype.onMIDIEvent=function(T,h){this._last_midi_event=h,this.boxcolor="#AFA",this._last_time=t.getTime(),this.trigger("on_midi",h),h.cmd==r.NOTEON?this.trigger("on_noteon",h):h.cmd==r.NOTEOFF?this.trigger("on_noteoff",h):h.cmd==r.CONTROLLERCHANGE?this.trigger("on_cc",h):h.cmd==r.PROGRAMCHANGE?this.trigger("on_pc",h):h.cmd==r.PITCHBEND&&this.trigger("on_pitchbend",h)},o.prototype.onDrawBackground=function(T){if(this.boxcolor="#AAA",!this.flags.collapsed&&this._last_midi_event){T.fillStyle="white";var h=t.getTime(),L=1-Math.max(0,(h-this._last_time)*.001);if(L>0){var _=T.globalAlpha;T.globalAlpha*=L,T.font="12px Tahoma",T.fillText(this._last_midi_event.toString(),2,this.size[1]*.5+3),T.globalAlpha=_}}},o.prototype.onExecute=function(){if(this.outputs)for(var T=this._last_midi_event,h=0;h<this.outputs.length;++h){var L=this.outputs[h],_=null;switch(L.name){case"midi":_=this._midi;break;case"last_midi":_=T;break;default:continue}this.setOutputData(h,_)}},o.prototype.onGetOutputs=function(){return[["last_midi","midi"],["on_midi",t.EVENT],["on_noteon",t.EVENT],["on_noteoff",t.EVENT],["on_cc",t.EVENT],["on_pc",t.EVENT],["on_pitchbend",t.EVENT]]},t.registerNodeType("midi/input",o);function a(){this.addInput("send",t.EVENT),this.properties={port:0};var T=this;new u(function(h){T._midi=h,T.widget.options.values=T.getMIDIOutputs()}),this.widget=this.addWidget("combo","Device",this.properties.port,{property:"port",values:this.getMIDIOutputs.bind(this)}),this.size=[340,60]}a.MIDIInterface=u,a.title="MIDI Output",a.desc="Sends MIDI to output channel",a.color=s,a.prototype.onGetPropertyInfo=function(T){if(this._midi&&T=="port"){var h=this.getMIDIOutputs();return{type:"enum",values:h}}},a.default_ports={0:"unknown"},a.prototype.getMIDIOutputs=function(){var T={};if(!this._midi)return a.default_ports;if(this._midi.output_ports_info)for(var h=0;h<this._midi.output_ports_info.length;++h){var L=this._midi.output_ports_info[h];if(L){var _=h+".- "+L.name+" version:"+L.version;T[h]=_}}return T},a.prototype.onAction=function(T,h){this._midi&&(T=="send"&&this._midi.sendMIDI(this.properties.port,h),this.trigger("midi",h))},a.prototype.onGetInputs=function(){return[["send",t.ACTION]]},a.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/output",a);function l(){this.addInput("on_midi",t.EVENT),this._str="",this.size=[200,40]}l.title="MIDI Show",l.desc="Shows MIDI in the graph",l.color=s,l.prototype.getTitle=function(){return this.flags.collapsed?this._str:this.title},l.prototype.onAction=function(T,h){h&&(h.constructor===r?this._str=h.toString():this._str="???")},l.prototype.onDrawForeground=function(T){!this._str||this.flags.collapsed||(T.font="30px Arial",T.fillText(this._str,10,this.size[1]*.8))},l.prototype.onGetInputs=function(){return[["in",t.ACTION]]},l.prototype.onGetOutputs=function(){return[["on_midi",t.EVENT]]},t.registerNodeType("midi/show",l);function f(){this.properties={channel:-1,cmd:-1,min_value:-1,max_value:-1};var T=this;this._learning=!1,this.addWidget("button","Learn","",function(){T._learning=!0,T.boxcolor="#FA3"}),this.addInput("in",t.EVENT),this.addOutput("on_midi",t.EVENT),this.boxcolor="#AAA"}f.title="MIDI Filter",f.desc="Filters MIDI messages",f.color=s,f["@cmd"]={type:"enum",title:"Command",values:r.commands_reversed},f.prototype.getTitle=function(){var T=null;return this.properties.cmd==-1?T="Nothing":T=r.commands_short[this.properties.cmd]||"Unknown",this.properties.min_value!=-1&&this.properties.max_value!=-1&&(T+=" "+(this.properties.min_value==this.properties.max_value?this.properties.max_value:this.properties.min_value+".."+this.properties.max_value)),"Filter: "+T},f.prototype.onPropertyChanged=function(T,h){if(T=="cmd"){var L=Number(h);isNaN(L)&&(L=r.commands[h]||0),this.properties.cmd=L}},f.prototype.onAction=function(T,h){if(!(!h||h.constructor!==r)){if(this._learning)this._learning=!1,this.boxcolor="#AAA",this.properties.channel=h.channel,this.properties.cmd=h.cmd,this.properties.min_value=this.properties.max_value=h.data[1];else if(this.properties.channel!=-1&&h.channel!=this.properties.channel||this.properties.cmd!=-1&&h.cmd!=this.properties.cmd||this.properties.min_value!=-1&&h.data[1]<this.properties.min_value||this.properties.max_value!=-1&&h.data[1]>this.properties.max_value)return;this.trigger("on_midi",h)}},t.registerNodeType("midi/filter",f);function m(){this.properties={channel:0,cmd:144,value1:1,value2:1},this.addInput("send",t.EVENT),this.addInput("assign",t.EVENT),this.addOutput("on_midi",t.EVENT),this.midi_event=new r,this.gate=!1}m.title="MIDIEvent",m.desc="Create a MIDI Event",m.color=s,m.prototype.onAction=function(T,L){if(T=="assign"){this.properties.channel=L.channel,this.properties.cmd=L.cmd,this.properties.value1=L.data[1],this.properties.value2=L.data[2],L.cmd==r.NOTEON?this.gate=!0:L.cmd==r.NOTEOFF&&(this.gate=!1);return}var L=this.midi_event;L.channel=this.properties.channel,this.properties.cmd&&this.properties.cmd.constructor===String?L.setCommandFromString(this.properties.cmd):L.cmd=this.properties.cmd,L.data[0]=L.cmd|L.channel,L.data[1]=Number(this.properties.value1),L.data[2]=Number(this.properties.value2),this.trigger("on_midi",L)},m.prototype.onExecute=function(){var T=this.properties;if(this.inputs)for(var h=0;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=-1)switch(L.name){case"note":var _=this.getInputData(h);_!=null&&(_.constructor===String&&(_=r.NoteStringToPitch(_)),this.properties.value1=(_|0)%255);break;case"cmd":var _=this.getInputData(h);_!=null&&(this.properties.cmd=_);break;case"value1":var _=this.getInputData(h);_!=null&&(this.properties.value1=clamp(_|0,0,127));break;case"value2":var _=this.getInputData(h);_!=null&&(this.properties.value2=clamp(_|0,0,127));break}}if(this.outputs)for(var h=0;h<this.outputs.length;++h){var D=this.outputs[h],_=null;switch(D.name){case"midi":_=new r,_.setup([T.cmd,T.value1,T.value2]),_.channel=T.channel;break;case"command":_=T.cmd;break;case"cc":_=T.value1;break;case"cc_value":_=T.value2;break;case"note":_=T.cmd==r.NOTEON||T.cmd==r.NOTEOFF?T.value1:null;break;case"velocity":_=T.cmd==r.NOTEON?T.value2:null;break;case"pitch":_=T.cmd==r.NOTEON?r.computePitch(T.value1):null;break;case"pitchbend":_=T.cmd==r.PITCHBEND?r.computePitchBend(T.value1,T.value2):null;break;case"gate":_=this.gate;break;default:continue}_!==null&&this.setOutputData(h,_)}},m.prototype.onPropertyChanged=function(T,h){T=="cmd"&&(this.properties.cmd=r.computeCommandFromString(h))},m.prototype.onGetInputs=function(){return[["cmd","number"],["note","number"],["value1","number"],["value2","number"]]},m.prototype.onGetOutputs=function(){return[["midi","midi"],["on_midi",t.EVENT],["command","number"],["note","number"],["velocity","number"],["cc","number"],["cc_value","number"],["pitch","number"],["gate","bool"],["pitchbend","number"]]},t.registerNodeType("midi/event",m);function O(){this.properties={cc:1,value:0},this.addOutput("value","number")}O.title="MIDICC",O.desc="gets a Controller Change",O.color=s,O.prototype.onExecute=function(){this.properties,u.input&&(this.properties.value=u.input.state.cc[this.properties.cc]),this.setOutputData(0,this.properties.value)},t.registerNodeType("midi/cc",O);function d(){this.addInput("generate",t.ACTION),this.addInput("scale","string"),this.addInput("octave","number"),this.addOutput("note",t.EVENT),this.properties={notes:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#",octave:2,duration:.5,mode:"sequence"},this.notes_pitches=d.processScale(this.properties.notes),this.sequence_index=0}d.title="MIDI Generator",d.desc="Generates a random MIDI note",d.color=s,d.processScale=function(T){for(var h=T.split(","),L=0;L<h.length;++L){var _=h[L];_.length==2&&_[1]!="#"||_.length>2?h[L]=-t.MIDIEvent.NoteStringToPitch(_):h[L]=r.note_to_index[_]||0}return h},d.prototype.onPropertyChanged=function(T,h){T=="notes"&&(this.notes_pitches=d.processScale(h))},d.prototype.onExecute=function(){var T=this.getInputData(2);T!=null&&(this.properties.octave=T);var h=this.getInputData(1);h&&(this.notes_pitches=d.processScale(h))},d.prototype.onAction=function(T,F){var L=0,_=this.notes_pitches.length,D=0;this.properties.mode=="sequence"?D=this.sequence_index=(this.sequence_index+1)%_:this.properties.mode=="random"&&(D=Math.floor(Math.random()*_));var B=this.notes_pitches[D];B>=0?L=B+(this.properties.octave-1)*12+33:L=-B;var F=new r;F.setup([r.NOTEON,L,10]);var H=this.properties.duration||1;this.trigger("note",F),setTimeout((function(){var V=new r;V.setup([r.NOTEOFF,L,0]),this.trigger("note",V)}).bind(this),H*1e3)},t.registerNodeType("midi/generator",d);function g(){this.properties={amount:0},this.addInput("in",t.ACTION),this.addInput("amount","number"),this.addOutput("out",t.EVENT),this.midi_event=new r}g.title="MIDI Transpose",g.desc="Transpose a MIDI note",g.color=s,g.prototype.onAction=function(T,h){!h||h.constructor!==r||(h.data[0]==r.NOTEON||h.data[0]==r.NOTEOFF?(this.midi_event=new r,this.midi_event.setup(h.data),this.midi_event.data[1]=Math.round(this.midi_event.data[1]+this.properties.amount),this.trigger("out",this.midi_event)):this.trigger("out",h))},g.prototype.onExecute=function(){var T=this.getInputData(1);T!=null&&(this.properties.amount=T)},t.registerNodeType("midi/transpose",g);function E(){this.properties={scale:"A,A#,B,C,C#,D,D#,E,F,F#,G,G#"},this.addInput("note",t.ACTION),this.addInput("scale","string"),this.addOutput("out",t.EVENT),this.valid_notes=new Array(12),this.offset_notes=new Array(12),this.processScale(this.properties.scale)}E.title="MIDI Quantize Pitch",E.desc="Transpose a MIDI note tp fit an scale",E.color=s,E.prototype.onPropertyChanged=function(T,h){T=="scale"&&this.processScale(h)},E.prototype.processScale=function(T){this._current_scale=T,this.notes_pitches=d.processScale(T);for(var h=0;h<12;++h)this.valid_notes[h]=this.notes_pitches.indexOf(h)!=-1;for(var h=0;h<12;++h){if(this.valid_notes[h]){this.offset_notes[h]=0;continue}for(var L=1;L<12;++L){if(this.valid_notes[(h-L)%12]){this.offset_notes[h]=-L;break}if(this.valid_notes[(h+L)%12]){this.offset_notes[h]=L;break}}}},E.prototype.onAction=function(T,h){if(!(!h||h.constructor!==r))if(h.data[0]==r.NOTEON||h.data[0]==r.NOTEOFF){this.midi_event=new r,this.midi_event.setup(h.data);var L=h.note,_=r.note_to_index[L],D=this.offset_notes[_];this.midi_event.data[1]+=D,this.trigger("out",this.midi_event)}else this.trigger("out",h)},E.prototype.onExecute=function(){var T=this.getInputData(1);T!=null&&T!=this._current_scale&&this.processScale(T)},t.registerNodeType("midi/quantize",E);function I(){this.properties={url:"",autoplay:!0},this.addInput("play",t.ACTION),this.addInput("pause",t.ACTION),this.addOutput("note",t.EVENT),this._midi=null,this._current_time=0,this._playing=!1,typeof MidiParser>"u"&&(console.error("midi-parser.js not included, LGMidiPlay requires that library: https://raw.githubusercontent.com/colxi/midi-parser-js/master/src/main.js"),this.boxcolor="red")}I.title="MIDI fromFile",I.desc="Plays a MIDI file",I.color=s,I.prototype.onAction=function(T){T=="play"?this.play():T=="pause"&&(this._playing=!this._playing)},I.prototype.onPropertyChanged=function(T,h){T=="url"&&this.loadMIDIFile(h)},I.prototype.onExecute=function(){if(this._midi&&this._playing){this._current_time+=this.graph.elapsed_time;for(var T=this._current_time*100,h=0;h<this._midi.tracks;++h){var L=this._midi.track[h];L._last_pos||(L._last_pos=0,L._time=0);var _=L.event[L._last_pos];if(_&&L._time+_.deltaTime<=T&&(L._last_pos++,L._time+=_.deltaTime,_.data)){var D=_.type<<4+_.channel,B=new r;B.setup([D,_.data[0],_.data[1]]),this.trigger("note",B)}}}},I.prototype.play=function(){if(this._playing=!0,this._current_time=0,!!this._midi)for(var T=0;T<this._midi.tracks;++T){var h=this._midi.track[T];h._last_pos=0,h._time=0}},I.prototype.loadMIDIFile=function(T){var h=this;t.fetchFile(T,"arraybuffer",function(L){h.boxcolor="#AFA",h._midi=MidiParser.parse(new Uint8Array(L)),h.properties.autoplay&&h.play()},function(L){h.boxcolor="#FAA",h._midi=null})},I.prototype.onDropFile=function(T){this.properties.url="",this.loadMIDIFile(T)},t.registerNodeType("midi/fromFile",I);function k(){if(this.properties={volume:.5,duration:1},this.addInput("note",t.ACTION),this.addInput("volume","number"),this.addInput("duration","number"),this.addOutput("note",t.EVENT),typeof AudioSynth>"u")console.error("Audiosynth.js not included, LGMidiPlay requires that library"),this.boxcolor="red";else{var T=this.synth=new AudioSynth;this.instrument=T.createInstrument("piano")}}k.title="MIDI Play",k.desc="Plays a MIDI note",k.color=s,k.prototype.onAction=function(T,h){if(!(!h||h.constructor!==r)){if(this.instrument&&h.data[0]==r.NOTEON){var L=h.note;if(!L||L=="undefined"||L.constructor!==String)return;this.instrument.play(L,h.octave,this.properties.duration,this.properties.volume)}this.trigger("note",h)}},k.prototype.onExecute=function(){var T=this.getInputData(1);T!=null&&(this.properties.volume=T);var h=this.getInputData(2);h!=null&&(this.properties.duration=h)},t.registerNodeType("midi/play",k);function N(){this.properties={num_octaves:2,start_octave:2},this.addInput("note",t.ACTION),this.addInput("reset",t.ACTION),this.addOutput("note",t.EVENT),this.size=[400,100],this.keys=[],this._last_key=-1}N.title="MIDI Keys",N.desc="Keyboard to play notes",N.color=s,N.keys=[{x:0,w:1,h:1,t:0},{x:.75,w:.5,h:.6,t:1},{x:1,w:1,h:1,t:0},{x:1.75,w:.5,h:.6,t:1},{x:2,w:1,h:1,t:0},{x:2.75,w:.5,h:.6,t:1},{x:3,w:1,h:1,t:0},{x:4,w:1,h:1,t:0},{x:4.75,w:.5,h:.6,t:1},{x:5,w:1,h:1,t:0},{x:5.75,w:.5,h:.6,t:1},{x:6,w:1,h:1,t:0}],N.prototype.onDrawForeground=function(T){if(!this.flags.collapsed){var h=this.properties.num_octaves*12;this.keys.length=h;var L=this.size[0]/(this.properties.num_octaves*7),_=this.size[1];T.globalAlpha=1;for(var D=0;D<2;D++)for(var B=0;B<h;++B){var F=N.keys[B%12];if(F.t==D){var H=Math.floor(B/12),V=H*7*L+F.x*L;D==0?T.fillStyle=this.keys[B]?"#CCC":"white":T.fillStyle=this.keys[B]?"#333":"black",T.fillRect(V+1,0,L*F.w-2,_*F.h)}}}},N.prototype.getKeyIndex=function(T){this.properties.num_octaves*12;for(var h=this.size[0]/(this.properties.num_octaves*7),L=this.size[1],_=1;_>=0;_--)for(var D=0;D<this.keys.length;++D){var B=N.keys[D%12];if(B.t==_){var F=Math.floor(D/12),H=F*7*h+B.x*h,V=h*B.w,Y=L*B.h;if(!(T[0]<H||T[0]>H+V||T[1]>Y))return D}}return-1},N.prototype.onAction=function(T,h){if(T=="reset"){for(var L=0;L<this.keys.length;++L)this.keys[L]=!1;return}if(!(!h||h.constructor!==r)){var _=h,D=(this.properties.start_octave-1)*12+29,B=_.data[1]-D;B>=0&&B<this.keys.length&&(_.data[0]==r.NOTEON?this.keys[B]=!0:_.data[0]==r.NOTEOFF&&(this.keys[B]=!1)),this.trigger("note",_)}},N.prototype.onMouseDown=function(T,h){if(!(h[1]<0)){var L=this.getKeyIndex(h);this.keys[L]=!0,this._last_key=L;var _=(this.properties.start_octave-1)*12+29+L,D=new r;return D.setup([r.NOTEON,_,100]),this.trigger("note",D),!0}},N.prototype.onMouseMove=function(T,h){if(!(h[1]<0||this._last_key==-1)){this.setDirtyCanvas(!0);var L=this.getKeyIndex(h);if(this._last_key==L)return!0;this.keys[this._last_key]=!1;var _=(this.properties.start_octave-1)*12+29+this._last_key,D=new r;D.setup([r.NOTEOFF,_,100]),this.trigger("note",D),this.keys[L]=!0;var _=(this.properties.start_octave-1)*12+29+L,D=new r;return D.setup([r.NOTEON,_,100]),this.trigger("note",D),this._last_key=L,!0}},N.prototype.onMouseUp=function(T,h){if(!(h[1]<0)){var L=this.getKeyIndex(h);this.keys[L]=!1,this._last_key=-1;var _=(this.properties.start_octave-1)*12+29+L,D=new r;return D.setup([r.NOTEOFF,_,100]),this.trigger("note",D),!0}},t.registerNodeType("midi/keys",N)})(litegraph),(function(e){var t=e.LiteGraph,s={};e.LGAudio=s,s.getAudioContext=function(){if(!this._audio_context){if(window.AudioContext=window.AudioContext||window.webkitAudioContext,!window.AudioContext)return console.error("AudioContext not supported by browser"),null;this._audio_context=new AudioContext,this._audio_context.onmessage=function(h){console.log("msg",h)},this._audio_context.onended=function(h){console.log("ended",h)},this._audio_context.oncomplete=function(h){console.log("complete",h)}}return this._audio_context},s.connect=function(h,L){try{h.connect(L)}catch(_){console.warn("LGraphAudio:",_)}},s.disconnect=function(h,L){try{h.disconnect(L)}catch(_){console.warn("LGraphAudio:",_)}},s.changeAllAudiosConnections=function(h,L){if(h.inputs)for(var _=0;_<h.inputs.length;++_){var D=h.inputs[_],B=h.graph.links[D.link];if(B){var F=h.graph.getNodeById(B.origin_id),H=null;F.getAudioNodeInOutputSlot?H=F.getAudioNodeInOutputSlot(B.origin_slot):H=F.audionode;var V=null;h.getAudioNodeInInputSlot?V=h.getAudioNodeInInputSlot(_):V=h.audionode,L?s.connect(H,V):s.disconnect(H,V)}}if(h.outputs)for(var _=0;_<h.outputs.length;++_)for(var Y=h.outputs[_],K=0;K<Y.links.length;++K){var B=h.graph.links[Y.links[K]];if(B){var H=null;h.getAudioNodeInOutputSlot?H=h.getAudioNodeInOutputSlot(_):H=h.audionode;var J=h.graph.getNodeById(B.target_id),V=null;J.getAudioNodeInInputSlot?V=J.getAudioNodeInInputSlot(B.target_slot):V=J.audionode,L?s.connect(H,V):s.disconnect(H,V)}}},s.onConnectionsChange=function(h,L,_,D){if(h==t.OUTPUT){var B=null;if(D&&(B=this.graph.getNodeById(D.target_id)),!!B){var F=null;this.getAudioNodeInOutputSlot?F=this.getAudioNodeInOutputSlot(L):F=this.audionode;var H=null;B.getAudioNodeInInputSlot?H=B.getAudioNodeInInputSlot(D.target_slot):H=B.audionode,_?s.connect(F,H):s.disconnect(F,H)}}},s.createAudioNodeWrapper=function(h){var L=h.prototype.onPropertyChanged;h.prototype.onPropertyChanged=function(_,D){L&&L.call(this,_,D),this.audionode&&this.audionode[_]!==void 0&&(this.audionode[_].value!==void 0?this.audionode[_].value=D:this.audionode[_]=D)},h.prototype.onConnectionsChange=s.onConnectionsChange},s.cached_audios={},s.loadSound=function(h,L,_){if(s.cached_audios[h]&&h.indexOf("blob:")==-1){L&&L(s.cached_audios[h]);return}s.onProcessAudioURL&&(h=s.onProcessAudioURL(h));var D=new XMLHttpRequest;D.open("GET",h,!0),D.responseType="arraybuffer";var B=s.getAudioContext();D.onload=function(){console.log("AudioSource loaded"),B.decodeAudioData(D.response,function(H){console.log("AudioSource decoded"),s.cached_audios[h]=H,L&&L(H)},F)},D.send();function F(H){console.log("Audio loading sample error:",H),_&&_(H)}return D};function r(){this.properties={src:"",gain:.5,loop:!0,autoplay:!0,playbackRate:1},this._loading_audio=!1,this._audiobuffer=null,this._audionodes=[],this._last_sourcenode=null,this.addOutput("out","audio"),this.addInput("gain","number");var h=s.getAudioContext();this.audionode=h.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain,this.properties.src&&this.loadSound(this.properties.src)}r.desc="Plays an audio file",r["@src"]={widget:"resource"},r.supported_extensions=["wav","ogg","mp3"],r.prototype.onAdded=function(h){h.status===LGraph.STATUS_RUNNING&&this.onStart()},r.prototype.onStart=function(){this._audiobuffer&&this.properties.autoplay&&this.playBuffer(this._audiobuffer)},r.prototype.onStop=function(){this.stopAllSounds()},r.prototype.onPause=function(){this.pauseAllSounds()},r.prototype.onUnpause=function(){this.unpauseAllSounds()},r.prototype.onRemoved=function(){this.stopAllSounds(),this._dropped_url&&URL.revokeObjectURL(this._url)},r.prototype.stopAllSounds=function(){for(var h=0;h<this._audionodes.length;++h)this._audionodes[h].started&&(this._audionodes[h].started=!1,this._audionodes[h].stop());this._audionodes.length=0},r.prototype.pauseAllSounds=function(){s.getAudioContext().suspend()},r.prototype.unpauseAllSounds=function(){s.getAudioContext().resume()},r.prototype.onExecute=function(){if(this.inputs)for(var h=0;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=null){var _=this.getInputData(h);if(_!==void 0){if(L.name=="gain")this.audionode.gain.value=_;else if(L.name=="src")this.setProperty("src",_);else if(L.name=="playbackRate"){this.properties.playbackRate=_;for(var D=0;D<this._audionodes.length;++D)this._audionodes[D].playbackRate.value=_}}}}if(this.outputs)for(var h=0;h<this.outputs.length;++h){var B=this.outputs[h];B.name=="buffer"&&this._audiobuffer&&this.setOutputData(h,this._audiobuffer)}},r.prototype.onAction=function(h){this._audiobuffer&&(h=="Play"?this.playBuffer(this._audiobuffer):h=="Stop"&&this.stopAllSounds())},r.prototype.onPropertyChanged=function(h,L){if(h=="src")this.loadSound(L);else if(h=="gain")this.audionode.gain.value=L;else if(h=="playbackRate")for(var _=0;_<this._audionodes.length;++_)this._audionodes[_].playbackRate.value=L},r.prototype.playBuffer=function(h){var L=this,_=s.getAudioContext(),D=_.createBufferSource();return this._last_sourcenode=D,D.graphnode=this,D.buffer=h,D.loop=this.properties.loop,D.playbackRate.value=this.properties.playbackRate,this._audionodes.push(D),D.connect(this.audionode),this._audionodes.push(D),this.trigger("start"),D.onended=function(){L.trigger("ended");var B=L._audionodes.indexOf(D);B!=-1&&L._audionodes.splice(B,1)},D.started||(D.started=!0,D.start()),D},r.prototype.loadSound=function(h){var L=this;if(this._request&&(this._request.abort(),this._request=null),this._audiobuffer=null,this._loading_audio=!1,!h)return;this._request=s.loadSound(h,_),this._loading_audio=!0,this.boxcolor="#AA4";function _(D){this.boxcolor=t.NODE_DEFAULT_BOXCOLOR,L._audiobuffer=D,L._loading_audio=!1,L.graph&&L.graph.status===LGraph.STATUS_RUNNING&&L.onStart()}},r.prototype.onConnectionsChange=s.onConnectionsChange,r.prototype.onGetInputs=function(){return[["playbackRate","number"],["src","string"],["Play",t.ACTION],["Stop",t.ACTION]]},r.prototype.onGetOutputs=function(){return[["buffer","audiobuffer"],["start",t.EVENT],["ended",t.EVENT]]},r.prototype.onDropFile=function(h){this._dropped_url&&URL.revokeObjectURL(this._dropped_url);var L=URL.createObjectURL(h);this.properties.src=L,this.loadSound(L),this._dropped_url=L},r.title="Source",r.desc="Plays audio",t.registerNodeType("audio/source",r);function n(){this.properties={gain:.5},this._audionodes=[],this._media_stream=null,this.addOutput("out","audio"),this.addInput("gain","number");var h=s.getAudioContext();this.audionode=h.createGain(),this.audionode.graphnode=this,this.audionode.gain.value=this.properties.gain}n.prototype.onAdded=function(h){h.status===LGraph.STATUS_RUNNING&&this.onStart()},n.prototype.onStart=function(){this._media_stream==null&&!this._waiting_confirmation&&this.openStream()},n.prototype.onStop=function(){this.audionode.gain.value=0},n.prototype.onPause=function(){this.audionode.gain.value=0},n.prototype.onUnpause=function(){this.audionode.gain.value=this.properties.gain},n.prototype.onRemoved=function(){if(this.audionode.gain.value=0,this.audiosource_node&&(this.audiosource_node.disconnect(this.audionode),this.audiosource_node=null),this._media_stream){var h=this._media_stream.getTracks();h.length&&h[0].stop()}},n.prototype.openStream=function(){if(!navigator.mediaDevices){console.log("getUserMedia() is not supported in your browser, use chrome and enable WebRTC from about://flags");return}this._waiting_confirmation=!0,navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(this.streamReady.bind(this)).catch(L);var h=this;function L(_){console.log("Media rejected",_),h._media_stream=!1,h.boxcolor="red"}},n.prototype.streamReady=function(h){this._media_stream=h,this.audiosource_node&&this.audiosource_node.disconnect(this.audionode);var L=s.getAudioContext();this.audiosource_node=L.createMediaStreamSource(h),this.audiosource_node.graphnode=this,this.audiosource_node.connect(this.audionode),this.boxcolor="white"},n.prototype.onExecute=function(){if(this._media_stream==null&&!this._waiting_confirmation&&this.openStream(),this.inputs)for(var h=0;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=null){var _=this.getInputData(h);_!==void 0&&L.name=="gain"&&(this.audionode.gain.value=this.properties.gain=_)}}},n.prototype.onAction=function(h){h=="Play"?this.audionode.gain.value=this.properties.gain:h=="Stop"&&(this.audionode.gain.value=0)},n.prototype.onPropertyChanged=function(h,L){h=="gain"&&(this.audionode.gain.value=L)},n.prototype.onConnectionsChange=s.onConnectionsChange,n.prototype.onGetInputs=function(){return[["playbackRate","number"],["Play",t.ACTION],["Stop",t.ACTION]]},n.title="MediaSource",n.desc="Plays microphone",t.registerNodeType("audio/media_source",n);function u(){this.properties={fftSize:2048,minDecibels:-100,maxDecibels:-10,smoothingTimeConstant:.5};var h=s.getAudioContext();this.audionode=h.createAnalyser(),this.audionode.graphnode=this,this.audionode.fftSize=this.properties.fftSize,this.audionode.minDecibels=this.properties.minDecibels,this.audionode.maxDecibels=this.properties.maxDecibels,this.audionode.smoothingTimeConstant=this.properties.smoothingTimeConstant,this.addInput("in","audio"),this.addOutput("freqs","array"),this.addOutput("samples","array"),this._freq_bin=null,this._time_bin=null}u.prototype.onPropertyChanged=function(h,L){this.audionode[h]=L},u.prototype.onExecute=function(){if(this.isOutputConnected(0)){var h=this.audionode.frequencyBinCount;(!this._freq_bin||this._freq_bin.length!=h)&&(this._freq_bin=new Uint8Array(h)),this.audionode.getByteFrequencyData(this._freq_bin),this.setOutputData(0,this._freq_bin)}if(this.isOutputConnected(1)){var h=this.audionode.frequencyBinCount;(!this._time_bin||this._time_bin.length!=h)&&(this._time_bin=new Uint8Array(h)),this.audionode.getByteTimeDomainData(this._time_bin),this.setOutputData(1,this._time_bin)}for(var L=1;L<this.inputs.length;++L){var _=this.inputs[L];if(_.link!=null){var D=this.getInputData(L);D!==void 0&&(this.audionode[_.name].value=D)}}},u.prototype.onGetInputs=function(){return[["minDecibels","number"],["maxDecibels","number"],["smoothingTimeConstant","number"]]},u.prototype.onGetOutputs=function(){return[["freqs","array"],["samples","array"]]},u.title="Analyser",u.desc="Audio Analyser",t.registerNodeType("audio/analyser",u);function o(){this.properties={gain:1},this.audionode=s.getAudioContext().createGain(),this.addInput("in","audio"),this.addInput("gain","number"),this.addOutput("out","audio")}o.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var L=this.inputs[h],_=this.getInputData(h);_!==void 0&&(this.audionode[L.name].value=_)}},s.createAudioNodeWrapper(o),o.title="Gain",o.desc="Audio gain",t.registerNodeType("audio/gain",o);function a(){this.properties={impulse_src:"",normalize:!0},this.audionode=s.getAudioContext().createConvolver(),this.addInput("in","audio"),this.addOutput("out","audio")}s.createAudioNodeWrapper(a),a.prototype.onRemove=function(){this._dropped_url&&URL.revokeObjectURL(this._dropped_url)},a.prototype.onPropertyChanged=function(h,L){h=="impulse_src"?this.loadImpulse(L):h=="normalize"&&(this.audionode.normalize=L)},a.prototype.onDropFile=function(h){this._dropped_url&&URL.revokeObjectURL(this._dropped_url),this._dropped_url=URL.createObjectURL(h),this.properties.impulse_src=this._dropped_url,this.loadImpulse(this._dropped_url)},a.prototype.loadImpulse=function(h){var L=this;if(this._request&&(this._request.abort(),this._request=null),this._impulse_buffer=null,this._loading_impulse=!1,!h)return;this._request=s.loadSound(h,_),this._loading_impulse=!0;function _(D){L._impulse_buffer=D,L.audionode.buffer=D,console.log("Impulse signal set"),L._loading_impulse=!1}},a.title="Convolver",a.desc="Convolves the signal (used for reverb)",t.registerNodeType("audio/convolver",a);function l(){this.properties={threshold:-50,knee:40,ratio:12,reduction:-20,attack:0,release:.25},this.audionode=s.getAudioContext().createDynamicsCompressor(),this.addInput("in","audio"),this.addOutput("out","audio")}s.createAudioNodeWrapper(l),l.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=null){var _=this.getInputData(h);_!==void 0&&(this.audionode[L.name].value=_)}}},l.prototype.onGetInputs=function(){return[["threshold","number"],["knee","number"],["ratio","number"],["reduction","number"],["attack","number"],["release","number"]]},l.title="DynamicsCompressor",l.desc="Dynamics Compressor",t.registerNodeType("audio/dynamicsCompressor",l);function f(){this.properties={},this.audionode=s.getAudioContext().createWaveShaper(),this.addInput("in","audio"),this.addInput("shape","waveshape"),this.addOutput("out","audio")}f.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length)){var h=this.getInputData(1);h!==void 0&&(this.audionode.curve=h)}},f.prototype.setWaveShape=function(h){this.audionode.curve=h},s.createAudioNodeWrapper(f);function m(){this.properties={gain1:.5,gain2:.5},this.audionode=s.getAudioContext().createGain(),this.audionode1=s.getAudioContext().createGain(),this.audionode1.gain.value=this.properties.gain1,this.audionode2=s.getAudioContext().createGain(),this.audionode2.gain.value=this.properties.gain2,this.audionode1.connect(this.audionode),this.audionode2.connect(this.audionode),this.addInput("in1","audio"),this.addInput("in1 gain","number"),this.addInput("in2","audio"),this.addInput("in2 gain","number"),this.addOutput("out","audio")}m.prototype.getAudioNodeInInputSlot=function(h){if(h==0)return this.audionode1;if(h==2)return this.audionode2},m.prototype.onPropertyChanged=function(h,L){h=="gain1"?this.audionode1.gain.value=L:h=="gain2"&&(this.audionode2.gain.value=L)},m.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var L=this.inputs[h];if(!(L.link==null||L.type=="audio")){var _=this.getInputData(h);_!==void 0&&(h==1?this.audionode1.gain.value=_:h==3&&(this.audionode2.gain.value=_))}}},s.createAudioNodeWrapper(m),m.title="Mixer",m.desc="Audio mixer",t.registerNodeType("audio/mixer",m);function O(){this.properties={A:.1,D:.1,S:.1,R:.1},this.audionode=s.getAudioContext().createGain(),this.audionode.gain.value=0,this.addInput("in","audio"),this.addInput("gate","boolean"),this.addOutput("out","audio"),this.gate=!1}O.prototype.onExecute=function(){var h=s.getAudioContext(),L=h.currentTime,_=this.audionode,D=_.gain,B=this.getInputData(1),F=this.getInputOrProperty("A"),H=this.getInputOrProperty("D"),V=this.getInputOrProperty("S"),Y=this.getInputOrProperty("R");!this.gate&&B?(D.cancelScheduledValues(0),D.setValueAtTime(0,L),D.linearRampToValueAtTime(1,L+F),D.linearRampToValueAtTime(V,L+F+H)):this.gate&&!B&&(D.cancelScheduledValues(0),D.setValueAtTime(D.value,L),D.linearRampToValueAtTime(0,L+Y)),this.gate=B},O.prototype.onGetInputs=function(){return[["A","number"],["D","number"],["S","number"],["R","number"]]},s.createAudioNodeWrapper(O),O.title="ADSR",O.desc="Audio envelope",t.registerNodeType("audio/adsr",O);function d(){this.properties={delayTime:.5},this.audionode=s.getAudioContext().createDelay(10),this.audionode.delayTime.value=this.properties.delayTime,this.addInput("in","audio"),this.addInput("time","number"),this.addOutput("out","audio")}s.createAudioNodeWrapper(d),d.prototype.onExecute=function(){var h=this.getInputData(1);h!==void 0&&(this.audionode.delayTime.value=h)},d.title="Delay",d.desc="Audio delay",t.registerNodeType("audio/delay",d);function g(){this.properties={frequency:350,detune:0,Q:1},this.addProperty("type","lowpass","enum",{values:["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"]}),this.audionode=s.getAudioContext().createBiquadFilter(),this.addInput("in","audio"),this.addOutput("out","audio")}g.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=1;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=null){var _=this.getInputData(h);_!==void 0&&(this.audionode[L.name].value=_)}}},g.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["Q","number"]]},s.createAudioNodeWrapper(g),g.title="BiquadFilter",g.desc="Audio filter",t.registerNodeType("audio/biquadfilter",g);function E(){this.properties={frequency:440,detune:0,type:"sine"},this.addProperty("type","sine","enum",{values:["sine","square","sawtooth","triangle","custom"]}),this.audionode=s.getAudioContext().createOscillator(),this.addOutput("out","audio")}E.prototype.onStart=function(){if(!this.audionode.started){this.audionode.started=!0;try{this.audionode.start()}catch{}}},E.prototype.onStop=function(){this.audionode.started&&(this.audionode.started=!1,this.audionode.stop())},E.prototype.onPause=function(){this.onStop()},E.prototype.onUnpause=function(){this.onStart()},E.prototype.onExecute=function(){if(!(!this.inputs||!this.inputs.length))for(var h=0;h<this.inputs.length;++h){var L=this.inputs[h];if(L.link!=null){var _=this.getInputData(h);_!==void 0&&(this.audionode[L.name].value=_)}}},E.prototype.onGetInputs=function(){return[["frequency","number"],["detune","number"],["type","string"]]},s.createAudioNodeWrapper(E),E.title="Oscillator",E.desc="Oscillator",t.registerNodeType("audio/oscillator",E);function I(){this.properties={continuous:!0,mark:-1},this.addInput("data","array"),this.addInput("mark","number"),this.size=[300,200],this._last_buffer=null}I.prototype.onExecute=function(){this._last_buffer=this.getInputData(0);var h=this.getInputData(1);h!==void 0&&(this.properties.mark=h),this.setDirtyCanvas(!0,!1)},I.prototype.onDrawForeground=function(h){if(this._last_buffer){var L=this._last_buffer,_=L.length/this.size[0],D=this.size[1];h.fillStyle="black",h.fillRect(0,0,this.size[0],this.size[1]),h.strokeStyle="white",h.beginPath();var B=0;if(this.properties.continuous){h.moveTo(B,D);for(var F=0;F<L.length;F+=_)h.lineTo(B,D-L[F|0]/255*D),B++}else for(var F=0;F<L.length;F+=_)h.moveTo(B+.5,D),h.lineTo(B+.5,D-L[F|0]/255*D),B++;if(h.stroke(),this.properties.mark>=0){var H=s.getAudioContext().sampleRate,V=H/L.length,B=2*(this.properties.mark/V)/_;B>=this.size[0]&&(B=this.size[0]-1),h.strokeStyle="red",h.beginPath(),h.moveTo(B,D),h.lineTo(B,0),h.stroke()}}},I.title="Visualization",I.desc="Audio Visualization",t.registerNodeType("audio/visualization",I);function k(){this.properties={band:440,amplitude:1},this.addInput("freqs","array"),this.addOutput("signal","number")}k.prototype.onExecute=function(){if(this._freqs=this.getInputData(0),!!this._freqs){var h=this.properties.band,B=this.getInputData(1);B!==void 0&&(h=B);var L=s.getAudioContext().sampleRate,_=L/this._freqs.length,D=2*(h/_),B=0;if(D<0&&(B=this._freqs[0]),D>=this._freqs.length)B=this._freqs[this._freqs.length-1];else{var F=D|0,H=this._freqs[F],V=this._freqs[F+1],Y=D-F;B=H*(1-Y)+V*Y}this.setOutputData(0,B/255*this.properties.amplitude)}},k.prototype.onGetInputs=function(){return[["band","number"]]},k.title="Signal",k.desc="extract the signal of some frequency",t.registerNodeType("audio/signal",k);function N(){if(!N.default_code){var h=N.default_function.toString(),L=h.indexOf("{")+1,_=h.lastIndexOf("}");N.default_code=h.substr(L,_-L)}this.properties={code:N.default_code};var D=s.getAudioContext();D.createScriptProcessor?this.audionode=D.createScriptProcessor(4096,1,1):(console.warn("ScriptProcessorNode deprecated"),this.audionode=D.createGain()),this.processCode(),N._bypass_function||(N._bypass_function=this.audionode.onaudioprocess),this.addInput("in","audio"),this.addOutput("out","audio")}N.prototype.onAdded=function(h){h.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback)},N["@code"]={widget:"code",type:"code"},N.prototype.onStart=function(){this.audionode.onaudioprocess=this._callback},N.prototype.onStop=function(){this.audionode.onaudioprocess=N._bypass_function},N.prototype.onPause=function(){this.audionode.onaudioprocess=N._bypass_function},N.prototype.onUnpause=function(){this.audionode.onaudioprocess=this._callback},N.prototype.onExecute=function(){},N.prototype.onRemoved=function(){this.audionode.onaudioprocess=N._bypass_function},N.prototype.processCode=function(){try{var h=new Function("properties",this.properties.code);this._script=new h(this.properties),this._old_code=this.properties.code,this._callback=this._script.onaudioprocess}catch(L){console.error("Error in onaudioprocess code",L),this._callback=N._bypass_function,this.audionode.onaudioprocess=this._callback}},N.prototype.onPropertyChanged=function(h,L){h=="code"&&(this.properties.code=L,this.processCode(),this.graph&&this.graph.status==LGraph.STATUS_RUNNING&&(this.audionode.onaudioprocess=this._callback))},N.default_function=function(){this.onaudioprocess=function(h){for(var L=h.inputBuffer,_=h.outputBuffer,D=0;D<_.numberOfChannels;D++)for(var B=L.getChannelData(D),F=_.getChannelData(D),H=0;H<L.length;H++)F[H]=B[H]}},s.createAudioNodeWrapper(N),N.title="Script",N.desc="apply script to signal",t.registerNodeType("audio/script",N);function T(){this.audionode=s.getAudioContext().destination,this.addInput("in","audio")}T.title="Destination",T.desc="Audio output",t.registerNodeType("audio/destination",T)})(litegraph),(function(e){var t=e.LiteGraph;function s(){this.size=[60,20],this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}s.title="WebSocket",s.desc="Send data through a websocket",s.prototype.onPropertyChanged=function(u,o){u=="url"&&this.connectSocket()},s.prototype.onExecute=function(){if(!this._ws&&this.properties.url&&this.connectSocket(),!(!this._ws||this._ws.readyState!=WebSocket.OPEN)){for(var u=this.properties.room,o=this.properties.only_send_changes,a=1;a<this.inputs.length;++a){var l=this.getInputData(a);if(l!=null){var f;try{f=JSON.stringify({type:0,room:u,channel:a,data:l})}catch{continue}o&&this._last_sent_data[a]==f||(this._last_sent_data[a]=f,this._ws.send(f))}}for(var a=1;a<this.outputs.length;++a)this.setOutputData(a,this._last_received_data[a]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},s.prototype.connectSocket=function(){var u=this,o=this.properties.url;o.substr(0,2)!="ws"&&(o="ws://"+o),this._ws=new WebSocket(o),this._ws.onopen=function(){console.log("ready"),u.boxcolor="#6C6"},this._ws.onmessage=function(a){u.boxcolor="#AFA";var l=JSON.parse(a.data);if(!(l.room&&l.room!=u.properties.room))if(l.type==1)if(l.data.object_class&&t[l.data.object_class]){var f=null;try{f=new t[l.data.object_class](l.data),u.triggerSlot(0,f)}catch{return}}else u.triggerSlot(0,l.data);else u._last_received_data[l.channel||0]=l.data},this._ws.onerror=function(a){console.log("couldnt connect to websocket"),u.boxcolor="#E88"},this._ws.onclose=function(a){console.log("connection closed"),u.boxcolor="#000"}},s.prototype.send=function(u){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send(JSON.stringify({type:1,msg:u}))},s.prototype.onAction=function(u,o){!this._ws||this._ws.readyState!=WebSocket.OPEN||this._ws.send({type:1,room:this.properties.room,action:u,data:o})},s.prototype.onGetInputs=function(){return[["in",0]]},s.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/websocket",s);function r(){this.room_widget=this.addWidget("text","Room","lgraph",this.setRoom.bind(this)),this.addWidget("button","Reconnect",null,this.connectSocket.bind(this)),this.addInput("send",t.ACTION),this.addOutput("received",t.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"tamats.com:55000",room:"lgraph",only_send_changes:!0},this._server=null,this.connectSocket(),this._last_sent_data=[],this._last_received_data=[],typeof SillyClient>"u"&&console.warn("remember to add SillyClient.js to your project: https://tamats.com/projects/sillyserver/src/sillyclient.js")}r.title="SillyClient",r.desc="Connects to SillyServer to broadcast messages",r.prototype.onPropertyChanged=function(u,o){u=="room"&&(this.room_widget.value=o),this.connectSocket()},r.prototype.setRoom=function(u){this.properties.room=u,this.room_widget.value=u,this.connectSocket()},r.prototype.onDrawForeground=function(){for(var u=1;u<this.inputs.length;++u){var o=this.inputs[u];o.label="in_"+u}for(var u=1;u<this.outputs.length;++u){var o=this.outputs[u];o.label="out_"+u}},r.prototype.onExecute=function(){if(!(!this._server||!this._server.is_connected)){for(var u=this.properties.only_send_changes,o=1;o<this.inputs.length;++o){var a=this.getInputData(o),l=this._last_sent_data[o];if(a!=null){if(u){var f=!0;if(a&&a.length&&l&&l.length==a.length&&a.constructor!==String){for(var m=0;m<a.length;++m)if(l[m]!=a[m]){f=!1;break}}else this._last_sent_data[o]!=a&&(f=!1);if(f)continue}if(this._server.sendMessage({type:0,channel:o,data:a}),a.length&&a.constructor!==String)if(this._last_sent_data[o]){this._last_sent_data[o].length=a.length;for(var m=0;m<a.length;++m)this._last_sent_data[o][m]=a[m]}else a.constructor===Array?this._last_sent_data[o]=a.concat():this._last_sent_data[o]=new a.constructor(a);else this._last_sent_data[o]=a}}for(var o=1;o<this.outputs.length;++o)this.setOutputData(o,this._last_received_data[o]);this.boxcolor=="#AFA"&&(this.boxcolor="#6C6")}},r.prototype.connectSocket=function(){var u=this;if(typeof SillyClient>"u"){this._error||console.error("SillyClient node cannot be used, you must include SillyServer.js"),this._error=!0;return}if(this._server=new SillyClient,this._server.on_ready=function(){console.log("ready"),u.boxcolor="#6C6"},this._server.on_message=function(o,a){var l=null;try{l=JSON.parse(a)}catch{return}if(l.type==1)if(l.data.object_class&&t[l.data.object_class]){var f=null;try{f=new t[l.data.object_class](l.data),u.triggerSlot(0,f)}catch{return}}else u.triggerSlot(0,l.data);else u._last_received_data[l.channel||0]=l.data;u.boxcolor="#AFA"},this._server.on_error=function(o){console.log("couldnt connect to websocket"),u.boxcolor="#E88"},this._server.on_close=function(o){console.log("connection closed"),u.boxcolor="#000"},this.properties.url&&this.properties.room){try{this._server.connect(this.properties.url,this.properties.room)}catch(o){console.error("SillyServer error: "+o),this._server=null;return}this._final_url=this.properties.url+"/"+this.properties.room}},r.prototype.send=function(u){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,data:u})},r.prototype.onAction=function(u,o){!this._server||!this._server.is_connected||this._server.sendMessage({type:1,action:u,data:o})},r.prototype.onGetInputs=function(){return[["in",0]]},r.prototype.onGetOutputs=function(){return[["out",0]]},t.registerNodeType("network/sillyclient",r);function n(){this.addInput("request",t.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",t.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}n.title="HTTP Request",n.desc="Fetch data through HTTP",n.prototype.fetch=function(){var u=this.properties.url;if(u){this.boxcolor="#FF0";var o=this;this._fetching=fetch(u).then(a=>{if(!a.ok)this.boxcolor="#F00",o.trigger("error");else return this.boxcolor="#0F0",a.text()}).then(a=>{o._data=a,o._fetching=null,o.trigger("ready")})}},n.prototype.onAction=function(u){u=="request"&&this.fetch()},n.prototype.onExecute=function(){this.setOutputData(1,this._data)},n.prototype.onGetOutputs=function(){return[["error",t.EVENT]]},t.registerNodeType("network/httprequest",n)})(litegraph)})(litegraph)),litegraph}var litegraphExports=requireLitegraph();function initSidebarSearch(){const e=document.getElementById("node-search-input"),t=document.getElementById("node-list");if(!e||!t){console.error("Sidebar elements not found! Check your IDs in index.html");return}const s=(r="")=>{t.innerHTML="";const n=Object.keys(litegraphExports.LiteGraph.registered_node_types),u={};n.forEach(o=>{if(o.startsWith("graph/"))return;const[a,l]=o.split("/");u[a]||(u[a]=[]),u[a].push({type:o,name:l})}),Object.entries(u).forEach(([o,a])=>{const l=document.createElement("div");l.textContent=o.toUpperCase(),l.style.cssText=`
        margin-top: 10px;
        font-size: 11px;
        color: #a5d6a7;
        border-bottom: 1px solid #333;
    `,t.appendChild(l),a.forEach(({type:f,name:m})=>{const O=document.createElement("div");O.className="node-item",O.textContent=m,O.onclick=()=>{const d=litegraphExports.LiteGraph.createNode(f),g=canvas.convertEventToCanvasOffset({clientX:window.innerWidth/2,clientY:window.innerHeight/2});d.pos=g,graph.add(d)},O.draggable=!0,O.ondragstart=d=>d.dataTransfer.setData("text",f),t.appendChild(O)})})};e.oninput=r=>s(r.target.value),s()}function registerFunNodes(){function e(){this.addInput("Play",litegraphExports.LiteGraph.ACTION),this.properties={url:"https://www.soundboard.com/handler/DownLoadTrack.ashx?cliptitle=Fart+Sound+1&filename=mt/MTY4NDMzMDUxNjgzNDcw_7Y_2fU9_2b_2fWv0.mp3",volume:.5},this.audio=new Audio(this.properties.url),this.addWidget("text","URL",this.properties.url,s=>{this.properties.url=s,this.audio.src=s})}e.title="Sound Player",e.prototype.onAction=function(){this.audio.volume=this.properties.volume,this.audio.currentTime=0,this.audio.play()},litegraphExports.LiteGraph.registerNodeType("audio/fart_sound",e);function t(){this.addOutput("Tick",litegraphExports.LiteGraph.EVENT),this.properties={interval:2e3},this.last_time=0,this.addWidget("number","Interval (ms)",this.properties.interval,s=>{this.properties.interval=s})}t.title="Clock / Timer",t.prototype.onExecute=function(){let s=Date.now();s-this.last_time>this.properties.interval&&(this.triggerSlot(0),this.last_time=s)},litegraphExports.LiteGraph.registerNodeType("logic/clock",t)}function registerMathNodes(){function e(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("Result","number")}e.title="Multiply",e.prototype.onExecute=function(){let t=this.getInputData(0)??0,s=this.getInputData(1)??1;this.setOutputData(0,t*s)},litegraphExports.LiteGraph.registerNodeType("math/multiply",e)}function registerIONodes$1(){function e(){this.addInput("Message",0),this.addInput("Trigger","boolean")}e.title="Fart Log",e.prototype.onExecute=function(){const s=this.getInputData(0),r=this.getInputData(1);s!==void 0&&r!==!1&&console.log("Fart IDE Output:",s)},LiteGraph.registerNodeType("io/log",e);function t(){this.addInput("Text","string"),this.addProperty("title","Fart IDE says:")}t.title="Alert Box",t.prototype.onExecute=function(){const s=this.getInputData(0);s&&alert(`${this.properties.title}
${s}`)},LiteGraph.registerNodeType("io/alert",t)}function registerIONodes(){function e(){this.addOutput("Value","string"),this.addProperty("text","hello world"),this.addWidget("text","Text",this.properties.text,r=>{this.properties.text=r})}e.title="String",e.prototype.onExecute=function(){this.setOutputData(0,this.properties.text)};function t(){this.addInput("In",0)}t.title="Log to Console",t.prototype.onExecute=function(){const r=this.getInputData(0);r!==void 0&&console.log("Fart IDE Output:",r)};function s(){this.addInput("Msg",0),this.addInput("Action",litegraphExports.LiteGraph.ACTION)}s.prototype.onAction=function(r,n){const u=this.getInputData(0);console.log("Fart IDE Triggered:",u)},litegraphExports.LiteGraph.registerNodeType("io/trigger_log",s),litegraphExports.LiteGraph.registerNodeType("io/string",e),litegraphExports.LiteGraph.registerNodeType("io/log",t)}const graph$1=new litegraphExports.LGraph,canvas$1=new litegraphExports.LGraphCanvas("#main-canvas",graph$1);window.graph=graph$1;window.canvas=canvas$1;window.LiteGraph=litegraphExports.LiteGraph;registerFunNodes();registerMathNodes();registerIONodes$1();registerIONodes();initSidebarSearch();initSidebarSearch();function resizeCanvas(){const e=document.getElementById("canvas-container");if(!e)return;const t=document.getElementById("main-canvas");t.width=e.clientWidth,t.height=e.clientHeight,canvas$1.resize()}let projectName="Untitled Project";window.projectName=projectName;window.addEventListener("resize",resizeCanvas);window.saveProject=()=>{const e={type:"FART_PROJECT",version:1,name:projectName,graph:graph$1.serialize()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/fart"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`${projectName||"project"}.fart`,s.click()};window.loadProject=e=>{const t=e.target.files[0];if(!t)return;if(!t.name.endsWith(".fart")){alert("Not a FART project ");return}const s=new FileReader;s.onload=r=>{try{const n=JSON.parse(r.target.result);if(n.type!=="FART_PROJECT")throw new Error("Invalid project format");graph$1.clear(),graph$1.configure(n.graph)}catch(n){alert("Corrupted or invalid .fart file "),console.error(n)}},s.readAsText(t)};window.clearCanvas=()=>{confirm("Wipe all nodes?")&&graph$1.clear()};graph$1.start();setTimeout(resizeCanvas,100);const projectNameInput=document.getElementById("project-name");projectNameInput.addEventListener("input",()=>{projectName=projectNameInput.value||"Untitled Project"});const node_const=litegraphExports.LiteGraph.createNode("basic/const");node_const.pos=[100,100];graph$1.add(node_const);const canvasElement=document.getElementById("main-canvas");canvasElement.ondragover=e=>e.preventDefault();canvasElement.ondrop=e=>{e.preventDefault();const t=e.dataTransfer.getData("text");if(t){const s=litegraphExports.LiteGraph.createNode(t);if(s){const r=canvasElement.getBoundingClientRect();e.clientX-r.left,e.clientY-r.top;const n=canvas$1.convertEventToCanvasOffset(e);s.pos=n,graph$1.add(s)}}};canvas$1.onContextMenu=function(e){litegraphExports.LiteGraph.ContextMenu(Object.keys(litegraphExports.LiteGraph.registered_node_types),{event:e,callback:t=>{const s=litegraphExports.LiteGraph.createNode(t);s.pos=canvas$1.convertEventToCanvasOffset(e),graph$1.add(s)}})};window.addEventListener("keydown",e=>{if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")&&e.ctrlKey&&e.key.toLowerCase()==="q"){e.preventDefault(),document.getElementById("node-search-input").focus();const t=document.getElementById("node-search-input");t.focus(),t.select()}});canvasElement.ondrop=e=>{if(e.preventDefault(),e.dataTransfer.files.length){const t=e.dataTransfer.files[0];if(t.name.endsWith(".fart")){const s=new FileReader;s.onload=r=>{const n=JSON.parse(r.target.result);graph$1.clear(),graph$1.configure(n.graph)},s.readAsText(t)}return}};
